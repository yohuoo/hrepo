<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">æ•°æ®ç»Ÿè®¡</li>
      </ol>
    </nav>
    <h1 class="page-title">æ•°æ®ç»Ÿè®¡åˆ†æ</h1>
    <p class="page-subtitle">å¯è§†åŒ–å±•ç¤ºæ‚¨çš„ä¸šåŠ¡æ•°æ®</p>
  </div>
</div>

<!-- ç­›é€‰åŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <!-- è¶…çº§ç®¡ç†å‘˜/ç®¡ç†å‘˜ç­›é€‰å™¨ -->
    <div class="row g-3 align-items-center mb-3" id="adminFilters" style="display: none;">
      <div class="col-md-4">
        <label class="form-label mb-1">æŸ¥çœ‹èŒƒå›´</label>
        <select class="form-select" id="viewScope" onchange="handleScopeChange()">
          <option value="all">å…¨éƒ¨æ•°æ®</option>
          <option value="department">æŒ‰éƒ¨é—¨</option>
          <option value="user">æŒ‰ç”¨æˆ·</option>
        </select>
      </div>
      <div class="col-md-4" id="departmentFilter" style="display: none;">
        <label class="form-label mb-1">é€‰æ‹©éƒ¨é—¨</label>
        <select class="form-select" id="filterDepartment" onchange="loadStatistics()">
          <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
        </select>
      </div>
      <div class="col-md-4" id="userFilter" style="display: none;">
        <label class="form-label mb-1">é€‰æ‹©ç”¨æˆ·</label>
        <select class="form-select" id="filterUser" onchange="loadStatistics()">
          <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
        </select>
      </div>
    </div>
    
    <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
    <div class="row g-3 align-items-center">
      <div class="col-md-6">
        <div class="btn-group w-100" role="group">
          <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('1d')">ä»Šæ—¥</button>
          <button type="button" class="btn btn-outline-primary active" onclick="setTimeRange('7d')">7å¤©</button>
          <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('30d')">30å¤©</button>
          <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('3m')">3ä¸ªæœˆ</button>
          <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('6m')">6ä¸ªæœˆ</button>
          <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('all')">å…¨éƒ¨</button>
        </div>
      </div>
      <div class="col-md-3">
        <input type="date" class="form-control" id="customStartDate" placeholder="å¼€å§‹æ—¥æœŸ" onchange="handleCustomDateChange()">
      </div>
      <div class="col-md-3">
        <input type="date" class="form-control" id="customEndDate" placeholder="ç»“æŸæ—¥æœŸ" onchange="handleCustomDateChange()">
      </div>
    </div>
  </div>
</div>

<!-- æ•°æ®å¡ç‰‡ -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card h-100" onclick="showContactDetails()" style="cursor: pointer;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-2">
              <i class="bi bi-person-lines-fill text-primary"></i> æ–°å¢è”ç³»äºº
            </h6>
            <h2 class="mb-1" id="contactsCount">0</h2>
            <small class="text-muted d-block" style="min-height: 20px;">&nbsp;</small>
          </div>
          <div class="stat-icon bg-primary bg-opacity-10 text-primary">
            <i class="bi bi-person-plus"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card h-100" onclick="showCustomerDetails()" style="cursor: pointer;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-2">
              <i class="bi bi-people text-success"></i> æ–°å¢å®¢æˆ·
            </h6>
            <h2 class="mb-1" id="customersCount">0</h2>
            <small class="text-muted d-block" style="min-height: 20px;">&nbsp;</small>
          </div>
          <div class="stat-icon bg-success bg-opacity-10 text-success">
            <i class="bi bi-building-add"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-2">
              <i class="bi bi-envelope text-info"></i> é‚®ä»¶äº’åŠ¨
            </h6>
            <h2 class="mb-1" id="emailsCount">0</h2>
            <small class="text-muted d-block" id="emailsDetail" style="min-height: 20px;">å‘é€0 / æ¥æ”¶0</small>
          </div>
          <div class="stat-icon bg-info bg-opacity-10 text-info">
            <i class="bi bi-send"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card h-100" onclick="window.location.href='/sales'" style="cursor: pointer;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-2">
              <i class="bi bi-cash-coin text-warning"></i> é”€å”®æ€»é¢
            </h6>
            <h2 class="mb-1" id="salesAmount">$0</h2>
            <small class="text-muted d-block" id="salesDetail" style="min-height: 20px;">0ç¬”äº¤æ˜“</small>
          </div>
          <div class="stat-icon bg-warning bg-opacity-10 text-warning">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ - åŠ¨æ€å¸ƒå±€ -->
<div class="row" id="trendsRow">
  <!-- æ•°æ®è¶‹åŠ¿å›¾ -->
  <div class="mb-4" id="trendChartCol">
    <div class="card chart-card">
      <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-semibold"><i class="bi bi-graph-up text-primary me-2"></i>æ•°æ®è¶‹åŠ¿</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- é”€å”®è¶‹åŠ¿å›¾ -->
  <div class="mb-4" id="salesChartCol">
    <div class="card chart-card">
      <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-semibold"><i class="bi bi-graph-up-arrow text-warning me-2"></i>é”€å”®è¶‹åŠ¿</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- å®¢æˆ·å…´è¶£åº¦ -->
  <div class="col-lg-6 mb-4">
    <div class="card chart-card h-100">
      <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-semibold"><i class="bi bi-pie-chart text-success me-2"></i>å®¢æˆ·å…´è¶£åº¦åˆ†å¸ƒ</h5>
      </div>
      <div class="card-body d-flex align-items-center justify-content-center">
        <div class="chart-container-doughnut">
          <canvas id="interestChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ•°æ®æ´å¯Ÿ -->
  <div class="col-lg-6 mb-4">
    <div class="card chart-card h-100">
      <div class="card-header bg-white border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-semibold"><i class="bi bi-lightbulb text-warning me-2"></i>æ•°æ®æ´å¯Ÿ</h5>
          <button class="btn btn-outline-warning btn-sm" onclick="loadDataInsights()">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
          </button>
        </div>
      </div>
      <div class="card-body" id="dataInsightsContainer">
        <div class="text-center p-4">
          <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
          </div>
          <p class="text-muted mt-2">AIæ­£åœ¨åˆ†ææ•°æ®...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AIåŠ¨ä½œå»ºè®® -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card chart-card">
      <div class="card-header bg-white border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-semibold"><i class="bi bi-robot text-primary me-2"></i>AIåŠ¨ä½œå»ºè®®</h5>
          <button class="btn btn-outline-primary btn-sm" onclick="loadAISuggestions()">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°å»ºè®®
          </button>
        </div>
      </div>
      <div class="card-body" id="aiSuggestionsContainer">
        <div class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
          </div>
          <p class="text-muted mt-2">AIæ­£åœ¨åˆ†ææ•°æ®...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.stat-card {
  transition: all 0.2s;
  border: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.stat-card:hover {
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.stat-icon {
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  font-size: 24px;
}

/* å›¾è¡¨å¡ç‰‡ç»Ÿä¸€æ ·å¼ */
.chart-card {
  border: none;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.chart-card:hover {
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.chart-card .card-header {
  padding: 1.25rem 1.5rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.chart-card .card-body {
  padding: 1.5rem;
}

/* æŠ˜çº¿å›¾å®¹å™¨ - ç»Ÿä¸€é«˜åº¦ */
.chart-container {
  position: relative;
  height: 350px;
  width: 100%;
}

/* ç¯å½¢å›¾å®¹å™¨ - å›ºå®šå°ºå¯¸ */
.chart-container-doughnut {
  position: relative;
  width: 100%;
  max-width: 400px;
  height: 400px;
}

/* ç¡®ä¿canvaså“åº”å¼ */
.chart-container canvas,
.chart-container-doughnut canvas {
  max-width: 100%;
  height: 100% !important;
}


/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 991px) {
  .chart-container {
    height: 300px;
  }
  
  .chart-container-doughnut {
    height: 350px;
  }
}

@media (max-width: 767px) {
  .chart-container {
    height: 250px;
  }
  
  .chart-container-doughnut {
    height: 300px;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let currentTimeRange = '7d';
let trendChart = null;
let interestChart = null;
let salesChart = null;
let currentUser = null;
let allDepartments = [];
let allUsers = [];

document.addEventListener('DOMContentLoaded', async function() {
  console.log('ğŸš€ ç»Ÿè®¡é¡µé¢JSå·²åŠ è½½ - ç‰ˆæœ¬: 2.0');
  
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  currentUser = JSON.parse(localStorage.getItem('userInfo') || '{}');
  console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·:', currentUser);
  
  // å¦‚æœuserInfoä¸­æ²¡æœ‰roleå­—æ®µï¼Œä»åç«¯é‡æ–°è·å–
  if (!currentUser.role) {
    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        currentUser = data.user;
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        console.log('âœ… é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯:', currentUser);
      }
    } catch (error) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
  }
  
  // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜æˆ–ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç­›é€‰å™¨å¹¶åŠ è½½éƒ¨é—¨å’Œç”¨æˆ·
  if (currentUser.role === 'super_admin' || currentUser.role === 'admin') {
    console.log('ğŸ”“ æ˜¾ç¤ºç®¡ç†å‘˜ç­›é€‰å™¨');
    document.getElementById('adminFilters').style.display = '';
    await loadDepartments();
    await loadUsers();
  }
  
  await loadStatistics();
  await Promise.all([
    loadAISuggestions(),
    loadDataInsights()
  ]);
});

// é™åˆ¶æ•°æ®ä¸ºæœ€å¤š30å¤©ï¼ˆä»å¼€å§‹æ—¶é—´ç®—èµ·ï¼‰
function limitDataTo30Days(dailyData) {
  if (!dailyData || dailyData.length === 0) {
    return [];
  }
  
  // å¦‚æœæ•°æ®ç‚¹å°‘äºç­‰äº30å¤©ï¼Œç›´æ¥è¿”å›
  if (dailyData.length <= 30) {
    return dailyData;
  }
  
  // åªè¿”å›å‰30å¤©çš„æ•°æ®
  console.log(`ğŸ“Š æ•°æ®ç‚¹è¿‡å¤š(${dailyData.length}å¤©)ï¼Œé™åˆ¶ä¸ºå‰30å¤©`);
  return dailyData.slice(0, 30);
}

// æ ¹æ®æ•°æ®ç‚¹æ•°é‡åŠ¨æ€è°ƒæ•´å›¾è¡¨å¸ƒå±€
function adjustChartLayout(dataPoints) {
  const trendCol = document.getElementById('trendChartCol');
  const salesCol = document.getElementById('salesChartCol');
  
  console.log(`ğŸ“ æ•°æ®ç‚¹æ•°é‡: ${dataPoints}å¤©ï¼Œè°ƒæ•´å¸ƒå±€...`);
  
  if (dataPoints < 15) {
    // å°‘äº15å¤©ï¼šä¸¤ä¸ªå›¾è¡¨å¹¶æ’æ˜¾ç¤º
    trendCol.className = 'col-lg-6 mb-4';
    salesCol.className = 'col-lg-6 mb-4';
    console.log('âœ… å¸ƒå±€: å¹¶æ’æ˜¾ç¤ºï¼ˆæ•°æ®ç‚¹ < 15å¤©ï¼‰');
  } else {
    // 15å¤©åŠä»¥ä¸Šï¼šä¸¤ä¸ªå›¾è¡¨åˆ†ä¸¤è¡Œæ˜¾ç¤º
    trendCol.className = 'col-12 mb-4';
    salesCol.className = 'col-12 mb-4';
    console.log('âœ… å¸ƒå±€: åˆ†è¡Œæ˜¾ç¤ºï¼ˆæ•°æ®ç‚¹ >= 15å¤©ï¼‰');
  }
}

// è®¾ç½®æ—¶é—´èŒƒå›´
function setTimeRange(range) {
  currentTimeRange = range;
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // æ¸…ç©ºè‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©
  document.getElementById('customStartDate').value = '';
  document.getElementById('customEndDate').value = '';
  
  loadStatistics();
}

// å¤„ç†è‡ªå®šä¹‰æ—¥æœŸå˜åŒ–
function handleCustomDateChange() {
  const customStart = document.getElementById('customStartDate').value;
  const customEnd = document.getElementById('customEndDate').value;
  
  // åªæœ‰å½“ä¸¤ä¸ªæ—¥æœŸéƒ½é€‰æ‹©äº†æ‰åŠ è½½æ•°æ®
  if (customStart && customEnd) {
    // å–æ¶ˆé¢„è®¾æ—¶é—´èŒƒå›´æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.btn-group button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    console.log('ğŸ“… è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´:', customStart, 'è‡³', customEnd);
    loadStatistics();
    loadAISuggestions();
  }
}

// åŠ è½½éƒ¨é—¨åˆ—è¡¨
async function loadDepartments() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/departments/tree', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    if (data.success) {
      allDepartments = flattenDepartments(data.departments || []);
      updateDepartmentSelect();
    }
  } catch (error) {
    console.error('åŠ è½½éƒ¨é—¨å¤±è´¥:', error);
  }
}

// æ‰å¹³åŒ–éƒ¨é—¨æ ‘
function flattenDepartments(depts, result = []) {
  depts.forEach(dept => {
    result.push(dept);
    if (dept.children && dept.children.length > 0) {
      flattenDepartments(dept.children, result);
    }
  });
  return result;
}

// æ›´æ–°éƒ¨é—¨é€‰æ‹©å™¨
function updateDepartmentSelect() {
  const select = document.getElementById('filterDepartment');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>';
  allDepartments.forEach(dept => {
    const indent = 'ã€€'.repeat(dept.level - 1);
    select.innerHTML += `<option value="${dept.id}">${indent}${dept.name}</option>`;
  });
}

// åŠ è½½ç”¨æˆ·åˆ—è¡¨
async function loadUsers() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/users?pageSize=1000', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    if (data.success) {
      allUsers = data.users || [];
      updateUserSelect();
    }
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
  }
}

// æ›´æ–°ç”¨æˆ·é€‰æ‹©å™¨
function updateUserSelect() {
  const select = document.getElementById('filterUser');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
  allUsers.forEach(user => {
    select.innerHTML += `<option value="${user.id}">${user.username} (${user.email})</option>`;
  });
}

// å¤„ç†èŒƒå›´å˜åŒ–
function handleScopeChange() {
  const scope = document.getElementById('viewScope').value;
  const departmentFilter = document.getElementById('departmentFilter');
  const userFilter = document.getElementById('userFilter');
  
  console.log('ğŸ”„ ç­›é€‰èŒƒå›´æ”¹å˜:', scope);
  
  if (scope === 'department') {
    departmentFilter.style.display = '';
    userFilter.style.display = 'none';
    // é‡ç½®éƒ¨é—¨é€‰æ‹©
    document.getElementById('filterDepartment').value = '';
  } else if (scope === 'user') {
    departmentFilter.style.display = 'none';
    userFilter.style.display = '';
    // é‡ç½®ç”¨æˆ·é€‰æ‹©
    document.getElementById('filterUser').value = '';
  } else {
    departmentFilter.style.display = 'none';
    userFilter.style.display = 'none';
  }
  
  // ç«‹å³é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
  loadStatistics();
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStatistics() {
  try {
    console.log('=== loadStatistics å‡½æ•°è¢«è°ƒç”¨ ===');
    console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', currentUser);
    
    const token = localStorage.getItem('authToken');
    
    let timeRange = currentTimeRange;
    const customStart = document.getElementById('customStartDate').value;
    const customEnd = document.getElementById('customEndDate').value;
    
    if (customStart && customEnd) {
      timeRange = `${customStart}|${customEnd}`;
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    let queryParams = `time_range=${timeRange}`;
    
    // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜æˆ–ç®¡ç†å‘˜ï¼Œæ·»åŠ ç­›é€‰å‚æ•°
    if (currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin')) {
      const viewScopeElement = document.getElementById('viewScope');
      const scope = viewScopeElement ? viewScopeElement.value : 'all';
      console.log('ğŸ” å½“å‰ç­›é€‰èŒƒå›´:', scope);
      console.log('ğŸ” viewScopeå…ƒç´ :', viewScopeElement);
      
      if (scope === 'department') {
        const deptElement = document.getElementById('filterDepartment');
        const deptId = deptElement ? deptElement.value : '';
        console.log('ğŸ¢ filterDepartmentå…ƒç´ :', deptElement);
        console.log('ğŸ¢ é€‰æ‹©çš„éƒ¨é—¨ID:', deptId);
        if (deptId) {
          queryParams += `&department_id=${deptId}`;
          console.log('âœ… æ·»åŠ éƒ¨é—¨ç­›é€‰å‚æ•°ï¼Œæœ€ç»ˆURLå‚æ•°:', queryParams);
        } else {
          console.log('âš ï¸ æœªé€‰æ‹©å…·ä½“éƒ¨é—¨');
        }
      } else if (scope === 'user') {
        const userElement = document.getElementById('filterUser');
        const selectedUserId = userElement ? userElement.value : '';
        console.log('ğŸ‘¤ filterUserå…ƒç´ :', userElement);
        console.log('ğŸ‘¤ é€‰æ‹©çš„ç”¨æˆ·ID:', selectedUserId);
        if (selectedUserId) {
          queryParams += `&user_id=${selectedUserId}`;
          console.log('âœ… æ·»åŠ ç”¨æˆ·ç­›é€‰å‚æ•°ï¼Œæœ€ç»ˆURLå‚æ•°:', queryParams);
        } else {
          console.log('âš ï¸ æœªé€‰æ‹©å…·ä½“ç”¨æˆ·');
        }
      } else {
        console.log('ğŸ“Š æŸ¥çœ‹å…¨éƒ¨æ•°æ®ï¼ˆæ— ç­›é€‰ï¼‰');
      }
    } else {
      console.log('âŒ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæˆ–currentUseræœªå®šä¹‰:', currentUser);
    }
    
    console.log('ğŸ“Š æœ€ç»ˆè¯·æ±‚URL:', `/api/statistics/dashboard?${queryParams}`);
    
    const response = await fetch(`/api/statistics/dashboard?${queryParams}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    console.log('ğŸ“¥ ç»Ÿè®¡æ•°æ®å“åº”:', data);
    
    if (!data.success) {
      console.error('âŒ åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', data.message);
      showError('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    const stats = data.statistics;
    console.log('ğŸ“ˆ ç»Ÿè®¡æ•°æ®:', stats);
    
    // æ›´æ–°æ•°æ®å¡ç‰‡
    document.getElementById('contactsCount').textContent = stats.contacts?.total || 0;
    document.getElementById('customersCount').textContent = stats.customers?.total || 0;
    document.getElementById('emailsCount').textContent = (stats.emails?.sent || 0) + (stats.emails?.received || 0);
    document.getElementById('emailsDetail').textContent = `å‘é€${stats.emails?.sent || 0} / æ¥æ”¶${stats.emails?.received || 0}`;
    document.getElementById('salesAmount').textContent = `$${parseFloat(stats.sales?.total_amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById('salesDetail').textContent = `${stats.sales?.total_records || 0}ç¬”äº¤æ˜“`;
    
    // é™åˆ¶æ•°æ®ä¸ºæœ€å¤š30å¤©å¹¶è°ƒæ•´å¸ƒå±€
    const contactsDaily = limitDataTo30Days(stats.contacts?.daily || []);
    const customersDaily = limitDataTo30Days(stats.customers?.daily || []);
    const salesDaily = limitDataTo30Days(stats.sales?.daily || []);
    
    // æ ¹æ®æ•°æ®ç‚¹æ•°é‡è°ƒæ•´å¸ƒå±€
    adjustChartLayout(Math.max(contactsDaily.length, customersDaily.length, salesDaily.length));
    
    // æ¸²æŸ“å›¾è¡¨
    renderTrendChart(contactsDaily, customersDaily);
    renderInterestChart(stats.customers?.by_interest || []);
    renderSalesChart(salesDaily);
    
  } catch (error) {
    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    showError('åŠ è½½å¤±è´¥');
  }
}

// æ¸²æŸ“è¶‹åŠ¿å›¾
function renderTrendChart(contactsDaily, customersDaily) {
  const ctx = document.getElementById('trendChart');
  
  if (trendChart) {
    trendChart.destroy();
  }
  
  // åˆå¹¶æ‰€æœ‰æ—¥æœŸï¼Œç¡®ä¿ä¸¤æ¡çº¿çš„æ—¥æœŸä¸€è‡´
  const allDates = new Set([
    ...contactsDaily.map(d => d.date),
    ...customersDaily.map(d => d.date)
  ]);
  const sortedDates = Array.from(allDates).sort();
  
  // ä¸ºæ¯ä¸ªæ—¥æœŸå‡†å¤‡æ•°æ®ï¼Œå¦‚æœæŸå¤©æ²¡æœ‰æ•°æ®åˆ™ä¸º0
  const contactsMap = new Map(contactsDaily.map(d => [d.date, parseInt(d.count)]));
  const customersMap = new Map(customersDaily.map(d => [d.date, parseInt(d.count)]));
  
  const contactsData = sortedDates.map(date => contactsMap.get(date) || 0);
  const customersData = sortedDates.map(date => customersMap.get(date) || 0);
  
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sortedDates,
      datasets: [
        {
          label: 'æ–°å¢è”ç³»äºº',
          data: contactsData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'æ–°å¢å®¢æˆ·',
          data: customersData,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        x: {
          grid: {
            display: false
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        }
      }
    }
  });
}

// æ¸²æŸ“å…´è¶£åº¦é¥¼å›¾
function renderInterestChart(interestData) {
  const ctx = document.getElementById('interestChart');
  
  if (interestChart) {
    interestChart.destroy();
  }
  
  const labels = [];
  const data = [];
  const colors = [];
  
  interestData.forEach(item => {
    if (item.interest_level === 'high') {
      labels.push('é«˜å…´è¶£');
      data.push(item.count);
      colors.push('#28a745');
    } else if (item.interest_level === 'medium') {
      labels.push('ä¸­ç­‰å…´è¶£');
      data.push(item.count);
      colors.push('#ffc107');
    } else if (item.interest_level === 'low') {
      labels.push('ä½å…´è¶£');
      data.push(item.count);
      colors.push('#dc3545');
    } else if (item.interest_level === 'none') {
      labels.push('æ— å…´è¶£');
      data.push(item.count);
      colors.push('#6c757d');
    }
  });
  
  if (data.length === 0) {
    labels.push('æš‚æ— æ•°æ®');
    data.push(1);
    colors.push('#e9ecef');
  }
  
  interestChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: {
              size: 13
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '65%'
    }
  });
}

// æ¸²æŸ“é”€å”®è¶‹åŠ¿å›¾ï¼ˆåŒYè½´ï¼šé‡‘é¢ + æ•°é‡ + äº¤æ˜“ç¬”æ•°ï¼‰
function renderSalesChart(salesDaily) {
  const ctx = document.getElementById('salesChart');
  
  if (salesChart) {
    salesChart.destroy();
  }
  
  // å‡†å¤‡æ•°æ®
  const dates = salesDaily.map(d => d.date);
  const amounts = salesDaily.map(d => parseFloat(d.amount || 0));
  const quantities = salesDaily.map(d => parseFloat(d.quantity || 0));
  const counts = salesDaily.map(d => parseInt(d.count || 0));
  
  salesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'é”€å”®é‡‘é¢ (USD)',
          data: amounts,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.4,
          fill: true,
          yAxisID: 'y-amount'
        },
        {
          label: 'é”€å”®æ•°é‡',
          data: quantities,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true,
          yAxisID: 'y-quantity'
        },
        {
          label: 'äº¤æ˜“ç¬”æ•°',
          data: counts,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true,
          yAxisID: 'y-quantity'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            padding: 15,
            font: {
              size: 13
            },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 13
          },
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.dataset.label === 'é”€å”®é‡‘é¢ (USD)') {
                // é”€å”®é‡‘é¢ï¼šæ˜¾ç¤ºä¸ºè´§å¸æ ¼å¼
                label += '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
              } else if (context.dataset.label === 'äº¤æ˜“ç¬”æ•°') {
                // äº¤æ˜“ç¬”æ•°ï¼šæ˜¾ç¤ºä¸ºæ•´æ•°
                label += context.parsed.y + ' ç¬”';
              } else {
                // é”€å”®æ•°é‡ï¼šæ˜¾ç¤ºä¸ºå°æ•°
                label += context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
              }
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          grid: {
            display: false
          },
          title: {
            display: false
          }
        },
        'y-amount': {
          type: 'linear',
          display: true,
          position: 'left',
          beginAtZero: true,
          title: {
            display: true,
            text: 'é”€å”®é‡‘é¢',
            color: '#f59e0b',
            font: {
              size: 12,
              weight: 'bold'
            }
          },
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString('en-US');
            },
            color: '#f59e0b',
            font: {
              size: 11
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)',
            drawOnChartArea: true,
          },
        },
        'y-quantity': {
          type: 'linear',
          display: true,
          position: 'right',
          beginAtZero: true,
          title: {
            display: true,
            text: 'æ•°é‡/ç¬”æ•°',
            color: '#3b82f6',
            font: {
              size: 12,
              weight: 'bold'
            }
          },
          ticks: {
            color: '#3b82f6',
            font: {
              size: 11
            }
          },
          grid: {
            drawOnChartArea: false,
          },
        }
      }
    }
  });
}

// æ˜¾ç¤ºè”ç³»äººè¯¦æƒ…
async function showContactDetails() {
  try {
    const token = localStorage.getItem('authToken');
    
    let timeRange = currentTimeRange;
    const customStart = document.getElementById('customStartDate').value;
    const customEnd = document.getElementById('customEndDate').value;
    
    if (customStart && customEnd) {
      timeRange = `${customStart}|${customEnd}`;
    }
    
    const response = await fetch(`/api/statistics/contacts/details?time_range=${timeRange}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–è”ç³»äººè¯¦æƒ…å¤±è´¥');
      return;
    }
    
    const contacts = data.contacts || [];
    
    let html = `
      <div class="modal fade" id="contactDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">è”ç³»äººè¯¦ç»†åˆ—è¡¨</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              ${contacts.length > 0 ? `
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>å§“å</th>
                        <th>é‚®ç®±</th>
                        <th>å…¬å¸</th>
                        <th>æ·»åŠ æ—¶é—´</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${contacts.map(c => `
                        <tr>
                          <td>${c.name}</td>
                          <td>${c.email}</td>
                          <td>${c.company}</td>
                          <td>${new Date(c.created_at).toLocaleString('zh-CN')}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              ` : '<p class="text-muted text-center">è¯¥æ—¶é—´æ®µå†…æ— æ–°å¢è”ç³»äºº</p>'}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ç§»é™¤æ—§æ¨¡æ€æ¡†
    const oldModal = document.getElementById('contactDetailsModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', html);
    new bootstrap.Modal(document.getElementById('contactDetailsModal')).show();
    
  } catch (error) {
    console.error('è·å–è”ç³»äººè¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–è”ç³»äººè¯¦æƒ…å¤±è´¥');
  }
}

// æ˜¾ç¤ºå®¢æˆ·è¯¦æƒ…
async function showCustomerDetails() {
  try {
    const token = localStorage.getItem('authToken');
    
    let timeRange = currentTimeRange;
    const customStart = document.getElementById('customStartDate').value;
    const customEnd = document.getElementById('customEndDate').value;
    
    if (customStart && customEnd) {
      timeRange = `${customStart}|${customEnd}`;
    }
    
    const response = await fetch(`/api/statistics/customers/details?time_range=${timeRange}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–å®¢æˆ·è¯¦æƒ…å¤±è´¥');
      return;
    }
    
    const customers = data.customers || [];
    
    let html = `
      <div class="modal fade" id="customerDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">å®¢æˆ·è¯¦ç»†åˆ—è¡¨</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              ${customers.length > 0 ? `
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>å§“å</th>
                        <th>å…¬å¸</th>
                        <th>é‚®ç®±</th>
                        <th>å…´è¶£åº¦</th>
                        <th>æ·»åŠ æ—¶é—´</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${customers.map(c => `
                        <tr>
                          <td>${c.name}</td>
                          <td>${c.company}</td>
                          <td>${c.email}</td>
                          <td>
                            <span class="badge bg-${c.interest_level === 'high' ? 'success' : c.interest_level === 'medium' ? 'warning' : 'secondary'}">
                              ${c.interest_level === 'high' ? 'é«˜' : c.interest_level === 'medium' ? 'ä¸­' : 'ä½'}
                            </span>
                          </td>
                          <td>${new Date(c.created_at).toLocaleString('zh-CN')}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              ` : '<p class="text-muted text-center">è¯¥æ—¶é—´æ®µå†…æ— æ–°å¢å®¢æˆ·</p>'}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ç§»é™¤æ—§æ¨¡æ€æ¡†
    const oldModal = document.getElementById('customerDetailsModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', html);
    new bootstrap.Modal(document.getElementById('customerDetailsModal')).show();
    
  } catch (error) {
    console.error('è·å–å®¢æˆ·è¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–å®¢æˆ·è¯¦æƒ…å¤±è´¥');
  }
}

// åŠ è½½æ•°æ®æ´å¯Ÿ
async function loadDataInsights() {
  try {
    console.log('ğŸ” å¼€å§‹åŠ è½½æ•°æ®æ´å¯Ÿ');
    
    const token = localStorage.getItem('authToken');
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const params = new URLSearchParams();
    
    // æ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°
    let timeRange = currentTimeRange;
    const customStart = document.getElementById('customStartDate').value;
    const customEnd = document.getElementById('customEndDate').value;
    
    if (customStart && customEnd) {
      timeRange = `${customStart}|${customEnd}`;
    }
    params.append('time_range', timeRange);
    
    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ç­›é€‰å‚æ•°
    if (currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin')) {
      const scopeElement = document.getElementById('viewScope');
      const scope = scopeElement ? scopeElement.value : 'all';
      
      if (scope === 'department') {
        const deptId = document.getElementById('filterDepartment')?.value;
        if (deptId) {
          params.append('department_id', deptId);
        }
      } else if (scope === 'user') {
        const userId = document.getElementById('filterUser')?.value;
        if (userId) {
          params.append('user_id', userId);
        }
      }
    }
    
    const response = await fetch(`/api/statistics/data-insights?${params.toString()}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.message || 'æ•°æ®æ´å¯ŸåŠ è½½å¤±è´¥');
    }
    
    const insights = data.insights || [];
    console.log('âœ… æ•°æ®æ´å¯ŸåŠ è½½æˆåŠŸï¼Œå…±', insights.length, 'æ¡');
    
    renderDataInsights(insights);
    
  } catch (error) {
    console.error('åŠ è½½æ•°æ®æ´å¯Ÿå¤±è´¥:', error);
    const container = document.getElementById('dataInsightsContainer');
    container.innerHTML = `
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle"></i> 
        æ•°æ®æ´å¯ŸåŠ è½½å¤±è´¥ï¼š${error.message}
        <button class="btn btn-sm btn-outline-warning ms-2" onclick="loadDataInsights()">é‡è¯•</button>
      </div>
    `;
  }
}

// æ¸²æŸ“æ•°æ®æ´å¯Ÿ
function renderDataInsights(insights) {
  const container = document.getElementById('dataInsightsContainer');
  
  if (insights.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle"></i> æš‚æ— æ•°æ®æ´å¯Ÿ
      </div>
    `;
    return;
  }
  
  let html = '<ul class="list-unstyled mb-0">';
  
  insights.forEach((insight, index) => {
    // æ ¹æ®è¶‹åŠ¿ç¡®å®šå›¾æ ‡å’Œé¢œè‰²
    let icon = '';
    let color = '';
    let bgColor = '';
    
    if (insight.trend === 'up') {
      // ä¸Šå‡è¶‹åŠ¿ - ç»¿è‰²ç®­å¤´
      icon = 'bi-arrow-up-circle-fill';
      color = 'text-success';
      bgColor = 'bg-success';
    } else if (insight.trend === 'down') {
      // ä¸‹é™è¶‹åŠ¿ - çº¢è‰²ç®­å¤´
      icon = 'bi-arrow-down-circle-fill';
      color = 'text-danger';
      bgColor = 'bg-danger';
    } else if (insight.trend === 'volatile') {
      // å‰§çƒˆæ³¢åŠ¨ - é»„è‰²æŠ˜çº¿
      icon = 'bi-graph-up';
      color = 'text-warning';
      bgColor = 'bg-warning';
    } else {
      // ç¨³å®š - ç°è‰²åœ†ç‚¹
      icon = 'bi-circle-fill';
      color = 'text-secondary';
      bgColor = 'bg-secondary';
    }
    
    html += `
      <li class="mb-3">
        <div class="d-flex align-items-start">
          <div class="flex-shrink-0">
            <i class="bi ${icon} ${color} fs-5"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <h6 class="mb-1 fw-bold">${insight.metric}</h6>
            <p class="mb-0 text-muted small">${insight.description}</p>
          </div>
        </div>
      </li>
    `;
  });
  
  html += '</ul>';
  container.innerHTML = html;
}

// åŠ è½½AIè¡ŒåŠ¨å»ºè®®
async function loadAISuggestions() {
  try {
    console.log('ğŸ¤– å¼€å§‹åŠ è½½AIè¡ŒåŠ¨å»ºè®®');
    
    const token = localStorage.getItem('authToken');
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const params = new URLSearchParams();
    
    // æ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°
    let timeRange = currentTimeRange;
    const customStart = document.getElementById('customStartDate').value;
    const customEnd = document.getElementById('customEndDate').value;
    
    if (customStart && customEnd) {
      timeRange = `${customStart}|${customEnd}`;
    }
    params.append('time_range', timeRange);
    
    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ç­›é€‰å‚æ•°
    if (currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin')) {
      const scopeElement = document.getElementById('viewScope');
      const scope = scopeElement ? scopeElement.value : 'all';
      
      if (scope === 'department') {
        const deptId = document.getElementById('filterDepartment')?.value;
        if (deptId) {
          params.append('department_id', deptId);
        }
      } else if (scope === 'user') {
        const userId = document.getElementById('filterUser')?.value;
        if (userId) {
          params.append('user_id', userId);
        }
      }
    }
    
    const response = await fetch(`/api/statistics/ai-suggestions?${params.toString()}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.message || 'AIå»ºè®®åŠ è½½å¤±è´¥');
    }
    
    const suggestions = data.suggestions || [];
    
    console.log('âœ… AIå»ºè®®åŠ è½½æˆåŠŸï¼Œå…±', suggestions.length, 'æ¡');
    
    renderAISuggestions(suggestions);
    
  } catch (error) {
    console.error('åŠ è½½AIå»ºè®®å¤±è´¥:', error);
    const container = document.getElementById('aiSuggestionsContainer');
    container.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> 
        AIå»ºè®®åŠ è½½å¤±è´¥ï¼š${error.message}
        <button class="btn btn-sm btn-outline-warning ms-2" onclick="loadAISuggestions()">é‡è¯•</button>
      </div>
    `;
  }
}

// æ¸²æŸ“AIå»ºè®®
function renderAISuggestions(suggestions) {
  const container = document.getElementById('aiSuggestionsContainer');
  
  if (suggestions.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle"></i> AIæš‚æ— å»ºè®®ï¼Œæ•°æ®åˆ†æä¸­...
      </div>
    `;
    return;
  }
  
  let html = '<div class="list-group list-group-flush">';
  
  suggestions.forEach((suggestion, index) => {
    const priorityClass = {
      'high': 'danger',
      'medium': 'warning',
      'low': 'info'
    }[suggestion.priority] || 'secondary';
    
    const priorityLabel = {
      'high': 'é«˜',
      'medium': 'ä¸­',
      'low': 'ä½'
    }[suggestion.priority] || 'æ™®é€š';
    
    const icon = {
      'high': 'exclamation-triangle-fill',
      'medium': 'exclamation-circle-fill',
      'low': 'info-circle-fill'
    }[suggestion.priority] || 'circle-fill';
    
    html += `
      <div class="list-group-item list-group-item-action">
        <div class="d-flex w-100 justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-2">
              <i class="bi bi-${icon} text-${priorityClass}"></i>
              ${suggestion.action}
            </h6>
          </div>
          <span class="badge bg-${priorityClass} ms-2">${priorityLabel}ä¼˜å…ˆçº§</span>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}
</script>

