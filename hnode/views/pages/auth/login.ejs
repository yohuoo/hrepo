<div class="auth-card">
  <div class="logo">
    <i class="bi bi-diagram-3 fs-1 text-primary"></i>
    <h2>CRMç³»ç»Ÿ</h2>
    <p class="text-muted">å®¢æˆ·å…³ç³»ç®¡ç†å¹³å°</p>
  </div>
  
  <form id="loginForm">
    <div class="mb-3">
      <label for="username" class="form-label">ç”¨æˆ·åæˆ–é‚®ç®±</label>
      <input type="text" class="form-control" id="username" name="username" required>
    </div>
    
    <div class="mb-3">
      <label for="password" class="form-label">å¯†ç </label>
      <input type="password" class="form-control" id="password" name="password" required>
    </div>
    
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="rememberMe">
      <label class="form-check-label" for="rememberMe">
        è®°ä½æˆ‘
      </label>
    </div>
    
    <button type="submit" class="btn btn-primary w-100 mb-3">
      <i class="bi bi-box-arrow-in-right"></i> ç™»å½•
    </button>
    
    <div class="text-center">
      <span class="text-muted">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
      <a href="/register">ç«‹å³æ³¨å†Œ</a>
    </div>
  </form>
</div>

<script>
// ä½¿ç”¨åŸç”ŸJavaScriptï¼Œä¸ä¾èµ–jQuery
document.addEventListener('DOMContentLoaded', function() {
  console.log('âœ… ç™»å½•é¡µé¢JavaScriptå·²åŠ è½½');
  
  const loginForm = document.getElementById('loginForm');
  
  if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log('âœ… è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      console.log('ğŸ“ ç”¨æˆ·å:', username);
      console.log('ğŸ“ å¯†ç é•¿åº¦:', password.length);
      
      if (!username || !password) {
        showWarning('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
        return;
      }
      
      try {
        console.log('ğŸ”„ å¼€å§‹è°ƒç”¨ç™»å½•API...');
        
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });
        
        const data = await response.json();
        console.log('ğŸ“¥ æœåŠ¡å™¨å“åº”:', data);
        
        if (data.success) {
          console.log('âœ… ç™»å½•æˆåŠŸï¼');
          localStorage.setItem('authToken', data.token);
          localStorage.setItem('userInfo', JSON.stringify(data.user));
          document.cookie = `authToken=${data.token}; path=/; max-age=${7*24*60*60}`;
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®æ”¹å¯†ç 
          if (data.requires_password_change) {
            showWarning('é¦–æ¬¡ç™»å½•éœ€è¦ä¿®æ”¹å¯†ç ');
            setTimeout(() => {
              window.location.href = '/change-password';
            }, 1000);
            return;
          }
          
          showSuccess('ç™»å½•æˆåŠŸï¼å³å°†è·³è½¬åˆ°æ§åˆ¶å°...');
          
          setTimeout(() => {
            console.log('ğŸ”„ è·³è½¬åˆ° /dashboard');
            window.location.href = '/dashboard';
          }, 500);
        } else {
          console.error('âŒ ç™»å½•å¤±è´¥:', data.message);
          showError('ç™»å½•å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('âŒ è¯·æ±‚é”™è¯¯:', error);
        showError('ç™»å½•å¤±è´¥: ' + error.message);
      }
    });
    
    console.log('âœ… è¡¨å•äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
  } else {
    console.error('âŒ æ‰¾ä¸åˆ°ç™»å½•è¡¨å•');
  }
});
</script>
