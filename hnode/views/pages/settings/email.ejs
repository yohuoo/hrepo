<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item"><a href="/settings">è®¾ç½®</a></li>
        <li class="breadcrumb-item active">é‚®ç®±é…ç½®</li>
      </ol>
    </nav>
    <h1 class="page-title">é‚®ç®±é…ç½®</h1>
  </div>
</div>

<!-- é‚®ç®±é…ç½®å¡ç‰‡ -->
<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">å·²é…ç½®é‚®ç®±</h5>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmailModal">
          <i class="bi bi-plus-lg"></i> æ·»åŠ é‚®ç®±
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>é‚®ç®±åœ°å€</th>
                <th>çŠ¶æ€</th>
                <th>é»˜è®¤é‚®ç®±</th>
                <th width="150">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="emailTableBody">
              <tr>
                <td colspan="4" class="text-center p-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- é…ç½®è¯´æ˜ -->
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">é…ç½®è¯´æ˜</h6>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <h6><i class="bi bi-info-circle"></i> å¦‚ä½•é…ç½®é‚®ç®±ï¼Ÿ</h6>
          <ol class="mb-0">
            <li>ç‚¹å‡»"æ·»åŠ é‚®ç®±"æŒ‰é’®</li>
            <li>å¡«å†™é‚®ç®±åœ°å€å’Œå¯†ç </li>
            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹SMTPè®¾ç½®</li>
            <li>æµ‹è¯•è¿æ¥æˆåŠŸåå³å¯ä½¿ç”¨</li>
          </ol>
        </div>
        
        <div class="alert alert-warning">
          <h6><i class="bi bi-exclamation-triangle"></i> æ³¨æ„äº‹é¡¹</h6>
          <ul class="mb-0">
            <li>å»ºè®®ä½¿ç”¨ä¸“ç”¨é‚®ç®±è´¦å·</li>
            <li>ç¡®ä¿å¼€å¯SMTPæœåŠ¡</li>
            <li>å¯èƒ½éœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ·»åŠ é‚®ç®±æ¨¡æ€æ¡† -->
<div class="modal fade" id="addEmailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ·»åŠ é‚®ç®±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addEmailForm">
          <div class="mb-3">
            <label class="form-label">é‚®ç®±åœ°å€ *</label>
            <input type="email" class="form-control" name="email_address" placeholder="example@company.com" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">é‚®ç®±å¯†ç  *</label>
            <input type="password" class="form-control" name="password" placeholder="é‚®ç®±å¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç " required>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_default" id="isDefault">
              <label class="form-check-label" for="isDefault">
                è®¾ä¸ºé»˜è®¤é‚®ç®±
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="addEmail()">
          <i class="bi bi-check"></i> æ·»åŠ é‚®ç®±
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘é‚®ç®±æ¨¡æ€æ¡† -->
<div class="modal fade" id="editEmailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¼–è¾‘é‚®ç®±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editEmailForm">
          <input type="hidden" name="id" id="editEmailId">
          
          <div class="mb-3">
            <label class="form-label">é‚®ç®±åœ°å€ *</label>
            <input type="email" class="form-control" name="email_address" id="editEmailAddress" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">é‚®ç®±å¯†ç </label>
            <input type="password" class="form-control" name="password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_default" id="editIsDefault">
              <label class="form-check-label" for="editIsDefault">
                è®¾ä¸ºé»˜è®¤é‚®ç®±
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="updateEmail()">
          <i class="bi bi-check"></i> ä¿å­˜ä¿®æ”¹
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let emailBindings = [];

document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… é‚®ç®±é…ç½®é¡µé¢å·²åŠ è½½');
  await loadEmailBindings();
});

// åŠ è½½é‚®ç®±ç»‘å®šåˆ—è¡¨
async function loadEmailBindings() {
  try {
    console.log('ğŸ”„ åŠ è½½é‚®ç®±ç»‘å®šåˆ—è¡¨...');
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    const response = await fetch('/api/user-email-bindings/', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ é‚®ç®±ç»‘å®šæ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½é‚®ç®±é…ç½®å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    emailBindings = data.bindings || [];
    console.log('âœ… åŠ è½½äº†', emailBindings.length, 'ä¸ªé‚®ç®±é…ç½®');
    renderEmailTable();
  } catch (error) {
    console.error('âŒ åŠ è½½é‚®ç®±é…ç½®å¤±è´¥:', error);
    showError('åŠ è½½é‚®ç®±é…ç½®å¤±è´¥: ' + error.message);
  }
}

// æ¸²æŸ“é‚®ç®±è¡¨æ ¼
function renderEmailTable() {
  const tbody = document.getElementById('emailTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°é‚®ç®±è¡¨æ ¼');
    return;
  }
  
  console.log('ğŸ”„ æ¸²æŸ“é‚®ç®±è¡¨æ ¼ï¼Œå…±', emailBindings.length, 'æ¡');
  
  if (emailBindings.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-envelope"></i>
            <h5>æš‚æ— é‚®ç®±é…ç½®</h5>
            <p>æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªé‚®ç®±é…ç½®</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  let html = '';
  emailBindings.forEach(binding => {
    const statusBadge = getStatusBadge(binding.status);
    const defaultBadge = binding.is_default ? 
      '<span class="badge bg-success"><i class="bi bi-star-fill"></i> é»˜è®¤</span>' : 
      '<span class="badge bg-secondary">æ™®é€š</span>';

    html += `
      <tr class="clickable-row" onclick="editEmail(${binding.id})" style="cursor: pointer;">
        <td>
          <div class="d-flex align-items-center">
            <i class="bi bi-envelope text-primary me-2"></i>
            <span class="fw-bold">${binding.email_address}</span>
          </div>
        </td>
        <td>${statusBadge}</td>
        <td>${defaultBadge}</td>
        <td onclick="event.stopPropagation();">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="editEmail(${binding.id}); return false;">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </a></li>
              ${!binding.is_default ? `
                <li><a class="dropdown-item" href="#" onclick="setDefaultEmail(${binding.id}); return false;">
                  <i class="bi bi-star"></i> è®¾ä¸ºé»˜è®¤
                </a></li>
              ` : ''}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteEmail(${binding.id}); return false;">
                <i class="bi bi-trash"></i> åˆ é™¤
              </a></li>
            </ul>
          </div>
        </td>
      </tr>
    `;
  });

  tbody.innerHTML = html;
  console.log('âœ… é‚®ç®±è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
}

// è·å–çŠ¶æ€å¾½ç« 
function getStatusBadge(status) {
  const badges = {
    'active': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> æ­£å¸¸</span>',
    'inactive': '<span class="badge bg-secondary"><i class="bi bi-pause-circle"></i> æœªæ¿€æ´»</span>',
    'error': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> é”™è¯¯</span>',
    'testing': '<span class="badge bg-warning"><i class="bi bi-clock"></i> æµ‹è¯•ä¸­</span>'
  };
  return badges[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
}

// æ·»åŠ é‚®ç®±
async function addEmail() {
  const formData = {
    email_address: document.querySelector('input[name="email_address"]').value,
    password: document.querySelector('input[name="password"]').value,
    is_default: document.getElementById('isDefault').checked
  };

  if (!formData.email_address || !formData.password) {
    showError('è¯·å¡«å†™é‚®ç®±åœ°å€å’Œå¯†ç ');
    return;
  }

  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/user-email-bindings/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('é‚®ç®±æ·»åŠ æˆåŠŸï¼');
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addEmailModal'));
      if (modal) {
        modal.hide();
      }
      
      document.getElementById('addEmailForm').reset();
      await loadEmailBindings();
    } else {
      showError('æ·»åŠ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ æ·»åŠ é‚®ç®±å¤±è´¥:', error);
    showError('æ·»åŠ å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æµ‹è¯•è¿æ¥åŠŸèƒ½å·²åˆ é™¤ï¼ˆä¸å†éœ€è¦SMTPé…ç½®ï¼‰

// ç¼–è¾‘é‚®ç®±
function editEmail(id) {
  console.log('âœ… ç¼–è¾‘é‚®ç®±:', id);
  
  const binding = emailBindings.find(b => b.id === id);
  if (!binding) {
    showError('æ‰¾ä¸åˆ°é‚®ç®±é…ç½®');
    return;
  }

  document.getElementById('editEmailId').value = binding.id;
  document.getElementById('editEmailAddress').value = binding.email_address;
  document.getElementById('editIsDefault').checked = binding.is_default || false;

  const modal = new bootstrap.Modal(document.getElementById('editEmailModal'));
  modal.show();
}

// æµ‹è¯•ç¼–è¾‘è¿æ¥åŠŸèƒ½å·²åˆ é™¤

// æ›´æ–°é‚®ç®±
async function updateEmail() {
  console.log('âœ… æ›´æ–°é‚®ç®±');
  
  const id = document.getElementById('editEmailId').value;
  const formData = {
    email_address: document.getElementById('editEmailAddress').value,
    is_default: document.getElementById('editIsDefault').checked
  };

  const password = document.querySelector('#editEmailModal input[name="password"]').value;
  if (password) {
    formData.password = password;
  }

  if (!formData.email_address) {
    showError('è¯·å¡«å†™é‚®ç®±åœ°å€');
    return;
  }

  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/user-email-bindings/${id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('é‚®ç®±æ›´æ–°æˆåŠŸï¼');
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('editEmailModal'));
      if (modal) {
        modal.hide();
      }
      
      await loadEmailBindings();
    } else {
      showError('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°é‚®ç®±å¤±è´¥:', error);
    showError('æ›´æ–°å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æµ‹è¯•é‚®ç®±è¿æ¥åŠŸèƒ½å·²åˆ é™¤

// è®¾ç½®é»˜è®¤é‚®ç®±
async function setDefaultEmail(id) {
  console.log('âœ… è®¾ç½®é»˜è®¤é‚®ç®±:', id);
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/user-email-bindings/${id}/set-default`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('é»˜è®¤é‚®ç®±è®¾ç½®æˆåŠŸï¼');
      await loadEmailBindings();
    } else {
      showError('è®¾ç½®å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ è®¾ç½®é»˜è®¤é‚®ç®±å¤±è´¥:', error);
    showError('è®¾ç½®å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// åˆ é™¤é‚®ç®±
async function deleteEmail(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé‚®ç®±é…ç½®å—ï¼Ÿ')) return;

  console.log('âœ… åˆ é™¤é‚®ç®±:', id);

  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/user-email-bindings/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('é‚®ç®±åˆ é™¤æˆåŠŸï¼');
      await loadEmailBindings();
    } else {
      showError('åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ åˆ é™¤é‚®ç®±å¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// å·¥å…·å‡½æ•°
function showLoading() {
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
}

function hideLoading() {
  // éšè—åŠ è½½çŠ¶æ€
}

function showToast(message, type) {
  console.log(`${type}: ${message}`);
}
</script>
