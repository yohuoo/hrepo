<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item"><a href="/settings/users">ç³»ç»Ÿè®¾ç½®</a></li>
        <li class="breadcrumb-item active">é¡µé¢æƒé™ç®¡ç†</li>
      </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="page-title">
          <i class="bi bi-shield-lock"></i> é¡µé¢æƒé™ç®¡ç†
        </h1>
        <p class="page-subtitle text-muted">é…ç½®éƒ¨é—¨å’Œç”¨æˆ·çš„é¡µé¢è®¿é—®æƒé™</p>
      </div>
      <button class="btn btn-outline-secondary" onclick="showAuditLogs()">
        <i class="bi bi-clock-history"></i> ä¿®æ”¹æ—¥å¿—
      </button>
    </div>
  </div>
</div>

<!-- é¡¶éƒ¨æ“ä½œæ  -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">æƒé™å¯¹è±¡</label>
        <div class="btn-group w-100" role="group">
          <input type="radio" class="btn-check" name="targetType" id="btnDepartment" value="department" checked>
          <label class="btn btn-outline-primary" for="btnDepartment" onclick="switchTargetType('department')">
            <i class="bi bi-building"></i> æŒ‰éƒ¨é—¨
          </label>
          
          <input type="radio" class="btn-check" name="targetType" id="btnUser" value="user">
          <label class="btn btn-outline-primary" for="btnUser" onclick="switchTargetType('user')">
            <i class="bi bi-person"></i> æŒ‰ç”¨æˆ·
          </label>
        </div>
      </div>
      <div class="col-md-9">
        <label class="form-label">æœç´¢</label>
        <input type="text" class="form-control" id="searchInput" 
               placeholder="æœç´¢éƒ¨é—¨åç§°æˆ–ç”¨æˆ·å/é‚®ç®±..." 
               oninput="filterTargetList()">
      </div>
    </div>
  </div>
</div>

<!-- ä¸»è¦å†…å®¹åŒº -->
<div class="row">
  <!-- å·¦ä¾§ï¼šéƒ¨é—¨/ç”¨æˆ·åˆ—è¡¨ -->
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-white border-bottom">
        <h6 class="mb-0" id="listTitle">
          <i class="bi bi-building"></i> éƒ¨é—¨åˆ—è¡¨
        </h6>
      </div>
      <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
        <div class="list-group list-group-flush" id="targetList">
          <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å³ä¾§ï¼šæƒé™é…ç½®æ ‘ -->
  <div class="col-md-8">
    <div class="card">
      <div class="card-header bg-white border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">
              <i class="bi bi-diagram-3"></i> æƒé™é…ç½®
              <span class="badge bg-secondary ms-2" id="currentTargetBadge">è¯·é€‰æ‹©</span>
            </h6>
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-success" id="selectAllBtn" onclick="selectAllPermissions()" disabled>
              <i class="bi bi-check-all"></i> å…¨é€‰
            </button>
            <button class="btn btn-outline-warning" id="clearAllBtn" onclick="clearAllPermissions()" disabled>
              <i class="bi bi-x-lg"></i> æ¸…é™¤
            </button>
            <button class="btn btn-primary" id="savePermissionsBtn" onclick="savePermissions()" disabled>
              <i class="bi bi-save"></i> ä¿å­˜
            </button>
          </div>
        </div>
      </div>
      <div class="card-body" id="permissionTreeContainer" style="max-height: 600px; overflow-y: auto;">
        <div class="text-muted text-center p-5">
          <i class="bi bi-hand-index" style="font-size: 3rem; opacity: 0.3;"></i>
          <p class="mt-3">è¯·å…ˆä»å·¦ä¾§é€‰æ‹©éƒ¨é—¨æˆ–ç”¨æˆ·</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å®¡è®¡æ—¥å¿—æ¨¡æ€æ¡† -->
<div class="modal fade" id="auditLogsModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-clock-history"></i> æƒé™ä¿®æ”¹æ—¥å¿—
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>æ—¶é—´</th>
                <th>æ“ä½œäºº</th>
                <th>æ“ä½œç±»å‹</th>
                <th>ç›®æ ‡</th>
                <th>å˜æ›´å†…å®¹</th>
              </tr>
            </thead>
            <tbody id="auditLogsBody">
              <tr>
                <td colspan="5" class="text-center p-5">
                  <div class="spinner-border text-primary"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<style>
.permission-tree {
  font-size: 14px;
}

/* ä¸€çº§èœå•å¡ç‰‡ */
.permission-group {
  margin-bottom: 1.25rem;
  border: none;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  background: #ffffff;
}

/* ä¸€çº§èœå•å¤´éƒ¨ */
.permission-group-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 1rem 1.25rem;
  margin-bottom: 0;
  border-bottom: 2px solid #dee2e6;
}

.permission-group-body {
  padding: 0;
}

.permission-group-header label {
  cursor: pointer;
  user-select: none;
  margin-bottom: 0;
  display: flex;
  align-items: center;
  font-weight: 600;
  font-size: 15px;
  color: #212529;
}

.permission-group-header input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  margin-right: 12px;
  flex-shrink: 0;
}

/* äºŒçº§é¡µé¢ - ç¼©è¿›2ä¸ªå­—ç¬¦ */
.permission-tree .permission-subitem {
  background: #fafbfc !important;
  margin: 0 !important;
  padding-top: 0.75rem !important;
  padding-bottom: 0.75rem !important;
  padding-right: 1.25rem !important;
  padding-left: 3em !important;  /* ä½¿ç”¨emå•ä½ï¼Œ3ä¸ªå­—ç¬¦å®½åº¦ */
  border-bottom: 1px solid #f0f0f0 !important;
}

.permission-tree .permission-subitem:last-child {
  border-bottom: none !important;
}

.permission-tree .permission-subitem label {
  cursor: pointer;
  user-select: none;
  margin-bottom: 0;
  display: flex;
  align-items: center;
  font-size: 14px;
  color: #495057;
}

.permission-tree .permission-subitem input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  margin-right: 10px;
  flex-shrink: 0;
}

/* ä¸‰çº§æ“ä½œ - ç¼©è¿›4ä¸ªå­—ç¬¦ */
.permission-tree .permission-action {
  background: #ffffff !important;
  margin: 0 !important;
  padding-top: 0.5rem !important;
  padding-bottom: 0.5rem !important;
  padding-right: 1.25rem !important;
  padding-left: 6em !important;  /* ä½¿ç”¨emå•ä½ï¼Œ6ä¸ªå­—ç¬¦å®½åº¦ */
  border-bottom: 1px solid #f8f9fa !important;
}

.permission-tree .permission-action:last-child {
  border-bottom: none !important;
}

.permission-tree .permission-action label {
  cursor: pointer;
  user-select: none;
  margin-bottom: 0;
  display: flex;
  align-items: center;
  font-size: 13px;
  color: #6c757d;
}

.permission-tree .permission-action input[type="checkbox"] {
  width: 16px;
  height: 16px;
  cursor: pointer;
  margin-right: 8px;
  flex-shrink: 0;
}

/* å·¦ä¾§åˆ—è¡¨ */
.target-list-item {
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
}

.target-list-item:hover {
  background-color: #f8f9fa;
  border-left-color: #adb5bd;
}

.target-list-item.active {
  background-color: #e7f1ff;
  border-left-color: #0d6efd;
  font-weight: 500;
}

/* å¾½ç«  */
.badge-system {
  font-size: 10px;
  vertical-align: middle;
}

/* checkboxç¾åŒ– */
input[type="checkbox"]:indeterminate {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

/* ç¦ç”¨çŠ¶æ€ */
input[type="checkbox"]:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

label:has(input[type="checkbox"]:disabled) {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

<script>
let currentTargetType = 'department';
let currentTargetId = null;
let currentTargetName = '';
let allDepartments = [];
let allUsers = [];
let pageTree = [];
let currentPermissions = [];

document.addEventListener('DOMContentLoaded', async function() {
  console.log('ğŸš€ é¡µé¢æƒé™ç®¡ç†é¡µé¢åŠ è½½');
  
  // åŠ è½½åˆå§‹æ•°æ®
  await Promise.all([
    loadDepartments(),
    loadUsers(),
    loadPageTree()
  ]);
  
  // æ˜¾ç¤ºéƒ¨é—¨åˆ—è¡¨
  renderTargetList();
});

// åŠ è½½éƒ¨é—¨åˆ—è¡¨
async function loadDepartments() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/departments/tree', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    allDepartments = data.departments || [];
    console.log('ğŸ“ éƒ¨é—¨æ•°é‡:', allDepartments.length);
  } catch (error) {
    console.error('åŠ è½½éƒ¨é—¨å¤±è´¥:', error);
  }
}

// åŠ è½½ç”¨æˆ·åˆ—è¡¨
async function loadUsers() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/users?pageSize=1000', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    allUsers = data.users || [];
    console.log('ğŸ‘¥ ç”¨æˆ·æ•°é‡:', allUsers.length);
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
  }
}

// åŠ è½½é¡µé¢æ ‘
async function loadPageTree() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/page-permissions/pages/tree', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    if (data.success) {
      pageTree = data.tree || [];
      console.log('ğŸŒ² é¡µé¢æ ‘åŠ è½½æˆåŠŸï¼Œä¸€çº§èœå•æ•°:', pageTree.length);
    }
  } catch (error) {
    console.error('åŠ è½½é¡µé¢æ ‘å¤±è´¥:', error);
  }
}

// åˆ‡æ¢ç›®æ ‡ç±»å‹
function switchTargetType(type) {
  currentTargetType = type;
  currentTargetId = null;
  currentTargetName = '';
  
  // æ›´æ–°åˆ—è¡¨æ ‡é¢˜
  document.getElementById('listTitle').innerHTML = type === 'department' 
    ? '<i class="bi bi-building"></i> éƒ¨é—¨åˆ—è¡¨'
    : '<i class="bi bi-person"></i> ç”¨æˆ·åˆ—è¡¨';
  
  // æ›´æ–°æœç´¢å ä½ç¬¦
  document.getElementById('searchInput').placeholder = type === 'department'
    ? 'æœç´¢éƒ¨é—¨åç§°...'
    : 'æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±...';
  
  // æ¸…ç©ºæœç´¢
  document.getElementById('searchInput').value = '';
  
  // æ¸²æŸ“åˆ—è¡¨
  renderTargetList();
  
  // æ¸…ç©ºæƒé™æ ‘
  showEmptyPermissionTree();
}

// æ‰å¹³åŒ–éƒ¨é—¨æ ‘
function flattenDepartments(departments, level = 0) {
  let result = [];
  departments.forEach(dept => {
    result.push({ ...dept, level });
    if (dept.children && dept.children.length > 0) {
      result = result.concat(flattenDepartments(dept.children, level + 1));
    }
  });
  return result;
}

// æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
function renderTargetList() {
  const listContainer = document.getElementById('targetList');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  
  if (currentTargetType === 'department') {
    const flatDepts = flattenDepartments(allDepartments);
    const filtered = flatDepts.filter(dept => 
      dept.name.toLowerCase().includes(searchTerm)
    );
    
    if (filtered.length === 0) {
      listContainer.innerHTML = '<div class="text-center p-4 text-muted">æš‚æ— æ•°æ®</div>';
      return;
    }
    
    let html = '';
    filtered.forEach(dept => {
      const indent = 'ã€€'.repeat(dept.level);
      html += `
        <a href="javascript:void(0)" 
           class="list-group-item list-group-item-action target-list-item" 
           onclick="selectTarget('department', ${dept.id}, '${dept.name.replace(/'/g, "\\'")}')">
          <div class="d-flex justify-content-between align-items-center">
            <span>
              ${indent}
              <i class="bi bi-building text-primary me-2"></i>
              <strong>${dept.name}</strong>
            </span>
            ${dept.manager_name ? `<small class="text-muted">è´Ÿè´£äºº: ${dept.manager_name}</small>` : ''}
          </div>
        </a>
      `;
    });
    listContainer.innerHTML = html;
  } else {
    const filtered = allUsers.filter(user => 
      user.username.toLowerCase().includes(searchTerm) ||
      (user.email && user.email.toLowerCase().includes(searchTerm))
    );
    
    if (filtered.length === 0) {
      listContainer.innerHTML = '<div class="text-center p-4 text-muted">æš‚æ— æ•°æ®</div>';
      return;
    }
    
    let html = '';
    filtered.forEach(user => {
      const roleText = user.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 
                      user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
      const roleClass = user.role === 'super_admin' ? 'danger' : 
                       user.role === 'admin' ? 'warning' : 'secondary';
      
      html += `
        <a href="javascript:void(0)" 
           class="list-group-item list-group-item-action target-list-item"
           onclick="selectTarget('user', ${user.id}, '${user.username.replace(/'/g, "\\'")}')">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-person-circle text-primary me-2"></i>
              <strong>${user.username}</strong>
              <span class="badge bg-${roleClass} ms-2">${roleText}</span>
            </div>
            <small class="text-muted">${user.email}</small>
          </div>
        </a>
      `;
    });
    listContainer.innerHTML = html;
  }
}

// ç­›é€‰ç›®æ ‡åˆ—è¡¨
function filterTargetList() {
  renderTargetList();
}

// é€‰æ‹©ç›®æ ‡
async function selectTarget(type, id, name) {
  currentTargetType = type;
  currentTargetId = id;
  currentTargetName = name;
  
  console.log('ğŸ“ é€‰æ‹©ç›®æ ‡:', { type, id, name });
  
  // æ›´æ–°é€‰ä¸­çŠ¶æ€
  document.querySelectorAll('.target-list-item').forEach(item => {
    item.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // æ›´æ–°å¾½ç« 
  document.getElementById('currentTargetBadge').textContent = name;
  
  // å¯ç”¨æŒ‰é’®
  document.getElementById('savePermissionsBtn').disabled = false;
  document.getElementById('selectAllBtn').disabled = false;
  document.getElementById('clearAllBtn').disabled = false;
  
  // åŠ è½½è¯¥ç›®æ ‡çš„æƒé™
  await loadTargetPermissions(type, id);
  
  // æ¸²æŸ“æƒé™æ ‘
  renderPermissionTree();
}

// åŠ è½½ç›®æ ‡çš„æƒé™é…ç½®
async function loadTargetPermissions(type, id) {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch(`/api/page-permissions/target/${type}/${id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    if (data.success) {
      currentPermissions = data.permissions || [];
      console.log('âœ… æƒé™æ•°é‡:', currentPermissions.length);
    }
  } catch (error) {
    console.error('åŠ è½½æƒé™å¤±è´¥:', error);
    currentPermissions = [];
  }
}

// æ˜¾ç¤ºç©ºçš„æƒé™æ ‘
function showEmptyPermissionTree() {
  const container = document.getElementById('permissionTreeContainer');
  container.innerHTML = `
    <div class="text-muted text-center p-5">
      <i class="bi bi-hand-index" style="font-size: 3rem; opacity: 0.3;"></i>
      <p class="mt-3">è¯·å…ˆä»å·¦ä¾§é€‰æ‹©éƒ¨é—¨æˆ–ç”¨æˆ·</p>
    </div>
  `;
  document.getElementById('currentTargetBadge').textContent = 'è¯·é€‰æ‹©';
  document.getElementById('savePermissionsBtn').disabled = true;
  document.getElementById('selectAllBtn').disabled = true;
  document.getElementById('clearAllBtn').disabled = true;
}

// å…¨é€‰æƒé™
function selectAllPermissions() {
  if (!currentTargetId) return;
  
  console.log('âœ… å…¨é€‰æ‰€æœ‰æƒé™');
  
  // è·å–æ‰€æœ‰éç³»ç»Ÿé¡µé¢çš„code
  const allCodes = [];
  
  pageTree.forEach(menu => {
    if (!menu.is_system) {
      allCodes.push(menu.code);
      
      if (menu.children) {
        menu.children.forEach(page => {
          if (!page.is_system) {
            allCodes.push(page.code);
            
            if (page.children) {
              page.children.forEach(action => {
                if (!action.is_system) {
                  allCodes.push(action.code);
                }
              });
            }
          }
        });
      }
    }
  });
  
  currentPermissions = allCodes;
  console.log('  å·²é€‰æ‹©æƒé™æ•°é‡:', currentPermissions.length);
  
  // é‡æ–°æ¸²æŸ“
  renderPermissionTree();
  
  showSuccess('å·²å…¨é€‰æ‰€æœ‰æƒé™');
}

// æ¸…é™¤æ‰€æœ‰æƒé™
function clearAllPermissions() {
  if (!currentTargetId) return;
  
  console.log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æƒé™');
  
  currentPermissions = [];
  
  // é‡æ–°æ¸²æŸ“
  renderPermissionTree();
  
  showWarning('å·²æ¸…é™¤æ‰€æœ‰æƒé™');
}

// æ¸²æŸ“æƒé™æ ‘
function renderPermissionTree() {
  const container = document.getElementById('permissionTreeContainer');
  
  if (!currentTargetId) {
    showEmptyPermissionTree();
    return;
  }
  
  let html = '<div class="permission-tree">';
  
  // éå†ä¸€çº§èœå•
  pageTree.forEach((menu, menuIdx) => {
    // è·³è¿‡ç³»ç»Ÿèœå•ï¼ˆå®é™…ä¸Šç›®å‰æ²¡æœ‰ç³»ç»Ÿä¸€çº§èœå•ï¼‰
    if (menu.is_system) return;
    
    const menuHasPermission = currentPermissions.includes(menu.code);
    
    html += `
      <div class="permission-group">
        <div class="permission-group-header">
          <label>
            <input type="checkbox" 
                   id="menu-${menu.code}" 
                   value="${menu.code}"
                   ${menuHasPermission ? 'checked' : ''}
                   onchange="toggleMenu('${menu.code}')">
            <i class="${menu.icon} me-2" style="font-size: 18px; color: #0d6efd;"></i>
            <span class="flex-grow-1">${menu.name}</span>
          </label>
        </div>
        <div class="permission-group-body">
    `;
    
    // éå†äºŒçº§é¡µé¢
    if (menu.children && menu.children.length > 0) {
      menu.children.forEach((page, pageIdx) => {
        // è·³è¿‡ç³»ç»Ÿé¡µé¢ï¼ˆå¦‚"é¡µé¢æƒé™"ï¼‰
        if (page.is_system) return;
        
        const pageHasPermission = currentPermissions.includes(page.code);
        
        html += `
          <div class="permission-subitem" style="padding-left: 3em !important; background: #fafbfc; padding-top: 0.75rem; padding-bottom: 0.75rem; padding-right: 1.25rem; border-bottom: 1px solid #f0f0f0;">
            <label style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
              <input type="checkbox" 
                     id="page-${page.code}" 
                     value="${page.code}"
                     data-parent="${menu.code}"
                     ${pageHasPermission ? 'checked' : ''}
                     onchange="togglePage('${page.code}', '${menu.code}')"
                     style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
              <i class="bi bi-file-text me-2" style="font-size: 14px; color: #6c757d;"></i>
              <span class="flex-grow-1" style="font-size: 14px; color: #495057;">${page.name}</span>
            </label>
        `;
        
        // éå†æ“ä½œï¼ˆä¸‰çº§ï¼‰
        if (page.children && page.children.length > 0) {
          page.children.forEach((action, actionIdx) => {
            // è·³è¿‡ç³»ç»Ÿæ“ä½œ
            if (action.is_system) return;
            
            const actionHasPermission = currentPermissions.includes(action.code);
            
            html += `
              <div class="permission-action" style="padding-left: 6em !important; background: #ffffff; padding-top: 0.5rem; padding-bottom: 0.5rem; padding-right: 1.25rem; border-bottom: 1px solid #f8f9fa;">
                <label style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                  <input type="checkbox" 
                         id="action-${action.code}" 
                         value="${action.code}"
                         data-parent="${page.code}"
                         data-grandparent="${menu.code}"
                         ${actionHasPermission ? 'checked' : ''}
                         onchange="toggleAction('${action.code}', '${page.code}', '${menu.code}')"
                         style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;">
                  <i class="bi bi-lightning me-2" style="font-size: 12px; color: #adb5bd;"></i>
                  <span style="font-size: 13px; color: #6c757d;">${action.name}</span>
                </label>
              </div>
            `;
          });
        }
        
        html += `</div>`;  // å…³é—­ permission-subitem
      });
    }
    
    html += `
        </div>
      </div>
    `;  // å…³é—­ permission-group-body å’Œ permission-group
  });
  
  html += '</div>';
  container.innerHTML = html;
  
  // æ›´æ–°åŠé€‰çŠ¶æ€
  updateIndeterminateStates();
}

// åˆ‡æ¢ä¸€çº§èœå•
function toggleMenu(menuCode) {
  const checkbox = document.getElementById(`menu-${menuCode}`);
  const isChecked = checkbox.checked;
  
  // è·å–è¯¥èœå•ä¸‹çš„æ‰€æœ‰é¡µé¢å’Œæ“ä½œ
  const menu = pageTree.find(m => m.code === menuCode);
  if (!menu || menu.is_system) return;
  
  const codes = [menuCode];
  
  if (menu.children) {
    menu.children.forEach(page => {
      if (!page.is_system) {
        codes.push(page.code);
        if (page.children) {
          page.children.forEach(action => {
            if (!action.is_system) {
              codes.push(action.code);
            }
          });
        }
      }
    });
  }
  
  // æ›´æ–°æƒé™æ•°ç»„
  if (isChecked) {
    codes.forEach(code => {
      if (!currentPermissions.includes(code)) {
        currentPermissions.push(code);
      }
    });
  } else {
    currentPermissions = currentPermissions.filter(code => !codes.includes(code));
  }
  
  // é‡æ–°æ¸²æŸ“
  renderPermissionTree();
}

// åˆ‡æ¢äºŒçº§é¡µé¢
function togglePage(pageCode, menuCode) {
  const checkbox = document.getElementById(`page-${pageCode}`);
  const isChecked = checkbox.checked;
  
  const menu = pageTree.find(m => m.code === menuCode);
  const page = menu?.children.find(p => p.code === pageCode);
  
  if (!page || page.is_system) return;
  
  const codes = [pageCode];
  
  if (page.children) {
    page.children.forEach(action => {
      if (!action.is_system) {
        codes.push(action.code);
      }
    });
  }
  
  // æ›´æ–°æƒé™
  if (isChecked) {
    codes.forEach(code => {
      if (!currentPermissions.includes(code)) {
        currentPermissions.push(code);
      }
    });
  } else {
    currentPermissions = currentPermissions.filter(code => !codes.includes(code));
  }
  
  // é‡æ–°æ¸²æŸ“
  renderPermissionTree();
}

// åˆ‡æ¢æ“ä½œ
function toggleAction(actionCode, pageCode, menuCode) {
  const checkbox = document.getElementById(`action-${actionCode}`);
  const isChecked = checkbox.checked;
  
  if (isChecked) {
    if (!currentPermissions.includes(actionCode)) {
      currentPermissions.push(actionCode);
    }
  } else {
    currentPermissions = currentPermissions.filter(code => code !== actionCode);
  }
  
  // é‡æ–°æ¸²æŸ“
  renderPermissionTree();
}

// æ›´æ–°åŠé€‰çŠ¶æ€
function updateIndeterminateStates() {
  pageTree.forEach(menu => {
    const menuCheckbox = document.getElementById(`menu-${menu.code}`);
    if (!menuCheckbox) return;
    
    // æ£€æŸ¥å­é¡µé¢çŠ¶æ€
    if (menu.children && menu.children.length > 0) {
      const nonSystemChildren = menu.children.filter(p => !p.is_system);
      if (nonSystemChildren.length === 0) return;
      
      const checkedCount = nonSystemChildren.filter(p => 
        currentPermissions.includes(p.code)
      ).length;
      
      if (checkedCount === 0) {
        menuCheckbox.checked = false;
        menuCheckbox.indeterminate = false;
      } else if (checkedCount === nonSystemChildren.length) {
        menuCheckbox.checked = true;
        menuCheckbox.indeterminate = false;
      } else {
        menuCheckbox.checked = false;
        menuCheckbox.indeterminate = true;
      }
    }
    
    // æ£€æŸ¥äºŒçº§é¡µé¢çš„åŠé€‰çŠ¶æ€
    if (menu.children) {
      menu.children.forEach(page => {
        const pageCheckbox = document.getElementById(`page-${page.code}`);
        if (!pageCheckbox || page.is_system) return;
        
        if (page.children && page.children.length > 0) {
          const nonSystemActions = page.children.filter(a => !a.is_system);
          if (nonSystemActions.length === 0) return;
          
          const checkedCount = nonSystemActions.filter(a => 
            currentPermissions.includes(a.code)
          ).length;
          
          if (checkedCount === 0) {
            pageCheckbox.checked = false;
            pageCheckbox.indeterminate = false;
          } else if (checkedCount === nonSystemActions.length) {
            pageCheckbox.checked = true;
            pageCheckbox.indeterminate = false;
          } else {
            pageCheckbox.checked = false;
            pageCheckbox.indeterminate = true;
          }
        }
      });
    }
  });
}

// ä¿å­˜æƒé™
async function savePermissions() {
  if (!currentTargetId) {
    showWarning('è¯·å…ˆé€‰æ‹©éƒ¨é—¨æˆ–ç”¨æˆ·');
    return;
  }
  
  console.log('ğŸ’¾ å¼€å§‹ä¿å­˜æƒé™:', {
    targetType: currentTargetType,
    targetId: currentTargetId,
    targetName: currentTargetName,
    permissionCount: currentPermissions.length,
    permissions: currentPermissions
  });
  
  try {
    const token = localStorage.getItem('authToken');
    const saveBtn = document.getElementById('savePermissionsBtn');
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';
    
    const requestBody = {
      permissions: currentPermissions
    };
    
    console.log('ğŸ“¤ å‘é€è¯·æ±‚:', requestBody);
    
    const response = await fetch(`/api/page-permissions/target/${currentTargetType}/${currentTargetId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status);
    const data = await response.json();
    console.log('ğŸ“¦ å“åº”æ•°æ®:', data);
    
    if (data.success) {
      showSuccess(`æƒé™ä¿å­˜æˆåŠŸï¼æ–°å¢${data.result.added.length}é¡¹ï¼Œç§»é™¤${data.result.removed.length}é¡¹`);
    } else {
      showError(data.message || 'ä¿å­˜å¤±è´¥');
    }
  } catch (error) {
    console.error('âŒ ä¿å­˜æƒé™å¤±è´¥:', error);
    showError('ä¿å­˜å¤±è´¥: ' + error.message);
  } finally {
    const saveBtn = document.getElementById('savePermissionsBtn');
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="bi bi-save"></i> ä¿å­˜æƒé™';
  }
}

// æ˜¾ç¤ºå®¡è®¡æ—¥å¿—
async function showAuditLogs() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/page-permissions/audit-logs?page=1&page_size=100', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('åŠ è½½æ—¥å¿—å¤±è´¥');
      return;
    }
    
    renderAuditLogs(data.logs || []);
    new bootstrap.Modal(document.getElementById('auditLogsModal')).show();
    
  } catch (error) {
    console.error('åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥:', error);
    showError('åŠ è½½æ—¥å¿—å¤±è´¥');
  }
}

// æ¸²æŸ“å®¡è®¡æ—¥å¿—
function renderAuditLogs(logs) {
  const tbody = document.getElementById('auditLogsBody');
  
  if (logs.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center p-5 text-muted">æš‚æ— ä¿®æ”¹æ—¥å¿—</td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  logs.forEach(log => {
    const added = log.changes?.added || [];
    const removed = log.changes?.removed || [];
    
    let changesHtml = '';
    if (added.length > 0) {
      changesHtml += `<div class="text-success"><i class="bi bi-plus-circle"></i> æ–°å¢: ${added.map(c => c.name).join(', ')}</div>`;
    }
    if (removed.length > 0) {
      changesHtml += `<div class="text-danger"><i class="bi bi-dash-circle"></i> ç§»é™¤: ${removed.map(c => c.name).join(', ')}</div>`;
    }
    if (!changesHtml) {
      changesHtml = '<span class="text-muted">æ— å˜æ›´</span>';
    }
    
    const targetTypeName = log.target_type === 'department' ? 'éƒ¨é—¨' : 'ç”¨æˆ·';
    
    html += `
      <tr>
        <td>${new Date(log.created_at).toLocaleString('zh-CN')}</td>
        <td>
          <i class="bi bi-person-circle text-primary me-1"></i>
          ${log.operator_name}
        </td>
        <td>
          <span class="badge bg-info">${log.action_type}</span>
        </td>
        <td>
          <i class="bi bi-${log.target_type === 'department' ? 'building' : 'person'} me-1"></i>
          ${targetTypeName}: ${log.target_name}
        </td>
        <td>${changesHtml}</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

// Toastæç¤º
function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>

