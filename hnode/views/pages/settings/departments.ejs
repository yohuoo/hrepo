<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item"><a href="/settings">ç³»ç»Ÿè®¾ç½®</a></li>
        <li class="breadcrumb-item active">éƒ¨é—¨ç®¡ç†</li>
      </ol>
    </nav>
    <h1 class="page-title">éƒ¨é—¨ç®¡ç†</h1>
    <p class="page-subtitle">ç®¡ç†å…¬å¸ç»„ç»‡æ¶æ„å’Œéƒ¨é—¨ä¿¡æ¯</p>
  </div>
</div>

<!-- æ“ä½œåŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">éƒ¨é—¨åˆ—è¡¨</h5>
      </div>
      <div>
        <button class="btn btn-primary" onclick="showAddDepartmentModal()">
          <i class="bi bi-plus-lg me-1"></i>æ·»åŠ éƒ¨é—¨
        </button>
      </div>
    </div>
  </div>
</div>

<!-- é¢åŒ…å±‘å¯¼èˆªï¼ˆæ˜¾ç¤ºå½“å‰æŸ¥çœ‹çš„éƒ¨é—¨è·¯å¾„ï¼‰ -->
<div class="card mb-3" id="breadcrumbCard" style="display: none;">
  <div class="card-body py-2">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0" id="departmentBreadcrumb">
        <li class="breadcrumb-item"><a href="#" onclick="loadDepartments(); return false;">å…¨éƒ¨éƒ¨é—¨</a></li>
      </ol>
    </nav>
  </div>
</div>

<!-- éƒ¨é—¨åˆ—è¡¨ -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 35%;">éƒ¨é—¨åç§°</th>
            <th style="width: 15%;">æˆå‘˜æ•°</th>
            <th style="width: 20%;">éƒ¨é—¨ä¸»ç®¡</th>
            <th style="width: 10%;">å­éƒ¨é—¨</th>
            <th style="width: 20%;" class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="departmentTableBody">
          <tr>
            <td colspan="5" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘éƒ¨é—¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="departmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="departmentModalTitle">æ·»åŠ éƒ¨é—¨</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="departmentForm">
          <input type="hidden" id="departmentId">
          <div class="mb-3">
            <label class="form-label">éƒ¨é—¨åç§° <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="departmentName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">ä¸Šçº§éƒ¨é—¨</label>
            <select class="form-select" id="parentDepartment">
              <option value="">æ— ï¼ˆé¡¶çº§éƒ¨é—¨ï¼‰</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">éƒ¨é—¨ä¸»ç®¡</label>
            <select class="form-select" id="departmentManager">
              <option value="">æœªè®¾ç½®</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">éƒ¨é—¨æè¿°</label>
            <textarea class="form-control" id="departmentDescription" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveDepartment()">
          <i class="bi bi-check-lg me-1"></i>ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<!-- éƒ¨é—¨æˆå‘˜æ¨¡æ€æ¡† -->
<div class="modal fade" id="departmentMembersModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-people-fill"></i> 
          <span id="membersDeptName"></span> - éƒ¨é—¨æˆå‘˜
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="membersListBody">
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<!-- å­éƒ¨é—¨åˆ—è¡¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="subDepartmentsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-diagram-3"></i> 
          <span id="subDeptParentName"></span> - å­éƒ¨é—¨
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 35%;">éƒ¨é—¨åç§°</th>
                <th style="width: 15%;">æˆå‘˜æ•°</th>
                <th style="width: 20%;">éƒ¨é—¨ä¸»ç®¡</th>
                <th style="width: 10%;">å­éƒ¨é—¨</th>
                <th style="width: 20%;" class="text-center">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="subDepartmentTableBody">
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<style>
/* éƒ¨é—¨åç§° */
.dept-name-cell {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: #212529;
}

.dept-name-cell i {
  font-size: 1.3rem;
  color: #667eea;
}

/* æˆå‘˜æ•°å¾½ç«  */
.member-count {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: rgba(40, 167, 69, 0.1);
  border-radius: 20px;
  color: #28a745;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.member-count:hover {
  background: rgba(40, 167, 69, 0.2);
  transform: scale(1.05);
}

.member-count i {
  font-size: 1.1rem;
}

/* ä¸»ç®¡ä¿¡æ¯ */
.manager-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.manager-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1rem;
}

.manager-name {
  color: #495057;
  font-weight: 500;
}

/* å­éƒ¨é—¨å¾½ç«  */
.sub-dept-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 20px;
  color: #667eea;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.sub-dept-badge:hover {
  background: rgba(102, 126, 234, 0.2);
  transform: scale(1.05);
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
}

.action-buttons .btn {
  padding: 6px 12px;
  border-radius: 8px;
}

/* æˆå‘˜å¤´åƒ */
.member-avatar-small {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.9rem;
  flex-shrink: 0;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  padding: 60px 20px;
  text-align: center;
}

.empty-state i {
  font-size: 4rem;
  color: #e9ecef;
  margin-bottom: 20px;
}

.empty-state h5 {
  color: #6c757d;
  margin-bottom: 10px;
}

.empty-state p {
  color: #adb5bd;
}

/* æ¨¡æ€æ¡†å±‚çº§æ§åˆ¶ - ç¡®ä¿æˆå‘˜æ¨¡æ€æ¡†åœ¨å­éƒ¨é—¨æ¨¡æ€æ¡†ä¹‹ä¸Š */
.modal.show {
  z-index: 1055;
}

.modal-backdrop {
  z-index: 1050;
}

.modal.show ~ .modal.show {
  z-index: 1065 !important;
}

.modal-backdrop.show ~ .modal-backdrop.show {
  z-index: 1060 !important;
}
</style>

<script>
console.log('ğŸ“„ departments.ejs script å¼€å§‹åŠ è½½');

let allDepartments = []; // æ‰€æœ‰éƒ¨é—¨æ•°æ®ï¼ˆæ ‘å½¢ï¼‰
let currentDepartments = []; // å½“å‰æ˜¾ç¤ºçš„éƒ¨é—¨åˆ—è¡¨
let allUsers = [];
let currentEditingDept = null;
let currentParentDept = null; // å½“å‰æŸ¥çœ‹çš„çˆ¶éƒ¨é—¨

// ==================== ç¦ç”¨æ¨¡æ€æ¡†é®ç½©å±‚ ====================
// ç›´æ¥ç¦ç”¨Bootstrapçš„backdropï¼Œé¿å…å±‚çº§å†²çªé—®é¢˜

let modalStack = []; // æ¨¡æ€æ¡†æ‰“å¼€é¡ºåºæ ˆ

// ç›‘å¬æ‰€æœ‰æ¨¡æ€æ¡†çš„æ˜¾ç¤ºäº‹ä»¶
document.addEventListener('show.bs.modal', function(e) {
  console.log('ğŸ“ æ¨¡æ€æ¡†å³å°†æ˜¾ç¤º:', e.target.id);
  
  // å…ˆç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒæ¨¡æ€æ¡†IDï¼ˆé¿å…é‡å¤ï¼‰
  const existingIndex = modalStack.indexOf(e.target.id);
  if (existingIndex > -1) {
    modalStack.splice(existingIndex, 1);
    console.log('ğŸ”„ ç§»é™¤é‡å¤çš„æ¨¡æ€æ¡†ID:', e.target.id);
  }
  
  // å°†å½“å‰æ¨¡æ€æ¡†æ·»åŠ åˆ°æ ˆé¡¶
  modalStack.push(e.target.id);
  console.log('ğŸ“š æ¨¡æ€æ¡†æ ˆ:', modalStack);
  
  // ç¦ç”¨backdrop
  e.target.setAttribute('data-bs-backdrop', 'false');
}, true);

// ç›‘å¬æ‰€æœ‰æ¨¡æ€æ¡†çš„æ˜¾ç¤ºå®Œæˆäº‹ä»¶
document.addEventListener('shown.bs.modal', function(e) {
  console.log('âœ… æ¨¡æ€æ¡†å·²æ˜¾ç¤º:', e.target.id);
  
  // ç«‹å³è®¾ç½®z-indexï¼Œä¸ä½¿ç”¨å»¶è¿Ÿ
  const visibleModals = document.querySelectorAll('.modal.show');
  
  console.log(`ğŸ”„ å½“å‰å¯è§æ¨¡æ€æ¡†: ${visibleModals.length}`);
  
  // æ ¹æ®æ‰“å¼€é¡ºåºåˆ†é…z-indexï¼ˆæ ˆé¡¶æœ€é«˜ï¼‰
  const processedModals = new Set();
  modalStack.forEach((modalId, stackIndex) => {
    const modal = document.getElementById(modalId);
    if (modal && modal.classList.contains('show') && !processedModals.has(modalId)) {
      const zIndex = 1050 + (stackIndex + 1) * 10;
      modal.style.setProperty('z-index', zIndex, 'important');
      processedModals.add(modalId);
      console.log(`  - ${modalId} (æ ˆä½ç½®${stackIndex}): z-index = ${zIndex}`);
    }
  });
  
  // ç§»é™¤æ‰€æœ‰backdropï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
  const allBackdrops = document.querySelectorAll('.modal-backdrop');
  allBackdrops.forEach(backdrop => backdrop.remove());
}, true);

// ç›‘å¬æ‰€æœ‰æ¨¡æ€æ¡†çš„å…³é—­äº‹ä»¶
document.addEventListener('hidden.bs.modal', function(e) {
  console.log('ğŸ“ æ¨¡æ€æ¡†å·²å…³é—­:', e.target.id);
  
  // ä»æ ˆä¸­ç§»é™¤å…³é—­çš„æ¨¡æ€æ¡†
  const index = modalStack.indexOf(e.target.id);
  if (index > -1) {
    modalStack.splice(index, 1);
    console.log('ğŸ“š æ¨¡æ€æ¡†æ ˆæ›´æ–°:', modalStack);
  }
  
  // ç«‹å³å¤„ç†ï¼Œä¸ä½¿ç”¨å»¶è¿Ÿ
  const visibleModals = document.querySelectorAll('.modal.show');
  
  console.log(`ğŸ§¹ æ¸…ç†æ£€æŸ¥ - å‰©ä½™æ¨¡æ€æ¡†: ${visibleModals.length}`);
  
  // é‡æ–°åˆ†é…å‰©ä½™æ¨¡æ€æ¡†çš„z-index
  const processedModals = new Set();
  modalStack.forEach((modalId, stackIndex) => {
    const modal = document.getElementById(modalId);
    if (modal && modal.classList.contains('show') && !processedModals.has(modalId)) {
      const zIndex = 1050 + (stackIndex + 1) * 10;
      modal.style.setProperty('z-index', zIndex, 'important');
      processedModals.add(modalId);
      console.log(`  - ${modalId} (æ ˆä½ç½®${stackIndex}): z-index = ${zIndex}`);
    }
  });
  
  // ç§»é™¤æ‰€æœ‰backdrop
  const allBackdrops = document.querySelectorAll('.modal-backdrop');
  allBackdrops.forEach(backdrop => backdrop.remove());
  
  // æ¸…ç†bodyæ ·å¼
  if (visibleModals.length === 0) {
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    modalStack = [];
    console.log('âœ… æ¸…ç†å®Œæˆ');
  }
}, true);

// å¼ºåˆ¶æ¸…ç†å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
window.forceCleanupBackdrops = function() {
  console.log('ğŸ†˜ å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ¨¡æ€æ¡†');
  
  const allModals = document.querySelectorAll('.modal');
  
  // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
  allModals.forEach(modal => {
    const instance = bootstrap.Modal.getInstance(modal);
    if (instance) {
      instance.hide();
    }
  });
  
  // ç§»é™¤æ‰€æœ‰backdrop
  const allBackdrops = document.querySelectorAll('.modal-backdrop');
  allBackdrops.forEach(backdrop => backdrop.remove());
  
  // æ¸…ç†body
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.paddingRight = '';
  
  // æ¸…ç©ºæ ˆ
  modalStack = [];
  
  console.log('âœ… å¼ºåˆ¶æ¸…ç†å®Œæˆ');
  showSuccess('é¡µé¢å·²æ¢å¤æ­£å¸¸');
};

document.addEventListener('DOMContentLoaded', async function() {
  console.log('ğŸš€ é¡µé¢åŠ è½½å¼€å§‹');
  
  // åªåœ¨ç¡®å®æœ‰é—®é¢˜æ—¶æ‰æ¸…ç†ï¼ˆç§»é™¤è‡ªåŠ¨æ¸…ç†ï¼‰
  // setTimeout(window.forceCleanupBackdrops, 500);
  
  // å¹¶è¡ŒåŠ è½½ï¼Œäº’ä¸é˜»å¡
  Promise.all([
    loadDepartments(),
    loadUsers()
  ]).then(() => {
    console.log('âœ… æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
  }).catch(err => {
    console.error('âŒ æ•°æ®åŠ è½½é”™è¯¯:', err);
  });
});

// åŠ è½½éƒ¨é—¨æ ‘
async function loadDepartments() {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/departments/tree', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('âœ… éƒ¨é—¨æ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      // æ¸…é™¤åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
      allDepartments = [];
      currentDepartments = [];
      renderDepartmentTable(currentDepartments);
      return;
    }
    
    allDepartments = data.departments || [];
    currentDepartments = allDepartments; // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰ä¸€çº§éƒ¨é—¨
    currentParentDept = null;
    renderDepartmentTable(currentDepartments);
    
  } catch (error) {
    console.error('âŒ åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥:', error);
    showError('åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥: ' + error.message);
    // æ¸…é™¤åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
    allDepartments = [];
    currentDepartments = [];
    renderDepartmentTable(currentDepartments);
  }
}

// æ¸²æŸ“éƒ¨é—¨è¡¨æ ¼ï¼ˆåªæ˜¾ç¤ºå½“å‰å±‚çº§çš„éƒ¨é—¨ï¼‰
function renderDepartmentTable(depts) {
  const tbody = document.getElementById('departmentTableBody');
  
  if (depts.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5">
          <div class="empty-state">
            <i class="bi bi-diagram-3"></i>
            <h5>æš‚æ— éƒ¨é—¨</h5>
            <p>${currentParentDept ? 'è¯¥éƒ¨é—¨ä¸‹æš‚æ— å­éƒ¨é—¨' : 'ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ éƒ¨é—¨"åˆ›å»ºç¬¬ä¸€ä¸ªéƒ¨é—¨'}</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  let rows = '';
  
  depts.forEach(dept => {
    const hasChildren = dept.children && dept.children.length > 0;
    const childrenCount = hasChildren ? dept.children.length : 0;
    
    rows += `
      <tr>
        <td>
          <div class="dept-name-cell">
            <i class="bi bi-building"></i>
            <span>${dept.name}</span>
            ${!dept.is_active ? '<span class="badge bg-secondary ms-2">å·²åœç”¨</span>' : ''}
          </div>
        </td>
        <td>
          <span class="member-count" onclick="viewDepartmentMembers(${dept.id}, '${dept.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-people-fill"></i>
            ${dept.member_count || 0}
          </span>
        </td>
        <td>
          ${dept.manager ? `
            <div class="manager-info">
              <div class="manager-avatar">${dept.manager.username.charAt(0).toUpperCase()}</div>
              <span class="manager-name">${dept.manager.username}</span>
            </div>
          ` : '<span class="text-muted">æœªè®¾ç½®</span>'}
        </td>
        <td>
          ${childrenCount > 0 ? `
            <span class="sub-dept-badge" onclick="viewSubDepartments(${dept.id}, '${dept.name.replace(/'/g, "\\'")}')">
              <i class="bi bi-diagram-3"></i>
              ${childrenCount}
            </span>
          ` : '<span class="text-muted">-</span>'}
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-outline-primary" onclick="editDepartment(${dept.id}, '${dept.name.replace(/'/g, "\\'")}', ${dept.parent_id || 'null'}, ${dept.manager_id || 'null'}, '${(dept.description || '').replace(/'/g, "\\'")}')">
              <i class="bi bi-pencil"></i> ç¼–è¾‘
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment(${dept.id}, '${dept.name.replace(/'/g, "\\'")}')">
              <i class="bi bi-trash"></i> åˆ é™¤
            </button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = rows;
}

// åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆç”¨äºé€‰æ‹©ä¸»ç®¡ï¼‰
async function loadUsers() {
  try {
    console.log('ğŸ“‹ å¼€å§‹åŠ è½½ç”¨æˆ·åˆ—è¡¨...');
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/users?pageSize=100', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('âœ… ç”¨æˆ·æ•°æ®:', data);
    
    if (data.success) {
      allUsers = data.users || [];
      updateManagerSelect();
      console.log(`âœ… åŠ è½½äº† ${allUsers.length} ä¸ªç”¨æˆ·`);
    } else {
      console.warn('âš ï¸ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', data.message);
    }
  } catch (error) {
    console.error('âŒ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
    // å³ä½¿å¤±è´¥ä¹Ÿä¸é˜»å¡é¡µé¢
    allUsers = [];
  }
}

// æ›´æ–°ä¸»ç®¡é€‰æ‹©æ¡†
function updateManagerSelect() {
  const select = document.getElementById('departmentManager');
  select.innerHTML = '<option value="">æœªè®¾ç½®</option>';
  
  allUsers.forEach(user => {
    select.innerHTML += `<option value="${user.id}">${user.username} (${user.email})</option>`;
  });
}

// æŸ¥çœ‹å­éƒ¨é—¨
function viewSubDepartments(parentId, parentName) {
  // æ‰¾åˆ°è¯¥éƒ¨é—¨
  const dept = findDepartmentById(allDepartments, parentId);
  if (!dept || !dept.children || dept.children.length === 0) {
    showWarning('è¯¥éƒ¨é—¨ä¸‹æš‚æ— å­éƒ¨é—¨');
    return;
  }
  
  // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
  document.getElementById('subDeptParentName').textContent = parentName;
  
  // æ¸²æŸ“å­éƒ¨é—¨è¡¨æ ¼
  const tbody = document.getElementById('subDepartmentTableBody');
  let rows = '';
  
  dept.children.forEach(child => {
    const hasChildren = child.children && child.children.length > 0;
    const childrenCount = hasChildren ? child.children.length : 0;
    
    rows += `
      <tr>
        <td>
          <div class="dept-name-cell">
            <i class="bi bi-diagram-2"></i>
            <span>${child.name}</span>
            ${!child.is_active ? '<span class="badge bg-secondary ms-2">å·²åœç”¨</span>' : ''}
          </div>
        </td>
        <td>
          <span class="member-count" onclick="viewDepartmentMembers(${child.id}, '${child.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-people-fill"></i>
            ${child.member_count || 0}
          </span>
        </td>
        <td>
          ${child.manager ? `
            <div class="manager-info">
              <div class="manager-avatar">${child.manager.username.charAt(0).toUpperCase()}</div>
              <span class="manager-name">${child.manager.username}</span>
            </div>
          ` : '<span class="text-muted">æœªè®¾ç½®</span>'}
        </td>
        <td>
          ${childrenCount > 0 ? `
            <span class="sub-dept-badge" onclick="viewSubDepartments(${child.id}, '${child.name.replace(/'/g, "\\'")}')">
              <i class="bi bi-diagram-3"></i>
              ${childrenCount}
            </span>
          ` : '<span class="text-muted">-</span>'}
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-outline-primary" onclick="editDepartment(${child.id}, '${child.name.replace(/'/g, "\\'")}', ${child.parent_id || 'null'}, ${child.manager_id || 'null'}, '${(child.description || '').replace(/'/g, "\\'")}')">
              <i class="bi bi-pencil"></i> ç¼–è¾‘
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment(${child.id}, '${child.name.replace(/'/g, "\\'")}')">
              <i class="bi bi-trash"></i> åˆ é™¤
            </button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = rows;
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå…¨å±€äº‹ä»¶ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†å±‚çº§ï¼‰
  const subModal = new bootstrap.Modal(document.getElementById('subDepartmentsModal'));
  subModal.show();
}

// æŸ¥çœ‹éƒ¨é—¨æˆå‘˜
async function viewDepartmentMembers(deptId, deptName) {
  try {
    document.getElementById('membersDeptName').textContent = deptName;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå…¨å±€äº‹ä»¶ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†å±‚çº§ï¼‰
    const modal = new bootstrap.Modal(document.getElementById('departmentMembersModal'));
    modal.show();
    
    // åŠ è½½æˆå‘˜æ•°æ®
    const token = localStorage.getItem('authToken');
    const response = await fetch(`/api/departments/${deptId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      document.getElementById('membersListBody').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-circle"></i>
          <h5>åŠ è½½å¤±è´¥</h5>
          <p>${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
        </div>
      `;
      return;
    }
    
    const dept = data.department;
    let members = dept.members || [];
    
    console.log('éƒ¨é—¨æ•°æ®:', dept);
    console.log('æˆå‘˜åˆ—è¡¨:', members);
    console.log('ä¸»ç®¡ä¿¡æ¯:', dept.manager);
    
    // å¦‚æœæœ‰ä¸»ç®¡ä¸”ä¸»ç®¡ä¸åœ¨æˆå‘˜åˆ—è¡¨ä¸­ï¼Œæ‰‹åŠ¨æ·»åŠ 
    if (dept.manager && dept.manager.id) {
      const managerInList = members.find(m => m.id === dept.manager.id);
      if (!managerInList) {
        members = [dept.manager, ...members];
        console.log('âœ… å·²å°†ä¸»ç®¡æ·»åŠ åˆ°æˆå‘˜åˆ—è¡¨');
      }
    }
    
    if (members.length === 0) {
      document.getElementById('membersListBody').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-people"></i>
          <h5>æš‚æ— æˆå‘˜</h5>
          <p>è¯¥éƒ¨é—¨ä¸‹æš‚æ— å‘˜å·¥</p>
        </div>
      `;
      return;
    }
    
    // æŒ‰è§’è‰²æ’åºï¼šä¸»ç®¡ â†’ è¶…çº§ç®¡ç†å‘˜ â†’ ç®¡ç†å‘˜ â†’ æ™®é€šç”¨æˆ·
    const sortedMembers = members.sort((a, b) => {
      // ä¸»ç®¡ä¼˜å…ˆ
      if (dept.manager_id && a.id === dept.manager_id) return -1;
      if (dept.manager_id && b.id === dept.manager_id) return 1;
      
      // è§’è‰²æ’åº
      const roleOrder = { 'super_admin': 1, 'admin': 2, 'user': 3 };
      return (roleOrder[a.role] || 999) - (roleOrder[b.role] || 999);
    });
    
    console.log('æ’åºåçš„æˆå‘˜:', sortedMembers);
    
    // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
    let html = `
      <div class="mb-3">
        <h6 class="text-muted mb-3">
          <i class="bi bi-people-fill me-2"></i>å…± ${sortedMembers.length} åæˆå‘˜
        </h6>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 25%;">å§“å</th>
              <th style="width: 20%;">è§’è‰²</th>
              <th style="width: 15%;">èŒä½</th>
              <th style="width: 40%;">é‚®ç®±</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    sortedMembers.forEach(member => {
      const isManager = dept.manager_id && member.id === dept.manager_id;
      let roleBadge = '';
      let positionBadge = '';
      
      // è§’è‰²å¾½ç« ï¼ˆä¸ç”¨æˆ·åˆ—è¡¨é¢œè‰²ä¸€è‡´ï¼‰
      if (member.role === 'super_admin') {
        roleBadge = '<span class="badge bg-danger">è¶…çº§ç®¡ç†å‘˜</span>';
      } else if (member.role === 'admin') {
        roleBadge = '<span class="badge bg-warning text-dark">ç®¡ç†å‘˜</span>';
      } else {
        roleBadge = '<span class="badge bg-primary">æ™®é€šç”¨æˆ·</span>';
      }
      
      // èŒä½å¾½ç« 
      if (isManager) {
        positionBadge = '<span class="badge bg-primary"><i class="bi bi-star-fill"></i> éƒ¨é—¨ä¸»ç®¡</span>';
      } else {
        positionBadge = '<span class="text-muted">-</span>';
      }
      
      html += `
        <tr>
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="member-avatar-small">${member.username.charAt(0).toUpperCase()}</div>
              <strong>${member.username}</strong>
            </div>
          </td>
          <td>${roleBadge}</td>
          <td>${positionBadge}</td>
          <td>
            <span class="text-muted">
              <i class="bi bi-envelope me-1"></i>${member.email}
            </span>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
    
    document.getElementById('membersListBody').innerHTML = html;
    
  } catch (error) {
    console.error('åŠ è½½éƒ¨é—¨æˆå‘˜å¤±è´¥:', error);
    document.getElementById('membersListBody').innerHTML = `
      <div class="empty-state">
        <i class="bi bi-exclamation-circle"></i>
        <h5>åŠ è½½å¤±è´¥</h5>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// è¾…åŠ©å‡½æ•°ï¼šåœ¨æ ‘å½¢ç»“æ„ä¸­æŸ¥æ‰¾éƒ¨é—¨
function findDepartmentById(depts, id) {
  for (let dept of depts) {
    if (dept.id === id) return dept;
    if (dept.children && dept.children.length > 0) {
      const found = findDepartmentById(dept.children, id);
      if (found) return found;
    }
  }
  return null;
}

// æ›´æ–°ä¸Šçº§éƒ¨é—¨é€‰æ‹©æ¡†
function updateParentSelect(excludeId = null) {
  const select = document.getElementById('parentDepartment');
  select.innerHTML = '<option value="">æ— ï¼ˆé¡¶çº§éƒ¨é—¨ï¼‰</option>';
  
  function addDeptOptions(depts, prefix = '') {
    depts.forEach(dept => {
      if (dept.id !== excludeId) {
        select.innerHTML += `<option value="${dept.id}">${prefix}${dept.name}</option>`;
        if (dept.children && dept.children.length > 0) {
          addDeptOptions(dept.children, prefix + 'ã€€');
        }
      }
    });
  }
  
  addDeptOptions(allDepartments);
}

// æ˜¾ç¤ºæ·»åŠ éƒ¨é—¨æ¨¡æ€æ¡†
function showAddDepartmentModal() {
  currentEditingDept = null;
  document.getElementById('departmentModalTitle').textContent = 'æ·»åŠ éƒ¨é—¨';
  document.getElementById('departmentId').value = '';
  document.getElementById('departmentName').value = '';
  document.getElementById('parentDepartment').value = '';
  document.getElementById('departmentManager').value = '';
  document.getElementById('departmentDescription').value = '';
  
  updateParentSelect();
  
  const modalEl = document.getElementById('departmentModal');
  // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå…¨å±€äº‹ä»¶ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†å±‚çº§ï¼‰
  new bootstrap.Modal(modalEl).show();
}

// ç¼–è¾‘éƒ¨é—¨
function editDepartment(id, name, parentId, managerId, description) {
  currentEditingDept = id;
  document.getElementById('departmentModalTitle').textContent = 'ç¼–è¾‘éƒ¨é—¨';
  document.getElementById('departmentId').value = id;
  document.getElementById('departmentName').value = name;
  document.getElementById('departmentDescription').value = description || '';
  
  updateParentSelect(id);  // æ’é™¤è‡ªå·±
  
  setTimeout(() => {
    document.getElementById('parentDepartment').value = parentId || '';
    document.getElementById('departmentManager').value = managerId || '';
  }, 100);
  
  const modalEl = document.getElementById('departmentModal');
  // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå…¨å±€äº‹ä»¶ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†å±‚çº§ï¼‰
  new bootstrap.Modal(modalEl).show();
}

// ä¿å­˜éƒ¨é—¨
async function saveDepartment() {
  try {
    const departmentId = document.getElementById('departmentId').value;
    const name = document.getElementById('departmentName').value.trim();
    const parentId = document.getElementById('parentDepartment').value;
    const managerId = document.getElementById('departmentManager').value;
    const description = document.getElementById('departmentDescription').value.trim();
    
    if (!name) {
      showWarning('è¯·è¾“å…¥éƒ¨é—¨åç§°');
      return;
    }
    
    const token = localStorage.getItem('authToken');
    const url = departmentId ? `/api/departments/${departmentId}` : '/api/departments';
    const method = departmentId ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name,
        parent_id: parentId ? parseInt(parentId) : null,
        manager_id: managerId ? parseInt(managerId) : null,
        description
      })
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError(data.message || 'ä¿å­˜å¤±è´¥');
      return;
    }
    
    showSuccess(departmentId ? 'éƒ¨é—¨æ›´æ–°æˆåŠŸ' : 'éƒ¨é—¨åˆ›å»ºæˆåŠŸ');
    bootstrap.Modal.getInstance(document.getElementById('departmentModal')).hide();
    await loadDepartments();
    
  } catch (error) {
    console.error('ä¿å­˜éƒ¨é—¨å¤±è´¥:', error);
    showError('ä¿å­˜å¤±è´¥: ' + error.message);
  }
}

// åˆ é™¤éƒ¨é—¨
async function deleteDepartment(id, name) {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤éƒ¨é—¨"${name}"å—ï¼Ÿ\n\næ³¨æ„ï¼šå¦‚æœéƒ¨é—¨ä¸‹æœ‰å­éƒ¨é—¨æˆ–æˆå‘˜ï¼Œå°†æ— æ³•åˆ é™¤ã€‚`)) {
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/departments/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError(data.message || 'åˆ é™¤å¤±è´¥');
      return;
    }
    
    showSuccess('éƒ¨é—¨åˆ é™¤æˆåŠŸ');
    await loadDepartments();
    
  } catch (error) {
    console.error('åˆ é™¤éƒ¨é—¨å¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

// æŸ¥çœ‹éƒ¨é—¨è¯¦æƒ…
async function viewDepartmentDetail(id) {
  try {
    const token = localStorage.getItem('authToken');
    
    const [deptResponse, membersResponse] = await Promise.all([
      fetch(`/api/departments/${id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      }),
      fetch(`/api/departments/${id}/members?includeSubDepartments=true`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
    ]);
    
    const deptData = await deptResponse.json();
    const membersData = await membersResponse.json();
    
    if (!deptData.success) {
      showError('è·å–éƒ¨é—¨è¯¦æƒ…å¤±è´¥');
      return;
    }
    
    const dept = deptData.department;
    const members = membersData.members || [];
    
    const html = `
      <div class="mb-3">
        <h6>åŸºæœ¬ä¿¡æ¯</h6>
        <table class="table table-sm">
          <tr>
            <th width="120">éƒ¨é—¨åç§°:</th>
            <td>${dept.name}</td>
          </tr>
          <tr>
            <th>ä¸Šçº§éƒ¨é—¨:</th>
            <td>${dept.parent ? dept.parent.name : 'æ— ï¼ˆé¡¶çº§éƒ¨é—¨ï¼‰'}</td>
          </tr>
          <tr>
            <th>éƒ¨é—¨å±‚çº§:</th>
            <td>ç¬¬ ${dept.level} çº§</td>
          </tr>
          <tr>
            <th>éƒ¨é—¨ä¸»ç®¡:</th>
            <td>${dept.manager ? `${dept.manager.username} (${dept.manager.email})` : 'æœªè®¾ç½®'}</td>
          </tr>
          <tr>
            <th>éƒ¨é—¨æè¿°:</th>
            <td>${dept.description || '-'}</td>
          </tr>
          <tr>
            <th>æˆå‘˜æ•°é‡:</th>
            <td>${dept.member_count || 0} äºº</td>
          </tr>
          <tr>
            <th>å­éƒ¨é—¨æ•°:</th>
            <td>${dept.child_count || 0} ä¸ª</td>
          </tr>
        </table>
      </div>
      
      <div class="mb-3">
        <h6>éƒ¨é—¨æˆå‘˜ï¼ˆå«å­éƒ¨é—¨ï¼‰</h6>
        ${members.length > 0 ? `
          <div class="list-group">
            ${members.map(member => `
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${member.username}</strong>
                    <span class="badge bg-${member.role === 'super_admin' ? 'danger' : member.role === 'admin' ? 'warning' : 'primary'} ms-2">
                      ${member.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : member.role === 'admin' ? 'ç®¡ç†å‘˜' : 'å‘˜å·¥'}
                    </span>
                    <div class="small text-muted">
                      ${member.email} | ${member.department.name}
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        ` : '<p class="text-muted">æš‚æ— æˆå‘˜</p>'}
      </div>
    `;
    
    document.getElementById('departmentDetailBody').innerHTML = html;
    // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå…¨å±€äº‹ä»¶ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†å±‚çº§ï¼‰
    new bootstrap.Modal(document.getElementById('departmentDetailModal')).show();
    
  } catch (error) {
    console.error('è·å–éƒ¨é—¨è¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–éƒ¨é—¨è¯¦æƒ…å¤±è´¥');
  }
}

// ==================== Toastæç¤ºå‡½æ•° ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>