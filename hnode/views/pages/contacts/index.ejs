<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">è”ç³»äºº</li>
      </ol>
    </nav>
    <h1 class="page-title">è”ç³»äººç®¡ç†</h1>
    <p class="page-subtitle">ç®¡ç†å’Œç»„ç»‡æ‚¨çš„ä¸šåŠ¡è”ç³»äºº</p>
  </div>
</div>

<!-- æœç´¢åŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-center">
      <div class="col-lg-6 col-md-12">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢å§“åã€é‚®ç®±æˆ–å…¬å¸...">
          <button class="btn btn-primary" onclick="searchContacts()">
            <i class="bi bi-search me-1"></i>æŸ¥è¯¢
          </button>
        </div>
      </div>
      <div class="col-lg-6 col-md-12">
        <div class="d-flex gap-2 justify-content-lg-end">
          <% if (typeof userPermissions !== 'undefined' && userPermissions.includes('contacts.hunter_search')) { %>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#hunterSearchModal">
            <i class="bi bi-globe me-1"></i>Hunter.ioæœç´¢
          </button>
          <% } %>
          <% if (typeof userPermissions !== 'undefined' && userPermissions.includes('contacts.create')) { %>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
            <i class="bi bi-plus-lg me-1"></i>æ·»åŠ è”ç³»äºº
          </button>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è”ç³»äººåˆ—è¡¨ -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th width="50">
              <input type="checkbox" id="selectAllContacts" onchange="toggleAllContacts()">
            </th>
            <th>è”ç³»äººå§“å</th>
            <th>ç”µå­é‚®ç®±</th>
            <th>å…¬å¸</th>
            <th>èŒä½</th>
            <th>åˆ›å»ºæ—¥æœŸ</th>
            <th>æ ‡ç­¾</th>
            <th width="100">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="contactTableBody">
          <tr>
            <td colspan="8" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="d-flex align-items-center gap-2">
          <span>æ¯é¡µ</span>
          <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelect" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <span>æ¡</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span id="contactCount">æ˜¾ç¤º1-4æ¡,å…±4æ¡</span>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
<div class="card mt-3" id="batchActionsCard" style="display: none;">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span id="selectedCount">å·²é€‰æ‹© 0 ä¸ªè”ç³»äºº</span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="exportSelectedContacts()">
          <i class="bi bi-download"></i> å¯¼å‡ºé€‰ä¸­
        </button>
        <button class="btn btn-outline-danger btn-sm" onclick="deleteSelectedContacts()">
          <i class="bi bi-trash"></i> åˆ é™¤é€‰ä¸­
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
          <i class="bi bi-x"></i> å–æ¶ˆé€‰æ‹©
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hunter.ioæœç´¢æ¨¡æ€æ¡† -->
<div class="modal fade" id="hunterSearchModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Hunter.io åŸŸåæœç´¢</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">è¾“å…¥å…¬å¸åŸŸåæˆ–ç½‘å€</label>
          <div class="input-group">
            <input type="text" class="form-control" id="hunterDomain" placeholder="ä¾‹å¦‚: google.com æˆ– https://www.google.com">
            <button class="btn btn-primary" onclick="searchHunter()">
              <i class="bi bi-search"></i> æœç´¢
            </button>
          </div>
        </div>
        <div id="hunterResults">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è”ç³»äººè¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="contactDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">è”ç³»äººè¯¦æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="contactDetailBody">
        <!-- è”ç³»äººè¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-primary" onclick="editContactFromDetail()">
          <i class="bi bi-pencil"></i> ç¼–è¾‘
        </button>
      </div>
    </div>
  </div>
</div>

<!-- æ·»åŠ è”ç³»äººæ¨¡æ€æ¡† -->
<div class="modal fade" id="addContactModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ·»åŠ è”ç³»äºº</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addContactForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“å *</label>
              <input type="text" class="form-control" id="addContactName" required placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">é‚®ç®± *</label>
              <input type="email" class="form-control" id="addContactEmail" required placeholder="example@company.com">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">åå­—</label>
              <input type="text" class="form-control" id="addContactFirstName" placeholder="First Name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“æ°</label>
              <input type="text" class="form-control" id="addContactLastName" placeholder="Last Name">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å…¬å¸</label>
              <input type="text" class="form-control" id="addContactCompany" placeholder="å…¬å¸åç§°">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">èŒä½</label>
              <input type="text" class="form-control" id="addContactPosition" placeholder="èŒä½åç§°">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">åŸŸå</label>
            <input type="text" class="form-control" id="addContactDomain" placeholder="company.com">
          </div>
          
          <div class="mb-3">
            <label class="form-label">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
            <input type="text" class="form-control" id="addContactTags" placeholder="ä¾‹å¦‚: VIP, é‡ç‚¹å®¢æˆ·">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveNewContact()">
          <i class="bi bi-plus"></i> æ·»åŠ 
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘è”ç³»äººæ¨¡æ€æ¡† -->
<div class="modal fade" id="editContactModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¼–è¾‘è”ç³»äºº</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editContactForm">
          <input type="hidden" id="editContactId">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“å *</label>
              <input type="text" class="form-control" id="editContactName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">é‚®ç®± *</label>
              <input type="email" class="form-control" id="editContactEmail" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">åå­—</label>
              <input type="text" class="form-control" id="editContactFirstName">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“æ°</label>
              <input type="text" class="form-control" id="editContactLastName">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å…¬å¸</label>
              <input type="text" class="form-control" id="editContactCompany">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">èŒä½</label>
              <input type="text" class="form-control" id="editContactPosition">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">åŸŸå</label>
            <input type="text" class="form-control" id="editContactDomain">
          </div>
          
          <div class="mb-3">
            <label class="form-label">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
            <input type="text" class="form-control" id="editContactTags" placeholder="ä¾‹å¦‚: VIP, é‡ç‚¹å®¢æˆ·">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveContactEdit()">
          <i class="bi bi-check"></i> ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ç”¨æˆ·æƒé™ï¼ˆä»åç«¯ä¼ é€’ï¼‰
// eslint-disable-next-line
const userPermissions = <%- JSON.stringify(userPermissions || []) %>;
console.log('ğŸ‘¤ ç”¨æˆ·æƒé™:', userPermissions);

let currentPage = 1;
let currentFilters = {};
let selectedContacts = [];
let pageSize = 20;

// æƒé™æ£€æŸ¥è¾…åŠ©å‡½æ•°
function hasPermission(code) {
  return userPermissions.includes(code);
}

document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… è”ç³»äººé¡µé¢å·²åŠ è½½');
  await loadContacts();
  
  const searchInput = document.getElementById('searchKeyword');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchContacts, 500));
  }
  
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  if (pageSizeSelect) {
    pageSizeSelect.addEventListener('change', changePageSize);
  }
});

async function loadContacts(page = 1) {
  try {
    console.log('ğŸ”„ åŠ è½½è”ç³»äººåˆ—è¡¨ï¼Œé¡µç :', page);
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    let queryParams = `page=${page}&pageSize=${pageSize}`;
    if (currentFilters.search) {
      queryParams += `&search=${encodeURIComponent(currentFilters.search)}`;
    }
    
    const url = `/api/contacts/?${queryParams}`;
    console.log('ğŸ“ è¯·æ±‚URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ è”ç³»äººæ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½è”ç³»äººå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    currentPage = page;
    renderContactTable(data.contacts || []);
    renderPagination(data.page, data.total_pages);
    updateContactCount(data.total, data.contacts?.length || 0, page);
    
  } catch (error) {
    console.error('âŒ åŠ è½½è”ç³»äººåˆ—è¡¨å¤±è´¥:', error);
    showError('åŠ è½½è”ç³»äººåˆ—è¡¨å¤±è´¥: ' + error.message);
  }
}

function renderContactTable(contacts) {
  const tbody = document.getElementById('contactTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°è”ç³»äººè¡¨æ ¼');
    return;
  }
  
  console.log('ğŸ”„ æ¸²æŸ“è”ç³»äººè¡¨æ ¼ï¼Œå…±', contacts.length, 'æ¡');
  
  if (contacts.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-person-lines-fill"></i>
            <h5>æš‚æ— è”ç³»äºº</h5>
            <p>å¼€å§‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªè”ç³»äºº</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  contacts.forEach(contact => {
    const tags = contact.tags ? contact.tags.map(tag => `<span class="badge bg-info me-1">${tag}</span>`).join('') : '';
    const isSelected = selectedContacts.includes(contact.id);
    
    html += `
      <tr class="contact-row" data-contact-id="${contact.id}">
        <td>
          <input type="checkbox" class="contact-checkbox" value="${contact.id}" ${isSelected ? 'checked' : ''} onchange="toggleContactSelection(${contact.id})">
        </td>
        <td>
          <div class="d-flex align-items-center">
            <div class="avatar-circle me-2" style="cursor: pointer;" onclick="event.stopPropagation(); viewContact(${contact.id});" title="ç‚¹å‡»æŸ¥çœ‹è”ç³»äººè¯¦æƒ…">
              ${getInitials(contact.name)}
            </div>
            <div>
              <div class="fw-bold">${contact.name || '-'}</div>
            </div>
          </div>
        </td>
        <td>${contact.email}</td>
        <td>${contact.company || '-'}</td>
        <td>${contact.position || '-'}</td>
        <td>${formatDate(contact.created_at)}</td>
        <td>${tags || '-'}</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              ${hasPermission('contacts.view') ? `
              <li><a class="dropdown-item" href="#" onclick="viewContact(${contact.id}); return false;">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
              </a></li>
              ` : ''}
              ${hasPermission('contacts.edit') ? `
              <li><a class="dropdown-item" href="#" onclick="editContact(${contact.id}); return false;">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </a></li>
              ` : ''}
              ${(hasPermission('contacts.view') || hasPermission('contacts.edit')) && hasPermission('contacts.delete') ? '<li><hr class="dropdown-divider"></li>' : ''}
              ${hasPermission('contacts.delete') ? `
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteContact(${contact.id}); return false;">
                <i class="bi bi-trash"></i> åˆ é™¤
              </a></li>
              ` : ''}
            </ul>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  console.log('âœ… è”ç³»äººè¡¨æ ¼æ¸²æŸ“å®Œæˆ');
}

function renderPagination(current, total) {
  const pagination = document.getElementById('pagination');
  if (!pagination) return;
  
  if (total <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadContacts(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;
  
  // é¡µç 
  const startPage = Math.max(1, current - 2);
  const endPage = Math.min(total, current + 2);
  
  if (startPage > 1) {
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadContacts(1); return false;">1</a></li>`;
    if (startPage > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadContacts(${i}); return false;">${i}</a>
      </li>
    `;
  }
  
  if (endPage < total) {
    if (endPage < total - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadContacts(${total}); return false;">${total}</a></li>`;
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadContacts(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;
  
  pagination.innerHTML = html;
}

function updateContactCount(total, current, page) {
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, total);
  const countElement = document.getElementById('contactCount');
  if (countElement) {
    countElement.textContent = `æ˜¾ç¤º${start}-${end}æ¡,å…±${total}æ¡`;
  }
}

function searchContacts() {
  currentFilters = {};
  
  const searchInput = document.getElementById('searchKeyword');
  const keyword = searchInput ? searchInput.value : '';
  if (keyword) currentFilters.search = keyword;
  
  loadContacts(1);
}

function changePageSize() {
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  pageSize = pageSizeSelect ? parseInt(pageSizeSelect.value) : 20;
  loadContacts(1);
}

// è”ç³»äººé€‰æ‹©åŠŸèƒ½
function toggleContactSelection(contactId) {
  console.log('ğŸ”„ åˆ‡æ¢è”ç³»äººé€‰æ‹©:', contactId);
  const index = selectedContacts.indexOf(contactId);
  if (index > -1) {
    selectedContacts.splice(index, 1);
    console.log('  âŒ å–æ¶ˆé€‰æ‹©');
  } else {
    selectedContacts.push(contactId);
    console.log('  âœ… æ·»åŠ é€‰æ‹©');
  }
  console.log('  å½“å‰å·²é€‰æ‹©:', selectedContacts);
  updateBatchActions();
}

function toggleAllContacts() {
  const selectAllCheckbox = document.getElementById('selectAllContacts');
  const isChecked = selectAllCheckbox.checked;
  const checkboxes = document.querySelectorAll('.contact-checkbox');
  
  console.log('ğŸ”„ å…¨é€‰/å–æ¶ˆå…¨é€‰:', isChecked);
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = isChecked;
  });
  
  if (isChecked) {
    selectedContacts = Array.from(checkboxes).map(cb => parseInt(cb.value));
    console.log('  âœ… å·²é€‰æ‹©æ‰€æœ‰è”ç³»äºº:', selectedContacts);
  } else {
    selectedContacts = [];
    console.log('  âŒ å·²å–æ¶ˆæ‰€æœ‰é€‰æ‹©');
  }
  
  updateBatchActions();
}

function updateBatchActions() {
  const count = selectedContacts.length;
  const selectedCountEl = document.getElementById('selectedCount');
  const batchActionsCard = document.getElementById('batchActionsCard');
  
  if (selectedCountEl) {
    selectedCountEl.textContent = `å·²é€‰æ‹© ${count} ä¸ªè”ç³»äºº`;
  }
  
  if (batchActionsCard) {
    if (count > 0) {
      batchActionsCard.style.display = 'block';
    } else {
      batchActionsCard.style.display = 'none';
    }
  }
  
  console.log('ğŸ“Š æ›´æ–°æ‰¹é‡æ“ä½œé¢æ¿: å·²é€‰æ‹©', count, 'ä¸ªè”ç³»äºº');
}

function clearSelection() {
  console.log('ğŸ—‘ï¸ æ¸…ç©ºé€‰æ‹©');
  selectedContacts = [];
  
  const checkboxes = document.querySelectorAll('.contact-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  
      const selectAllCheckbox = document.getElementById('selectAllContacts');
  if (selectAllCheckbox) {
    selectAllCheckbox.checked = false;
  }
  
  updateBatchActions();
}

async function deleteSelectedContacts() {
  if (selectedContacts.length === 0) {
    showWarning('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è”ç³»äºº');
    return;
  }
  
  if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedContacts.length} ä¸ªè”ç³»äººå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
    return;
  }
  
  try {
    console.log('ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤è”ç³»äºº:', selectedContacts);
    
    const token = localStorage.getItem('authToken');
    let successCount = 0;
    let failCount = 0;
    
    // é€ä¸ªåˆ é™¤
    for (const contactId of selectedContacts) {
      try {
        const response = await fetch(`/api/contacts/${contactId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        if (data.success) {
          successCount++;
          console.log(`  âœ… åˆ é™¤è”ç³»äºº ${contactId} æˆåŠŸ`);
        } else {
          failCount++;
          console.log(`  âŒ åˆ é™¤è”ç³»äºº ${contactId} å¤±è´¥:`, data.message);
        }
      } catch (error) {
        console.error(`âŒ åˆ é™¤è”ç³»äºº ${contactId} å‡ºé”™:`, error);
        failCount++;
      }
    }
    
    // æ˜¾ç¤ºç»“æœ
    if (successCount > 0) {
      showSuccess(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªè”ç³»äºº${failCount > 0 ? `ï¼Œå¤±è´¥ ${failCount} ä¸ª` : ''}`);
      
      // æ¸…ç©ºé€‰æ‹©å¹¶åˆ·æ–°åˆ—è¡¨
      selectedContacts = [];
      
      const selectAllCheckbox = document.getElementById('selectAllContacts');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
      }
      
      updateBatchActions();
      await loadContacts(currentPage);
    } else {
      showError('åˆ é™¤å¤±è´¥');
    }
  } catch (error) {
    console.error('âŒ æ‰¹é‡åˆ é™¤è”ç³»äººå¤±è´¥:', error);
    showError('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

// æ‰¹é‡æ“ä½œ
async function exportSelectedContacts() {
  if (selectedContacts.length === 0) {
    showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è”ç³»äºº', 'warning');
    return;
  }
  
  try {
    console.log('ğŸ“¥ å¯¼å‡ºé€‰ä¸­çš„è”ç³»äºº:', selectedContacts);
    
    const token = localStorage.getItem('authToken');
    
    // è·å–é€‰ä¸­è”ç³»äººçš„å®Œæ•´ä¿¡æ¯
    const contactsData = [];
    for (const contactId of selectedContacts) {
      const response = await fetch(`/api/contacts/${contactId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.success) {
        contactsData.push(data.contact);
      }
    }
    
    if (contactsData.length === 0) {
      showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'warning');
      return;
    }
    
    // è½¬æ¢ä¸ºCSVæ ¼å¼
    const headers = ['å§“å', 'é‚®ç®±', 'åå­—', 'å§“æ°', 'å…¬å¸', 'èŒä½', 'åŸŸå', 'æ ‡ç­¾', 'åˆ›å»ºæ—¶é—´'];
    const csvRows = [headers.join(',')];
    
    contactsData.forEach(contact => {
      const row = [
        `"${contact.name || ''}"`,
        `"${contact.email || ''}"`,
        `"${contact.first_name || ''}"`,
        `"${contact.last_name || ''}"`,
        `"${contact.company || ''}"`,
        `"${contact.position || ''}"`,
        `"${contact.domain || ''}"`,
        `"${contact.tags && contact.tags.length > 0 ? contact.tags.join(';') : ''}"`,
        `"${new Date(contact.created_at).toLocaleDateString('zh-CN')}"`
      ];
      csvRows.push(row.join(','));
    });
    
    // åˆ›å»ºCSVæ–‡ä»¶å¹¶ä¸‹è½½
    const csvContent = '\uFEFF' + csvRows.join('\n'); // \uFEFF æ˜¯BOMï¼Œè®©Excelæ­£ç¡®è¯†åˆ«UTF-8
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `è”ç³»äººå¯¼å‡º_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast(`æˆåŠŸå¯¼å‡º ${contactsData.length} ä¸ªè”ç³»äºº`, 'success');
  } catch (error) {
    console.error('âŒ å¯¼å‡ºè”ç³»äººå¤±è´¥:', error);
    showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'danger');
  }
}

// ç­›é€‰åŠŸèƒ½å·²ç§»é™¤

// Hunter.ioæœç´¢
async function searchHunter() {
  const domain = $('#hunterDomain').val();
  if (!domain) {
    showToast('è¯·è¾“å…¥åŸŸå', 'warning');
    return;
  }
  
  try {
    showLoading();
    const response = await axios.get('/api/hunter/domain-search', {
      params: { domain: domain, limit: 20 }
    });
    
    const contacts = response.data.contacts;
    
    if (contacts.length === 0) {
      $('#hunterResults').html('<div class="alert alert-info">æœªæ‰¾åˆ°è”ç³»äºº</div>');
      return;
    }
    
    let html = '<div class="list-group">';
    contacts.forEach((contact, index) => {
      html += `
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">${contact.name || contact.first_name + ' ' + contact.last_name}</h6>
              <small class="text-muted">${contact.email}</small><br>
              <small class="text-muted">${contact.position || '-'} at ${contact.company || '-'}</small>
            </div>
            <button class="btn btn-sm btn-primary" onclick="importContact(${index})">
              <i class="bi bi-plus"></i> å¯¼å…¥
            </button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    $('#hunterResults').html(html);
    window.hunterContacts = contacts;
    
  } catch (error) {
    showToast(error.response?.data?.message || 'æœç´¢å¤±è´¥', 'danger');
  } finally {
    hideLoading();
  }
}

async function importContact(index) {
  const contact = window.hunterContacts[index];
  
  try {
    await axios.post('/api/contacts/', {
      name: contact.name,
      first_name: contact.first_name,
      last_name: contact.last_name,
      email: contact.email,
      company: contact.company,
      domain: contact.domain,
      position: contact.position
    });
    
    showToast('è”ç³»äººå¯¼å…¥æˆåŠŸ', 'success');
    $('#hunterSearchModal').modal('hide');
    await loadContacts(1);
  } catch (error) {
    showToast(error.response?.data?.message || 'å¯¼å…¥å¤±è´¥', 'danger');
  }
}

// è”ç³»äººæ“ä½œ
async function viewContact(id) {
  console.log('âœ… æŸ¥çœ‹è”ç³»äººè¯¦æƒ…:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/contacts/${id}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      const contact = data.contact;
      
      // æ¸²æŸ“è”ç³»äººè¯¦æƒ…
      const detailHTML = `
        <div class="contact-detail">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">å§“å</label>
                <p class="fw-bold">${contact.name}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">é‚®ç®±</label>
                <p class="fw-bold">${contact.email}</p>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">åå­—</label>
                <p>${contact.first_name || '-'}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">å§“æ°</label>
                <p>${contact.last_name || '-'}</p>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">å…¬å¸</label>
                <p>${contact.company || '-'}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">èŒä½</label>
                <p>${contact.position || '-'}</p>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">åŸŸå</label>
                <p>${contact.domain || '-'}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">æ ‡ç­¾</label>
                <p>${contact.tags && contact.tags.length > 0 ? contact.tags.map(tag => `<span class="badge bg-info me-1">${tag}</span>`).join('') : '-'}</p>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">åˆ›å»ºæ—¶é—´</label>
                <p>${new Date(contact.created_at).toLocaleString('zh-CN')}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="detail-item">
                <label class="text-muted">æ›´æ–°æ—¶é—´</label>
                <p>${new Date(contact.updated_at).toLocaleString('zh-CN')}</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('contactDetailBody').innerHTML = detailHTML;
      
      // ä¿å­˜å½“å‰è”ç³»äººæ•°æ®ä¾›ç¼–è¾‘ä½¿ç”¨
      window.currentContact = contact;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = new bootstrap.Modal(document.getElementById('contactDetailModal'));
      modal.show();
    } else {
      showError('è·å–è”ç³»äººè¯¦æƒ…å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('âŒ æŸ¥çœ‹è”ç³»äººè¯¦æƒ…å¤±è´¥:', error);
    showError('æŸ¥çœ‹è”ç³»äººè¯¦æƒ…å¤±è´¥: ' + error.message);
  }
}

function editContact(id) {
  console.log('âœ… ç¼–è¾‘è”ç³»äºº:', id);
  
  // å…ˆè·å–è”ç³»äººè¯¦æƒ…ï¼Œç„¶åæ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
  viewContactForEdit(id);
}

// ä»è¯¦æƒ…é¡µé¢è¿›å…¥ç¼–è¾‘
function editContactFromDetail() {
  if (!window.currentContact) {
    showError('æ— æ³•è·å–è”ç³»äººä¿¡æ¯');
    return;
  }
  
  // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
  const detailModal = bootstrap.Modal.getInstance(document.getElementById('contactDetailModal'));
  if (detailModal) {
    detailModal.hide();
  }
  
  // å¡«å……ç¼–è¾‘è¡¨å•
  fillEditForm(window.currentContact);
  
  // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
  const editModal = new bootstrap.Modal(document.getElementById('editContactModal'));
  editModal.show();
}

// è·å–è”ç³»äººå¹¶æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
async function viewContactForEdit(id) {
  console.log('âœ… è·å–è”ç³»äººä¿¡æ¯ç”¨äºç¼–è¾‘:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/contacts/${id}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      fillEditForm(data.contact);
      
      // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
      const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
      modal.show();
    } else {
      showError('è·å–è”ç³»äººä¿¡æ¯å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('âŒ è·å–è”ç³»äººä¿¡æ¯å¤±è´¥:', error);
    showError('è·å–è”ç³»äººä¿¡æ¯å¤±è´¥: ' + error.message);
  }
}

// å¡«å……ç¼–è¾‘è¡¨å•
function fillEditForm(contact) {
  document.getElementById('editContactId').value = contact.id;
  document.getElementById('editContactName').value = contact.name || '';
  document.getElementById('editContactEmail').value = contact.email || '';
  document.getElementById('editContactFirstName').value = contact.first_name || '';
  document.getElementById('editContactLastName').value = contact.last_name || '';
  document.getElementById('editContactCompany').value = contact.company || '';
  document.getElementById('editContactPosition').value = contact.position || '';
  document.getElementById('editContactDomain').value = contact.domain || '';
  document.getElementById('editContactTags').value = contact.tags ? contact.tags.join(', ') : '';
}

// ä¿å­˜æ–°è”ç³»äºº
async function saveNewContact() {
  console.log('âœ… æ·»åŠ æ–°è”ç³»äºº');
  
  const name = document.getElementById('addContactName').value;
  const email = document.getElementById('addContactEmail').value;
  
  if (!name || !email) {
    showWarning('è¯·å¡«å†™å§“åå’Œé‚®ç®±');
    return;
  }
  
  const contactData = {
    name: name,
    email: email,
    first_name: document.getElementById('addContactFirstName').value,
    last_name: document.getElementById('addContactLastName').value,
    company: document.getElementById('addContactCompany').value,
    position: document.getElementById('addContactPosition').value,
    domain: document.getElementById('addContactDomain').value,
    tags: document.getElementById('addContactTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
  };
  
  try {
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ åˆ›å»ºæ–°è”ç³»äºº...', contactData);
    
    const response = await fetch('/api/contacts/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(contactData)
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ åˆ›å»ºå“åº”:', data);
    
    if (data.success) {
      showSuccess('è”ç³»äººæ·»åŠ æˆåŠŸï¼');
      
      // å…³é—­æ¨¡æ€æ¡†
      const modal = bootstrap.Modal.getInstance(document.getElementById('addContactModal'));
      if (modal) {
        modal.hide();
      }
      
      // æ¸…ç©ºè¡¨å•
      document.getElementById('addContactForm').reset();
      
      // åˆ·æ–°è”ç³»äººåˆ—è¡¨
      await loadContacts(1);
    } else {
      showError('æ·»åŠ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ æ·»åŠ è”ç³»äººå¤±è´¥:', error);
    showError('æ·»åŠ å¤±è´¥: ' + error.message);
  }
}

// ä¿å­˜ç¼–è¾‘
async function saveContactEdit() {
  console.log('âœ… ä¿å­˜è”ç³»äººç¼–è¾‘');
  
  const id = document.getElementById('editContactId').value;
  const name = document.getElementById('editContactName').value;
  const email = document.getElementById('editContactEmail').value;
  
  if (!name || !email) {
    showWarning('è¯·å¡«å†™å§“åå’Œé‚®ç®±');
    return;
  }
  
  const contactData = {
    name: name,
    email: email,
    first_name: document.getElementById('editContactFirstName').value,
    last_name: document.getElementById('editContactLastName').value,
    company: document.getElementById('editContactCompany').value,
    position: document.getElementById('editContactPosition').value,
    domain: document.getElementById('editContactDomain').value,
    tags: document.getElementById('editContactTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
  };
  
  try {
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ æ›´æ–°è”ç³»äººä¿¡æ¯...');
    
    const response = await fetch(`/api/contacts/${id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(contactData)
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ æ›´æ–°å“åº”:', data);
    
    if (data.success) {
      showSuccess('è”ç³»äººä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
      
      // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
      const modal = bootstrap.Modal.getInstance(document.getElementById('editContactModal'));
      if (modal) {
        modal.hide();
      }
      
      // åˆ·æ–°è”ç³»äººåˆ—è¡¨
      await loadContacts(currentPage);
    } else {
      showError('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ ä¿å­˜è”ç³»äººå¤±è´¥:', error);
    showError('ä¿å­˜å¤±è´¥: ' + error.message);
  }
}

async function deleteContact(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè”ç³»äººå—ï¼Ÿ')) return;
  
  console.log('âœ… åˆ é™¤è”ç³»äºº:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/contacts/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('è”ç³»äººå·²åˆ é™¤');
      await loadContacts(currentPage);
    } else {
      showError('åˆ é™¤å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('åˆ é™¤è”ç³»äººå¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

// å·¥å…·å‡½æ•°
function getInitials(name) {
  if (!name) return '?';
  const names = name.split(' ');
  if (names.length >= 2) {
    return (names[0][0] + names[1][0]).toUpperCase();
  }
  return name[0].toUpperCase();
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN');
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showLoading() {
  // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§é®ç½©
  hideLoading();
  
  console.log('ğŸ”„ æ˜¾ç¤ºåŠ è½½ä¸­...');
  const loadingHTML = `
    <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">åŠ è½½ä¸­...</span>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
  console.log('âœ… éšè—åŠ è½½ä¸­');
  const loading = document.getElementById('loadingOverlay');
  if (loading) {
    loading.remove();
  }
}

// ==================== Toastæç¤ºå‡½æ•° ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>
