<!-- æµ·å¤–å®¢æˆ·æœç´¢ä¸»é¡µé¢ -->
<div class="overseas-search-hero">
  <div class="container-fluid position-relative">
    <!-- å³ä¸Šè§’å†å²è®°å½•æŒ‰é’® -->
    <div class="position-absolute top-0 end-0 mt-3 me-3">
      <button class="btn btn-outline-secondary" onclick="showSearchHistory()">
        <i class="bi bi-clock-history"></i> å†å²è®°å½• (<span id="historyCount">0</span>)
      </button>
    </div>
    
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="search-hero-card">
          <div class="search-hero-content">
            <h1 class="search-title">æµ·å¤–å®¢æˆ·æœç´¢</h1>
            <p class="search-description">é€šè¿‡AIæ™ºèƒ½åˆ†æï¼Œå¿«é€Ÿè·å–æ½œåœ¨æµ·å¤–å®¢æˆ·åˆ—è¡¨ï¼Œæå‡é”€å”®æ•ˆç‡</p>
            <button class="btn btn-primary btn-lg search-btn" id="searchButton">
              <i class="bi bi-search"></i> æœç´¢æ½œåœ¨å®¢æˆ·
            </button>
            <p class="search-hint">ç‚¹å‡»æŒ‰é’®è·å–AIæ¨èçš„æµ·å¤–å®¢æˆ·åˆ—è¡¨</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å®¢æˆ·åˆ—è¡¨åŒºåŸŸ -->
<div class="container-fluid mt-4" id="customerListSection" style="display: none;">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">å®¢æˆ·åˆ—è¡¨</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="exportCustomers()">
              <i class="bi bi-download"></i> å¯¼å‡º
            </button>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-funnel"></i> ç­›é€‰
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('all')">æ‰€æœ‰å›½å®¶</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('US')">ç¾å›½</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('UK')">è‹±å›½</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('DE')">å¾·å›½</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('JP')">æ—¥æœ¬</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>åºå·</th>
                  <th>å…¬å¸åç§°</th>
                  <th>å…¬å¸ç®€ä»‹</th>
                  <th>åŸŸå</th>
                  <th>å›½å®¶</th>
                  <th>åŸå¸‚</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="overseasCustomerTableBody">
                <!-- å®¢æˆ·æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è”ç³»äººåˆ—è¡¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="contactListModal" tabindex="-1" aria-labelledby="contactListModalLabel" data-bs-backdrop="static">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contactListModalLabel">æ½œåœ¨è”ç³»äººåˆ—è¡¨</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="contactSearchInput" 
                     placeholder="æœç´¢å§“åã€èŒä½ã€é‚®ç®±..." 
                     onkeyup="filterContactList()">
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" onclick="selectAllContacts()">
                <i class="bi bi-check-square"></i> å…¨é€‰
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="clearContactSelection()">
                <i class="bi bi-square"></i> å–æ¶ˆå…¨é€‰
              </button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th width="50">
                  <input type="checkbox" id="selectAllContacts" onchange="toggleAllContacts()">
                </th>
                <th>å§“å</th>
                <th>èŒä½</th>
                <th>å…¬å¸</th>
                <th>é‚®ç®±</th>
                <th>ç®€ä»‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="contactListTableBody">
              <!-- è”ç³»äººæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <span id="selectedContactsCount">å·²é€‰æ‹© 0 äºº</span>
          </div>
          <div>
            <button class="btn btn-secondary me-2" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="batchAddContacts()">
              <i class="bi bi-person-plus"></i> æ‰¹é‡æ·»åŠ è”ç³»äºº
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æœç´¢å†å²è®°å½•æ¨¡æ€æ¡† -->
<div class="modal fade" id="searchHistoryModal" tabindex="-1" data-bs-keyboard="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-clock-history"></i> æœç´¢å†å²è®°å½•
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="clearHistorySelection()"></button>
      </div>
      <div class="modal-body">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 
              æ€»å…±æœç´¢è¿‡ <strong id="statsTotal">0</strong> å®¶å…¬å¸
              </div>
                </div>
              </div>
        
        <!-- æœç´¢è¿‡æ»¤ -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="historySearch" 
                     placeholder="æœç´¢å…¬å¸åç§°ã€åŸŸåã€å…³é”®è¯..." 
                     onkeyup="debounceHistorySearch()">
              <button class="btn btn-outline-primary" onclick="loadSearchHistory(1)">
                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                  </button>
                </div>
              </div>
                </div>
        
        <!-- å†å²è®°å½•è¡¨æ ¼ -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th width="50">
                  <input type="checkbox" id="selectAllHistory" onchange="toggleAllHistory()">
                </th>
                <th>åºå·</th>
                <th>å…¬å¸åç§°</th>
                <th>å…¬å¸ç®€ä»‹</th>
                <th>ç½‘ç«™/åŸŸå</th>
                <th>ä½ç½®</th>
                <th>æœç´¢æ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
                </td>
              </tr>
            </tbody>
          </table>
            </div>

        <!-- åˆ†é¡µ -->
        <nav>
          <ul class="pagination justify-content-center" id="historyPagination"></ul>
        </nav>
      </div>
      <div class="modal-footer">
        <div class="d-flex justify-content-between w-100 align-items-center">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-success" onclick="exportSelectedHistory()">
              <i class="bi bi-file-earmark-arrow-down"></i> å¯¼å‡ºé€‰ä¸­
            </button>
            <button type="button" class="btn btn-outline-info" onclick="exportAllHistory()">
              <i class="bi bi-download"></i> å¯¼å‡ºå…¨éƒ¨
            </button>
            <button type="button" class="btn btn-danger" onclick="batchDeleteHistory()">
              <i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤ (<span id="selectedHistoryCount">0</span>)
            </button>
      </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearHistorySelection()">å…³é—­</button>
    </div>
  </div>
</div>
      </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let overseasCustomers = [];
let selectedContacts = [];
let currentTemplate = null;
let currentPreviewIndex = 0;
let emailPreviews = [];
let currentHistoryPage = 1;
let selectedHistoryIds = new Set();  // ä¿å­˜è·¨é¡µé€‰ä¸­çš„å†å²è®°å½•ID

// ä½¿ç”¨åŸç”ŸJavaScript
document.addEventListener('DOMContentLoaded', function() {
  console.log('âœ… æµ·å¤–å®¢æˆ·æœç´¢é¡µé¢å·²åŠ è½½');
  initializePage();
  updateHistoryCount();
  
  // å¤‡ç”¨æ–¹æ¡ˆï¼šé€šè¿‡JavaScriptç»‘å®šç‚¹å‡»äº‹ä»¶
  const searchBtn = document.querySelector('.search-btn');
  if (searchBtn) {
    console.log('âœ… æ‰¾åˆ°æœç´¢æŒ‰é’®ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶');
    searchBtn.addEventListener('click', function(e) {
      console.log('ğŸ–±ï¸ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ˆé€šè¿‡addEventListenerï¼‰');
      e.preventDefault();
      searchOverseasCustomers();
    });
  } else {
    console.error('âŒ æœªæ‰¾åˆ°æœç´¢æŒ‰é’®');
  }
});

function initializePage() {
  console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
}

// æœç´¢æµ·å¤–å®¢æˆ·
async function searchOverseasCustomers() {
  console.log('âœ… æœç´¢æŒ‰é’®è¢«ç‚¹å‡»');
  
  try {
    showLoading();
    
    console.log('ğŸ”„ è°ƒç”¨åç«¯æµ·å¤–å®¢æˆ·æœç´¢æ¥å£...');
    
    // è·å–token
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    // ä½¿ç”¨fetchè°ƒç”¨æ­£ç¡®çš„æ¥å£
    const response = await fetch('/api/overseas/companies/sugar-free', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    console.log('ğŸ“¥ æœåŠ¡å™¨å“åº”:', data);
    
    if (!data.success) {
      const errorMsg = data.error || data.message || 'æœªçŸ¥é”™è¯¯';
      console.error('âŒ æœç´¢å¤±è´¥:', errorMsg);
      showError('æœç´¢å¤±è´¥: ' + errorMsg);
      hideLoading();
      return;
    }
    
    if (!data.companies || data.companies.length === 0) {
      console.warn('âš ï¸  OpenAIè¿”å›çš„å…¬å¸åˆ—è¡¨ä¸ºç©º');
      showWarning('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å…¬å¸ï¼Œè¯·ç¨åé‡è¯•');
      hideLoading();
      return;
    }
    
    // å°†companiesè½¬æ¢ä¸ºcustomersæ ¼å¼
    overseasCustomers = (data.companies || []).map(company => ({
      company_name: company.name || company.company_name,  // æ”¯æŒä¸¤ç§å­—æ®µå
      company_description: company.description,
      email: company.email || '',
      domain: company.domain || (company.website ? company.website.replace(/^https?:\/\/(www\.)?/, '').split('/')[0] : ''),
      website: company.website || '',
      country: company.country,
      city: company.city || '',
      location: company.location || ''
    }));
    
    if (overseasCustomers.length === 0) {
      showInfo('æœªæ‰¾åˆ°æµ·å¤–å®¢æˆ·');
      hideLoading();
      return;
    }
    
    console.log(`âœ… æ‰¾åˆ° ${overseasCustomers.length} ä¸ªæµ·å¤–å®¢æˆ·`);
    
    // æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
    const customerListSection = document.getElementById('customerListSection');
    if (customerListSection) {
      customerListSection.style.display = 'block';
    }
    
    renderOverseasCustomers();
    showSuccess(`æ‰¾åˆ° ${overseasCustomers.length} ä¸ªæµ·å¤–å®¢æˆ·`);
    
    // æ›´æ–°å†å²è®°å½•æ•°é‡
    updateHistoryCount();
    
  } catch (error) {
    console.error('âŒ æœç´¢æµ·å¤–å®¢æˆ·å¤±è´¥:', error);
    showError('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ¸²æŸ“æµ·å¤–å®¢æˆ·åˆ—è¡¨
function renderOverseasCustomers() {
  const tbody = document.getElementById('overseasCustomerTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°å®¢æˆ·åˆ—è¡¨è¡¨æ ¼');
    return;
  }
  
  let html = '';
  
  overseasCustomers.forEach((customer, index) => {
    html += `
      <tr>
        <td>${index + 1}</td>
        <td>${customer.company_name}</td>
        <td>${customer.company_description || '-'}</td>
        <td>${customer.domain || '-'}</td>
        <td>${customer.country || '-'}</td>
        <td>${customer.city || customer.location || '-'}</td>
        <td style="white-space: nowrap;">
          <button class="btn btn-primary btn-sm" 
                  onclick="searchCompanyContacts('${customer.company_name.replace(/'/g, "\\'")}', '${customer.domain}')" 
                  title="æœç´¢è”ç³»äºº"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  style="min-width: 40px;">
            <i class="bi bi-person-lines-fill"></i>
          </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  console.log('âœ… å®¢æˆ·åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
  
  // åˆå§‹åŒ–Bootstrap Tooltip
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltipTriggerList.forEach(tooltipTriggerEl => {
    new bootstrap.Tooltip(tooltipTriggerEl);
  });
}

// æœç´¢å…¬å¸è”ç³»äºº
async function searchCompanyContacts(companyName, domain) {
  console.log('âœ… æœç´¢è”ç³»äººæŒ‰é’®è¢«ç‚¹å‡»');
  console.log('  - å…¬å¸åç§°:', companyName);
  console.log('  - åŸŸå:', domain);
  
  if (!domain) {
    showWarning('è¯¥å…¬å¸æ²¡æœ‰åŸŸåä¿¡æ¯ï¼Œæ— æ³•æœç´¢è”ç³»äºº');
    return;
  }
  
  try {
    showLoading();
    
    // è·å–token
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    console.log('ğŸ”„ è°ƒç”¨Hunter.ioæ¥å£æœç´¢è”ç³»äºº...');
    
    // ä½¿ç”¨fetchè°ƒç”¨Hunter.ioæ¥å£ï¼Œé¿å…baseURLé‡å¤é—®é¢˜
    const url = `/api/hunter/domain-search?domain=${encodeURIComponent(domain)}&limit=10`;
    console.log('ğŸ“ è¯·æ±‚URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ Hunter.ioå“åº”:', data);
    
    if (!data.success) {
      showError('æœç´¢è”ç³»äººå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    const contacts = data.contacts || [];
    
    if (contacts.length === 0) {
      showInfo('æœªæ‰¾åˆ°è”ç³»äºº');
      hideLoading();
      return;
    }
    
    console.log(`âœ… æ‰¾åˆ° ${contacts.length} ä¸ªè”ç³»äºº`);
    
    // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›åç»­ä½¿ç”¨
    window.hunterContacts = contacts;
    
    // å…ˆåŠ è½½å·²å­˜åœ¨çš„è”ç³»äººé‚®ç®±åˆ—è¡¨
    await loadExistingContacts();
    
    // æ˜¾ç¤ºè”ç³»äººåˆ—è¡¨æ¨¡æ€æ¡†
    const modalLabel = document.getElementById('contactListModalLabel');
    if (modalLabel) {
      modalLabel.textContent = `${companyName} - æ½œåœ¨è”ç³»äººåˆ—è¡¨`;
    }
    
    renderContactList(contacts);
    
    // ç¡®ä¿è”ç³»äººæ¨¡æ€æ¡†åœ¨å†å²è®°å½•æ¨¡æ€æ¡†ä¹‹ä¸Š
    const contactModal = document.getElementById('contactListModal');
    const historyModal = document.getElementById('searchHistoryModal');
    
    // è®¾ç½®è”ç³»äººæ¨¡æ€æ¡†çš„z-indexé«˜äºå†å²è®°å½•
    contactModal.style.zIndex = '2060';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(contactModal);
    modal.show();
    
    // æ¨¡æ€æ¡†æ˜¾ç¤ºåå†æ¬¡ç¡®ä¿z-index
    setTimeout(() => {
      const contactBackdrop = document.querySelectorAll('.modal-backdrop');
      if (contactBackdrop.length > 0) {
        contactBackdrop[contactBackdrop.length - 1].style.zIndex = '2050';
      }
      contactModal.style.zIndex = '2060';
    }, 100);
    
  } catch (error) {
    console.error('âŒ æœç´¢è”ç³»äººå¤±è´¥:', error);
    showError('æœç´¢è”ç³»äººå¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ¸²æŸ“è”ç³»äººåˆ—è¡¨
function renderContactList(contacts) {
  const tbody = document.getElementById('contactListTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°è”ç³»äººåˆ—è¡¨è¡¨æ ¼');
    return;
  }
  
  let html = '';
  
  contacts.forEach((contact, index) => {
    const isExisting = checkIfContactExists(contact.email);
    const contactName = contact.name || `${contact.first_name || ''} ${contact.last_name || ''}`.trim();
    
    html += `
      <tr>
        <td>
          <input type="checkbox" class="contact-checkbox" value="${index}" ${isExisting ? 'disabled' : ''}>
        </td>
        <td>${contactName || '-'}</td>
        <td>${contact.position || '-'}</td>
        <td>${contact.company || '-'}</td>
        <td>${contact.email}</td>
        <td>${contact.description || '-'}</td>
        <td style="white-space: nowrap;">
          ${isExisting ? 
            '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å·²æ·»åŠ </span>' :
            `<button class="btn btn-primary btn-sm" onclick="addContact(${index}); return false;" style="min-width: 70px;">
              <i class="bi bi-plus-lg"></i>
            </button>`
          }
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  updateSelectedContactsCount();
  console.log('âœ… è”ç³»äººåˆ—è¡¨æ¸²æŸ“å®Œæˆ');
}

// å…¨å±€å˜é‡ï¼šå·²å­˜åœ¨çš„è”ç³»äººé‚®ç®±åˆ—è¡¨
let existingContactEmails = new Set();

// åŠ è½½å·²å­˜åœ¨çš„è”ç³»äºº
async function loadExistingContacts() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/contacts/?pageSize=1000', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success && data.contacts) {
      existingContactEmails = new Set(data.contacts.map(c => c.email.toLowerCase()));
      console.log('âœ… å·²åŠ è½½ç°æœ‰è”ç³»äººé‚®ç®±åˆ—è¡¨ï¼Œå…±', existingContactEmails.size, 'ä¸ª');
    }
  } catch (error) {
    console.error('åŠ è½½ç°æœ‰è”ç³»äººå¤±è´¥:', error);
  }
}

// æ£€æŸ¥è”ç³»äººæ˜¯å¦å·²å­˜åœ¨
function checkIfContactExists(email) {
  return existingContactEmails.has(email.toLowerCase());
}

// æ·»åŠ è”ç³»äºº
async function addContact(index) {
  console.log('âœ… æ·»åŠ è”ç³»äººæŒ‰é’®è¢«ç‚¹å‡»:', index);
  const contact = window.hunterContacts[index];
  
  if (!contact) {
    showError('è”ç³»äººä¿¡æ¯é”™è¯¯');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (checkIfContactExists(contact.email)) {
    showInfo('è¯¥è”ç³»äººå·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ ');
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/contacts/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: contact.name || `${contact.first_name} ${contact.last_name}`,
        first_name: contact.first_name,
        last_name: contact.last_name,
        email: contact.email,
        company: contact.company,
        domain: contact.domain,
        position: contact.position
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      console.log('âœ… è”ç³»äººæ·»åŠ æˆåŠŸ');
      
      // æ·»åŠ åˆ°å·²å­˜åœ¨é‚®ç®±åˆ—è¡¨
      existingContactEmails.add(contact.email.toLowerCase());
      
      // é‡æ–°æ¸²æŸ“è”ç³»äººåˆ—è¡¨ï¼ŒæŒ‰é’®ä¼šå˜æˆ"å·²æ˜¯è”ç³»äºº"
      renderContactList(window.hunterContacts);
      
      showSuccess('è”ç³»äººæ·»åŠ æˆåŠŸ');
    } else {
      showError('æ·»åŠ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
    
  } catch (error) {
    console.error('âŒ æ·»åŠ è”ç³»äººå¤±è´¥:', error);
    showError('æ·»åŠ è”ç³»äººå¤±è´¥: ' + error.message);
  }
}

// å…¨é€‰è”ç³»äºº
function selectAllContacts() {
  const checkboxes = document.querySelectorAll('.contact-checkbox:not(:disabled)');
  checkboxes.forEach(cb => cb.checked = true);
  updateSelectedContactsCount();
}

// å–æ¶ˆå…¨é€‰
function clearContactSelection() {
  const checkboxes = document.querySelectorAll('.contact-checkbox');
  checkboxes.forEach(cb => cb.checked = false);
  updateSelectedContactsCount();
}

// åˆ‡æ¢å…¨é€‰
function toggleAllContacts() {
  const selectAll = document.getElementById('selectAllContacts');
  const isChecked = selectAll ? selectAll.checked : false;
  const checkboxes = document.querySelectorAll('.contact-checkbox:not(:disabled)');
  checkboxes.forEach(cb => cb.checked = isChecked);
  updateSelectedContactsCount();
}

// æ›´æ–°é€‰ä¸­è”ç³»äººæ•°é‡
function updateSelectedContactsCount() {
  const selectedCount = document.querySelectorAll('.contact-checkbox:checked').length;
  const countElement = document.getElementById('selectedContactsCount');
  if (countElement) {
    countElement.textContent = `å·²é€‰æ‹© ${selectedCount} äºº`;
  }
}

// æ‰¹é‡æ·»åŠ è”ç³»äºº
async function batchAddContacts() {
  const selectedContacts = getSelectedContacts();
  
  if (selectedContacts.length === 0) {
    showWarning('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªè”ç³»äºº');
    return;
  }
  
  console.log(`ğŸ“¦ å‡†å¤‡æ‰¹é‡æ·»åŠ  ${selectedContacts.length} ä¸ªè”ç³»äºº`);
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    // è°ƒç”¨æ‰¹é‡åˆ›å»ºæ¥å£
    const response = await fetch('/api/contacts/batch', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ contacts: selectedContacts })
    });
    
    const data = await response.json();
    
    if (data.success) {
      const { success_count, duplicate_count, failed_count, success, duplicate } = data.results;
      
      let message = `æˆåŠŸæ·»åŠ  ${success_count} ä¸ªè”ç³»äºº`;
      if (duplicate_count > 0) {
        message += `ï¼Œ${duplicate_count} ä¸ªå·²å­˜åœ¨`;
      }
      if (failed_count > 0) {
        message += `ï¼Œ${failed_count} ä¸ªå¤±è´¥`;
      }
      
      showSuccess(message);
      
      // æ›´æ–°è¡¨æ ¼ä¸­çš„æŒ‰é’®çŠ¶æ€ï¼Œæ ‡è®°å“ªäº›å·²æ·»åŠ 
      const successEmails = success.map(c => c.email);
      const duplicateEmails = duplicate.map(c => c.email);
      
      document.querySelectorAll('.contact-checkbox:checked').forEach(checkbox => {
        const row = checkbox.closest('tr');
        const index = parseInt(checkbox.value);
        const contact = window.hunterContacts[index];
        
        if (successEmails.includes(contact.email)) {
          // æˆåŠŸæ·»åŠ ï¼šç¦ç”¨å¤é€‰æ¡†ï¼Œæ˜¾ç¤ºæˆåŠŸæ ‡è®°
          checkbox.disabled = true;
          checkbox.checked = false;
          const statusCell = row.querySelector('td:last-child');
          statusCell.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å·²æ·»åŠ </span>';
        } else if (duplicateEmails.includes(contact.email)) {
          // å·²å­˜åœ¨ï¼šç¦ç”¨å¤é€‰æ¡†ï¼Œæ˜¾ç¤ºå·²å­˜åœ¨æ ‡è®°
          checkbox.disabled = true;
          checkbox.checked = false;
          const statusCell = row.querySelector('td:last-child');
          statusCell.innerHTML = '<span class="badge bg-warning"><i class="bi bi-info-circle"></i> å·²å­˜åœ¨</span>';
        }
      });
      
      // æ›´æ–°é€‰ä¸­æ•°é‡
      updateSelectedContactsCount();
      
      console.log('âœ… æ‰¹é‡æ·»åŠ å®Œæˆ:', data.results);
    } else {
      showError('æ‰¹é‡æ·»åŠ å¤±è´¥: ' + data.message);
    }
    
  } catch (error) {
    console.error('âŒ æ‰¹é‡æ·»åŠ è”ç³»äººå¤±è´¥:', error);
    showError('æ‰¹é‡æ·»åŠ å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// è·å–é€‰ä¸­çš„è”ç³»äºº
function getSelectedContacts() {
  const selected = [];
  document.querySelectorAll('.contact-checkbox:checked').forEach(checkbox => {
    const index = parseInt(checkbox.value);
    if (window.hunterContacts && window.hunterContacts[index]) {
    selected.push(window.hunterContacts[index]);
    }
  });
  return selected;
}

// è¿‡æ»¤è”ç³»äººåˆ—è¡¨
function filterContactList() {
  const searchInput = document.getElementById('contactSearchInput');
  const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  
  const tbody = document.getElementById('contactListTableBody');
  if (!tbody) return;
  
  const rows = tbody.querySelectorAll('tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// å¯¼å‡ºå®¢æˆ·
function exportCustomers() {
  if (overseasCustomers.length === 0) {
    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å®¢æˆ·æ•°æ®', 'warning');
    return;
  }
  
  // åˆ›å»ºCSVå†…å®¹
  let csvContent = 'åºå·,å…¬å¸åç§°,å…¬å¸ç®€ä»‹,åŸŸå,å›½å®¶,åŸå¸‚\n';
  overseasCustomers.forEach((customer, index) => {
    const city = customer.city || customer.location || '-';
    csvContent += `${index + 1},"${customer.company_name}","${customer.company_description}","${customer.domain}","${customer.country}","${city}"\n`;
  });
  
  // ä¸‹è½½CSVæ–‡ä»¶
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'æµ·å¤–å®¢æˆ·åˆ—è¡¨.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast('å®¢æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
}

// æŒ‰å›½å®¶ç­›é€‰
function filterByCountry(country) {
  // å®ç°æŒ‰å›½å®¶ç­›é€‰å®¢æˆ·çš„åŠŸèƒ½
  console.log('æŒ‰å›½å®¶ç­›é€‰:', country);
}

// åˆ›å»ºæ–°æ¨¡æ¿
function createNewTemplate() {
  window.location.href = '/emails/templates';
}

// å·¥å…·å‡½æ•°
function showLoading() {
  // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§é®ç½©
  hideLoading();
  
  console.log('ğŸ”„ æ˜¾ç¤ºåŠ è½½ä¸­...');
  const loadingHTML = `
    <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
          </div>
  `;
  document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
  console.log('âœ… éšè—åŠ è½½ä¸­');
  const loading = document.getElementById('loadingOverlay');
  if (loading) {
    loading.remove();
  }
}

// ==================== Toastæç¤ºå‡½æ•° ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
        </div>
      `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

// ==================== æœç´¢å†å²è®°å½•åŠŸèƒ½ ====================

// æ˜¾ç¤ºæœç´¢å†å²æ¨¡æ€æ¡†
async function showSearchHistory() {
  const modalElement = document.getElementById('searchHistoryModal');
  const modal = new bootstrap.Modal(modalElement);
  
  // ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ï¼Œè‡ªåŠ¨æ¸…ç©ºé€‰ä¸­çŠ¶æ€
  modalElement.addEventListener('hidden.bs.modal', function() {
    clearHistorySelection();
  }, { once: true });
  
  modal.show();
  
  // åŠ è½½ç»Ÿè®¡æ•°æ®å’Œå†å²è®°å½•
  await loadHistoryStats();
  await loadSearchHistory(1);
}

// åŠ è½½å†å²ç»Ÿè®¡
async function loadHistoryStats() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/overseas/search-history/stats', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.stats) {
      document.getElementById('statsTotal').textContent = data.stats.total || 0;
      document.getElementById('historyCount').textContent = data.stats.total || 0;
    }
  } catch (error) {
    console.error('åŠ è½½å†å²ç»Ÿè®¡å¤±è´¥:', error);
  }
}

// åŠ è½½æœç´¢å†å²åˆ—è¡¨
async function loadSearchHistory(page = 1) {
  try {
    currentHistoryPage = page;
    
    const search = document.getElementById('historySearch').value;
    
    const token = localStorage.getItem('authToken');
    let url = `/api/overseas/search-history?page=${page}&pageSize=20`;
    
    if (search) {
      url += `&search=${encodeURIComponent(search)}`;
    }
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      renderHistoryTable(data.histories || []);
      renderHistoryPagination(data.page, data.totalPages);
    } else {
      showError('åŠ è½½å†å²è®°å½•å¤±è´¥');
    }
  } catch (error) {
    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
    showError('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + error.message);
  }
}

// æ¸²æŸ“å†å²è®°å½•è¡¨æ ¼
function renderHistoryTable(histories) {
  const tbody = document.getElementById('historyTableBody');
  
  if (histories.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center p-4">
          <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
          <p class="text-muted mt-2">æš‚æ— æœç´¢å†å²</p>
        </td>
      </tr>
    `;
    
    // æ¸…é™¤è¡¨å¤´å…¨é€‰çŠ¶æ€
    const selectAllCheckbox = document.getElementById('selectAllHistory');
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
    }
    
    return;
  }
  
  let html = '';
  histories.forEach((history, index) => {
    const startIndex = (currentHistoryPage - 1) * 20 + index + 1;
    const isChecked = selectedHistoryIds.has(history.id);  // æ£€æŸ¥æ˜¯å¦åœ¨è·¨é¡µé€‰ä¸­é›†åˆä¸­
    
    html += `
      <tr>
        <td>
          <input type="checkbox" class="history-checkbox" value="${history.id}" 
                 onchange="toggleHistorySelection(${history.id})" 
                 ${isChecked ? 'checked' : ''}>
        </td>
        <td>${startIndex}</td>
        <td><strong>${history.company_name}</strong></td>
        <td>
          <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
               title="${history.company_description || '-'}">
            ${history.company_description || '-'}
      </div>
        </td>
        <td>
          ${history.company_website ? `
            <a href="${history.company_website}" target="_blank" class="text-decoration-none">
              ${history.company_domain || history.company_website}
              <i class="bi bi-box-arrow-up-right ms-1"></i>
            </a>
          ` : '-'}
        </td>
        <td>${history.company_location || '-'}</td>
        <td><small>${new Date(history.created_at).toLocaleDateString('zh-CN')}</small></td>
        <td style="white-space: nowrap;">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" 
                    onclick="searchCompanyContacts('${history.company_name.replace(/'/g, "\\'")}', '${history.company_domain || ''}')" 
                    title="æœç´¢è”ç³»äºº"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    style="min-width: 40px;">
              <i class="bi bi-person-lines-fill"></i>
            </button>
            <button class="btn btn-outline-danger" 
                    onclick="deleteHistory(${history.id})" 
                    title="åˆ é™¤"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    style="min-width: 40px;">
              <i class="bi bi-trash"></i>
            </button>
      </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  
  // æ›´æ–°è¡¨å¤´å…¨é€‰çŠ¶æ€
  updateSelectAllHistoryCheckbox();
  
  // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
  updateHistoryCheckCount();
  
  // åˆå§‹åŒ–Bootstrap Tooltip
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltipTriggerList.forEach(tooltipTriggerEl => {
    new bootstrap.Tooltip(tooltipTriggerEl);
  });
}

// æ¸²æŸ“å†å²è®°å½•åˆ†é¡µ
function renderHistoryPagination(current, total) {
  const pagination = document.getElementById('historyPagination');
  
  if (total <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadSearchHistory(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;
  
  // é¡µç 
  for (let i = 1; i <= total; i++) {
    if (i === 1 || i === total || (i >= current - 2 && i <= current + 2)) {
      html += `
        <li class="page-item ${i === current ? 'active' : ''}">
          <a class="page-link" href="#" onclick="loadSearchHistory(${i}); return false;">${i}</a>
        </li>
      `;
    } else if (i === current - 3 || i === current + 3) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadSearchHistory(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;
  
  pagination.innerHTML = html;
}

// åˆ é™¤å†å²è®°å½•ï¼ˆå•ä¸ªï¼‰
async function deleteHistory(historyId) {
  // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—è€Œä¸æ˜¯åŸç”Ÿconfirm
  if (!await showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ', 'åˆ é™¤åæ— æ³•æ¢å¤')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch(`/api/overseas/search-history/${historyId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('åˆ é™¤æˆåŠŸ');
      
      // ä»é€‰ä¸­é›†åˆä¸­ç§»é™¤
      selectedHistoryIds.delete(historyId);
      
      // æ£€æŸ¥å½“å‰é¡µæ˜¯å¦åªæœ‰è¿™ä¸€æ¡è®°å½•
      const currentPageHistories = document.querySelectorAll('.history-checkbox').length;
      let targetPage = currentHistoryPage;
      
      if (currentPageHistories <= 1 && currentHistoryPage > 1) {
        targetPage = currentHistoryPage - 1;
      }
      
      await loadSearchHistory(targetPage);
      await loadHistoryStats();
      updateHistoryCheckCount();
    } else {
      showError('åˆ é™¤å¤±è´¥');
    }
  } catch (error) {
    console.error('åˆ é™¤å¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥');
  }
}

// æ‰¹é‡åˆ é™¤å†å²è®°å½•
async function batchDeleteHistory() {
  const selectedIds = getSelectedHistoryIds();
  
  if (selectedIds.length === 0) {
    showWarning('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
    return;
  }
  
  // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
  if (!await showConfirmDialog(
    `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡å†å²è®°å½•å—ï¼Ÿ`,
    'åˆ é™¤åæ— æ³•æ¢å¤'
  )) {
    return;
  }
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/overseas/search-history/batch-delete', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ ids: selectedIds })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess(`æˆåŠŸåˆ é™¤ ${data.deleted_count} æ¡è®°å½•`);
      
      // æ¸…ç©ºé€‰ä¸­é›†åˆ
      selectedHistoryIds.clear();
      
      // æ¸…é™¤è¡¨å¤´çš„å…¨é€‰å¤é€‰æ¡†
      const selectAllCheckbox = document.getElementById('selectAllHistory');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
      
      // é‡æ–°åŠ è½½å½“å‰é¡µï¼Œå¦‚æœå½“å‰é¡µä¸ºç©ºåˆ™è·³è½¬åˆ°ä¸Šä¸€é¡µ
      const currentPageHistories = document.querySelectorAll('.history-checkbox').length;
      const deletedOnCurrentPage = selectedIds.filter(id => {
        const checkbox = document.querySelector(`.history-checkbox[value="${id}"]`);
        return checkbox !== null;
      }).length;
      
      // å¦‚æœå½“å‰é¡µæ‰€æœ‰è®°å½•éƒ½è¢«åˆ é™¤äº†ï¼Œè·³è½¬åˆ°ä¸Šä¸€é¡µæˆ–ç¬¬ä¸€é¡µ
      let targetPage = currentHistoryPage;
      if (deletedOnCurrentPage >= currentPageHistories && currentHistoryPage > 1) {
        targetPage = currentHistoryPage - 1;
      }
      
      await loadSearchHistory(targetPage);
      await loadHistoryStats();
      
      // é‡ç½®é€‰ä¸­æ•°é‡
      updateHistoryCheckCount();
    } else {
      showError('æ‰¹é‡åˆ é™¤å¤±è´¥');
    }
  } catch (error) {
    console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
    showError('æ‰¹é‡åˆ é™¤å¤±è´¥');
  } finally {
    hideLoading();
  }
}

// åˆ‡æ¢å•ä¸ªå†å²è®°å½•çš„é€‰ä¸­çŠ¶æ€
function toggleHistorySelection(historyId) {
  const checkbox = document.querySelector(`.history-checkbox[value="${historyId}"]`);
  
  if (checkbox && checkbox.checked) {
    selectedHistoryIds.add(historyId);
  } else {
    selectedHistoryIds.delete(historyId);
  }
  
  updateHistoryCheckCount();
  updateSelectAllHistoryCheckbox();
}

// è·å–é€‰ä¸­çš„å†å²è®°å½•IDï¼ˆåŒ…æ‹¬è·¨é¡µé€‰ä¸­çš„ï¼‰
function getSelectedHistoryIds() {
  return Array.from(selectedHistoryIds);
}

// æ›´æ–°é€‰ä¸­çš„å†å²è®°å½•æ•°é‡
function updateHistoryCheckCount() {
  const count = selectedHistoryIds.size;
  const countElement = document.getElementById('selectedHistoryCount');
  if (countElement) {
    countElement.textContent = count;
  }
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰å†å²è®°å½•ï¼ˆä»…å½“å‰é¡µï¼‰
function toggleAllHistory() {
  const selectAll = document.getElementById('selectAllHistory');
  const checkboxes = document.querySelectorAll('.history-checkbox');
  
  checkboxes.forEach(checkbox => {
    if (!checkbox.disabled) {
      const historyId = parseInt(checkbox.value);
      
      if (selectAll.checked) {
        selectedHistoryIds.add(historyId);
        checkbox.checked = true;
      } else {
        selectedHistoryIds.delete(historyId);
        checkbox.checked = false;
      }
    }
  });
  
  updateHistoryCheckCount();
}

// æ›´æ–°è¡¨å¤´å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
function updateSelectAllHistoryCheckbox() {
  const selectAll = document.getElementById('selectAllHistory');
  if (!selectAll) return;
  
  const checkboxes = document.querySelectorAll('.history-checkbox');
  const checkedCheckboxes = document.querySelectorAll('.history-checkbox:checked');
  
  if (checkboxes.length === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else if (checkedCheckboxes.length === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else if (checkedCheckboxes.length === checkboxes.length) {
    selectAll.checked = true;
    selectAll.indeterminate = false;
  } else {
    selectAll.checked = false;
    selectAll.indeterminate = true;  // éƒ¨åˆ†é€‰ä¸­çŠ¶æ€
  }
}

// æ¸…ç©ºå†å²è®°å½•é€‰ä¸­çŠ¶æ€
function clearHistorySelection() {
  console.log('ğŸ§¹ æ¸…ç©ºå†å²è®°å½•é€‰ä¸­çŠ¶æ€');
  
  // æ¸…ç©ºå…¨å±€é€‰ä¸­é›†åˆ
  selectedHistoryIds.clear();
  
  // æ¸…é™¤æ‰€æœ‰å¤é€‰æ¡†
  document.querySelectorAll('.history-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  // æ¸…é™¤è¡¨å¤´å…¨é€‰
  const selectAll = document.getElementById('selectAllHistory');
  if (selectAll) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  }
  
  // æ›´æ–°è®¡æ•°
  updateHistoryCheckCount();
}

// è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
function showConfirmDialog(message, subtitle = '') {
  return new Promise((resolve) => {
    // åˆ›å»ºç¡®è®¤å¼¹çª—
    const modalHTML = `
      <div class="modal fade" id="confirmDialog" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="bi bi-question-circle text-warning"></i> ç¡®è®¤æ“ä½œ
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2">${message}</p>
              ${subtitle ? `<small class="text-muted">${subtitle}</small>` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="window.confirmDialogResolve(false)">
                å–æ¶ˆ
              </button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="window.confirmDialogResolve(true)">
                ç¡®å®šåˆ é™¤
              </button>
            </div>
          </div>
      </div>
    </div>
  `;
    
    // ç§»é™¤æ—§çš„ç¡®è®¤å¼¹çª—
    const oldModal = document.getElementById('confirmDialog');
    if (oldModal) oldModal.remove();
    
    // æ·»åŠ æ–°å¼¹çª—
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // è®¾ç½®å…¨å±€resolveå‡½æ•°
    window.confirmDialogResolve = resolve;
    
    // æ˜¾ç¤ºå¼¹çª—
    const modal = new bootstrap.Modal(document.getElementById('confirmDialog'));
    modal.show();
    
    // å¼¹çª—å…³é—­æ—¶å¦‚æœæ²¡æœ‰ç‚¹å‡»æŒ‰é’®ï¼Œé»˜è®¤è¿”å›false
    document.getElementById('confirmDialog').addEventListener('hidden.bs.modal', () => {
      if (window.confirmDialogResolve) {
        const resolver = window.confirmDialogResolve;
        window.confirmDialogResolve = null;
        resolver(false);
      }
    }, { once: true });
  });
}

// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•ç»Ÿè®¡
async function updateHistoryCount() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/overseas/search-history/stats', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.stats) {
      document.getElementById('historyCount').textContent = data.stats.total || 0;
    }
  } catch (error) {
    console.error('è·å–å†å²ç»Ÿè®¡å¤±è´¥:', error);
  }
}

// é˜²æŠ–æœç´¢å†å²
let historySearchTimeout;
function debounceHistorySearch() {
  clearTimeout(historySearchTimeout);
  historySearchTimeout = setTimeout(() => {
    loadSearchHistory(1);
  }, 500);
}

// å¯¼å‡ºé€‰ä¸­çš„å†å²è®°å½•
async function exportSelectedHistory() {
  const selectedIds = getSelectedHistoryIds();
  
  if (selectedIds.length === 0) {
    showWarning('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è®°å½•');
      return;
    }
    
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    // è·å–é€‰ä¸­çš„å†å²è®°å½•è¯¦ç»†æ•°æ®
    const promises = selectedIds.map(id => 
      fetch(`/api/overseas/search-history?page=1&pageSize=1000`, {
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(r => r.json())
    );
    
    // ç®€åŒ–ï¼šç›´æ¥ä»å½“å‰é¡µé¢çš„æ•°æ®ä¸­ç­›é€‰
    const allCheckboxes = document.querySelectorAll('.history-checkbox:checked');
    const selectedHistories = [];
    
    allCheckboxes.forEach(checkbox => {
      const row = checkbox.closest('tr');
      const cells = row.querySelectorAll('td');
      
      selectedHistories.push({
        company_name: cells[2].textContent.trim(),
        company_description: cells[3].textContent.trim(),
        company_domain: cells[4].textContent.trim(),
        company_location: cells[5].textContent.trim(),
        created_at: cells[6].textContent.trim()
      });
    });
    
    exportToCSV(selectedHistories, 'æœç´¢å†å²è®°å½•_é€‰ä¸­.csv');
    showSuccess(`æˆåŠŸå¯¼å‡º ${selectedHistories.length} æ¡è®°å½•`);
    
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    showError('å¯¼å‡ºå¤±è´¥');
  } finally {
    hideLoading();
  }
}

// å¯¼å‡ºå…¨éƒ¨å†å²è®°å½•
async function exportAllHistory() {
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    // è·å–æ‰€æœ‰å†å²è®°å½•ï¼ˆä¸åˆ†é¡µï¼‰
    const response = await fetch('/api/overseas/search-history?page=1&pageSize=10000', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success || !data.histories || data.histories.length === 0) {
      showWarning('æ²¡æœ‰å¯å¯¼å‡ºçš„å†å²è®°å½•');
      hideLoading();
    return;
  }
  
    exportToCSV(data.histories, 'æœç´¢å†å²è®°å½•_å…¨éƒ¨.csv');
    showSuccess(`æˆåŠŸå¯¼å‡º ${data.histories.length} æ¡è®°å½•`);
    
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    showError('å¯¼å‡ºå¤±è´¥');
  } finally {
    hideLoading();
  }
}

// é€šç”¨CSVå¯¼å‡ºå‡½æ•°
function exportToCSV(histories, filename) {
  // åˆ›å»ºCSVå†…å®¹
  let csvContent = '\uFEFF';  // UTF-8 BOMï¼Œç¡®ä¿Excelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡
  csvContent += 'åºå·,å…¬å¸åç§°,å…¬å¸ç®€ä»‹,ç½‘ç«™,åŸŸå,ä½ç½®,å›½å®¶,æœç´¢æ—¶é—´\n';
  
  histories.forEach((history, index) => {
    const name = history.company_name || '';
    const desc = (history.company_description || '-').replace(/"/g, '""').replace(/\n/g, ' ');
    const website = history.company_website || '-';
    const domain = history.company_domain || '-';
    const location = history.company_location || '-';
    const country = history.country || '-';
    const time = history.created_at ? new Date(history.created_at).toLocaleString('zh-CN') : '-';
    
    csvContent += `${index + 1},"${name}","${desc}","${website}","${domain}","${location}","${country}","${time}"\n`;
  });
  
  // ä¸‹è½½CSVæ–‡ä»¶
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
</script>
