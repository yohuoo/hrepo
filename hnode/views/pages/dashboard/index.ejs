<!-- æµ·å¤–å®¢æˆ·æœç´¢ä¸»é¡µé¢ -->
<div class="overseas-search-hero">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="search-hero-card">
          <div class="search-hero-content">
            <h1 class="search-title">æµ·å¤–å®¢æˆ·æœç´¢</h1>
            <p class="search-description">é€šè¿‡AIæ™ºèƒ½åˆ†æï¼Œå¿«é€Ÿè·å–æ½œåœ¨æµ·å¤–å®¢æˆ·åˆ—è¡¨ï¼Œæå‡é”€å”®æ•ˆç‡</p>
            <button class="btn btn-primary btn-lg search-btn" id="searchButton">
              <i class="bi bi-search"></i> æœç´¢æ½œåœ¨å®¢æˆ·
            </button>
            <p class="search-hint">ç‚¹å‡»æŒ‰é’®è·å–AIæ¨èçš„æµ·å¤–å®¢æˆ·åˆ—è¡¨</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å®¢æˆ·åˆ—è¡¨åŒºåŸŸ -->
<div class="container-fluid mt-4" id="customerListSection" style="display: none;">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">å®¢æˆ·åˆ—è¡¨</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="exportCustomers()">
              <i class="bi bi-download"></i> å¯¼å‡º
            </button>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-funnel"></i> ç­›é€‰
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('all')">æ‰€æœ‰å›½å®¶</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('US')">ç¾å›½</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('UK')">è‹±å›½</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('DE')">å¾·å›½</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByCountry('JP')">æ—¥æœ¬</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>åºå·</th>
                  <th>å…¬å¸åç§°</th>
                  <th>å…¬å¸ç®€ä»‹</th>
                  <th>é‚®ç®±</th>
                  <th>åŸŸå</th>
                  <th>å›½å®¶</th>
                  <th>åŸå¸‚</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="overseasCustomerTableBody">
                <!-- å®¢æˆ·æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è”ç³»äººåˆ—è¡¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="contactListModal" tabindex="-1" aria-labelledby="contactListModalLabel">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contactListModalLabel">æ½œåœ¨è”ç³»äººåˆ—è¡¨</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <input type="text" class="form-control" id="contactSearchInput" placeholder="æœç´¢è”ç³»äºº">
          </div>
          <div class="col-md-6">
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" onclick="selectAllContacts()">
                <i class="bi bi-check-square"></i> å…¨é€‰
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="clearContactSelection()">
                <i class="bi bi-square"></i> å–æ¶ˆå…¨é€‰
              </button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th width="50">
                  <input type="checkbox" id="selectAllContacts" onchange="toggleAllContacts()">
                </th>
                <th>å§“å</th>
                <th>èŒä½</th>
                <th>å…¬å¸</th>
                <th>é‚®ç®±</th>
                <th>ç®€ä»‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="contactListTableBody">
              <!-- è”ç³»äººæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <span id="selectedContactsCount">å·²é€‰æ‹© 0 äºº</span>
          </div>
          <div>
            <button class="btn btn-secondary me-2" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="proceedToEmailTemplate()">ä¸‹ä¸€æ­¥</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- é‚®ä»¶æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailTemplateModal" tabindex="-1" aria-labelledby="emailTemplateModalLabel">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailTemplateModalLabel">é€‰æ‹©é‚®ä»¶æ¨¡æ¿</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6>é‚®ä»¶æ¨¡æ¿</h6>
                <button class="btn btn-sm btn-primary" onclick="createNewTemplate()">
                  <i class="bi bi-plus"></i> æ–°å»º
                </button>
              </div>
              <div class="card-body">
                <div class="list-group" id="templateList">
                  <!-- æ¨¡æ¿åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h6>é‚®ä»¶é¢„è§ˆ</h6>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-primary" onclick="previousPreview()">
                    <i class="bi bi-chevron-left"></i> ä¸Šä¸€ä¸ª
                  </button>
                  <button class="btn btn-sm btn-outline-primary" onclick="nextPreview()">
                    ä¸‹ä¸€ä¸ª <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div id="emailPreviewContent">
                  <!-- é‚®ä»¶é¢„è§ˆå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="proceedToEmailSettings()">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
  </div>
</div>

<!-- é‚®ä»¶å‘é€è®¾ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailSettingsModal" tabindex="-1" aria-labelledby="emailSettingsModalLabel">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailSettingsModalLabel">é‚®ä»¶å‘é€è®¾ç½®</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">é€‰æ‹©å‘ä»¶é‚®ç®±</label>
          <select class="form-select" id="senderEmailSelect">
            <!-- å‘ä»¶é‚®ç®±é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">å‘é€æ—¶é—´</label>
          <select class="form-select" id="sendTimeSelect">
            <option value="immediate">ç«‹å³å‘é€</option>
            <option value="scheduled">å®šæ—¶å‘é€</option>
          </select>
        </div>
        <div class="mb-3" id="scheduleTimeDiv" style="display: none;">
          <label class="form-label">å‘é€æ—¶é—´</label>
          <input type="datetime-local" class="form-control" id="scheduleTime">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="sendEmails()">
          <i class="bi bi-send"></i> å‘é€é‚®ä»¶
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let overseasCustomers = [];
let selectedContacts = [];
let currentTemplate = null;
let currentPreviewIndex = 0;
let emailPreviews = [];

// ä½¿ç”¨åŸç”ŸJavaScript
document.addEventListener('DOMContentLoaded', function() {
  console.log('âœ… æµ·å¤–å®¢æˆ·æœç´¢é¡µé¢å·²åŠ è½½');
  initializePage();
  
  // å¤‡ç”¨æ–¹æ¡ˆï¼šé€šè¿‡JavaScriptç»‘å®šç‚¹å‡»äº‹ä»¶
  const searchBtn = document.querySelector('.search-btn');
  if (searchBtn) {
    console.log('âœ… æ‰¾åˆ°æœç´¢æŒ‰é’®ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶');
    searchBtn.addEventListener('click', function(e) {
      console.log('ğŸ–±ï¸ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ˆé€šè¿‡addEventListenerï¼‰');
      e.preventDefault();
      searchOverseasCustomers();
    });
  } else {
    console.error('âŒ æœªæ‰¾åˆ°æœç´¢æŒ‰é’®');
  }
});

function initializePage() {
  console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
}

// æœç´¢æµ·å¤–å®¢æˆ·
async function searchOverseasCustomers() {
  console.log('âœ… æœç´¢æŒ‰é’®è¢«ç‚¹å‡»');
  
  try {
    showLoading();
    
    console.log('ğŸ”„ è°ƒç”¨åç«¯æµ·å¤–å®¢æˆ·æœç´¢æ¥å£...');
    
    // è·å–token
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    // ä½¿ç”¨fetchè°ƒç”¨æ­£ç¡®çš„æ¥å£
    const response = await fetch('/api/overseas/companies/sugar-free', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    console.log('ğŸ“¥ æœåŠ¡å™¨å“åº”:', data);
    
    if (!data.success) {
      showError('æœç´¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    // å°†companiesè½¬æ¢ä¸ºcustomersæ ¼å¼
    overseasCustomers = (data.companies || []).map(company => ({
      company_name: company.company_name,
      company_description: company.description,
      email: company.email || '',
      domain: company.website ? company.website.replace(/^https?:\/\/(www\.)?/, '') : '',
      country: company.country,
      city: company.city
    }));
    
    if (overseasCustomers.length === 0) {
      showInfo('æœªæ‰¾åˆ°æµ·å¤–å®¢æˆ·');
      hideLoading();
      return;
    }
    
    console.log(`âœ… æ‰¾åˆ° ${overseasCustomers.length} ä¸ªæµ·å¤–å®¢æˆ·`);
    
    // æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
    const customerListSection = document.getElementById('customerListSection');
    if (customerListSection) {
      customerListSection.style.display = 'block';
    }
    
    renderOverseasCustomers();
    showSuccess(`æ‰¾åˆ° ${overseasCustomers.length} ä¸ªæµ·å¤–å®¢æˆ·`);
    
  } catch (error) {
    console.error('âŒ æœç´¢æµ·å¤–å®¢æˆ·å¤±è´¥:', error);
    showError('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ¸²æŸ“æµ·å¤–å®¢æˆ·åˆ—è¡¨
function renderOverseasCustomers() {
  const tbody = document.getElementById('overseasCustomerTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°å®¢æˆ·åˆ—è¡¨è¡¨æ ¼');
    return;
  }
  
  let html = '';
  
  overseasCustomers.forEach((customer, index) => {
    html += `
      <tr>
        <td>${index + 1}</td>
        <td>${customer.company_name || 'æœªçŸ¥å…¬å¸'}</td>
        <td>${customer.company_description || '-'}</td>
        <td>${customer.email || '-'}</td>
        <td>${customer.domain || '-'}</td>
        <td>${customer.country || '-'}</td>
        <td>${customer.city || '-'}</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="searchCompanyContacts('${customer.company_name}', '${customer.domain}')">
            <i class="bi bi-person-lines-fill"></i> è”ç³»äºº
          </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  console.log('âœ… å®¢æˆ·åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
}

// æœç´¢å…¬å¸è”ç³»äºº
async function searchCompanyContacts(companyName, domain) {
  console.log('âœ… æœç´¢è”ç³»äººæŒ‰é’®è¢«ç‚¹å‡»:', companyName, domain);
  
  try {
    showLoading();
    
    // è·å–token
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    console.log('ğŸ”„ è°ƒç”¨Hunter.ioæ¥å£æœç´¢è”ç³»äºº...');
    
    // ä½¿ç”¨fetchè°ƒç”¨Hunter.ioæ¥å£ï¼Œé¿å…baseURLé‡å¤é—®é¢˜
    const url = `/api/hunter/domain-search?domain=${encodeURIComponent(domain)}&limit=10`;
    console.log('ğŸ“ è¯·æ±‚URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ Hunter.ioå“åº”:', data);
    
    if (!data.success) {
      showError('æœç´¢è”ç³»äººå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    const contacts = data.contacts || [];
    
    if (contacts.length === 0) {
      showInfo('æœªæ‰¾åˆ°è”ç³»äºº');
      hideLoading();
      return;
    }
    
    console.log(`âœ… æ‰¾åˆ° ${contacts.length} ä¸ªè”ç³»äºº`);
    
    // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›åç»­ä½¿ç”¨
    window.hunterContacts = contacts;
    
    // å…ˆåŠ è½½å·²å­˜åœ¨çš„è”ç³»äººé‚®ç®±åˆ—è¡¨
    await loadExistingContacts();
    
    // æ˜¾ç¤ºè”ç³»äººåˆ—è¡¨æ¨¡æ€æ¡†
    const modalLabel = document.getElementById('contactListModalLabel');
    if (modalLabel) {
      modalLabel.textContent = `${companyName} - æ½œåœ¨è”ç³»äººåˆ—è¡¨`;
    }
    
    renderContactList(contacts);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('contactListModal'));
    modal.show();
    
  } catch (error) {
    console.error('âŒ æœç´¢è”ç³»äººå¤±è´¥:', error);
    showError('æœç´¢è”ç³»äººå¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ¸²æŸ“è”ç³»äººåˆ—è¡¨
function renderContactList(contacts) {
  const tbody = document.getElementById('contactListTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°è”ç³»äººåˆ—è¡¨è¡¨æ ¼');
    return;
  }
  
  let html = '';
  
  contacts.forEach((contact, index) => {
    const isExisting = checkIfContactExists(contact.email);
    const contactName = contact.name || `${contact.first_name || ''} ${contact.last_name || ''}`.trim();
    
    html += `
      <tr>
        <td>
          <input type="checkbox" class="contact-checkbox" value="${index}" ${isExisting ? 'disabled' : ''}>
        </td>
        <td>${contactName || '-'}</td>
        <td>${contact.position || '-'}</td>
        <td>${contact.company || '-'}</td>
        <td>${contact.email}</td>
        <td>${contact.description || '-'}</td>
        <td>
          ${isExisting ? 
            '<span class="badge bg-success"><i class="bi bi-check"></i> å·²æ˜¯è”ç³»äºº</span>' :
            `<button class="btn btn-primary btn-sm" onclick="addContact(${index}); return false;">
              <i class="bi bi-plus"></i> æ·»åŠ 
            </button>`
          }
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  updateSelectedContactsCount();
  console.log('âœ… è”ç³»äººåˆ—è¡¨æ¸²æŸ“å®Œæˆ');
}

// å…¨å±€å˜é‡ï¼šå·²å­˜åœ¨çš„è”ç³»äººé‚®ç®±åˆ—è¡¨
let existingContactEmails = new Set();

// åŠ è½½å·²å­˜åœ¨çš„è”ç³»äºº
async function loadExistingContacts() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/contacts/?pageSize=1000', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success && data.contacts) {
      existingContactEmails = new Set(data.contacts.map(c => c.email.toLowerCase()));
      console.log('âœ… å·²åŠ è½½ç°æœ‰è”ç³»äººé‚®ç®±åˆ—è¡¨ï¼Œå…±', existingContactEmails.size, 'ä¸ª');
    }
  } catch (error) {
    console.error('åŠ è½½ç°æœ‰è”ç³»äººå¤±è´¥:', error);
  }
}

// æ£€æŸ¥è”ç³»äººæ˜¯å¦å·²å­˜åœ¨
function checkIfContactExists(email) {
  return existingContactEmails.has(email.toLowerCase());
}

// æ·»åŠ è”ç³»äºº
async function addContact(index) {
  console.log('âœ… æ·»åŠ è”ç³»äººæŒ‰é’®è¢«ç‚¹å‡»:', index);
  const contact = window.hunterContacts[index];
  
  if (!contact) {
    showError('è”ç³»äººä¿¡æ¯é”™è¯¯');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (checkIfContactExists(contact.email)) {
    showInfo('è¯¥è”ç³»äººå·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ ');
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/contacts/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: contact.name || `${contact.first_name} ${contact.last_name}`,
        first_name: contact.first_name,
        last_name: contact.last_name,
        email: contact.email,
        company: contact.company,
        domain: contact.domain,
        position: contact.position
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      console.log('âœ… è”ç³»äººæ·»åŠ æˆåŠŸ');
      
      // æ·»åŠ åˆ°å·²å­˜åœ¨é‚®ç®±åˆ—è¡¨
      existingContactEmails.add(contact.email.toLowerCase());
      
      // é‡æ–°æ¸²æŸ“è”ç³»äººåˆ—è¡¨ï¼ŒæŒ‰é’®ä¼šå˜æˆ"å·²æ˜¯è”ç³»äºº"
      renderContactList(window.hunterContacts);
      
      showSuccess('è”ç³»äººæ·»åŠ æˆåŠŸ');
    } else {
      showError('æ·»åŠ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
    
  } catch (error) {
    console.error('âŒ æ·»åŠ è”ç³»äººå¤±è´¥:', error);
    showError('æ·»åŠ è”ç³»äººå¤±è´¥: ' + error.message);
  }
}

// å…¨é€‰è”ç³»äºº
function selectAllContacts() {
  const checkboxes = document.querySelectorAll('.contact-checkbox:not(:disabled)');
  checkboxes.forEach(cb => cb.checked = true);
  updateSelectedContactsCount();
}

// å–æ¶ˆå…¨é€‰
function clearContactSelection() {
  const checkboxes = document.querySelectorAll('.contact-checkbox');
  checkboxes.forEach(cb => cb.checked = false);
  updateSelectedContactsCount();
}

// åˆ‡æ¢å…¨é€‰
function toggleAllContacts() {
  const selectAll = document.getElementById('selectAllContacts');
  const isChecked = selectAll ? selectAll.checked : false;
  const checkboxes = document.querySelectorAll('.contact-checkbox:not(:disabled)');
  checkboxes.forEach(cb => cb.checked = isChecked);
  updateSelectedContactsCount();
}

// æ›´æ–°é€‰ä¸­è”ç³»äººæ•°é‡
function updateSelectedContactsCount() {
  const selectedCount = document.querySelectorAll('.contact-checkbox:checked').length;
  const countElement = document.getElementById('selectedContactsCount');
  if (countElement) {
    countElement.textContent = `å·²é€‰æ‹© ${selectedCount} äºº`;
  }
}

// è¿›å…¥é‚®ä»¶æ¨¡æ¿é€‰æ‹©
function proceedToEmailTemplate() {
  const selectedContacts = getSelectedContacts();
  
  if (selectedContacts.length === 0) {
    showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªè”ç³»äºº', 'warning');
    return;
  }
  
  // å…³é—­è”ç³»äººåˆ—è¡¨æ¨¡æ€æ¡†
  $('#contactListModal').modal('hide');
  
  // æ˜¾ç¤ºé‚®ä»¶æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†
  loadEmailTemplates();
  $('#emailTemplateModal').modal('show');
}

// è·å–é€‰ä¸­çš„è”ç³»äºº
function getSelectedContacts() {
  const selected = [];
  $('.contact-checkbox:checked').each(function() {
    const index = $(this).val();
    selected.push(window.hunterContacts[index]);
  });
  return selected;
}

// åŠ è½½é‚®ä»¶æ¨¡æ¿
async function loadEmailTemplates() {
  try {
    const response = await axios.get('/api/email-templates/');
    const templates = response.data.templates || [];
    
    let html = '';
    templates.forEach(template => {
      html += `
        <div class="list-group-item list-group-item-action template-item" data-template-id="${template.id}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">${template.title}</h6>
              <small class="text-muted">${template.description || 'æ— æè¿°'}</small>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="previewTemplate(${template.id})">
              <i class="bi bi-eye"></i> é¢„è§ˆ
            </button>
          </div>
        </div>
      `;
    });
    
    $('#templateList').html(html);
    
  } catch (error) {
    console.error('åŠ è½½é‚®ä»¶æ¨¡æ¿å¤±è´¥:', error);
    showToast('åŠ è½½é‚®ä»¶æ¨¡æ¿å¤±è´¥', 'danger');
  }
}

// é¢„è§ˆé‚®ä»¶æ¨¡æ¿
async function previewTemplate(templateId) {
  try {
    const selectedContacts = getSelectedContacts();
    const contactIds = selectedContacts.map(contact => contact.id);
    
    const response = await axios.post('/api/email-templates/batch-preview', {
      template_id: templateId,
      contact_ids: contactIds
    });
    
    emailPreviews = response.data.previews || [];
    currentPreviewIndex = 0;
    
    renderEmailPreview();
    
  } catch (error) {
    console.error('é¢„è§ˆé‚®ä»¶æ¨¡æ¿å¤±è´¥:', error);
    showToast('é¢„è§ˆé‚®ä»¶æ¨¡æ¿å¤±è´¥', 'danger');
  }
}

// æ¸²æŸ“é‚®ä»¶é¢„è§ˆ
function renderEmailPreview() {
  if (emailPreviews.length === 0) {
    $('#emailPreviewContent').html('<div class="text-center p-4">æš‚æ— é¢„è§ˆå†…å®¹</div>');
    return;
  }
  
  const preview = emailPreviews[currentPreviewIndex];
  const html = `
    <div class="email-preview">
      <div class="preview-header mb-3">
        <h6>æ”¶ä»¶äºº: ${preview.contact_name} (${preview.contact_email})</h6>
        <small class="text-muted">æ¨¡æ¿: ${preview.template_title}</small>
      </div>
      <div class="preview-content">
        <pre style="white-space: pre-wrap; font-family: inherit;">${preview.rendered_content}</pre>
      </div>
      <div class="preview-footer mt-3">
        <small class="text-muted">ä½¿ç”¨å˜é‡: ${preview.variables_used.join(', ')}</small>
      </div>
    </div>
  `;
  
  $('#emailPreviewContent').html(html);
}

// ä¸Šä¸€ä¸ªé¢„è§ˆ
function previousPreview() {
  if (currentPreviewIndex > 0) {
    currentPreviewIndex--;
    renderEmailPreview();
  }
}

// ä¸‹ä¸€ä¸ªé¢„è§ˆ
function nextPreview() {
  if (currentPreviewIndex < emailPreviews.length - 1) {
    currentPreviewIndex++;
    renderEmailPreview();
  }
}

// è¿›å…¥é‚®ä»¶å‘é€è®¾ç½®
function proceedToEmailSettings() {
  if (emailPreviews.length === 0) {
    showToast('è¯·å…ˆé¢„è§ˆé‚®ä»¶æ¨¡æ¿', 'warning');
    return;
  }
  
  // å…³é—­é‚®ä»¶æ¨¡æ¿æ¨¡æ€æ¡†
  $('#emailTemplateModal').modal('hide');
  
  // åŠ è½½å‘ä»¶é‚®ç®±é€‰é¡¹
  loadSenderEmails();
  
  // æ˜¾ç¤ºé‚®ä»¶å‘é€è®¾ç½®æ¨¡æ€æ¡†
  $('#emailSettingsModal').modal('show');
}

// åŠ è½½å‘ä»¶é‚®ç®±
async function loadSenderEmails() {
  try {
    const response = await axios.get('/api/user-email-bindings/');
    const bindings = response.data.bindings || [];
    
    let html = '';
    bindings.forEach(binding => {
      const isDefault = binding.is_default ? ' (é»˜è®¤)' : '';
      html += `<option value="${binding.id}">${binding.email_address}${isDefault}</option>`;
    });
    
    $('#senderEmailSelect').html(html);
    
  } catch (error) {
    console.error('åŠ è½½å‘ä»¶é‚®ç®±å¤±è´¥:', error);
    showToast('åŠ è½½å‘ä»¶é‚®ç®±å¤±è´¥', 'danger');
  }
}

// å‘é€é‚®ä»¶
async function sendEmails() {
  try {
    const senderEmailId = $('#senderEmailSelect').val();
    const sendTime = $('#sendTimeSelect').val();
    const scheduleTime = $('#scheduleTime').val();
    
    if (!senderEmailId) {
      showToast('è¯·é€‰æ‹©å‘ä»¶é‚®ç®±', 'warning');
      return;
    }
    
    showLoading();
    
    const selectedContacts = getSelectedContacts();
    const contactIds = selectedContacts.map(contact => contact.id);
    
    const response = await axios.post('/api/emails/send-batch', {
      template_id: currentTemplate,
      contact_ids: contactIds,
      sender_email_binding_id: senderEmailId,
      send_time: sendTime === 'scheduled' ? scheduleTime : null
    });
    
    showToast('é‚®ä»¶å‘é€æˆåŠŸ', 'success');
    $('#emailSettingsModal').modal('hide');
    
  } catch (error) {
    console.error('å‘é€é‚®ä»¶å¤±è´¥:', error);
    showToast('å‘é€é‚®ä»¶å¤±è´¥', 'danger');
  } finally {
    hideLoading();
  }
}

// å¯¼å‡ºå®¢æˆ·
function exportCustomers() {
  if (overseasCustomers.length === 0) {
    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å®¢æˆ·æ•°æ®', 'warning');
    return;
  }
  
  // åˆ›å»ºCSVå†…å®¹
  let csvContent = 'åºå·,å…¬å¸åç§°,å…¬å¸ç®€ä»‹,é‚®ç®±,åŸŸå,å›½å®¶,åŸå¸‚\n';
  overseasCustomers.forEach((customer, index) => {
    csvContent += `${index + 1},"${customer.company_name}","${customer.company_description}","${customer.email}","${customer.domain}","${customer.country}","${customer.city}"\n`;
  });
  
  // ä¸‹è½½CSVæ–‡ä»¶
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'æµ·å¤–å®¢æˆ·åˆ—è¡¨.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast('å®¢æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
}

// æŒ‰å›½å®¶ç­›é€‰
function filterByCountry(country) {
  // å®ç°æŒ‰å›½å®¶ç­›é€‰å®¢æˆ·çš„åŠŸèƒ½
  console.log('æŒ‰å›½å®¶ç­›é€‰:', country);
}

// åˆ›å»ºæ–°æ¨¡æ¿
function createNewTemplate() {
  window.location.href = '/emails/templates';
}

// å·¥å…·å‡½æ•°
function showLoading() {
  console.log('ğŸ”„ æ˜¾ç¤ºåŠ è½½ä¸­...');
  const loadingHTML = `
    <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">åŠ è½½ä¸­...</span>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
  console.log('âœ… éšè—åŠ è½½ä¸­');
  const loading = document.getElementById('loadingOverlay');
  if (loading) {
    loading.remove();
  }
}

// Toastå‡½æ•°å·²åœ¨main.jsä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å®šä¹‰
</script>
