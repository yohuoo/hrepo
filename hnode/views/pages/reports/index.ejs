<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">æ•°æ®æŠ¥å‘Š</li>
      </ol>
    </nav>
    <h1 class="page-title">æ•°æ®æŠ¥å‘Šä¸­å¿ƒ</h1>
    <p class="page-subtitle">AIæ™ºèƒ½ç”Ÿæˆå·¥ä½œæŠ¥å‘Š</p>
  </div>
</div>

<!-- ç”ŸæˆæŠ¥å‘ŠåŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-header">
    <h6 class="mb-0"><i class="bi bi-robot"></i> ç”Ÿæˆæ–°æŠ¥å‘Š</h6>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3" id="reportTypeField">
        <label class="form-label">æŠ¥å‘Šç±»å‹</label>
        <select class="form-select" id="reportType" onchange="updateReportForm()">
          <option value="personal">ä¸ªäººæŠ¥å‘Š</option>
          <!-- éƒ¨é—¨å’Œå…¬å¸æŠ¥å‘Šä»…ç®¡ç†å‘˜å¯è§ -->
        </select>
      </div>
      <div class="col-md-3" id="departmentField" style="display: none;">
        <label class="form-label">é€‰æ‹©éƒ¨é—¨</label>
        <select class="form-select" id="reportDepartment">
          <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
        </select>
      </div>
      <div class="col-md-3" id="userField" style="display: none;">
        <label class="form-label">é€‰æ‹©ç”¨æˆ·</label>
        <select class="form-select" id="reportUser">
          <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">å‘¨æœŸç±»å‹</label>
        <select class="form-select" id="periodType">
          <option value="month" selected>æœˆæŠ¥</option>
          <option value="week">å‘¨æŠ¥</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">å¹´ä»½</label>
        <input type="number" class="form-control" id="reportYear" value="2025">
      </div>
      <div class="col-md-2" id="monthField">
        <label class="form-label">æœˆä»½</label>
        <select class="form-select" id="reportMonth">
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10" selected>10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
      </div>
      <div class="col-md-2" id="weekField" style="display: none;">
        <label class="form-label">ç¬¬å‡ å‘¨</label>
        <input type="number" class="form-control" id="reportWeek" min="1" max="5" value="1" placeholder="1-5">
      </div>
      <div class="col-md-2" id="departmentField" style="display: none;">
        <label class="form-label">é€‰æ‹©éƒ¨é—¨</label>
        <select class="form-select" id="targetDepartment">
          <option value="">è¯·é€‰æ‹©</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="generateReport()">
          <i class="bi bi-stars me-1"></i>ç”ŸæˆæŠ¥å‘Š
        </button>
      </div>
    </div>
  </div>
</div>

<!-- å†å²æŠ¥å‘Šåˆ—è¡¨ -->
<div class="card">
  <div class="card-header">
    <h6 class="mb-0"><i class="bi bi-file-earmark-bar-graph"></i> å†å²æŠ¥å‘Š</h6>
  </div>
  <div class="card-body">
    <div class="list-group" id="reportsList">
      <div class="text-center p-5">
        <div class="spinner-border text-primary"></div>
      </div>
    </div>
  </div>
</div>

<!-- æŠ¥å‘Šè¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="reportDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-text"></i> æŠ¥å‘Šè¯¦æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body markdown-content" id="reportDetailBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-primary" onclick="downloadReport()">
          <i class="bi bi-download"></i> ä¸‹è½½æŠ¥å‘Š
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let departments = [];
let allUsers = [];
let currentReport = null;
let currentUser = null;

document.addEventListener('DOMContentLoaded', async function() {
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  currentUser = JSON.parse(localStorage.getItem('userInfo') || '{}');
  
  // å¦‚æœuserInfoä¸­æ²¡æœ‰roleå­—æ®µï¼Œä»åç«¯é‡æ–°è·å–
  if (!currentUser.role) {
    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        currentUser = data.user;
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
      }
    } catch (error) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
  }
  
  await loadDepartments();
  await loadUsers();
  
  // æ ¹æ®ç”¨æˆ·è§’è‰²æ·»åŠ æŠ¥å‘Šç±»å‹é€‰é¡¹
  if (currentUser.role === 'super_admin' || currentUser.role === 'admin') {
    const reportTypeSelect = document.getElementById('reportType');
    reportTypeSelect.innerHTML += '<option value="department">éƒ¨é—¨æŠ¥å‘Š</option>';
    if (currentUser.role === 'super_admin') {
      reportTypeSelect.innerHTML += '<option value="company">å…¬å¸æŠ¥å‘Š</option>';
    }
  }
  
  await loadReports();
  
  // è®¾ç½®é»˜è®¤æœˆä»½ä¸ºå½“å‰æœˆ
  const now = new Date();
  document.getElementById('reportYear').value = now.getFullYear();
  document.getElementById('reportMonth').value = now.getMonth() + 1;
  
  // å‘¨æœŸç±»å‹åˆ‡æ¢
  document.getElementById('periodType').addEventListener('change', function() {
    if (this.value === 'week') {
      // å‘¨æŠ¥ï¼šåŒæ—¶æ˜¾ç¤ºæœˆä»½å’Œå‘¨æ•°ï¼ˆæ ¼å¼ï¼šæŸå¹´æŸæœˆç¬¬å‡ å‘¨ï¼‰
      document.getElementById('monthField').style.display = 'block';
      document.getElementById('weekField').style.display = 'block';
    } else {
      // æœˆæŠ¥ï¼šåªæ˜¾ç¤ºæœˆä»½ï¼Œéšè—å‘¨æ•°
      document.getElementById('monthField').style.display = 'block';
      document.getElementById('weekField').style.display = 'none';
    }
  });
});

// åŠ è½½éƒ¨é—¨åˆ—è¡¨
async function loadDepartments() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/departments/tree', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    
    if (data.success) {
      departments = data.departments || [];
      updateDepartmentSelect();
    }
  } catch (error) {
    console.error('åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥:', error);
  }
}

// åŠ è½½ç”¨æˆ·åˆ—è¡¨
async function loadUsers() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/users?pageSize=1000', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    
    if (data.success) {
      allUsers = data.users || [];
      updateUserSelect();
    }
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
  }
}

// æ›´æ–°ç”¨æˆ·é€‰æ‹©æ¡†
function updateUserSelect() {
  const select = document.getElementById('reportUser');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
  allUsers.forEach(user => {
    select.innerHTML += `<option value="${user.id}">${user.username} (${user.email})</option>`;
  });
}

// æ›´æ–°éƒ¨é—¨é€‰æ‹©æ¡†
function updateDepartmentSelect() {
  const select = document.getElementById('targetDepartment');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
  
  // åŒæ—¶æ›´æ–°æŠ¥å‘Šç”Ÿæˆè¡¨å•ä¸­çš„éƒ¨é—¨é€‰æ‹©å™¨
  const reportDeptSelect = document.getElementById('reportDepartment');
  reportDeptSelect.innerHTML = '<option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>';
  
  function addOptions(depts, prefix = '') {
    depts.forEach(dept => {
      select.innerHTML += `<option value="${dept.id}">${prefix}${dept.name}</option>`;
      reportDeptSelect.innerHTML += `<option value="${dept.id}">${prefix}${dept.name}</option>`;
      if (dept.children && dept.children.length > 0) {
        addOptions(dept.children, prefix + 'ã€€');
      }
    });
  }
  
  addOptions(departments);
}

// æ›´æ–°æŠ¥å‘Šè¡¨å•
function updateReportForm() {
  const reportType = document.getElementById('reportType').value;
  const deptField = document.getElementById('departmentField');
  const userField = document.getElementById('userField');
  
  // æ ¹æ®æŠ¥å‘Šç±»å‹æ˜¾ç¤º/éšè—ç›¸åº”çš„é€‰æ‹©å™¨
  if (reportType === 'department') {
    deptField.style.display = 'block';
    userField.style.display = 'none';
  } else if (reportType === 'personal') {
    deptField.style.display = 'none';
    userField.style.display = 'block';
  } else {
    // å…¬å¸æŠ¥å‘Šï¼Œéšè—ä¸¤ä¸ªé€‰æ‹©å™¨
    deptField.style.display = 'none';
    userField.style.display = 'none';
  }
}

// ç”ŸæˆæŠ¥å‘Š
async function generateReport() {
  try {
    const reportType = document.getElementById('reportType').value;
    const periodType = document.getElementById('periodType').value;
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    const week = document.getElementById('reportWeek').value;
    
    // è·å–éƒ¨é—¨æˆ–ç”¨æˆ·ID
    let departmentId = null;
    let userId = null;
    
    if (reportType === 'department') {
      departmentId = document.getElementById('reportDepartment').value;
      if (!departmentId) {
        showWarning('è¯·é€‰æ‹©éƒ¨é—¨');
        return;
      }
    } else if (reportType === 'personal') {
      userId = document.getElementById('reportUser').value;
      // å¦‚æœæ²¡æœ‰é€‰æ‹©ç”¨æˆ·ï¼Œåˆ™ç”Ÿæˆå½“å‰ç”¨æˆ·çš„æŠ¥å‘Š
    }
    
    const token = localStorage.getItem('authToken');
    
    let url = '/api/reports/';
    if (reportType === 'personal') {
      if (userId) {
        url += `user/${userId}`;
      } else {
        url += 'personal';
      }
    } else if (reportType === 'department') {
      url += `department/${departmentId}`;
    } else {
      url += 'company';
    }
    
    showInfo('æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...');
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        year: parseInt(year),
        month: parseInt(month),  // æœˆæŠ¥å’Œå‘¨æŠ¥éƒ½éœ€è¦æœˆä»½
        week: periodType === 'week' ? parseInt(week) : null,
        period_type: periodType
      })
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError(data.message || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
      return;
    }
    
    showSuccess('æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼');
    await loadReports();
    viewReport(data.report.id);
    
  } catch (error) {
    console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error);
    showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
  }
}

// åŠ è½½å†å²æŠ¥å‘Š
async function loadReports() {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/reports?pageSize=50', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      return;
    }
    
    renderReportsList(data.reports || []);
    
  } catch (error) {
    console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
  }
}

// æ¸²æŸ“æŠ¥å‘Šåˆ—è¡¨
function renderReportsList(reports) {
  const container = document.getElementById('reportsList');
  
  if (reports.length === 0) {
    container.innerHTML = `
      <div class="empty-state text-center p-5">
        <i class="bi bi-file-earmark-bar-graph"></i>
        <h5>æš‚æ— æŠ¥å‘Š</h5>
        <p class="text-muted">ç‚¹å‡»ä¸Šæ–¹"ç”ŸæˆæŠ¥å‘Š"åˆ›å»ºç¬¬ä¸€ä»½æŠ¥å‘Š</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  let hasGenerating = false;  // æ˜¯å¦æœ‰ç”Ÿæˆä¸­çš„æŠ¥å‘Š
  
  reports.forEach(report => {
    const typeText = {
      'personal': 'ä¸ªäººæŠ¥å‘Š',
      'department': 'éƒ¨é—¨æŠ¥å‘Š',
      'company': 'å…¬å¸æŠ¥å‘Š'
    }[report.report_type] || 'æœªçŸ¥';
    
    const periodText = report.period_type === 'month' 
      ? `${report.year}å¹´${report.month}æœˆ`
      : `${report.year}å¹´ç¬¬${report.week}å‘¨`;
    
    // åˆ¤æ–­æ˜¯å¦ç”Ÿæˆä¸­ï¼ˆsummaryä¸ºnullæˆ–ä¸ºç©ºï¼‰
    const isGenerating = !report.summary || report.summary.trim() === '';
    if (isGenerating) hasGenerating = true;
    
    const clickAction = isGenerating ? 'return false;' : `viewReport(${report.id}); return false;`;
    const cursorStyle = isGenerating ? 'cursor: not-allowed; opacity: 0.7;' : 'cursor: pointer;';
    
    html += `
      <a href="#" class="list-group-item list-group-item-action" style="${cursorStyle}" onclick="${clickAction}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1">
              <span class="badge bg-${report.report_type === 'company' ? 'danger' : report.report_type === 'department' ? 'warning' : 'primary'}">
                ${typeText}
              </span>
              ${periodText}
              ${isGenerating ? '<span class="badge bg-secondary ms-2"><i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...</span>' : ''}
            </h6>
            <p class="mb-1 text-muted small">
              ${report.user ? `ç”¨æˆ·: ${report.user.username}` : ''}
              ${report.department ? `éƒ¨é—¨: ${report.department.name}` : ''}
            </p>
            <p class="mb-0 text-muted small">
              ç”Ÿæˆæ—¶é—´: ${new Date(report.created_at).toLocaleString('zh-CN')} | 
              ç”Ÿæˆäºº: ${report.generator ? report.generator.username : 'æœªçŸ¥'}
            </p>
          </div>
        </div>
      </a>
    `;
  });
  
  container.innerHTML = html;
  
  // å¦‚æœæœ‰ç”Ÿæˆä¸­çš„æŠ¥å‘Šï¼Œ5ç§’åè‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
  if (hasGenerating) {
    console.log('â³ æ£€æµ‹åˆ°ç”Ÿæˆä¸­çš„æŠ¥å‘Šï¼Œ5ç§’åè‡ªåŠ¨åˆ·æ–°...');
    setTimeout(() => {
      console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨');
      loadReports();
    }, 5000);
  }
}

// æŸ¥çœ‹æŠ¥å‘Šè¯¦æƒ…
async function viewReport(id) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/reports/${id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–æŠ¥å‘Šå¤±è´¥');
      return;
    }
    
    currentReport = data.report;
    
    // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨ç”Ÿæˆä¸­
    const isGenerating = !currentReport.summary || currentReport.summary.trim() === '';
    
    // æ¸²æŸ“å†…å®¹
    const body = document.getElementById('reportDetailBody');
    if (isGenerating) {
      // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
      body.innerHTML = `
        <div class="text-center p-5">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
          <h5>æŠ¥å‘Šç”Ÿæˆä¸­...</h5>
          <p class="text-muted">AIæ­£åœ¨åˆ†ææ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™</p>
          <button class="btn btn-sm btn-outline-primary mt-3" onclick="viewReport(${id})">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æŸ¥çœ‹
          </button>
        </div>
      `;
    } else {
      // æ¸²æŸ“Markdown
      if (typeof marked !== 'undefined') {
        body.innerHTML = marked.parse(currentReport.summary);
      } else {
        body.innerHTML = `<pre>${currentReport.summary}</pre>`;
      }
    }
    
    new bootstrap.Modal(document.getElementById('reportDetailModal')).show();
    
  } catch (error) {
    console.error('è·å–æŠ¥å‘Šè¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–æŠ¥å‘Šå¤±è´¥');
  }
}

// ä¸‹è½½æŠ¥å‘Š
function downloadReport() {
  if (!currentReport) {
    showWarning('æ²¡æœ‰å¯ä¸‹è½½çš„æŠ¥å‘Š');
    return;
  }
  
  const typeText = {
    'personal': 'ä¸ªäººæŠ¥å‘Š',
    'department': 'éƒ¨é—¨æŠ¥å‘Š',
    'company': 'å…¬å¸æŠ¥å‘Š'
  }[currentReport.report_type] || 'æŠ¥å‘Š';
  
  const periodText = currentReport.period_type === 'month'
    ? `${currentReport.year}å¹´${currentReport.month}æœˆ`
    : `${currentReport.year}å¹´ç¬¬${currentReport.week}å‘¨`;
  
  const fileName = `${typeText}_${periodText}.md`;
  const content = currentReport.summary || '# æŠ¥å‘Šå†…å®¹ä¸ºç©º';
  
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('æŠ¥å‘Šä¸‹è½½æˆåŠŸ');
}

// ==================== Toastæç¤ºå‡½æ•° ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>

