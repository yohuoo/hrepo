<!-- 页面标题和面包屑 -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">控制台</a></li>
        <li class="breadcrumb-item active">客户管理</li>
      </ol>
    </nav>
    <h1 class="page-title">客户管理</h1>
  </div>
</div>

<!-- 搜索区域 -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-center">
      <div class="col-lg-9 col-md-8">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchKeyword" placeholder="搜索客户姓名、邮箱或公司名称...">
        </div>
      </div>
      <div class="col-lg-3 col-md-4">
        <% if (typeof userPermissions !== 'undefined' && userPermissions.includes('customers.create')) { %>
        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
          <i class="bi bi-plus-lg me-1"></i>新增客户
        </button>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- 客户列表 -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>姓名</th>
            <th>邮箱地址</th>
            <th>公司</th>
            <th>往来邮件次数</th>
            <th>沟通进度</th>
            <th>客户兴趣度</th>
            <th>成交状态</th>
            <th>合同管理</th>
            <th>最近沟通时间</th>
            <th width="100">操作</th>
          </tr>
        </thead>
        <tbody id="customerTableBody">
          <tr>
            <td colspan="10" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="d-flex align-items-center gap-2">
          <span>每页显示</span>
          <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelect" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <span>条</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span id="customerCount">显示1-4条,共4条</span>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 客户详情抽屉 -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="customerDetailDrawer" aria-labelledby="customerDetailDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="customerDetailDrawerLabel">客户详情</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="customerDetailContent">
      <!-- 客户详情内容将通过JavaScript动态加载 -->
    </div>
  </div>
</div>

<!-- 添加客户模态框 -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">添加客户</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addCustomerForm">
          <div class="mb-3">
            <label class="form-label">姓名 *</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">名字</label>
              <input type="text" class="form-control" name="first_name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">姓氏</label>
              <input type="text" class="form-control" name="last_name">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">邮箱 *</label>
            <input type="email" class="form-control" name="email" required>
          </div>
          <div class="mb-3">
            <label class="form-label">公司 *</label>
            <input type="text" class="form-control" name="company" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="addCustomer()">添加</button>
      </div>
    </div>
  </div>
</div>

<!-- 客户详情模态框 -->
<div class="modal fade" id="customerDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">客户详情</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="customerDetailBody">
        <!-- 客户详情内容将通过JavaScript动态加载 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-info" id="reanalyzeBtn" onclick="reanalyzeCustomer()">
          <i class="bi bi-robot"></i> 重新AI分析
        </button>
        <button type="button" class="btn btn-primary" id="editCustomerBtn" onclick="editCustomerFromDetail()">
          <i class="bi bi-pencil"></i> 编辑客户
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 编辑客户模态框 -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">编辑客户</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editCustomerForm">
          <input type="hidden" id="editCustomerId">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">姓名 *</label>
              <input type="text" class="form-control" id="editCustomerName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">邮箱 *</label>
              <input type="email" class="form-control" id="editCustomerEmail" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">名字</label>
              <input type="text" class="form-control" id="editCustomerFirstName">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">姓氏</label>
              <input type="text" class="form-control" id="editCustomerLastName">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">公司 *</label>
            <input type="text" class="form-control" id="editCustomerCompany" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">国家</label>
              <input type="text" class="form-control" id="editCustomerCountry">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">城市</label>
              <input type="text" class="form-control" id="editCustomerCity">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">沟通进度</label>
              <select class="form-select" id="editCustomerProgress">
                <option value="待联系">待联系</option>
                <option value="跟进中">跟进中</option>
                <option value="不再跟进">不再跟进</option>
                <option value="暂停跟进">暂停跟进</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">兴趣度</label>
              <select class="form-select" id="editCustomerInterest">
                <option value="无兴趣">无兴趣</option>
                <option value="低兴趣">低兴趣</option>
                <option value="中等兴趣">中等兴趣</option>
                <option value="高兴趣">高兴趣</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveCustomerEdit()">
          <i class="bi bi-check"></i> 保存
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 合同录入模态框 -->
<div class="modal fade" id="contractModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> 录入合同</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-robot"></i> <strong>AI已为您分析：</strong>以下信息基于客户的邮件往来和销售记录生成，请核对后保存
        </div>
        <div class="alert alert-success">
          <i class="bi bi-check-circle"></i> <strong>提示：</strong>保存合同后，系统将自动把客户标记为"已成交"状态
        </div>
        
        <form id="contractForm">
          <input type="hidden" id="contractId">
          <input type="hidden" id="contractCustomerId">
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">合同编号</label>
              <input type="text" class="form-control" id="contractNumber" placeholder="选填">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">甲方名称（买方） <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="partyAName" required placeholder="客户公司">
              <small class="text-muted">客户公司</small>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">乙方名称（卖方）</label>
              <input type="text" class="form-control" id="partyBName" value="浩天药业有限公司" placeholder="我方公司">
              <small class="text-muted">我方公司</small>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">采购商品 <span class="text-danger">*</span></label>
            <textarea class="form-control" id="purchaseProduct" rows="2" required placeholder="产品名称及规格"></textarea>
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">采购数量</label>
              <input type="number" class="form-control" id="purchaseQuantity" step="0.01" placeholder="0.00">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">合同金额</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="contractAmount" step="0.01" placeholder="0.00">
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">币种</label>
              <select class="form-select" id="contractCurrency">
                <option value="USD">USD</option>
                <option value="CNY">CNY</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">预计交付时间</label>
            <input type="date" class="form-control" id="estimatedDeliveryDate">
          </div>
          
          <div class="mb-3">
            <label class="form-label">备注</label>
            <textarea class="form-control" id="contractNotes" rows="3" placeholder="其他说明"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveContract()">
          <i class="bi bi-check-lg"></i> 保存合同
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 合同列表模态框 -->
<div class="modal fade" id="contractListModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> 合同列表</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="contractListBody">
        <!-- 合同列表将通过JavaScript动态加载 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<script>
// 用户权限（从后端传递）
// eslint-disable-next-line
const userPermissions = <%- JSON.stringify(userPermissions || []) %>;
console.log('👤 用户权限:', userPermissions);

// 权限检查辅助函数
function hasPermission(code) {
  return userPermissions.includes(code);
}

let currentPage = 1;
let currentFilters = {};
let pageSize = 20;
let currentMeetingDataInCustomer = null; // 保存当前会议的完整数据（客户详情中）

document.addEventListener('DOMContentLoaded', async function() {
  console.log('✅ 客户页面已加载');
  await loadCustomers();
  
  const searchInput = document.getElementById('searchKeyword');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchCustomers, 500));
  }
  
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  if (pageSizeSelect) {
    pageSizeSelect.addEventListener('change', changePageSize);
  }
});

async function loadCustomers(page = 1) {
  try {
    console.log('🔄 加载客户列表，页码:', page);
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('请先登录');
      window.location.href = '/login';
      return;
    }
    
    // 构建查询参数
    let queryParams = `page=${page}&pageSize=${pageSize}`;
    if (currentFilters.search) {
      queryParams += `&search=${encodeURIComponent(currentFilters.search)}`;
    }
    
    const url = `/api/customers/?${queryParams}`;
    console.log('📍 请求URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('📥 客户数据:', data);
    
    if (!data.success) {
      showError('加载客户失败: ' + (data.message || '未知错误'));
      return;
    }
    
    // 详细查看第一个客户的所有字段
    if (data.customers && data.customers.length > 0) {
      console.log('🔍 第一个客户的所有字段:', Object.keys(data.customers[0]));
      console.log('🔍 deal_status值:', data.customers[0].deal_status);
    }
    
    currentPage = page;
    renderCustomerTable(data.customers || []);
    renderPagination(data.page, data.total_pages);
    updateCustomerCount(data.total, data.customers?.length || 0, page);
    
  } catch (error) {
    console.error('❌ 加载客户列表失败:', error);
    showError('加载客户列表失败: ' + error.message);
  }
}

function renderCustomerTable(customers) {
  const tbody = document.getElementById('customerTableBody');
  if (!tbody) {
    console.error('❌ 找不到客户表格');
    return;
  }
  
  console.log('🔄 渲染客户表格，共', customers.length, '条');
  
  if (customers.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <h5>暂无客户</h5>
            <p>开始添加您的第一个客户</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  customers.forEach((customer, index) => {
    const progressBadge = getProgressBadge(customer.communication_progress);
    const interestBadge = getInterestBadge(customer.interest_level);
    
    // 调试日志：打印第一个客户的数据
    if (index === 0) {
      console.log('📊 第一个客户数据示例:', {
        id: customer.id,
        name: customer.name,
        deal_status: customer.deal_status,
        contract_count: customer.contract_count
      });
    }
    
    html += `
      <tr class="customer-row" data-customer-id="${customer.id}">
        <td>
          <div class="d-flex align-items-center">
            <div class="avatar-circle me-2" style="cursor: pointer;" onclick="event.stopPropagation(); viewCustomerDetail(${customer.id});" title="点击查看客户详情">
              ${getInitials(customer.name)}
            </div>
            <div>
              <div class="fw-bold">${customer.name}</div>
            </div>
          </div>
        </td>
        <td>${customer.email}</td>
        <td>${customer.company || '-'}</td>
        <td>${customer.email_count || 0}</td>
        <td>${progressBadge}</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              ${interestBadge}
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, '无兴趣')">无兴趣</a></li>
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, '低兴趣')">低兴趣</a></li>
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, '中等兴趣')">中等兴趣</a></li>
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, '高兴趣')">高兴趣</a></li>
            </ul>
          </div>
        </td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm ${customer.deal_status === '已成交' ? 'btn-success' : 'btn-outline-secondary'} dropdown-toggle" type="button" data-bs-toggle="dropdown">
              ${customer.deal_status || '未成交'}
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); updateDealStatus(${customer.id}, '未成交'); return false;">未成交</a></li>
              <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); updateDealStatus(${customer.id}, '已成交'); return false;">已成交</a></li>
            </ul>
          </div>
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            ${customer.deal_status === '已成交' ? `
              <button class="btn btn-outline-primary" 
                      onclick="event.stopPropagation(); openContractModal(${customer.id})">
                <i class="bi bi-file-earmark-plus"></i> 录入合同
              </button>
            ` : `
              <button class="btn btn-outline-secondary" disabled title="请先将客户标记为已成交">
                <i class="bi bi-file-earmark-plus"></i> 录入合同
              </button>
            `}
            ${customer.contract_count && customer.contract_count > 0 ? `
              <button class="btn btn-outline-info" 
                      onclick="event.stopPropagation(); showContractList(${customer.id})">
                <i class="bi bi-list-ul"></i> 合同列表(${customer.contract_count})
              </button>
            ` : `
              <button class="btn btn-outline-secondary" disabled title="暂无合同">
                <i class="bi bi-list-ul"></i> 合同列表
              </button>
            `}
          </div>
        </td>
        <td>${customer.last_communication_time ? formatDate(customer.last_communication_time) : '-'}</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              ${hasPermission('customers.view') ? `
              <li><a class="dropdown-item" href="#" onclick="viewCustomerDetail(${customer.id})">
                <i class="bi bi-eye"></i> 查看详情
              </a></li>
              ` : ''}
              ${hasPermission('customers.edit') ? `
              <li><a class="dropdown-item" href="#" onclick="editCustomer(${customer.id})">
                <i class="bi bi-pencil"></i> 编辑
              </a></li>
              ` : ''}
              ${(hasPermission('customers.view') || hasPermission('customers.edit')) && hasPermission('customers.delete') ? '<li><hr class="dropdown-divider"></li>' : ''}
              ${hasPermission('customers.delete') ? `
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteCustomer(${customer.id})">
                <i class="bi bi-trash"></i> 删除
              </a></li>
              ` : ''}
            </ul>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  console.log('✅ 客户表格渲染完成');
}

function renderPagination(current, total) {
  const pagination = document.getElementById('pagination');
  if (!pagination) return;
  
  if (total <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // 上一页
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadCustomers(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;
  
  // 页码
  const startPage = Math.max(1, current - 2);
  const endPage = Math.min(total, current + 2);
  
  if (startPage > 1) {
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomers(1); return false;">1</a></li>`;
    if (startPage > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadCustomers(${i}); return false;">${i}</a>
      </li>
    `;
  }
  
  if (endPage < total) {
    if (endPage < total - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomers(${total}); return false;">${total}</a></li>`;
  }
  
  // 下一页
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadCustomers(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;
  
  pagination.innerHTML = html;
}

function updateCustomerCount(total, current, page) {
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, total);
  const countElement = document.getElementById('customerCount');
  if (countElement) {
    countElement.textContent = `显示${start}-${end}条,共${total}条`;
  }
}

function searchCustomers() {
  currentFilters = {};
  
  const searchInput = document.getElementById('searchKeyword');
  const keyword = searchInput ? searchInput.value : '';
  if (keyword) currentFilters.search = keyword;
  
  loadCustomers(1);
}

function changePageSize() {
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  pageSize = pageSizeSelect ? parseInt(pageSizeSelect.value) : 20;
  loadCustomers(1);
}

// 客户详情功能（优化版：先显示页面，后台加载AI分析）
async function viewCustomerDetail(customerId) {
  console.log('✅ 查看客户详情:', customerId);
  
  // 防止短时间内重复点击
  if (window.isLoadingCustomerDetail) {
    console.log('⚠️ 正在加载客户详情，请稍候...');
    return;
  }
  
  window.isLoadingCustomerDetail = true;
  
  try {
    const token = localStorage.getItem('authToken');
    
    // 1. 先获取客户基本信息、邮件记录和会议记录
    const [customerResponse, emailResponse, meetingResponse] = await Promise.all([
      fetch(`/api/customers/${customerId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`/api/email-history/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`/api/zoom-meetings/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
    ]);
    
    const customerData = await customerResponse.json();
    const emailData = await emailResponse.json();
    const meetingData = await meetingResponse.json();
    
    if (!customerData.success) {
      showError('获取客户信息失败');
      window.isLoadingCustomerDetail = false;
      return;
    }
    
    const customer = customerData.customer;
    const emails = emailData.email_history || [];
    const meetings = meetingData.meetings || [];
    
    // 保存当前客户数据
    window.currentCustomer = customer;
    
    // 2. 先尝试获取已有的分析数据
    console.log('🔍 获取已有分析数据...');
    const cachedAnalysisResponse = await fetch(`/api/customer-analysis/${customerId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    const cachedAnalysisData = await cachedAnalysisResponse.json();
    
    // 3. 使用已有数据或空数据渲染页面（立即显示）
    const initialAnalysis = cachedAnalysisData.success ? cachedAnalysisData.analysis : null;
    const needsAnalysis = !cachedAnalysisData.success || !cachedAnalysisData.analysis;
    
    renderCustomerDetailModal(customer, initialAnalysis, emails, meetings, needsAnalysis);
    
    // 4. 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('customerDetailModal'));
    modal.show();
    
    // 5. 如果需要分析，禁用按钮并在后台加载
    if (needsAnalysis) {
      console.log('🤖 后台触发AI客户分析...');
      
      // 禁用按钮
      disableAnalysisButtons();
      
      // 异步执行，不阻塞页面显示
      loadAIAnalysis(customerId, customer, emails, meetings);
    } else {
      console.log('✅ 使用已有分析数据');
    }
    
  } catch (error) {
    console.error('❌ 加载客户详情失败:', error);
    showError('加载客户详情失败: ' + error.message);
  } finally {
    window.isLoadingCustomerDetail = false;
  }
}

// 后台加载AI分析
async function loadAIAnalysis(customerId, customer, emails, meetings) {
  try {
    const token = localStorage.getItem('authToken');
    
    const analyzeResponse = await fetch(`/api/customer-analysis/${customerId}/analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const analyzeData = await analyzeResponse.json();
    
    if (analyzeData.success) {
      console.log('✅ AI分析完成，更新页面');
      // 更新页面显示（不重新加载整个模态框）
      renderCustomerDetailModal(customer, analyzeData.analysis, emails, meetings, false);
      // 启用按钮
      enableAnalysisButtons();
    } else {
      console.log('⚠️ AI分析失败:', analyzeData.message);
      // 显示分析失败的提示
      const analysisSection = document.querySelector('.ai-analysis-section');
      if (analysisSection) {
        analysisSection.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-muted mb-0">AI 智能分析</h6>
          </div>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> AI分析失败: ${analyzeData.message}
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="reanalyzeCustomer()">重试</button>
          </div>
        `;
      }
      // 启用按钮
      enableAnalysisButtons();
    }
  } catch (error) {
    console.error('❌ AI分析失败:', error);
    const analysisSection = document.querySelector('.ai-analysis-section');
    if (analysisSection) {
      analysisSection.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="text-muted mb-0">AI 智能分析</h6>
        </div>
        <div class="alert alert-danger">
          <i class="bi bi-x-circle"></i> AI分析失败: ${error.message}
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="reanalyzeCustomer()">重试</button>
        </div>
      `;
    }
    // 启用按钮
    enableAnalysisButtons();
  }
}

// 禁用分析相关按钮
function disableAnalysisButtons() {
  const reanalyzeBtn = document.getElementById('reanalyzeBtn');
  const editCustomerBtn = document.getElementById('editCustomerBtn');
  
  if (reanalyzeBtn) {
    reanalyzeBtn.disabled = true;
    reanalyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> AI分析中...';
  }
  
  if (editCustomerBtn) {
    editCustomerBtn.disabled = true;
  }
}

// 启用分析相关按钮
function enableAnalysisButtons() {
  const reanalyzeBtn = document.getElementById('reanalyzeBtn');
  const editCustomerBtn = document.getElementById('editCustomerBtn');
  
  if (reanalyzeBtn) {
    reanalyzeBtn.disabled = false;
    reanalyzeBtn.innerHTML = '<i class="bi bi-robot"></i> 重新AI分析';
  }
  
  if (editCustomerBtn) {
    editCustomerBtn.disabled = false;
  }
}

// 会议状态徽章
function getStatusBadgeForMeeting(status) {
  const badges = {
    'pending': '<span class="badge bg-info"><i class="bi bi-hourglass-split"></i> 等待处理</span>',
    'processing': '<span class="badge bg-warning"><i class="bi bi-gear"></i> 处理中</span>',
    'transcribing': '<span class="badge bg-primary"><i class="bi bi-mic"></i> 识别中</span>',
    'summarizing': '<span class="badge bg-info"><i class="bi bi-robot"></i> 生成中</span>',
    'completed': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 已完成</span>',
    'failed': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> 失败</span>'
  };
  return badges[status] || `<span class="badge bg-secondary">${status || '未知'}</span>`;
}

// 去除Markdown格式，提取纯文本
function stripMarkdown(text) {
  if (!text) return '';
  
  return text
    .replace(/#{1,6}\s+/g, '')      // 移除标题标记 ##
    .replace(/\*\*(.+?)\*\*/g, '$1') // 移除粗体 **text**
    .replace(/\*(.+?)\*/g, '$1')     // 移除斜体 *text*
    .replace(/\[(.+?)\]\(.+?\)/g, '$1') // 移除链接 [text](url)
    .replace(/`(.+?)`/g, '$1')       // 移除代码标记 `code`
    .replace(/^[\s-*]\s+/gm, '')     // 移除列表标记
    .replace(/\n{3,}/g, '\n\n')      // 多个换行合并为两个
    .trim();
}

// 安全解析数组数据（处理可能是字符串或对象的情况）
function parseArrayField(field, fieldName = 'unknown') {
  console.log(`🔍 解析字段 ${fieldName}:`, field, 'Type:', typeof field);
  
  if (!field) {
    console.log(`  → 空值，返回 []`);
    return [];
  }
  
  if (Array.isArray(field)) {
    console.log(`  → 已是数组，长度: ${field.length}`);
    return field;
  }
  
  if (typeof field === 'string') {
    try {
      const parsed = JSON.parse(field);
      console.log(`  → 解析JSON字符串:`, parsed);
      return Array.isArray(parsed) ? parsed : [parsed];
    } catch (e) {
      console.log(`  → JSON解析失败，当作普通字符串`);
      return [field];
    }
  }
  
  if (typeof field === 'object') {
    const values = Object.values(field);
    console.log(`  → 对象转数组:`, values);
    return values;
  }
  
  console.log(`  → 未知类型，返回 []`);
  return [];
}

function renderCustomerDetailModal(customer, analysis, emails, meetings = [], isLoading = false) {
  // 转换字面的 \n 为实际换行符
  const convertNewlines = (text) => {
    if (!text) return '';
    return text.replace(/\\n/g, '\n');
  };
  
  // 解析分析数据中的数组字段
  let opportunities = [];
  let risks = [];
  let strategicSuggestions = [];
  let nextActions = [];
  
  if (analysis) {
    opportunities = parseArrayField(analysis.opportunities, 'opportunities');
    risks = parseArrayField(analysis.risks, 'risks');
    strategicSuggestions = parseArrayField(analysis.strategic_suggestions, 'strategic_suggestions');
    nextActions = parseArrayField(analysis.next_actions, 'next_actions');
    
    // 转换当前沟通进度中的换行符
    if (analysis.current_progress) {
      analysis.current_progress = convertNewlines(analysis.current_progress);
    }
    
    // 转换数组字段中的换行符
    opportunities = opportunities.map(item => {
      if (typeof item === 'object') {
        return {
          ...item,
          description: convertNewlines(item.description || ''),
          title: convertNewlines(item.title || '')
        };
      }
      return convertNewlines(String(item));
    });
    
    risks = risks.map(item => {
      if (typeof item === 'object') {
        return {
          ...item,
          description: convertNewlines(item.description || ''),
          title: convertNewlines(item.title || '')
        };
      }
      return convertNewlines(String(item));
    });
    
    strategicSuggestions = strategicSuggestions.map(item => {
      if (typeof item === 'object') {
        return {
          ...item,
          description: convertNewlines(item.description || ''),
          title: convertNewlines(item.title || ''),
          expected_outcome: convertNewlines(item.expected_outcome || '')
        };
      }
      return convertNewlines(String(item));
    });
    
    nextActions = nextActions.map(item => {
      if (typeof item === 'object') {
        return {
          ...item,
          action: convertNewlines(item.action || item.title || item.name || ''),
          description: convertNewlines(item.description || '')
        };
      }
      return convertNewlines(String(item));
    });
  }
  
  // 预处理会议数据，添加摘要预览
  console.log('🎥 会议数据:', meetings);
  const processedMeetings = (meetings || []).map(meeting => {
    let summaryPreview = '';
    console.log(`🔍 处理会议 ${meeting.id}:`, {
      has_ai_summary: !!meeting.ai_summary,
      ai_summary_length: meeting.ai_summary ? meeting.ai_summary.length : 0,
      ai_summary_preview: meeting.ai_summary ? meeting.ai_summary.substring(0, 50) : 'null'
    });
    
    if (meeting.ai_summary) {
      const plainText = stripMarkdown(meeting.ai_summary);
      console.log(`  → stripMarkdown后:`, plainText.substring(0, 100));
      summaryPreview = plainText.substring(0, 80) + (plainText.length > 80 ? '...' : '');
    }
    
    console.log(`  → summaryPreview:`, summaryPreview);
    return {
      ...meeting,
      summaryPreview
    };
  });
  
  const html = `
    <div class="customer-detail">
      <!-- 基本信息 -->
      <div class="mb-4">
        <h6 class="text-muted mb-2">基本信息</h6>
        <div class="row">
          <div class="col-6">
            <strong>姓名:</strong> ${customer.name}
          </div>
          <div class="col-6">
            <strong>邮箱:</strong> ${customer.email}
          </div>
        </div>
      </div>
      
      <!-- AI智能分析 -->
      <div class="mb-4 ai-analysis-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="text-muted mb-0">AI 智能分析</h6>
          ${isLoading ? `
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
          ` : ''}
        </div>
        
        ${analysis ? `
          <!-- 当前沟通进度 -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-chat-dots text-primary me-2"></i>
                <strong>当前沟通进度</strong>
              </div>
              <p class="mb-0" style="white-space: pre-line;">${analysis.current_progress || '暂无分析数据'}</p>
            </div>
          </div>
          
          <!-- 机会点与风险预警 -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                <strong>机会点与风险预警</strong>
              </div>
              <div class="row">
                <div class="col-6">
                  <h6 class="text-success">机会点</h6>
                  <ul class="list-unstyled">
                    ${opportunities.length > 0 
                      ? opportunities.map(opp => {
                          if (typeof opp === 'object' && opp.title) {
                            const priority = opp.priority || '';
                            let priorityBadge = '';
                            
                            if (priority === '高') {
                              priorityBadge = `<span class="badge bg-success">高</span>`;
                            } else if (priority === '中') {
                              priorityBadge = `<span class="badge bg-info">中</span>`;
                            } else if (priority === '低') {
                              priorityBadge = `<span class="badge bg-secondary">低</span>`;
                            } else if (priority) {
                              priorityBadge = `<span class="badge bg-primary">${priority}</span>`;
                            }
                            
                            return `<li class="mb-3">
                              <strong>• ${opp.title}</strong> ${priorityBadge}
                              <br><small class="text-muted" style="white-space: pre-line;">${opp.description || ''}</small>
                            </li>`;
                          }
                          return `<li style="white-space: pre-line;">• ${opp}</li>`;
                        }).join('') 
                      : '<li class="text-muted">暂无数据</li>'}
                  </ul>
                </div>
                <div class="col-6">
                  <h6 class="text-danger">风险点</h6>
                  <ul class="list-unstyled">
                    ${risks.length > 0 
                      ? risks.map(risk => {
                          if (typeof risk === 'object' && risk.title) {
                            return `<li class="mb-3"><strong>• ${risk.title}</strong>${risk.severity ? ` <span class="badge bg-danger">${risk.severity}</span>` : ''}<br><small class="text-muted" style="white-space: pre-line;">${risk.description || ''}</small></li>`;
                          }
                          return `<li style="white-space: pre-line;">• ${risk}</li>`;
                        }).join('') 
                      : '<li class="text-muted">暂无数据</li>'}
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 战略建议 -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-lightbulb text-info me-2"></i>
                <strong>战略建议</strong>
              </div>
              <ul class="list-unstyled">
                ${strategicSuggestions.length > 0 
                  ? strategicSuggestions.map(rec => {
                      if (typeof rec === 'object' && rec.title) {
                        return `<li class="mb-3"><strong>• ${rec.title}</strong><br><small class="text-muted" style="white-space: pre-line;">${rec.description || ''}</small>${rec.expected_outcome ? `<br><small class="text-success" style="white-space: pre-line;"><i class="bi bi-check-circle"></i> 预期结果: ${rec.expected_outcome}</small>` : ''}</li>`;
                      }
                      return `<li style="white-space: pre-line;">• ${rec}</li>`;
                    }).join('') 
                  : '<li class="text-muted">暂无数据</li>'}
              </ul>
            </div>
          </div>
          
          <!-- 下一步行动建议 -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-list-check text-success me-2"></i>
                <strong>下一步行动建议</strong>
              </div>
              <ul class="list-unstyled">
                ${nextActions.length > 0 
                  ? nextActions.map((step, idx) => {
                      if (typeof step === 'object') {
                        // 字段名称：action, deadline, priority
                        const action = step.action || step.title || step.name || '行动项';
                        const deadline = step.deadline || '';
                        const priority = step.priority || '';
                        
                        let priorityBadge = '';
                        if (priority === '紧急') {
                          priorityBadge = `<span class="badge bg-danger">${priority}</span>`;
                        } else if (priority === '重要') {
                          priorityBadge = `<span class="badge bg-warning">${priority}</span>`;
                        } else if (priority === '一般') {
                          priorityBadge = `<span class="badge bg-secondary">${priority}</span>`;
                        } else if (priority) {
                          priorityBadge = `<span class="badge bg-info">${priority}</span>`;
                        }
                        
                        return `<li class="mb-2">
                          <strong>• ${action}</strong> ${priorityBadge}
                          ${step.description ? `<br><small class="text-muted" style="white-space: pre-line;">${step.description}</small>` : ''}
                          ${deadline ? `<br><small class="text-muted"><i class="bi bi-calendar"></i> ${deadline}</small>` : ''}
                        </li>`;
                      }
                      return `<li style="white-space: pre-line;">• ${step}</li>`;
                    }).join('') 
                  : '<li class="text-muted">暂无数据</li>'}
              </ul>
            </div>
          </div>
        ` : `
          <!-- 无分析数据时的占位符 -->
          <div class="card mb-3">
            <div class="card-body text-center p-5">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">加载中...</span>
              </div>
              <p class="text-muted mb-0">正在进行AI智能分析，请稍候...</p>
              <small class="text-muted">这可能需要20-30秒</small>
            </div>
          </div>
        `}
      </div>
      
      <!-- 往来记录 -->
      <div class="mb-4">
        <ul class="nav nav-tabs" id="communicationTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" type="button" role="tab">
              邮件往来记录
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="meetings-tab" data-bs-toggle="tab" data-bs-target="#meetings" type="button" role="tab">
              视频会议记录
            </button>
          </li>
        </ul>
        <div class="tab-content" id="communicationTabContent">
          <div class="tab-pane fade show active" id="emails" role="tabpanel">
            <div class="mt-3">
              ${renderEmailHistory(emails)}
            </div>
          </div>
          <div class="tab-pane fade" id="meetings" role="tabpanel">
            <div class="mt-3">
              ${processedMeetings && processedMeetings.length > 0 ? `
                <div class="list-group">
                  ${processedMeetings.map(meeting => `
                    <a href="#" class="list-group-item list-group-item-action" onclick="showMeetingDetailInCustomer(${meeting.id}); return false;">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h6 class="mb-1">${meeting.meeting_title || '未命名会议'}</h6>
                          <p class="mb-1 text-muted small">
                            <i class="bi bi-calendar"></i> ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '未知日期'}
                          </p>
                          ${meeting.summaryPreview ? `
                            <p class="mb-0 text-muted small" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                              <i class="bi bi-robot"></i> ${meeting.summaryPreview}
                            </p>
                          ` : `
                            <p class="mb-0 text-muted small">
                              <i class="bi bi-hourglass-split"></i> ${meeting.status === 'completed' ? '暂无摘要' : '处理中...'}
                            </p>
                          `}
                        </div>
                        <div class="text-end">
                          ${getStatusBadgeForMeeting(meeting.status)}
                        </div>
                      </div>
                    </a>
                  `).join('')}
                </div>
              ` : '<p class="text-muted">暂无视频会议记录</p>'}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  const detailBody = document.getElementById('customerDetailBody');
  if (detailBody) {
    detailBody.innerHTML = html;
  }
  console.log('✅ 客户详情渲染完成');
}

function renderEmailHistory(emails) {
  if (emails.length === 0) {
    return '<p class="text-muted">暂无邮件往来记录</p>';
  }
  
  let html = '<div class="list-group">';
  emails.forEach(email => {
    const preview = (email.content || '').substring(0, 80);
    html += `
      <a href="#" class="list-group-item list-group-item-action" onclick="showEmailDetailInCustomer(${email.id}); return false;">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1">${email.title || '无主题'}</h6>
            <p class="mb-1 text-muted small">${preview}${preview.length >= 80 ? '...' : ''}</p>
            <small class="text-muted">
              <i class="bi bi-send"></i> ${email.send_address} → ${email.receive_address}
            </small>
          </div>
          <div class="text-end">
            <small class="text-muted">${formatDate(email.send_time)}</small>
            <br>
            <span class="badge ${email.email_type === 'sent' ? 'bg-primary' : 'bg-success'} mt-1">
              ${email.email_type === 'sent' ? '已发送' : '已接收'}
            </span>
          </div>
        </div>
      </a>
    `;
  });
  html += '</div>';
  
  return html;
}

// 在客户详情中查看邮件详情
async function showEmailDetailInCustomer(emailId) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/email-history/${emailId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('获取邮件详情失败');
      return;
    }
    
    const email = data.email_history;
    
    // 保存邮件数据到全局变量（用于翻译）
    window.currentEmailInDetail = email;
    
    // 创建邮件详情模态框
    const modalHTML = `
      <div class="modal fade" id="emailDetailInCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-envelope"></i> 邮件详情</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>主题:</strong>
                  <div class="btn-group btn-group-sm" id="titleTranslationToggle" style="display: none;">
                    <button class="btn btn-outline-secondary btn-sm active" onclick="showOriginalContent()">原文</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="showTranslatedContent()">译文</button>
                  </div>
                </div>
                <div class="mt-1">
                  <span id="emailDetailTitle" class="text-primary">${email.title || '无主题'}</span>
                  <span id="emailDetailTitleTranslation" class="text-info" style="display: none;"><!-- 翻译标题 --></span>
                </div>
              </div>
              <div class="mb-3">
                <strong>发件人:</strong> ${email.send_address}
              </div>
              <div class="mb-3">
                <strong>收件人:</strong> ${email.receive_address}
              </div>
              <div class="mb-3">
                <strong>发送时间:</strong> ${new Date(email.send_time).toLocaleString('zh-CN')}
              </div>
              <div class="mb-3">
                <strong>类型:</strong> 
                <span class="badge ${email.email_type === 'sent' ? 'bg-primary' : 'bg-success'}">
                  ${email.email_type === 'sent' ? '已发送' : '已接收'}
                </span>
              </div>
              <hr>
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>内容:</strong>
                </div>
                <div class="mt-2 p-3 bg-light rounded" style="white-space: pre-line;" id="emailDetailContent">${email.content ? email.content.trim() : '(无内容)'}</div>
                <div class="mt-2 p-3 bg-info bg-opacity-10 rounded" style="white-space: pre-line; display: none;" id="emailDetailTranslation"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-info" onclick="translateEmailInDetail()" id="translateEmailBtn">
                <i class="bi bi-translate"></i> 翻译邮件
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // 移除旧的模态框
    const oldModal = document.getElementById('emailDetailInCustomerModal');
    if (oldModal) oldModal.remove();
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('emailDetailInCustomerModal'));
    modal.show();
    
  } catch (error) {
    console.error('❌ 获取邮件详情失败:', error);
    showError('获取邮件详情失败: ' + error.message);
  }
}

// 在客户详情中查看会议详情
async function showMeetingDetailInCustomer(meetingId) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/zoom-meetings/${meetingId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('获取会议详情失败');
      return;
    }
    
    const meeting = data.meeting;
    
    // 创建会议详情模态框
    const modalHTML = `
      <div class="modal fade" id="meetingDetailInCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-camera-video"></i> 会议详情</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <strong>会议标题:</strong> ${meeting.meeting_title || '未命名会议'}
              </div>
              <div class="mb-3">
                <strong>会议日期:</strong> ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}
              </div>
              <div class="mb-3">
                <strong>视频文件:</strong> ${meeting.video_file_name || '-'}
              </div>
              <div class="mb-3">
                <strong>状态:</strong> ${getStatusBadgeForMeeting(meeting.status)}
              </div>
              
              ${meeting.ai_summary ? `
                <hr>
                <div class="mb-3">
                  <strong><i class="bi bi-robot"></i> AI 会议摘要:</strong>
                  <div class="mt-2 p-3 bg-light rounded markdown-content" id="customerMeetingSummary-${meeting.id}"></div>
                </div>
              ` : `
                <hr>
                <div class="alert alert-info mb-0">
                  <i class="bi bi-info-circle"></i> ${meeting.status === 'completed' ? '暂无AI摘要' : 'AI摘要生成中，请稍后刷新查看'}
                </div>
              `}
              
              ${meeting.transcript_text ? `
                <hr>
                <div class="mb-3">
                  <strong><i class="bi bi-file-text"></i> 会议文字稿:</strong>
                  <div class="mt-2 p-3 bg-light rounded" style="max-height: 300px; overflow-y: auto; white-space: pre-line; line-height: 1.8;">
                    ${meeting.transcript_text}
                  </div>
                </div>
              ` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-info" onclick="downloadTranscriptInCustomer()">
                <i class="bi bi-file-text"></i> 下载文字稿 (.txt)
              </button>
              <button type="button" class="btn btn-primary" onclick="downloadAISummaryInCustomer()">
                <i class="bi bi-file-earmark-text"></i> 下载AI分析 (.md)
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // 保存当前会议数据
    currentMeetingDataInCustomer = meeting;
    
    // 移除旧的模态框
    const oldModal = document.getElementById('meetingDetailInCustomerModal');
    if (oldModal) oldModal.remove();
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 渲染Markdown（在DOM插入后）
    if (meeting.ai_summary && typeof marked !== 'undefined') {
      setTimeout(() => {
        const summaryEl = document.getElementById(`customerMeetingSummary-${meeting.id}`);
        if (summaryEl) {
          try {
            summaryEl.innerHTML = marked.parse(meeting.ai_summary);
          } catch (e) {
            console.error('Markdown渲染失败:', e);
            summaryEl.textContent = meeting.ai_summary;
          }
        }
      }, 100);
    }
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('meetingDetailInCustomerModal'));
    modal.show();
    
  } catch (error) {
    console.error('❌ 获取会议详情失败:', error);
    showError('获取会议详情失败: ' + error.message);
  }
}

// 更新客户兴趣程度
async function updateInterestLevel(customerId, level) {
  console.log('✅ 更新客户兴趣程度:', customerId, level);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/customers/${customerId}/interest-level`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        interest_level: level
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('客户兴趣程度已更新');
      await loadCustomers(currentPage);
    } else {
      showError('更新失败: ' + data.message);
    }
  } catch (error) {
    console.error('❌ 更新失败:', error);
    showError('更新失败: ' + error.message);
  }
}

// 客户操作
// 编辑客户
async function editCustomer(id) {
  console.log('✅ 编辑客户:', id);
  await viewCustomerForEdit(id);
}

// 从详情页面进入编辑
function editCustomerFromDetail() {
  if (!window.currentCustomer) {
    showError('无法获取客户信息');
    return;
  }
  
  // 关闭详情模态框
  const detailModal = bootstrap.Modal.getInstance(document.getElementById('customerDetailModal'));
  if (detailModal) {
    detailModal.hide();
  }
  
  // 填充编辑表单
  fillCustomerEditForm(window.currentCustomer);
  
  // 显示编辑模态框
  const editModal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
  editModal.show();
}

// 重新AI分析客户
async function reanalyzeCustomer() {
  if (!window.currentCustomer) {
    showError('无法获取客户信息');
    return;
  }
  
  const customerId = window.currentCustomer.id;
  
  if (!confirm('确定要重新进行AI分析吗？\n\n这将使用最新的邮件和会议数据重新生成客户分析报告。')) {
    return;
  }
  
  try {
    console.log('🤖 开始重新AI客户分析...');
    
    // 禁用按钮
    disableAnalysisButtons();
    
    const token = localStorage.getItem('authToken');
    
    // 显示加载状态
    let analysisSectionEl = document.querySelector('.ai-analysis-section');
    if (analysisSectionEl) {
      const loadingHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="text-muted mb-0">AI 智能分析</h6>
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-body text-center p-5">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
            <p class="text-muted mb-0">正在进行AI智能分析，请稍候...</p>
            <small class="text-muted">这可能需要20-30秒</small>
          </div>
        </div>
      `;
      analysisSectionEl.innerHTML = loadingHTML;
    }
    
    // 重新获取邮件和会议数据（可能有新的数据）
    const [emailResponse, meetingResponse] = await Promise.all([
      fetch(`/api/email-history/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`/api/zoom-meetings/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
    ]);
    
    const emailData = await emailResponse.json();
    const meetingData = await meetingResponse.json();
    const emails = emailData.email_history || [];
    const meetings = meetingData.meetings || [];
    
    const response = await fetch(`/api/customer-analysis/${customerId}/analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('AI分析失败: ' + (data.message || '未知错误'));
      enableAnalysisButtons();
      return;
    }
    
    console.log('✅ AI分析完成，更新页面');
    
    // 更新页面显示
    renderCustomerDetailModal(window.currentCustomer, data.analysis, emails, meetings, false);
    
    // 启用按钮
    enableAnalysisButtons();
    
    // 显示成功提示（不使用 alert）
    analysisSectionEl = document.querySelector('.ai-analysis-section');
    if (analysisSectionEl) {
      const successBanner = document.createElement('div');
      successBanner.className = 'alert alert-success alert-dismissible fade show mb-3';
      successBanner.innerHTML = `
        <i class="bi bi-check-circle"></i> AI分析已完成！
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      analysisSectionEl.insertBefore(successBanner, analysisSectionEl.firstChild);
      
      // 3秒后自动关闭
      setTimeout(() => {
        successBanner.remove();
      }, 3000);
    }
    
  } catch (error) {
    console.error('❌ AI分析失败:', error);
    showError('AI分析失败: ' + error.message);
    enableAnalysisButtons();
  }
}

// 获取客户并打开编辑模态框
async function viewCustomerForEdit(id) {
  console.log('✅ 获取客户信息用于编辑:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/customers/${id}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      fillCustomerEditForm(data.customer);
      
      // 显示编辑模态框
      const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
      modal.show();
    } else {
      showError('获取客户信息失败: ' + data.message);
    }
  } catch (error) {
    console.error('❌ 获取客户信息失败:', error);
    showError('获取客户信息失败: ' + error.message);
  }
}

// 填充编辑表单
function fillCustomerEditForm(customer) {
  document.getElementById('editCustomerId').value = customer.id;
  document.getElementById('editCustomerName').value = customer.name || '';
  document.getElementById('editCustomerEmail').value = customer.email || '';
  document.getElementById('editCustomerFirstName').value = customer.first_name || '';
  document.getElementById('editCustomerLastName').value = customer.last_name || '';
  document.getElementById('editCustomerCompany').value = customer.company || '';
  document.getElementById('editCustomerCountry').value = customer.country || '';
  document.getElementById('editCustomerCity').value = customer.city || '';
  document.getElementById('editCustomerProgress').value = customer.communication_progress || '待联系';
  document.getElementById('editCustomerInterest').value = customer.interest_level || '无兴趣';
}

// 保存编辑
async function saveCustomerEdit() {
  console.log('✅ 保存客户编辑');
  
  const id = document.getElementById('editCustomerId').value;
  const name = document.getElementById('editCustomerName').value;
  const email = document.getElementById('editCustomerEmail').value;
  const company = document.getElementById('editCustomerCompany').value;
  
  if (!name || !email || !company) {
    showWarning('请填写姓名、邮箱和公司');
    return;
  }
  
  const customerData = {
    name: name,
    email: email,
    first_name: document.getElementById('editCustomerFirstName').value,
    last_name: document.getElementById('editCustomerLastName').value,
    company: company,
    country: document.getElementById('editCustomerCountry').value,
    city: document.getElementById('editCustomerCity').value,
    communication_progress: document.getElementById('editCustomerProgress').value,
    interest_level: document.getElementById('editCustomerInterest').value
  };
  
  try {
    const token = localStorage.getItem('authToken');
    
    console.log('🔄 更新客户信息...');
    
    const response = await fetch(`/api/customers/${id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(customerData)
    });
    
    const data = await response.json();
    console.log('📥 更新响应:', data);
    
    if (data.success) {
      showSuccess('客户信息保存成功！');
      
      // 关闭编辑模态框
      const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
      if (modal) {
        modal.hide();
      }
      
      // 刷新客户列表
      await loadCustomers(currentPage);
    } else {
      showError('保存失败: ' + (data.message || '未知错误'));
    }
  } catch (error) {
    console.error('❌ 保存客户失败:', error);
    showError('保存失败: ' + error.message);
  }
}

async function deleteCustomer(id) {
  if (!confirm('确定要删除这个客户吗？')) return;
  
  console.log('✅ 删除客户:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/customers/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('客户已删除');
      await loadCustomers(currentPage);
    } else {
      showError('删除失败: ' + data.message);
    }
  } catch (error) {
    console.error('❌ 删除客户失败:', error);
    showError('删除失败: ' + error.message);
  }
}

// 添加客户
async function addCustomer() {
  console.log('✅ 添加新客户');
  
  const formData = {
    name: document.querySelector('input[name="name"]').value,
    first_name: document.querySelector('input[name="first_name"]').value,
    last_name: document.querySelector('input[name="last_name"]').value,
    email: document.querySelector('input[name="email"]').value,
    company: document.querySelector('input[name="company"]').value
  };
  
  if (!formData.name || !formData.email || !formData.company) {
    showWarning('请填写必填项（姓名、邮箱、公司）');
    return;
  }
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/customers/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('客户添加成功！');
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
      if (modal) {
        modal.hide();
      }
      
      document.getElementById('addCustomerForm').reset();
      await loadCustomers(1);
    } else {
      showError('添加失败: ' + (data.message || '未知错误'));
    }
  } catch (error) {
    console.error('❌ 添加客户失败:', error);
    showError('添加失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 工具函数
function getProgressBadge(progress) {
  const badges = {
    '待联系': '<span class="badge bg-secondary">待联系</span>',
    '跟进中': '<span class="badge bg-primary">跟进中</span>',
    '不再跟进': '<span class="badge bg-danger">不再跟进</span>',
    '暂停跟进': '<span class="badge bg-warning">暂停跟进</span>'
  };
  return badges[progress] || '<span class="badge bg-secondary">未知</span>';
}

function getInterestBadge(level) {
  const badges = {
    '无兴趣': '<span class="badge bg-secondary">无兴趣</span>',
    '低兴趣': '<span class="badge bg-warning">低兴趣</span>',
    '中等兴趣': '<span class="badge bg-info">中等兴趣</span>',
    '高兴趣': '<span class="badge bg-success">高兴趣</span>'
  };
  return badges[level] || '<span class="badge bg-secondary">未知</span>';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN');
}

// 获取姓名首字母
function getInitials(name) {
  if (!name) return '?';
  const names = name.split(' ');
  if (names.length >= 2) {
    return (names[0][0] + names[1][0]).toUpperCase();
  }
  return name[0].toUpperCase();
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showLoading() {
  // 先移除可能存在的旧遮罩
  hideLoading();
  
  console.log('🔄 显示加载中...');
  const loadingHTML = `
    <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">加载中...</span>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
  console.log('✅ 隐藏加载中');
  const loading = document.getElementById('loadingOverlay');
  if (loading) {
    loading.remove();
  }
}

// 下载文字稿（客户详情中使用）
function downloadTranscriptInCustomer() {
  if (!currentMeetingDataInCustomer || !currentMeetingDataInCustomer.transcript_text) {
    showWarning('暂无文字稿内容');
    return;
  }
  
  const meeting = currentMeetingDataInCustomer;
  const fileName = `${meeting.meeting_title || '会议'}_文字稿_${new Date().toISOString().split('T')[0]}.txt`;
  
  // 构建文字稿内容
  let content = `会议文字稿\n`;
  content += `=====================================\n\n`;
  content += `会议标题: ${meeting.meeting_title || '未命名会议'}\n`;
  content += `会议日期: ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}\n`;
  if (meeting.customer) {
    content += `关联客户: ${meeting.customer.name} (${meeting.customer.company})\n`;
  }
  content += `生成时间: ${new Date().toLocaleString('zh-CN')}\n`;
  content += `\n=====================================\n\n`;
  content += meeting.transcript_text;
  
  // 创建并下载文件
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('文字稿下载成功');
}

// 下载AI分析（客户详情中使用）
function downloadAISummaryInCustomer() {
  if (!currentMeetingDataInCustomer || !currentMeetingDataInCustomer.ai_summary) {
    showWarning('暂无AI分析内容');
    return;
  }
  
  const meeting = currentMeetingDataInCustomer;
  const fileName = `${meeting.meeting_title || '会议'}_AI分析_${new Date().toISOString().split('T')[0]}.md`;
  
  // 构建Markdown内容
  let content = `# ${meeting.meeting_title || '会议'} - AI智能分析\n\n`;
  content += `---\n\n`;
  content += `## 📋 会议信息\n\n`;
  content += `- **会议标题**: ${meeting.meeting_title || '未命名会议'}\n`;
  content += `- **会议日期**: ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}\n`;
  if (meeting.customer) {
    content += `- **关联客户**: ${meeting.customer.name} (${meeting.customer.company})\n`;
  }
  content += `- **分析时间**: ${new Date().toLocaleString('zh-CN')}\n`;
  content += `\n---\n\n`;
  content += `## 🤖 AI会议总结\n\n`;
  content += meeting.ai_summary;
  content += `\n\n---\n\n`;
  content += `*本分析由AI自动生成，仅供参考*\n`;
  
  // 创建并下载文件
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('AI分析下载成功');
}

// ==================== Toast提示函数 ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // 创建toast元素
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3秒后自动移除
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

// ==================== 合同管理相关函数 ====================

// 更新成交状态
async function updateDealStatus(customerId, dealStatus) {
  console.log('🔵 更新成交状态，客户ID:', customerId, '新状态:', dealStatus);
  
  try {
    const token = localStorage.getItem('authToken');
    
    console.log('📤 发送更新请求...');
    
    const response = await fetch(`/api/customers/${customerId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ deal_status: dealStatus })
    });
    
    const data = await response.json();
    
    console.log('📥 响应数据:', data);
    
    if (data.success) {
      console.log('✅ 成交状态更新成功');
      showSuccess(`成交状态已更新为：${dealStatus}`);
      await loadCustomers(currentPage);
    } else {
      console.error('❌ 更新失败:', data.message);
      showError(data.message || '更新失败');
    }
  } catch (error) {
    console.error('❌ 更新成交状态失败:', error);
    showError('更新失败');
  }
}

// 打开合同录入模态框
async function openContractModal(customerId) {
  console.log('🔵 打开合同录入模态框，客户ID:', customerId);
  
  try {
    window.currentContractCustomerId = customerId;
    
    // 重置表单
    const contractForm = document.getElementById('contractForm');
    if (!contractForm) {
      console.error('❌ 找不到contractForm元素');
      showError('表单加载失败');
      return;
    }
    
    contractForm.reset();
    document.getElementById('contractId').value = '';
    document.getElementById('contractCustomerId').value = customerId;
    
    console.log('✅ 表单已重置');
    
    // 调用AI生成合同建议
    showInfo('AI正在分析客户信息...');
    
    const token = localStorage.getItem('authToken');
    const response = await fetch(`/api/contracts/ai-suggest/${customerId}`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (data.success && data.suggestion) {
      // 填充AI建议的数据
      const suggestion = data.suggestion;
      document.getElementById('partyAName').value = suggestion.party_a_name || '';
      document.getElementById('partyBName').value = suggestion.party_b_name || '浩天药业有限公司';
      document.getElementById('purchaseProduct').value = suggestion.purchase_product || '';
      document.getElementById('purchaseQuantity').value = suggestion.purchase_quantity || '';
      document.getElementById('estimatedDeliveryDate').value = suggestion.estimated_delivery_date || '';
      document.getElementById('contractAmount').value = suggestion.contract_amount || '';
      document.getElementById('contractCurrency').value = suggestion.currency || 'USD';
      
      showSuccess('AI建议已加载，您可以继续编辑');
    } else {
      // 如果AI建议失败，至少填充默认的乙方名称
      document.getElementById('partyBName').value = '浩天药业有限公司';
    }
    
    // 显示模态框
    new bootstrap.Modal(document.getElementById('contractModal')).show();
    
  } catch (error) {
    console.error('打开合同模态框失败:', error);
    showError('加载AI建议失败，请手动填写');
    // 即使AI失败，也显示模态框让用户手动填写
    new bootstrap.Modal(document.getElementById('contractModal')).show();
  }
}

// 保存合同
async function saveContract() {
  console.log('🔵 点击保存合同按钮');
  
  try {
    const contractId = document.getElementById('contractId').value;
    const customerId = document.getElementById('contractCustomerId').value;
    const contractNumber = document.getElementById('contractNumber').value.trim();
    const partyAName = document.getElementById('partyAName').value.trim();
    const partyBName = document.getElementById('partyBName').value.trim();
    
    console.log('📝 合同数据:', {
      customerId,
      partyAName,
      partyBName
    });
    const purchaseProduct = document.getElementById('purchaseProduct').value.trim();
    const purchaseQuantity = document.getElementById('purchaseQuantity').value;
    const estimatedDeliveryDate = document.getElementById('estimatedDeliveryDate').value;
    const contractAmount = document.getElementById('contractAmount').value;
    const contractCurrency = document.getElementById('contractCurrency').value;
    const contractNotes = document.getElementById('contractNotes').value.trim();
    
    if (!partyAName || !purchaseProduct) {
      console.warn('⚠️ 表单验证失败：甲方名称或采购商品为空');
      showWarning('请填写甲方名称和采购商品');
      return;
    }
    
    console.log('✅ 表单验证通过');
    
    const token = localStorage.getItem('authToken');
    const url = contractId ? `/api/contracts/${contractId}` : '/api/contracts/';
    const method = contractId ? 'PUT' : 'POST';
    
    console.log('📤 准备发送请求:', { url, method });
    
    const requestBody = {
      customer_id: parseInt(customerId),
      contract_number: contractNumber,
      party_a_name: partyAName,
      party_b_name: partyBName || '浩天药业有限公司',
      purchase_product: purchaseProduct,
      purchase_quantity: parseFloat(purchaseQuantity) || 0,
      estimated_delivery_date: estimatedDeliveryDate || null,
      contract_amount: parseFloat(contractAmount) || 0,
      currency: contractCurrency,
      notes: contractNotes
    };
    
    console.log('📦 请求体:', requestBody);
    
    const response = await fetch(url, {
      method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    const data = await response.json();
    
    console.log('📥 响应数据:', data);
    
    if (data.success) {
      console.log('✅ 合同保存成功，准备刷新客户列表');
      showSuccess(data.message || '合同保存成功');
      bootstrap.Modal.getInstance(document.getElementById('contractModal')).hide();
      await loadCustomers(currentPage);
      console.log('✅ 客户列表已刷新');
    } else {
      console.error('❌ 保存失败:', data.message);
      showError(data.message || '保存失败');
    }
  } catch (error) {
    console.error('保存合同失败:', error);
    showError('保存失败');
  }
}

// 显示合同列表
async function showContractList(customerId) {
  console.log('🔵 显示合同列表，客户ID:', customerId);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/contracts/customer/${customerId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('获取合同列表失败');
      return;
    }
    
    const contracts = data.contracts || [];
    
    // 渲染合同列表
    let html = '';
    if (contracts.length === 0) {
      html = '<p class="text-muted text-center p-3">暂无合同</p>';
    } else {
      html = '<div class="list-group">';
      contracts.forEach(contract => {
        html += `
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-2">
                  <span class="badge bg-info me-2">甲方</span>${contract.party_a_name || '(未命名)'}
                  <span class="ms-3 badge bg-success me-2">乙方</span>${contract.party_b_name || '浩天药业有限公司'}
                </h6>
                <p class="mb-1"><strong>产品：</strong>${contract.purchase_product || '-'}</p>
                <p class="mb-1"><strong>数量：</strong>${contract.purchase_quantity || 0}</p>
                <p class="mb-1"><strong>金额：</strong>${contract.currency} $${parseFloat(contract.contract_amount || 0).toLocaleString()}</p>
                <p class="mb-1"><strong>预计交付：</strong>${contract.estimated_delivery_date || '-'}</p>
                <small class="text-muted">创建时间：${new Date(contract.created_at).toLocaleString('zh-CN')}</small>
              </div>
              <div class="btn-group-vertical btn-group-sm">
                <button class="btn btn-outline-danger btn-sm" onclick="deleteContract(${contract.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    document.getElementById('contractListBody').innerHTML = html;
    
    new bootstrap.Modal(document.getElementById('contractListModal')).show();
    
  } catch (error) {
    console.error('获取合同列表失败:', error);
    showError('获取合同列表失败');
  }
}

// 删除合同
async function deleteContract(contractId) {
  if (!confirm('确定要删除这个合同吗？')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/contracts/${contractId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('合同已删除');
      // 关闭列表模态框并刷新客户列表
      bootstrap.Modal.getInstance(document.getElementById('contractListModal')).hide();
      loadCustomers(currentPage);
    } else {
      showError(data.message || '删除失败');
    }
  } catch (error) {
    console.error('删除合同失败:', error);
    showError('删除失败');
  }
}

// ==================== 邮件详情翻译功能 ====================

// 翻译邮件
async function translateEmailInDetail() {
  try {
    const email = window.currentEmailInDetail;
    if (!email) {
      showError('邮件数据丢失');
      return;
    }
    
    const translateBtn = document.getElementById('translateEmailBtn');
    const originalBtn = translateBtn.innerHTML;
    
    // 显示加载状态
    translateBtn.disabled = true;
    translateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 翻译中...';
    
    const token = localStorage.getItem('authToken');
    
    console.log('🔄 调用翻译API...');
    
    const response = await fetch('/api/emails/ai-assist', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: email.title || '',
        content: email.content || '',
        type: 'translate'
        // 不传target_language，让AI自动检测：中文→英文，英文→中文
      })
    });
    
    const data = await response.json();
    
    translateBtn.disabled = false;
    translateBtn.innerHTML = originalBtn;
    
    if (!data.success) {
      showError('翻译失败: ' + (data.message || '未知错误'));
      return;
    }
    
    console.log('✅ 翻译成功');
    console.log('翻译结果:', data.result);
    console.log('原标题:', email.title);
    console.log('译文标题:', data.result.title);
    console.log('原文语言:', data.result.detected_language);
    console.log('目标语言:', data.result.target_language);
    
    // 显示翻译结果
    const translationDiv = document.getElementById('emailDetailTranslation');
    const titleTranslationSpan = document.getElementById('emailDetailTitleTranslation');
    
    if (translationDiv && data.result) {
      // 保存翻译结果
      window.currentEmailTranslation = {
        title: data.result.title || email.title,
        content: data.result.content || email.content,
        detected_language: data.result.detected_language,
        target_language: data.result.target_language
      };
      
      // 更新翻译内容（保留换行格式）
      const translatedContent = data.result.content ? data.result.content.trim() : '';
      // 使用innerHTML来保留换行，但先转义HTML防止XSS
      const escapedContent = translatedContent
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
      translationDiv.innerHTML = escapedContent;
      console.log('✅ 已更新翻译内容');
      
      // 更新翻译标题
      if (titleTranslationSpan) {
        const escapedTitle = (data.result.title || email.title).trim()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        titleTranslationSpan.innerHTML = escapedTitle;
        console.log('✅ 已更新翻译标题:', data.result.title);
      } else {
        console.warn('⚠️ 找不到标题翻译元素');
      }
      
      // 显示切换按钮
      document.getElementById('titleTranslationToggle').style.display = 'inline-flex';
      
      // 自动切换到译文
      showTranslatedContent();
      
      const langMap = {
        'zh': '中文',
        'en': '英文',
        'chinese': '中文',
        'english': '英文'
      };
      const fromLang = langMap[data.result.detected_language] || data.result.detected_language || '未知';
      const toLang = langMap[data.result.target_language] || data.result.target_language || '未知';
      
      showSuccess(`翻译完成（${fromLang} → ${toLang}）`);
    }
    
  } catch (error) {
    console.error('❌ 翻译失败:', error);
    showError('翻译失败: ' + error.message);
    
    const translateBtn = document.getElementById('translateEmailBtn');
    if (translateBtn) {
      translateBtn.disabled = false;
      translateBtn.innerHTML = '<i class="bi bi-translate"></i> 翻译邮件';
    }
  }
}

// 显示原文
function showOriginalContent() {
  // 切换标题
  const titleOriginal = document.getElementById('emailDetailTitle');
  const titleTranslation = document.getElementById('emailDetailTitleTranslation');
  if (titleOriginal) titleOriginal.style.display = 'inline';
  if (titleTranslation) titleTranslation.style.display = 'none';
  
  // 切换内容
  document.getElementById('emailDetailContent').style.display = 'block';
  document.getElementById('emailDetailTranslation').style.display = 'none';
  
  // 更新标题按钮状态
  const titleToggleBtns = document.querySelectorAll('#titleTranslationToggle button');
  if (titleToggleBtns.length > 0) {
    titleToggleBtns[0].classList.add('active');
    titleToggleBtns[1].classList.remove('active');
  }
}

// 显示译文
function showTranslatedContent() {
  // 切换标题
  const titleOriginal = document.getElementById('emailDetailTitle');
  const titleTranslation = document.getElementById('emailDetailTitleTranslation');
  if (titleOriginal) titleOriginal.style.display = 'none';
  if (titleTranslation) titleTranslation.style.display = 'inline';
  
  // 切换内容
  document.getElementById('emailDetailContent').style.display = 'none';
  document.getElementById('emailDetailTranslation').style.display = 'block';
  
  // 更新标题按钮状态
  const titleToggleBtns = document.querySelectorAll('#titleTranslationToggle button');
  if (titleToggleBtns.length > 0) {
    titleToggleBtns[0].classList.remove('active');
    titleToggleBtns[1].classList.add('active');
  }
}
</script>

