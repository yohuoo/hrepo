<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">å®¢æˆ·ç®¡ç†</li>
      </ol>
    </nav>
    <h1 class="page-title">å®¢æˆ·ç®¡ç†</h1>
  </div>
</div>

<!-- æœç´¢åŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-center">
      <div class="col-lg-9 col-md-8">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢å®¢æˆ·å§“åã€é‚®ç®±æˆ–å…¬å¸åç§°...">
        </div>
      </div>
      <div class="col-lg-3 col-md-4">
        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
          <i class="bi bi-plus-lg me-1"></i>æ–°å¢å®¢æˆ·
        </button>
      </div>
    </div>
  </div>
</div>

<!-- å®¢æˆ·åˆ—è¡¨ -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>å§“å</th>
            <th>é‚®ç®±åœ°å€</th>
            <th>å…¬å¸</th>
            <th>å¾€æ¥é‚®ä»¶æ¬¡æ•°</th>
            <th>æ²Ÿé€šè¿›åº¦</th>
            <th>å®¢æˆ·å…´è¶£åº¦</th>
            <th>æœ€è¿‘æ²Ÿé€šæ—¶é—´</th>
            <th>å½“å‰è¿›åº¦</th>
            <th width="100">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="customerTableBody">
          <tr>
            <td colspan="9" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="d-flex align-items-center gap-2">
          <span>æ¯é¡µæ˜¾ç¤º</span>
          <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelect" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <span>æ¡</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span id="customerCount">æ˜¾ç¤º1-4æ¡,å…±4æ¡</span>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å®¢æˆ·è¯¦æƒ…æŠ½å±‰ -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="customerDetailDrawer" aria-labelledby="customerDetailDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="customerDetailDrawerLabel">å®¢æˆ·è¯¦æƒ…</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="customerDetailContent">
      <!-- å®¢æˆ·è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>
  </div>
</div>

<!-- æ·»åŠ å®¢æˆ·æ¨¡æ€æ¡† -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ·»åŠ å®¢æˆ·</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addCustomerForm">
          <div class="mb-3">
            <label class="form-label">å§“å *</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">åå­—</label>
              <input type="text" class="form-control" name="first_name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“æ°</label>
              <input type="text" class="form-control" name="last_name">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">é‚®ç®± *</label>
            <input type="email" class="form-control" name="email" required>
          </div>
          <div class="mb-3">
            <label class="form-label">å…¬å¸ *</label>
            <input type="text" class="form-control" name="company" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="addCustomer()">æ·»åŠ </button>
      </div>
    </div>
  </div>
</div>

<!-- å®¢æˆ·è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="customerDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å®¢æˆ·è¯¦æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="customerDetailBody">
        <!-- å®¢æˆ·è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-info" id="reanalyzeBtn" onclick="reanalyzeCustomer()">
          <i class="bi bi-robot"></i> é‡æ–°AIåˆ†æ
        </button>
        <button type="button" class="btn btn-primary" id="editCustomerBtn" onclick="editCustomerFromDetail()">
          <i class="bi bi-pencil"></i> ç¼–è¾‘å®¢æˆ·
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘å®¢æˆ·æ¨¡æ€æ¡† -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¼–è¾‘å®¢æˆ·</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editCustomerForm">
          <input type="hidden" id="editCustomerId">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“å *</label>
              <input type="text" class="form-control" id="editCustomerName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">é‚®ç®± *</label>
              <input type="email" class="form-control" id="editCustomerEmail" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">åå­—</label>
              <input type="text" class="form-control" id="editCustomerFirstName">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">å§“æ°</label>
              <input type="text" class="form-control" id="editCustomerLastName">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">å…¬å¸ *</label>
            <input type="text" class="form-control" id="editCustomerCompany" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å›½å®¶</label>
              <input type="text" class="form-control" id="editCustomerCountry">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">åŸå¸‚</label>
              <input type="text" class="form-control" id="editCustomerCity">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">æ²Ÿé€šè¿›åº¦</label>
              <select class="form-select" id="editCustomerProgress">
                <option value="å¾…è”ç³»">å¾…è”ç³»</option>
                <option value="è·Ÿè¿›ä¸­">è·Ÿè¿›ä¸­</option>
                <option value="ä¸å†è·Ÿè¿›">ä¸å†è·Ÿè¿›</option>
                <option value="æš‚åœè·Ÿè¿›">æš‚åœè·Ÿè¿›</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">å…´è¶£åº¦</label>
              <select class="form-select" id="editCustomerInterest">
                <option value="æ— å…´è¶£">æ— å…´è¶£</option>
                <option value="ä½å…´è¶£">ä½å…´è¶£</option>
                <option value="ä¸­ç­‰å…´è¶£">ä¸­ç­‰å…´è¶£</option>
                <option value="é«˜å…´è¶£">é«˜å…´è¶£</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveCustomerEdit()">
          <i class="bi bi-check"></i> ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let pageSize = 20;
let currentMeetingDataInCustomer = null; // ä¿å­˜å½“å‰ä¼šè®®çš„å®Œæ•´æ•°æ®ï¼ˆå®¢æˆ·è¯¦æƒ…ä¸­ï¼‰

document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… å®¢æˆ·é¡µé¢å·²åŠ è½½');
  await loadCustomers();
  
  const searchInput = document.getElementById('searchKeyword');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchCustomers, 500));
  }
  
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  if (pageSizeSelect) {
    pageSizeSelect.addEventListener('change', changePageSize);
  }
});

async function loadCustomers(page = 1) {
  try {
    console.log('ğŸ”„ åŠ è½½å®¢æˆ·åˆ—è¡¨ï¼Œé¡µç :', page);
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    let queryParams = `page=${page}&pageSize=${pageSize}`;
    if (currentFilters.search) {
      queryParams += `&search=${encodeURIComponent(currentFilters.search)}`;
    }
    
    const url = `/api/customers/?${queryParams}`;
    console.log('ğŸ“ è¯·æ±‚URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ å®¢æˆ·æ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½å®¢æˆ·å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    currentPage = page;
    renderCustomerTable(data.customers || []);
    renderPagination(data.page, data.total_pages);
    updateCustomerCount(data.total, data.customers?.length || 0, page);
    
  } catch (error) {
    console.error('âŒ åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
    showError('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message);
  }
}

function renderCustomerTable(customers) {
  const tbody = document.getElementById('customerTableBody');
  if (!tbody) {
    console.error('âŒ æ‰¾ä¸åˆ°å®¢æˆ·è¡¨æ ¼');
    return;
  }
  
  console.log('ğŸ”„ æ¸²æŸ“å®¢æˆ·è¡¨æ ¼ï¼Œå…±', customers.length, 'æ¡');
  
  if (customers.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <h5>æš‚æ— å®¢æˆ·</h5>
            <p>å¼€å§‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªå®¢æˆ·</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  customers.forEach(customer => {
    const progressBadge = getProgressBadge(customer.communication_progress);
    const interestBadge = getInterestBadge(customer.interest_level);
    
    html += `
      <tr class="customer-row" data-customer-id="${customer.id}">
        <td>
          <a href="#" class="text-primary fw-bold" onclick="viewCustomerDetail(${customer.id})">
            ${customer.name}
          </a>
        </td>
        <td>${customer.email}</td>
        <td>${customer.company || '-'}</td>
        <td>${customer.email_count || 0}</td>
        <td>${progressBadge}</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              ${interestBadge}
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, 'æ— å…´è¶£')">æ— å…´è¶£</a></li>
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, 'ä½å…´è¶£')">ä½å…´è¶£</a></li>
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, 'ä¸­ç­‰å…´è¶£')">ä¸­ç­‰å…´è¶£</a></li>
              <li><a class="dropdown-item" href="#" onclick="updateInterestLevel(${customer.id}, 'é«˜å…´è¶£')">é«˜å…´è¶£</a></li>
            </ul>
          </div>
        </td>
        <td>${customer.last_communication_time ? formatDate(customer.last_communication_time) : '-'}</td>
        <td class="text-truncate" style="max-width: 200px;" title="${customer.current_progress || ''}">
          ${customer.current_progress || '-'}
        </td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="viewCustomerDetail(${customer.id})">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="editCustomer(${customer.id})">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteCustomer(${customer.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </a></li>
            </ul>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  console.log('âœ… å®¢æˆ·è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
}

function renderPagination(current, total) {
  const pagination = document.getElementById('pagination');
  if (!pagination) return;
  
  if (total <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadCustomers(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;
  
  // é¡µç 
  const startPage = Math.max(1, current - 2);
  const endPage = Math.min(total, current + 2);
  
  if (startPage > 1) {
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomers(1); return false;">1</a></li>`;
    if (startPage > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadCustomers(${i}); return false;">${i}</a>
      </li>
    `;
  }
  
  if (endPage < total) {
    if (endPage < total - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomers(${total}); return false;">${total}</a></li>`;
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadCustomers(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;
  
  pagination.innerHTML = html;
}

function updateCustomerCount(total, current, page) {
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, total);
  const countElement = document.getElementById('customerCount');
  if (countElement) {
    countElement.textContent = `æ˜¾ç¤º${start}-${end}æ¡,å…±${total}æ¡`;
  }
}

function searchCustomers() {
  currentFilters = {};
  
  const searchInput = document.getElementById('searchKeyword');
  const keyword = searchInput ? searchInput.value : '';
  if (keyword) currentFilters.search = keyword;
  
  loadCustomers(1);
}

function changePageSize() {
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  pageSize = pageSizeSelect ? parseInt(pageSizeSelect.value) : 20;
  loadCustomers(1);
}

// å®¢æˆ·è¯¦æƒ…åŠŸèƒ½ï¼ˆä¼˜åŒ–ç‰ˆï¼šå…ˆæ˜¾ç¤ºé¡µé¢ï¼Œåå°åŠ è½½AIåˆ†æï¼‰
async function viewCustomerDetail(customerId) {
  console.log('âœ… æŸ¥çœ‹å®¢æˆ·è¯¦æƒ…:', customerId);
  
  // é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤ç‚¹å‡»
  if (window.isLoadingCustomerDetail) {
    console.log('âš ï¸ æ­£åœ¨åŠ è½½å®¢æˆ·è¯¦æƒ…ï¼Œè¯·ç¨å€™...');
    return;
  }
  
  window.isLoadingCustomerDetail = true;
  
  try {
    const token = localStorage.getItem('authToken');
    
    // 1. å…ˆè·å–å®¢æˆ·åŸºæœ¬ä¿¡æ¯ã€é‚®ä»¶è®°å½•å’Œä¼šè®®è®°å½•
    const [customerResponse, emailResponse, meetingResponse] = await Promise.all([
      fetch(`/api/customers/${customerId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`/api/email-history/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`/api/zoom-meetings/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
    ]);
    
    const customerData = await customerResponse.json();
    const emailData = await emailResponse.json();
    const meetingData = await meetingResponse.json();
    
    if (!customerData.success) {
      showError('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥');
      window.isLoadingCustomerDetail = false;
      return;
    }
    
    const customer = customerData.customer;
    const emails = emailData.email_history || [];
    const meetings = meetingData.meetings || [];
    
    // ä¿å­˜å½“å‰å®¢æˆ·æ•°æ®
    window.currentCustomer = customer;
    
    // 2. å…ˆå°è¯•è·å–å·²æœ‰çš„åˆ†ææ•°æ®
    console.log('ğŸ” è·å–å·²æœ‰åˆ†ææ•°æ®...');
    const cachedAnalysisResponse = await fetch(`/api/customer-analysis/${customerId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    const cachedAnalysisData = await cachedAnalysisResponse.json();
    
    // 3. ä½¿ç”¨å·²æœ‰æ•°æ®æˆ–ç©ºæ•°æ®æ¸²æŸ“é¡µé¢ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰
    const initialAnalysis = cachedAnalysisData.success ? cachedAnalysisData.analysis : null;
    const needsAnalysis = !cachedAnalysisData.success || !cachedAnalysisData.analysis;
    
    renderCustomerDetailModal(customer, initialAnalysis, emails, meetings, needsAnalysis);
    
    // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('customerDetailModal'));
    modal.show();
    
    // 5. å¦‚æœéœ€è¦åˆ†æï¼Œç¦ç”¨æŒ‰é’®å¹¶åœ¨åå°åŠ è½½
    if (needsAnalysis) {
      console.log('ğŸ¤– åå°è§¦å‘AIå®¢æˆ·åˆ†æ...');
      
      // ç¦ç”¨æŒ‰é’®
      disableAnalysisButtons();
      
      // å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡é¡µé¢æ˜¾ç¤º
      loadAIAnalysis(customerId, customer, emails, meetings);
    } else {
      console.log('âœ… ä½¿ç”¨å·²æœ‰åˆ†ææ•°æ®');
    }
    
  } catch (error) {
    console.error('âŒ åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥:', error);
    showError('åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥: ' + error.message);
  } finally {
    window.isLoadingCustomerDetail = false;
  }
}

// åå°åŠ è½½AIåˆ†æ
async function loadAIAnalysis(customerId, customer, emails, meetings) {
  try {
    const token = localStorage.getItem('authToken');
    
    const analyzeResponse = await fetch(`/api/customer-analysis/${customerId}/analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const analyzeData = await analyzeResponse.json();
    
    if (analyzeData.success) {
      console.log('âœ… AIåˆ†æå®Œæˆï¼Œæ›´æ–°é¡µé¢');
      // æ›´æ–°é¡µé¢æ˜¾ç¤ºï¼ˆä¸é‡æ–°åŠ è½½æ•´ä¸ªæ¨¡æ€æ¡†ï¼‰
      renderCustomerDetailModal(customer, analyzeData.analysis, emails, meetings, false);
      // å¯ç”¨æŒ‰é’®
      enableAnalysisButtons();
    } else {
      console.log('âš ï¸ AIåˆ†æå¤±è´¥:', analyzeData.message);
      // æ˜¾ç¤ºåˆ†æå¤±è´¥çš„æç¤º
      const analysisSection = document.querySelector('.ai-analysis-section');
      if (analysisSection) {
        analysisSection.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-muted mb-0">AI æ™ºèƒ½åˆ†æ</h6>
          </div>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> AIåˆ†æå¤±è´¥: ${analyzeData.message}
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="reanalyzeCustomer()">é‡è¯•</button>
          </div>
        `;
      }
      // å¯ç”¨æŒ‰é’®
      enableAnalysisButtons();
    }
  } catch (error) {
    console.error('âŒ AIåˆ†æå¤±è´¥:', error);
    const analysisSection = document.querySelector('.ai-analysis-section');
    if (analysisSection) {
      analysisSection.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="text-muted mb-0">AI æ™ºèƒ½åˆ†æ</h6>
        </div>
        <div class="alert alert-danger">
          <i class="bi bi-x-circle"></i> AIåˆ†æå¤±è´¥: ${error.message}
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="reanalyzeCustomer()">é‡è¯•</button>
        </div>
      `;
    }
    // å¯ç”¨æŒ‰é’®
    enableAnalysisButtons();
  }
}

// ç¦ç”¨åˆ†æç›¸å…³æŒ‰é’®
function disableAnalysisButtons() {
  const reanalyzeBtn = document.getElementById('reanalyzeBtn');
  const editCustomerBtn = document.getElementById('editCustomerBtn');
  
  if (reanalyzeBtn) {
    reanalyzeBtn.disabled = true;
    reanalyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> AIåˆ†æä¸­...';
  }
  
  if (editCustomerBtn) {
    editCustomerBtn.disabled = true;
  }
}

// å¯ç”¨åˆ†æç›¸å…³æŒ‰é’®
function enableAnalysisButtons() {
  const reanalyzeBtn = document.getElementById('reanalyzeBtn');
  const editCustomerBtn = document.getElementById('editCustomerBtn');
  
  if (reanalyzeBtn) {
    reanalyzeBtn.disabled = false;
    reanalyzeBtn.innerHTML = '<i class="bi bi-robot"></i> é‡æ–°AIåˆ†æ';
  }
  
  if (editCustomerBtn) {
    editCustomerBtn.disabled = false;
  }
}

// ä¼šè®®çŠ¶æ€å¾½ç« 
function getStatusBadgeForMeeting(status) {
  const badges = {
    'pending': '<span class="badge bg-info"><i class="bi bi-hourglass-split"></i> ç­‰å¾…å¤„ç†</span>',
    'processing': '<span class="badge bg-warning"><i class="bi bi-gear"></i> å¤„ç†ä¸­</span>',
    'transcribing': '<span class="badge bg-primary"><i class="bi bi-mic"></i> è¯†åˆ«ä¸­</span>',
    'summarizing': '<span class="badge bg-info"><i class="bi bi-robot"></i> ç”Ÿæˆä¸­</span>',
    'completed': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å·²å®Œæˆ</span>',
    'failed': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±è´¥</span>'
  };
  return badges[status] || `<span class="badge bg-secondary">${status || 'æœªçŸ¥'}</span>`;
}

// å»é™¤Markdownæ ¼å¼ï¼Œæå–çº¯æ–‡æœ¬
function stripMarkdown(text) {
  if (!text) return '';
  
  return text
    .replace(/#{1,6}\s+/g, '')      // ç§»é™¤æ ‡é¢˜æ ‡è®° ##
    .replace(/\*\*(.+?)\*\*/g, '$1') // ç§»é™¤ç²—ä½“ **text**
    .replace(/\*(.+?)\*/g, '$1')     // ç§»é™¤æ–œä½“ *text*
    .replace(/\[(.+?)\]\(.+?\)/g, '$1') // ç§»é™¤é“¾æ¥ [text](url)
    .replace(/`(.+?)`/g, '$1')       // ç§»é™¤ä»£ç æ ‡è®° `code`
    .replace(/^[\s-*]\s+/gm, '')     // ç§»é™¤åˆ—è¡¨æ ‡è®°
    .replace(/\n{3,}/g, '\n\n')      // å¤šä¸ªæ¢è¡Œåˆå¹¶ä¸ºä¸¤ä¸ª
    .trim();
}

// å®‰å…¨è§£ææ•°ç»„æ•°æ®ï¼ˆå¤„ç†å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å¯¹è±¡çš„æƒ…å†µï¼‰
function parseArrayField(field, fieldName = 'unknown') {
  console.log(`ğŸ” è§£æå­—æ®µ ${fieldName}:`, field, 'Type:', typeof field);
  
  if (!field) {
    console.log(`  â†’ ç©ºå€¼ï¼Œè¿”å› []`);
    return [];
  }
  
  if (Array.isArray(field)) {
    console.log(`  â†’ å·²æ˜¯æ•°ç»„ï¼Œé•¿åº¦: ${field.length}`);
    return field;
  }
  
  if (typeof field === 'string') {
    try {
      const parsed = JSON.parse(field);
      console.log(`  â†’ è§£æJSONå­—ç¬¦ä¸²:`, parsed);
      return Array.isArray(parsed) ? parsed : [parsed];
    } catch (e) {
      console.log(`  â†’ JSONè§£æå¤±è´¥ï¼Œå½“ä½œæ™®é€šå­—ç¬¦ä¸²`);
      return [field];
    }
  }
  
  if (typeof field === 'object') {
    const values = Object.values(field);
    console.log(`  â†’ å¯¹è±¡è½¬æ•°ç»„:`, values);
    return values;
  }
  
  console.log(`  â†’ æœªçŸ¥ç±»å‹ï¼Œè¿”å› []`);
  return [];
}

function renderCustomerDetailModal(customer, analysis, emails, meetings = [], isLoading = false) {
  // è§£æåˆ†ææ•°æ®ä¸­çš„æ•°ç»„å­—æ®µ
  let opportunities = [];
  let risks = [];
  let strategicSuggestions = [];
  let nextActions = [];
  
  if (analysis) {
    opportunities = parseArrayField(analysis.opportunities, 'opportunities');
    risks = parseArrayField(analysis.risks, 'risks');
    strategicSuggestions = parseArrayField(analysis.strategic_suggestions, 'strategic_suggestions');
    nextActions = parseArrayField(analysis.next_actions, 'next_actions');
  }
  
  // é¢„å¤„ç†ä¼šè®®æ•°æ®ï¼Œæ·»åŠ æ‘˜è¦é¢„è§ˆ
  console.log('ğŸ¥ ä¼šè®®æ•°æ®:', meetings);
  const processedMeetings = (meetings || []).map(meeting => {
    let summaryPreview = '';
    console.log(`ğŸ” å¤„ç†ä¼šè®® ${meeting.id}:`, {
      has_ai_summary: !!meeting.ai_summary,
      ai_summary_length: meeting.ai_summary ? meeting.ai_summary.length : 0,
      ai_summary_preview: meeting.ai_summary ? meeting.ai_summary.substring(0, 50) : 'null'
    });
    
    if (meeting.ai_summary) {
      const plainText = stripMarkdown(meeting.ai_summary);
      console.log(`  â†’ stripMarkdownå:`, plainText.substring(0, 100));
      summaryPreview = plainText.substring(0, 80) + (plainText.length > 80 ? '...' : '');
    }
    
    console.log(`  â†’ summaryPreview:`, summaryPreview);
    return {
      ...meeting,
      summaryPreview
    };
  });
  
  const html = `
    <div class="customer-detail">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div class="mb-4">
        <h6 class="text-muted mb-2">åŸºæœ¬ä¿¡æ¯</h6>
        <div class="row">
          <div class="col-6">
            <strong>å§“å:</strong> ${customer.name}
          </div>
          <div class="col-6">
            <strong>é‚®ç®±:</strong> ${customer.email}
          </div>
        </div>
      </div>
      
      <!-- AIæ™ºèƒ½åˆ†æ -->
      <div class="mb-4 ai-analysis-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="text-muted mb-0">AI æ™ºèƒ½åˆ†æ</h6>
          ${isLoading ? `
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
          ` : ''}
        </div>
        
        ${analysis ? `
          <!-- å½“å‰æ²Ÿé€šè¿›åº¦ -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-chat-dots text-primary me-2"></i>
                <strong>å½“å‰æ²Ÿé€šè¿›åº¦</strong>
              </div>
              <p class="mb-0">${analysis.current_progress || 'æš‚æ— åˆ†ææ•°æ®'}</p>
            </div>
          </div>
          
          <!-- æœºä¼šç‚¹ä¸é£é™©é¢„è­¦ -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                <strong>æœºä¼šç‚¹ä¸é£é™©é¢„è­¦</strong>
              </div>
              <div class="row">
                <div class="col-6">
                  <h6 class="text-success">æœºä¼šç‚¹</h6>
                  <ul class="list-unstyled">
                    ${opportunities.length > 0 
                      ? opportunities.map(opp => {
                          if (typeof opp === 'object' && opp.title) {
                            const priority = opp.priority || '';
                            let priorityBadge = '';
                            
                            if (priority === 'é«˜') {
                              priorityBadge = `<span class="badge bg-success">é«˜</span>`;
                            } else if (priority === 'ä¸­') {
                              priorityBadge = `<span class="badge bg-info">ä¸­</span>`;
                            } else if (priority === 'ä½') {
                              priorityBadge = `<span class="badge bg-secondary">ä½</span>`;
                            } else if (priority) {
                              priorityBadge = `<span class="badge bg-primary">${priority}</span>`;
                            }
                            
                            return `<li class="mb-3">
                              <strong>â€¢ ${opp.title}</strong> ${priorityBadge}
                              <br><small class="text-muted">${opp.description || ''}</small>
                            </li>`;
                          }
                          return `<li>â€¢ ${opp}</li>`;
                        }).join('') 
                      : '<li class="text-muted">æš‚æ— æ•°æ®</li>'}
                  </ul>
                </div>
                <div class="col-6">
                  <h6 class="text-danger">é£é™©ç‚¹</h6>
                  <ul class="list-unstyled">
                    ${risks.length > 0 
                      ? risks.map(risk => {
                          if (typeof risk === 'object' && risk.title) {
                            return `<li><strong>â€¢ ${risk.title}</strong>${risk.severity ? ` <span class="badge bg-danger">${risk.severity}</span>` : ''}<br><small class="text-muted">${risk.description || ''}</small></li>`;
                          }
                          return `<li>â€¢ ${risk}</li>`;
                        }).join('') 
                      : '<li class="text-muted">æš‚æ— æ•°æ®</li>'}
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æˆ˜ç•¥å»ºè®® -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-lightbulb text-info me-2"></i>
                <strong>æˆ˜ç•¥å»ºè®®</strong>
              </div>
              <ul class="list-unstyled">
                ${strategicSuggestions.length > 0 
                  ? strategicSuggestions.map(rec => {
                      if (typeof rec === 'object' && rec.title) {
                        return `<li class="mb-3"><strong>â€¢ ${rec.title}</strong><br><small class="text-muted">${rec.description || ''}</small>${rec.expected_outcome ? `<br><small class="text-success"><i class="bi bi-check-circle"></i> é¢„æœŸç»“æœ: ${rec.expected_outcome}</small>` : ''}</li>`;
                      }
                      return `<li>â€¢ ${rec}</li>`;
                    }).join('') 
                  : '<li class="text-muted">æš‚æ— æ•°æ®</li>'}
              </ul>
            </div>
          </div>
          
          <!-- ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®® -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-list-check text-success me-2"></i>
                <strong>ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®</strong>
              </div>
              <ul class="list-unstyled">
                ${nextActions.length > 0 
                  ? nextActions.map((step, idx) => {
                      if (typeof step === 'object') {
                        // å­—æ®µåç§°ï¼šaction, deadline, priority
                        const action = step.action || step.title || step.name || 'è¡ŒåŠ¨é¡¹';
                        const deadline = step.deadline || '';
                        const priority = step.priority || '';
                        
                        let priorityBadge = '';
                        if (priority === 'ç´§æ€¥') {
                          priorityBadge = `<span class="badge bg-danger">${priority}</span>`;
                        } else if (priority === 'é‡è¦') {
                          priorityBadge = `<span class="badge bg-warning">${priority}</span>`;
                        } else if (priority === 'ä¸€èˆ¬') {
                          priorityBadge = `<span class="badge bg-secondary">${priority}</span>`;
                        } else if (priority) {
                          priorityBadge = `<span class="badge bg-info">${priority}</span>`;
                        }
                        
                        return `<li class="mb-2">
                          <strong>â€¢ ${action}</strong> ${priorityBadge}
                          ${deadline ? `<br><small class="text-muted"><i class="bi bi-calendar"></i> ${deadline}</small>` : ''}
                        </li>`;
                      }
                      return `<li>â€¢ ${step}</li>`;
                    }).join('') 
                  : '<li class="text-muted">æš‚æ— æ•°æ®</li>'}
              </ul>
            </div>
          </div>
        ` : `
          <!-- æ— åˆ†ææ•°æ®æ—¶çš„å ä½ç¬¦ -->
          <div class="card mb-3">
            <div class="card-body text-center p-5">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
              <p class="text-muted mb-0">æ­£åœ¨è¿›è¡ŒAIæ™ºèƒ½åˆ†æï¼Œè¯·ç¨å€™...</p>
              <small class="text-muted">è¿™å¯èƒ½éœ€è¦20-30ç§’</small>
            </div>
          </div>
        `}
      </div>
      
      <!-- å¾€æ¥è®°å½• -->
      <div class="mb-4">
        <ul class="nav nav-tabs" id="communicationTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" type="button" role="tab">
              é‚®ä»¶å¾€æ¥è®°å½•
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="meetings-tab" data-bs-toggle="tab" data-bs-target="#meetings" type="button" role="tab">
              è§†é¢‘ä¼šè®®è®°å½•
            </button>
          </li>
        </ul>
        <div class="tab-content" id="communicationTabContent">
          <div class="tab-pane fade show active" id="emails" role="tabpanel">
            <div class="mt-3">
              ${renderEmailHistory(emails)}
            </div>
          </div>
          <div class="tab-pane fade" id="meetings" role="tabpanel">
            <div class="mt-3">
              ${processedMeetings && processedMeetings.length > 0 ? `
                <div class="list-group">
                  ${processedMeetings.map(meeting => `
                    <a href="#" class="list-group-item list-group-item-action" onclick="showMeetingDetailInCustomer(${meeting.id}); return false;">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h6 class="mb-1">${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}</h6>
                          <p class="mb-1 text-muted small">
                            <i class="bi bi-calendar"></i> ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : 'æœªçŸ¥æ—¥æœŸ'}
                          </p>
                          ${meeting.summaryPreview ? `
                            <p class="mb-0 text-muted small" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                              <i class="bi bi-robot"></i> ${meeting.summaryPreview}
                            </p>
                          ` : `
                            <p class="mb-0 text-muted small">
                              <i class="bi bi-hourglass-split"></i> ${meeting.status === 'completed' ? 'æš‚æ— æ‘˜è¦' : 'å¤„ç†ä¸­...'}
                            </p>
                          `}
                        </div>
                        <div class="text-end">
                          ${getStatusBadgeForMeeting(meeting.status)}
                        </div>
                      </div>
                    </a>
                  `).join('')}
                </div>
              ` : '<p class="text-muted">æš‚æ— è§†é¢‘ä¼šè®®è®°å½•</p>'}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  const detailBody = document.getElementById('customerDetailBody');
  if (detailBody) {
    detailBody.innerHTML = html;
  }
  console.log('âœ… å®¢æˆ·è¯¦æƒ…æ¸²æŸ“å®Œæˆ');
}

function renderEmailHistory(emails) {
  if (emails.length === 0) {
    return '<p class="text-muted">æš‚æ— é‚®ä»¶å¾€æ¥è®°å½•</p>';
  }
  
  let html = '<div class="list-group">';
  emails.forEach(email => {
    const preview = (email.content || '').substring(0, 80);
    html += `
      <a href="#" class="list-group-item list-group-item-action" onclick="showEmailDetailInCustomer(${email.id}); return false;">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1">${email.title || 'æ— ä¸»é¢˜'}</h6>
            <p class="mb-1 text-muted small">${preview}${preview.length >= 80 ? '...' : ''}</p>
            <small class="text-muted">
              <i class="bi bi-send"></i> ${email.send_address} â†’ ${email.receive_address}
            </small>
          </div>
          <div class="text-end">
            <small class="text-muted">${formatDate(email.send_time)}</small>
            <br>
            <span class="badge ${email.email_type === 'sent' ? 'bg-primary' : 'bg-success'} mt-1">
              ${email.email_type === 'sent' ? 'å·²å‘é€' : 'å·²æ¥æ”¶'}
            </span>
          </div>
        </div>
      </a>
    `;
  });
  html += '</div>';
  
  return html;
}

// åœ¨å®¢æˆ·è¯¦æƒ…ä¸­æŸ¥çœ‹é‚®ä»¶è¯¦æƒ…
async function showEmailDetailInCustomer(emailId) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/email-history/${emailId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥');
      return;
    }
    
    const email = data.email_history;
    
    // åˆ›å»ºé‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡†
    const modalHTML = `
      <div class="modal fade" id="emailDetailInCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-envelope"></i> é‚®ä»¶è¯¦æƒ…</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <strong>ä¸»é¢˜:</strong> ${email.title || 'æ— ä¸»é¢˜'}
              </div>
              <div class="mb-3">
                <strong>å‘ä»¶äºº:</strong> ${email.send_address}
              </div>
              <div class="mb-3">
                <strong>æ”¶ä»¶äºº:</strong> ${email.receive_address}
              </div>
              <div class="mb-3">
                <strong>å‘é€æ—¶é—´:</strong> ${new Date(email.send_time).toLocaleString('zh-CN')}
              </div>
              <div class="mb-3">
                <strong>ç±»å‹:</strong> 
                <span class="badge ${email.email_type === 'sent' ? 'bg-primary' : 'bg-success'}">
                  ${email.email_type === 'sent' ? 'å·²å‘é€' : 'å·²æ¥æ”¶'}
                </span>
              </div>
              <hr>
              <div class="mb-3">
                <strong>å†…å®¹:</strong>
                <div class="mt-2 p-3 bg-light rounded" style="white-space: pre-wrap;">
                  ${email.content || '(æ— å†…å®¹)'}
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
    const oldModal = document.getElementById('emailDetailInCustomerModal');
    if (oldModal) oldModal.remove();
    
    // æ·»åŠ æ–°æ¨¡æ€æ¡†
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('emailDetailInCustomerModal'));
    modal.show();
    
  } catch (error) {
    console.error('âŒ è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥: ' + error.message);
  }
}

// åœ¨å®¢æˆ·è¯¦æƒ…ä¸­æŸ¥çœ‹ä¼šè®®è¯¦æƒ…
async function showMeetingDetailInCustomer(meetingId) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/zoom-meetings/${meetingId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–ä¼šè®®è¯¦æƒ…å¤±è´¥');
      return;
    }
    
    const meeting = data.meeting;
    
    // åˆ›å»ºä¼šè®®è¯¦æƒ…æ¨¡æ€æ¡†
    const modalHTML = `
      <div class="modal fade" id="meetingDetailInCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-camera-video"></i> ä¼šè®®è¯¦æƒ…</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <strong>ä¼šè®®æ ‡é¢˜:</strong> ${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}
              </div>
              <div class="mb-3">
                <strong>ä¼šè®®æ—¥æœŸ:</strong> ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}
              </div>
              <div class="mb-3">
                <strong>è§†é¢‘æ–‡ä»¶:</strong> ${meeting.video_file_name || '-'}
              </div>
              <div class="mb-3">
                <strong>çŠ¶æ€:</strong> ${getStatusBadgeForMeeting(meeting.status)}
              </div>
              
              ${meeting.ai_summary ? `
                <hr>
                <div class="mb-3">
                  <strong><i class="bi bi-robot"></i> AI ä¼šè®®æ‘˜è¦:</strong>
                  <div class="mt-2 p-3 bg-light rounded markdown-content" id="customerMeetingSummary-${meeting.id}"></div>
                </div>
              ` : `
                <hr>
                <div class="alert alert-info mb-0">
                  <i class="bi bi-info-circle"></i> ${meeting.status === 'completed' ? 'æš‚æ— AIæ‘˜è¦' : 'AIæ‘˜è¦ç”Ÿæˆä¸­ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹'}
                </div>
              `}
              
              ${meeting.transcript_text ? `
                <hr>
                <div class="mb-3">
                  <strong><i class="bi bi-file-text"></i> ä¼šè®®æ–‡å­—ç¨¿:</strong>
                  <div class="mt-2 p-3 bg-light rounded" style="max-height: 300px; overflow-y: auto; white-space: pre-line; line-height: 1.8;">
                    ${meeting.transcript_text}
                  </div>
                </div>
              ` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
              <button type="button" class="btn btn-info" onclick="downloadTranscriptInCustomer()">
                <i class="bi bi-file-text"></i> ä¸‹è½½æ–‡å­—ç¨¿ (.txt)
              </button>
              <button type="button" class="btn btn-primary" onclick="downloadAISummaryInCustomer()">
                <i class="bi bi-file-earmark-text"></i> ä¸‹è½½AIåˆ†æ (.md)
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ä¿å­˜å½“å‰ä¼šè®®æ•°æ®
    currentMeetingDataInCustomer = meeting;
    
    // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
    const oldModal = document.getElementById('meetingDetailInCustomerModal');
    if (oldModal) oldModal.remove();
    
    // æ·»åŠ æ–°æ¨¡æ€æ¡†
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // æ¸²æŸ“Markdownï¼ˆåœ¨DOMæ’å…¥åï¼‰
    if (meeting.ai_summary && typeof marked !== 'undefined') {
      setTimeout(() => {
        const summaryEl = document.getElementById(`customerMeetingSummary-${meeting.id}`);
        if (summaryEl) {
          try {
            summaryEl.innerHTML = marked.parse(meeting.ai_summary);
          } catch (e) {
            console.error('Markdownæ¸²æŸ“å¤±è´¥:', e);
            summaryEl.textContent = meeting.ai_summary;
          }
        }
      }, 100);
    }
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('meetingDetailInCustomerModal'));
    modal.show();
    
  } catch (error) {
    console.error('âŒ è·å–ä¼šè®®è¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–ä¼šè®®è¯¦æƒ…å¤±è´¥: ' + error.message);
  }
}

// æ›´æ–°å®¢æˆ·å…´è¶£ç¨‹åº¦
async function updateInterestLevel(customerId, level) {
  console.log('âœ… æ›´æ–°å®¢æˆ·å…´è¶£ç¨‹åº¦:', customerId, level);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/customers/${customerId}/interest-level`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        interest_level: level
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('å®¢æˆ·å…´è¶£ç¨‹åº¦å·²æ›´æ–°');
      await loadCustomers(currentPage);
    } else {
      showError('æ›´æ–°å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°å¤±è´¥:', error);
    showError('æ›´æ–°å¤±è´¥: ' + error.message);
  }
}

// å®¢æˆ·æ“ä½œ
// ç¼–è¾‘å®¢æˆ·
async function editCustomer(id) {
  console.log('âœ… ç¼–è¾‘å®¢æˆ·:', id);
  await viewCustomerForEdit(id);
}

// ä»è¯¦æƒ…é¡µé¢è¿›å…¥ç¼–è¾‘
function editCustomerFromDetail() {
  if (!window.currentCustomer) {
    showError('æ— æ³•è·å–å®¢æˆ·ä¿¡æ¯');
    return;
  }
  
  // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
  const detailModal = bootstrap.Modal.getInstance(document.getElementById('customerDetailModal'));
  if (detailModal) {
    detailModal.hide();
  }
  
  // å¡«å……ç¼–è¾‘è¡¨å•
  fillCustomerEditForm(window.currentCustomer);
  
  // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
  const editModal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
  editModal.show();
}

// é‡æ–°AIåˆ†æå®¢æˆ·
async function reanalyzeCustomer() {
  if (!window.currentCustomer) {
    showError('æ— æ³•è·å–å®¢æˆ·ä¿¡æ¯');
    return;
  }
  
  const customerId = window.currentCustomer.id;
  
  if (!confirm('ç¡®å®šè¦é‡æ–°è¿›è¡ŒAIåˆ†æå—ï¼Ÿ\n\nè¿™å°†ä½¿ç”¨æœ€æ–°çš„é‚®ä»¶å’Œä¼šè®®æ•°æ®é‡æ–°ç”Ÿæˆå®¢æˆ·åˆ†ææŠ¥å‘Šã€‚')) {
    return;
  }
  
  try {
    console.log('ğŸ¤– å¼€å§‹é‡æ–°AIå®¢æˆ·åˆ†æ...');
    
    // ç¦ç”¨æŒ‰é’®
    disableAnalysisButtons();
    
    const token = localStorage.getItem('authToken');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    let analysisSectionEl = document.querySelector('.ai-analysis-section');
    if (analysisSectionEl) {
      const loadingHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="text-muted mb-0">AI æ™ºèƒ½åˆ†æ</h6>
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-body text-center p-5">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="text-muted mb-0">æ­£åœ¨è¿›è¡ŒAIæ™ºèƒ½åˆ†æï¼Œè¯·ç¨å€™...</p>
            <small class="text-muted">è¿™å¯èƒ½éœ€è¦20-30ç§’</small>
          </div>
        </div>
      `;
      analysisSectionEl.innerHTML = loadingHTML;
    }
    
    // é‡æ–°è·å–é‚®ä»¶å’Œä¼šè®®æ•°æ®ï¼ˆå¯èƒ½æœ‰æ–°çš„æ•°æ®ï¼‰
    const [emailResponse, meetingResponse] = await Promise.all([
      fetch(`/api/email-history/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`/api/zoom-meetings/?customer_id=${customerId}&pageSize=10`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
    ]);
    
    const emailData = await emailResponse.json();
    const meetingData = await meetingResponse.json();
    const emails = emailData.email_history || [];
    const meetings = meetingData.meetings || [];
    
    const response = await fetch(`/api/customer-analysis/${customerId}/analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('AIåˆ†æå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      enableAnalysisButtons();
      return;
    }
    
    console.log('âœ… AIåˆ†æå®Œæˆï¼Œæ›´æ–°é¡µé¢');
    
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    renderCustomerDetailModal(window.currentCustomer, data.analysis, emails, meetings, false);
    
    // å¯ç”¨æŒ‰é’®
    enableAnalysisButtons();
    
    // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä¸ä½¿ç”¨ alertï¼‰
    analysisSectionEl = document.querySelector('.ai-analysis-section');
    if (analysisSectionEl) {
      const successBanner = document.createElement('div');
      successBanner.className = 'alert alert-success alert-dismissible fade show mb-3';
      successBanner.innerHTML = `
        <i class="bi bi-check-circle"></i> AIåˆ†æå·²å®Œæˆï¼
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      analysisSectionEl.insertBefore(successBanner, analysisSectionEl.firstChild);
      
      // 3ç§’åè‡ªåŠ¨å…³é—­
      setTimeout(() => {
        successBanner.remove();
      }, 3000);
    }
    
  } catch (error) {
    console.error('âŒ AIåˆ†æå¤±è´¥:', error);
    showError('AIåˆ†æå¤±è´¥: ' + error.message);
    enableAnalysisButtons();
  }
}

// è·å–å®¢æˆ·å¹¶æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
async function viewCustomerForEdit(id) {
  console.log('âœ… è·å–å®¢æˆ·ä¿¡æ¯ç”¨äºç¼–è¾‘:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/customers/${id}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      fillCustomerEditForm(data.customer);
      
      // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
      const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
      modal.show();
    } else {
      showError('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('âŒ è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥:', error);
    showError('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
  }
}

// å¡«å……ç¼–è¾‘è¡¨å•
function fillCustomerEditForm(customer) {
  document.getElementById('editCustomerId').value = customer.id;
  document.getElementById('editCustomerName').value = customer.name || '';
  document.getElementById('editCustomerEmail').value = customer.email || '';
  document.getElementById('editCustomerFirstName').value = customer.first_name || '';
  document.getElementById('editCustomerLastName').value = customer.last_name || '';
  document.getElementById('editCustomerCompany').value = customer.company || '';
  document.getElementById('editCustomerCountry').value = customer.country || '';
  document.getElementById('editCustomerCity').value = customer.city || '';
  document.getElementById('editCustomerProgress').value = customer.communication_progress || 'å¾…è”ç³»';
  document.getElementById('editCustomerInterest').value = customer.interest_level || 'æ— å…´è¶£';
}

// ä¿å­˜ç¼–è¾‘
async function saveCustomerEdit() {
  console.log('âœ… ä¿å­˜å®¢æˆ·ç¼–è¾‘');
  
  const id = document.getElementById('editCustomerId').value;
  const name = document.getElementById('editCustomerName').value;
  const email = document.getElementById('editCustomerEmail').value;
  const company = document.getElementById('editCustomerCompany').value;
  
  if (!name || !email || !company) {
    showWarning('è¯·å¡«å†™å§“åã€é‚®ç®±å’Œå…¬å¸');
    return;
  }
  
  const customerData = {
    name: name,
    email: email,
    first_name: document.getElementById('editCustomerFirstName').value,
    last_name: document.getElementById('editCustomerLastName').value,
    company: company,
    country: document.getElementById('editCustomerCountry').value,
    city: document.getElementById('editCustomerCity').value,
    communication_progress: document.getElementById('editCustomerProgress').value,
    interest_level: document.getElementById('editCustomerInterest').value
  };
  
  try {
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ æ›´æ–°å®¢æˆ·ä¿¡æ¯...');
    
    const response = await fetch(`/api/customers/${id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(customerData)
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ æ›´æ–°å“åº”:', data);
    
    if (data.success) {
      showSuccess('å®¢æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
      
      // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
      const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
      if (modal) {
        modal.hide();
      }
      
      // åˆ·æ–°å®¢æˆ·åˆ—è¡¨
      await loadCustomers(currentPage);
    } else {
      showError('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ ä¿å­˜å®¢æˆ·å¤±è´¥:', error);
    showError('ä¿å­˜å¤±è´¥: ' + error.message);
  }
}

async function deleteCustomer(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿ')) return;
  
  console.log('âœ… åˆ é™¤å®¢æˆ·:', id);
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/customers/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('å®¢æˆ·å·²åˆ é™¤');
      await loadCustomers(currentPage);
    } else {
      showError('åˆ é™¤å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    console.error('âŒ åˆ é™¤å®¢æˆ·å¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

// æ·»åŠ å®¢æˆ·
async function addCustomer() {
  console.log('âœ… æ·»åŠ æ–°å®¢æˆ·');
  
  const formData = {
    name: document.querySelector('input[name="name"]').value,
    first_name: document.querySelector('input[name="first_name"]').value,
    last_name: document.querySelector('input[name="last_name"]').value,
    email: document.querySelector('input[name="email"]').value,
    company: document.querySelector('input[name="company"]').value
  };
  
  if (!formData.name || !formData.email || !formData.company) {
    showWarning('è¯·å¡«å†™å¿…å¡«é¡¹ï¼ˆå§“åã€é‚®ç®±ã€å…¬å¸ï¼‰');
    return;
  }
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/customers/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('å®¢æˆ·æ·»åŠ æˆåŠŸï¼');
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
      if (modal) {
        modal.hide();
      }
      
      document.getElementById('addCustomerForm').reset();
      await loadCustomers(1);
    } else {
      showError('æ·»åŠ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('âŒ æ·»åŠ å®¢æˆ·å¤±è´¥:', error);
    showError('æ·»åŠ å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// å·¥å…·å‡½æ•°
function getProgressBadge(progress) {
  const badges = {
    'å¾…è”ç³»': '<span class="badge bg-secondary">å¾…è”ç³»</span>',
    'è·Ÿè¿›ä¸­': '<span class="badge bg-primary">è·Ÿè¿›ä¸­</span>',
    'ä¸å†è·Ÿè¿›': '<span class="badge bg-danger">ä¸å†è·Ÿè¿›</span>',
    'æš‚åœè·Ÿè¿›': '<span class="badge bg-warning">æš‚åœè·Ÿè¿›</span>'
  };
  return badges[progress] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
}

function getInterestBadge(level) {
  const badges = {
    'æ— å…´è¶£': '<span class="badge bg-secondary">æ— å…´è¶£</span>',
    'ä½å…´è¶£': '<span class="badge bg-warning">ä½å…´è¶£</span>',
    'ä¸­ç­‰å…´è¶£': '<span class="badge bg-info">ä¸­ç­‰å…´è¶£</span>',
    'é«˜å…´è¶£': '<span class="badge bg-success">é«˜å…´è¶£</span>'
  };
  return badges[level] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN');
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showLoading() {
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
}

function hideLoading() {
  // éšè—åŠ è½½çŠ¶æ€
}

// ä¸‹è½½æ–‡å­—ç¨¿ï¼ˆå®¢æˆ·è¯¦æƒ…ä¸­ä½¿ç”¨ï¼‰
function downloadTranscriptInCustomer() {
  if (!currentMeetingDataInCustomer || !currentMeetingDataInCustomer.transcript_text) {
    showWarning('æš‚æ— æ–‡å­—ç¨¿å†…å®¹');
    return;
  }
  
  const meeting = currentMeetingDataInCustomer;
  const fileName = `${meeting.meeting_title || 'ä¼šè®®'}_æ–‡å­—ç¨¿_${new Date().toISOString().split('T')[0]}.txt`;
  
  // æ„å»ºæ–‡å­—ç¨¿å†…å®¹
  let content = `ä¼šè®®æ–‡å­—ç¨¿\n`;
  content += `=====================================\n\n`;
  content += `ä¼šè®®æ ‡é¢˜: ${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}\n`;
  content += `ä¼šè®®æ—¥æœŸ: ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}\n`;
  if (meeting.customer) {
    content += `å…³è”å®¢æˆ·: ${meeting.customer.name} (${meeting.customer.company})\n`;
  }
  content += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
  content += `\n=====================================\n\n`;
  content += meeting.transcript_text;
  
  // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('æ–‡å­—ç¨¿ä¸‹è½½æˆåŠŸ');
}

// ä¸‹è½½AIåˆ†æï¼ˆå®¢æˆ·è¯¦æƒ…ä¸­ä½¿ç”¨ï¼‰
function downloadAISummaryInCustomer() {
  if (!currentMeetingDataInCustomer || !currentMeetingDataInCustomer.ai_summary) {
    showWarning('æš‚æ— AIåˆ†æå†…å®¹');
    return;
  }
  
  const meeting = currentMeetingDataInCustomer;
  const fileName = `${meeting.meeting_title || 'ä¼šè®®'}_AIåˆ†æ_${new Date().toISOString().split('T')[0]}.md`;
  
  // æ„å»ºMarkdownå†…å®¹
  let content = `# ${meeting.meeting_title || 'ä¼šè®®'} - AIæ™ºèƒ½åˆ†æ\n\n`;
  content += `---\n\n`;
  content += `## ğŸ“‹ ä¼šè®®ä¿¡æ¯\n\n`;
  content += `- **ä¼šè®®æ ‡é¢˜**: ${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}\n`;
  content += `- **ä¼šè®®æ—¥æœŸ**: ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}\n`;
  if (meeting.customer) {
    content += `- **å…³è”å®¢æˆ·**: ${meeting.customer.name} (${meeting.customer.company})\n`;
  }
  content += `- **åˆ†ææ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n`;
  content += `\n---\n\n`;
  content += `## ğŸ¤– AIä¼šè®®æ€»ç»“\n\n`;
  content += meeting.ai_summary;
  content += `\n\n---\n\n`;
  content += `*æœ¬åˆ†æç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ*\n`;
  
  // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('AIåˆ†æä¸‹è½½æˆåŠŸ');
}

function showToast(message, type) {
  // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
  console.log(`${type}: ${message}`);
}
</script>
