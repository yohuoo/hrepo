<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">æ¡ˆä¾‹æ€»ç»“</li>
      </ol>
    </nav>
    <h1 class="page-title">
      <i class="bi bi-trophy"></i> æ¡ˆä¾‹æ€»ç»“
      <small class="text-muted ms-2">åˆ†äº«æˆåŠŸç»éªŒ</small>
    </h1>
  </div>
</div>

<!-- æ“ä½œæ  -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-center">
      <div class="col-lg-9">
        <div class="alert alert-info mb-0">
          <i class="bi bi-info-circle"></i> 
          <strong>æç¤ºï¼š</strong>åªæœ‰æ ‡è®°ä¸º"å·²æˆäº¤"çš„å®¢æˆ·æ‰èƒ½ç”Ÿæˆæ¡ˆä¾‹æ€»ç»“ã€‚AIå°†åˆ†æå®¢æˆ·çš„é‚®ä»¶å¾€æ¥ã€é”€å”®è®°å½•å’Œå®¢æˆ·æŠ¥å‘Šï¼Œç”Ÿæˆä¸“ä¸šçš„æ¡ˆä¾‹åˆ†æã€‚
        </div>
      </div>
      <div class="col-lg-3">
        <button class="btn btn-primary w-100" onclick="showGenerateCaseModal()">
          <i class="bi bi-stars me-1"></i>ç”Ÿæˆæ–°æ¡ˆä¾‹
        </button>
      </div>
    </div>
  </div>
</div>

<!-- æ¡ˆä¾‹åˆ—è¡¨ -->
<div class="row" id="caseStudiesContainer">
  <div class="col-12 text-center p-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>
</div>

<!-- åˆ†é¡µ -->
<div class="card mt-4" id="paginationCard" style="display: none;">
  <div class="card-footer">
    <div class="row align-items-center">
      <div class="col-md-6">
        <span id="caseCount">å…± 0 ä¸ªæ¡ˆä¾‹</span>
      </div>
      <div class="col-md-6">
        <nav>
          <ul class="pagination pagination-sm mb-0 justify-content-end" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- ç”Ÿæˆæ¡ˆä¾‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="generateCaseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-stars"></i> ç”Ÿæˆæ¡ˆä¾‹æ€»ç»“</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">é€‰æ‹©å·²æˆäº¤å®¢æˆ·</label>
          <select class="form-select" id="dealCustomerSelect">
            <option value="">åŠ è½½ä¸­...</option>
          </select>
        </div>
        <div class="alert alert-warning">
          <i class="bi bi-clock-history"></i> AIç”Ÿæˆæ¡ˆä¾‹éœ€è¦15-30ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="generateCase()">
          <i class="bi bi-stars"></i> å¼€å§‹ç”Ÿæˆ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- æ¡ˆä¾‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="caseDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title" id="caseDetailTitle">æ¡ˆä¾‹è¯¦æƒ…</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="caseDetailBody">
        <!-- æ¡ˆä¾‹è¯¦æƒ…å°†åŠ¨æ€åŠ è½½ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;
let currentUser = null;

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', async () => {
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  const userStr = localStorage.getItem('currentUser');
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
  
  await loadCaseStudies();
});

// åŠ è½½æ¡ˆä¾‹åˆ—è¡¨
async function loadCaseStudies(page = 1) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/case-studies?page=${page}&page_size=12`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('åŠ è½½å¤±è´¥');
      return;
    }
    
    const caseStudies = data.caseStudies || [];
    currentPage = data.page;
    totalPages = data.totalPages;
    
    renderCaseStudies(caseStudies);
    renderPagination(data.total);
    
  } catch (error) {
    console.error('åŠ è½½æ¡ˆä¾‹åˆ—è¡¨å¤±è´¥:', error);
    showError('åŠ è½½å¤±è´¥');
  }
}

// æ¸²æŸ“æ¡ˆä¾‹åˆ—è¡¨
function renderCaseStudies(caseStudies) {
  const container = document.getElementById('caseStudiesContainer');
  
  if (caseStudies.length === 0) {
    container.innerHTML = `
      <div class="col-12">
        <div class="alert alert-warning">
          <i class="bi bi-inbox"></i> æš‚æ— æ¡ˆä¾‹ï¼Œç‚¹å‡»"ç”Ÿæˆæ–°æ¡ˆä¾‹"å¼€å§‹åˆ›å»º
        </div>
      </div>
    `;
    return;
  }
  
  let html = '';
  caseStudies.forEach(caseStudy => {
    const customer = caseStudy.customer || {};
    const user = caseStudy.user || {};
    const generator = caseStudy.generator || {};
    
    html += `
      <div class="col-lg-6 col-xl-4 mb-4">
        <div class="card h-100 shadow-sm hover-shadow">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h5 class="card-title mb-0">
                <i class="bi bi-trophy text-warning"></i> ${caseStudy.title || 'æœªå‘½åæ¡ˆä¾‹'}
              </h5>
              <span class="badge bg-success">å·²æˆäº¤</span>
            </div>
            
            <div class="mb-3">
              <p class="text-muted mb-1"><i class="bi bi-building"></i> <strong>${customer.company || '-'}</strong></p>
              <p class="text-muted mb-1"><i class="bi bi-person"></i> ${customer.name || '-'}</p>
              <p class="text-muted mb-1"><i class="bi bi-envelope"></i> ${customer.email || '-'}</p>
            </div>
            
            <hr>
            
            <div class="mb-3">
              <small class="text-muted">
                <i class="bi bi-person-badge"></i> å½’å±ï¼š${user.username || '-'}<br>
                <i class="bi bi-robot"></i> ç”Ÿæˆè€…ï¼š${generator.username || '-'}<br>
                <i class="bi bi-clock"></i> ${new Date(caseStudy.created_at).toLocaleString('zh-CN')}
              </small>
            </div>
            
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary btn-sm" onclick="viewCaseDetail(${caseStudy.id})">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
              </button>
              ${(currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin' || caseStudy.generated_by === currentUser.id)) ? `
              <button class="btn btn-outline-danger btn-sm" onclick="deleteCase(${caseStudy.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </button>
              ` : ''}
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// æ¸²æŸ“åˆ†é¡µ
function renderPagination(total) {
  const paginationCard = document.getElementById('paginationCard');
  const countSpan = document.getElementById('caseCount');
  const pagination = document.getElementById('pagination');
  
  if (total === 0) {
    paginationCard.style.display = 'none';
    return;
  }
  
  paginationCard.style.display = 'block';
  countSpan.textContent = `å…± ${total} ä¸ªæ¡ˆä¾‹`;
  
  let html = '';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadCaseStudies(${currentPage - 1}); return false;">ä¸Šä¸€é¡µ</a>
    </li>
  `;
  
  // é¡µç 
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
      html += `
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="loadCaseStudies(${i}); return false;">${i}</a>
        </li>
      `;
    } else if (i === currentPage - 3 || i === currentPage + 3) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadCaseStudies(${currentPage + 1}); return false;">ä¸‹ä¸€é¡µ</a>
    </li>
  `;
  
  pagination.innerHTML = html;
}

// æ˜¾ç¤ºç”Ÿæˆæ¡ˆä¾‹æ¨¡æ€æ¡†
async function showGenerateCaseModal() {
  try {
    const token = localStorage.getItem('authToken');
    
    // è·å–å·²æˆäº¤çš„å®¢æˆ·åˆ—è¡¨
    const response = await fetch('/api/customers?page_size=1000', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–å®¢æˆ·åˆ—è¡¨å¤±è´¥');
      return;
    }
    
    const dealCustomers = (data.customers || []).filter(c => c.deal_status === 'å·²æˆäº¤');
    
    if (dealCustomers.length === 0) {
      showWarning('æš‚æ— å·²æˆäº¤çš„å®¢æˆ·ï¼Œè¯·å…ˆåœ¨å®¢æˆ·ç®¡ç†ä¸­å°†å®¢æˆ·æ ‡è®°ä¸º"å·²æˆäº¤"');
      return;
    }
    
    const select = document.getElementById('dealCustomerSelect');
    select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·...</option>';
    dealCustomers.forEach(c => {
      select.innerHTML += `<option value="${c.id}">${c.name} - ${c.company}</option>`;
    });
    
    new bootstrap.Modal(document.getElementById('generateCaseModal')).show();
    
  } catch (error) {
    console.error('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
    showError('åŠ è½½å¤±è´¥');
  }
}

// ç”Ÿæˆæ¡ˆä¾‹
async function generateCase() {
  console.log('ğŸ¯ å¼€å§‹ç”Ÿæˆæ¡ˆä¾‹');
  
  const customerId = document.getElementById('dealCustomerSelect').value;
  console.log('ğŸ“‹ é€‰ä¸­çš„å®¢æˆ·ID:', customerId);
  
  if (!customerId) {
    console.warn('âš ï¸ æœªé€‰æ‹©å®¢æˆ·');
    showWarning('è¯·é€‰æ‹©å®¢æˆ·');
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    console.log('ğŸ”‘ Tokenå­˜åœ¨:', !!token);
    
    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
    const generateBtn = event.target;
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ç”Ÿæˆä¸­...';
    
    console.log('ğŸ“¤ å‘é€ç”Ÿæˆè¯·æ±‚...');
    const response = await fetch(`/api/case-studies/generate/${customerId}`, {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status);
    const data = await response.json();
    console.log('ğŸ“¦ å“åº”æ•°æ®:', data);
    
    // å…³é—­æ¨¡æ€æ¡†
    const modal = bootstrap.Modal.getInstance(document.getElementById('generateCaseModal'));
    if (modal) {
      modal.hide();
    }
    
    if (data.success) {
      showSuccess('æ¡ˆä¾‹ç”ŸæˆæˆåŠŸï¼');
      loadCaseStudies(currentPage);
    } else {
      showError(data.message || 'ç”Ÿæˆå¤±è´¥');
    }
  } catch (error) {
    console.error('âŒ ç”Ÿæˆæ¡ˆä¾‹å¤±è´¥:', error);
    showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    const generateBtn = document.querySelector('#generateCaseModal .btn-primary');
    if (generateBtn) {
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="bi bi-stars"></i> å¼€å§‹ç”Ÿæˆ';
    }
  }
}

// æŸ¥çœ‹æ¡ˆä¾‹è¯¦æƒ…
async function viewCaseDetail(caseStudyId) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/case-studies/${caseStudyId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–æ¡ˆä¾‹è¯¦æƒ…å¤±è´¥');
      return;
    }
    
    const caseStudy = data.caseStudy;
    const customer = caseStudy.customer || {};
    
    document.getElementById('caseDetailTitle').textContent = caseStudy.title || 'æ¡ˆä¾‹è¯¦æƒ…';
    
    // æ¸²æŸ“Markdown
    const summaryHtml = marked.parse(caseStudy.summary || '');
    
    const detailBody = document.getElementById('caseDetailBody');
    detailBody.innerHTML = `
      <div class="mb-4">
        <h4><i class="bi bi-building"></i> å®¢æˆ·ä¿¡æ¯</h4>
        <div class="card bg-light">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>å…¬å¸ï¼š</strong>${customer.company || '-'}</div>
              <div class="col-md-4"><strong>è”ç³»äººï¼š</strong>${customer.name || '-'}</div>
              <div class="col-md-4"><strong>é‚®ç®±ï¼š</strong>${customer.email || '-'}</div>
            </div>
          </div>
        </div>
      </div>
      
      ${caseStudy.customer_info ? `
      <div class="mb-4">
        <h5><i class="bi bi-info-circle"></i> å®¢æˆ·åŸºæœ¬ä¿¡æ¯</h5>
        <div class="card">
          <div class="card-body">
            ${caseStudy.customer_info}
          </div>
        </div>
      </div>
      ` : ''}
      
      ${caseStudy.sales_techniques ? `
      <div class="mb-4">
        <h5><i class="bi bi-lightbulb"></i> é”€å”®æŠ€å·§</h5>
        <div class="card border-primary">
          <div class="card-body">
            ${caseStudy.sales_techniques}
          </div>
        </div>
      </div>
      ` : ''}
      
      ${caseStudy.communication_highlights ? `
      <div class="mb-4">
        <h5><i class="bi bi-chat-dots"></i> æ²Ÿé€šäº®ç‚¹</h5>
        <div class="card border-success">
          <div class="card-body">
            ${caseStudy.communication_highlights}
          </div>
        </div>
      </div>
      ` : ''}
      
      <div class="mb-4">
        <h5><i class="bi bi-file-text"></i> å®Œæ•´æ€»ç»“</h5>
        <div class="card border-warning">
          <div class="card-body markdown-content">
            ${summaryHtml}
          </div>
        </div>
      </div>
    `;
    
    new bootstrap.Modal(document.getElementById('caseDetailModal')).show();
    
  } catch (error) {
    console.error('è·å–æ¡ˆä¾‹è¯¦æƒ…å¤±è´¥:', error);
    showError('è·å–å¤±è´¥');
  }
}

// åˆ é™¤æ¡ˆä¾‹
async function deleteCase(caseStudyId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¡ˆä¾‹å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/case-studies/${caseStudyId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('æ¡ˆä¾‹å·²åˆ é™¤');
      loadCaseStudies(currentPage);
    } else {
      showError(data.message || 'åˆ é™¤å¤±è´¥');
    }
  } catch (error) {
    console.error('åˆ é™¤æ¡ˆä¾‹å¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥');
  }
}

// æç¤ºå‡½æ•°
function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>

<style>
.hover-shadow {
  transition: box-shadow 0.3s ease-in-out;
}

.hover-shadow:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3 {
  margin-top: 1.5rem;
  margin-bottom: 1rem;
}

.markdown-content ul,
.markdown-content ol {
  padding-left: 2rem;
}

.markdown-content p {
  margin-bottom: 1rem;
}

.markdown-content code {
  background-color: #f8f9fa;
  padding: 0.2rem 0.4rem;
  border-radius: 0.25rem;
}
</style>

