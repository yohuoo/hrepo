<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">é”€å”®æ•°æ®</li>
      </ol>
    </nav>
    <h1 class="page-title">é”€å”®æ•°æ®ç®¡ç†</h1>
    <p class="page-subtitle">è®°å½•å’Œç®¡ç†æ‚¨çš„é”€å”®ä¸šç»©</p>
  </div>
</div>

<!-- æœç´¢å’Œæ“ä½œåŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <!-- è¶…çº§ç®¡ç†å‘˜/ç®¡ç†å‘˜ç­›é€‰å™¨ -->
    <div class="row g-3 align-items-center mb-3" id="adminFilters" style="display: none;">
      <div class="col-md-4">
        <label class="form-label mb-1">æŸ¥çœ‹èŒƒå›´</label>
        <select class="form-select" id="viewScope" onchange="handleScopeChange()">
          <option value="all">å…¨éƒ¨æ•°æ®</option>
          <option value="department">æŒ‰éƒ¨é—¨</option>
          <option value="user">æŒ‰ç”¨æˆ·</option>
        </select>
      </div>
      <div class="col-md-4" id="departmentFilter" style="display: none;">
        <label class="form-label mb-1">é€‰æ‹©éƒ¨é—¨</label>
        <select class="form-select" id="filterDepartment" onchange="handleFilterChange()">
          <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
        </select>
      </div>
      <div class="col-md-4" id="userFilter" style="display: none;">
        <label class="form-label mb-1">é€‰æ‹©ç”¨æˆ·</label>
        <select class="form-select" id="filterUser" onchange="handleFilterChange()">
          <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
        </select>
      </div>
    </div>
    
    <!-- æ—¶é—´ç­›é€‰å’Œæ“ä½œæŒ‰é’® -->
    <div class="row g-3 align-items-center">
      <div class="col-lg-3">
        <input type="date" class="form-control" id="startDate" placeholder="å¼€å§‹æ—¥æœŸ">
      </div>
      <div class="col-lg-3">
        <input type="date" class="form-control" id="endDate" placeholder="ç»“æŸæ—¥æœŸ">
      </div>
      <div class="col-lg-3">
        <button class="btn btn-outline-primary w-100" onclick="handleSearch()">
          <i class="bi bi-search me-1"></i>æŸ¥è¯¢
        </button>
      </div>
      <div class="col-lg-3">
        <button class="btn btn-primary w-100" onclick="showAddSalesModal()">
          <i class="bi bi-plus-lg me-1"></i>æ·»åŠ é”€å”®è®°å½•
        </button>
      </div>
    </div>
  </div>
</div>

<!-- é”€å”®ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted">é”€å”®æ€»é¢</h6>
        <h3 class="mb-0" id="totalAmount">$0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted">é”€å”®è®°å½•</h6>
        <h3 class="mb-0" id="totalRecords">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted">å®¢æˆ·æ•°</h6>
        <h3 class="mb-0" id="totalCustomers">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted">é”€å”®æ•°é‡</h6>
        <h3 class="mb-0" id="totalQuantity">0</h3>
      </div>
    </div>
  </div>
</div>

<!-- é”€å”®è®°å½•åˆ—è¡¨ -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å®¢æˆ·</th>
            <th>é”€å”®äººå‘˜</th>
            <th>äº§å“</th>
            <th>æ•°é‡</th>
            <th>é‡‘é¢</th>
            <th>å¤‡æ³¨</th>
            <th width="100">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="salesTableBody">
          <tr>
            <td colspan="8" class="text-center p-5">
              <div class="spinner-border text-primary"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘é”€å”®è®°å½•æ¨¡æ€æ¡† -->
<div class="modal fade" id="salesModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="salesModalTitle">æ·»åŠ é”€å”®è®°å½•</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="salesForm">
          <input type="hidden" id="salesId">
          <div class="mb-3">
            <label class="form-label">é”€å”®æ—¥æœŸ <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="saleDate" required>
          </div>
          <div class="mb-3">
            <label class="form-label">å®¢æˆ· <span class="text-danger">*</span></label>
            <select class="form-select" id="customerId" required>
              <option value="">é€‰æ‹©å®¢æˆ·</option>
            </select>
            <div class="form-text">
              å¦‚æ‰¾ä¸åˆ°å®¢æˆ·ï¼Œè¯·å…ˆåˆ°"å®¢æˆ·ç®¡ç†"é¡µé¢æ·»åŠ 
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">äº§å“åç§° <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="productName" placeholder="å¦‚ï¼šPQQã€ç”œå¶èŠ" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">é”€å”®æ•°é‡ <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="quantity" step="0.01" min="0" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">é”€å”®é‡‘é¢ <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="amount" step="0.01" min="0" required>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">å¤‡æ³¨</label>
            <textarea class="form-control" id="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveSalesRecord()">
          <i class="bi bi-check-lg me-1"></i>ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let customers = [];
let currentUser = null;
let allDepartments = [];
let allUsers = [];

document.addEventListener('DOMContentLoaded', async function() {
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  currentUser = JSON.parse(localStorage.getItem('userInfo') || '{}');
  
  // å¦‚æœuserInfoä¸­æ²¡æœ‰roleå­—æ®µï¼Œä»åç«¯é‡æ–°è·å–
  if (!currentUser.role) {
    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        currentUser = data.user;
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
      }
    } catch (error) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
  }
  
  // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜æˆ–ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç­›é€‰å™¨å¹¶åŠ è½½éƒ¨é—¨å’Œç”¨æˆ·
  if (currentUser.role === 'super_admin' || currentUser.role === 'admin') {
    document.getElementById('adminFilters').style.display = '';
    await loadDepartments();
    await loadAllUsers();
  }
  
  await loadCustomers();
  await loadSalesStatistics();
  await loadSalesRecords();
  
  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å¤©
  document.getElementById('saleDate').valueAsDate = new Date();
});

// åŠ è½½éƒ¨é—¨åˆ—è¡¨
async function loadDepartments() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/departments/tree', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    if (data.success) {
      allDepartments = flattenDepartments(data.departments || []);
      updateDepartmentSelect();
    }
  } catch (error) {
    console.error('åŠ è½½éƒ¨é—¨å¤±è´¥:', error);
  }
}

// æ‰å¹³åŒ–éƒ¨é—¨æ ‘
function flattenDepartments(depts, result = []) {
  depts.forEach(dept => {
    result.push(dept);
    if (dept.children && dept.children.length > 0) {
      flattenDepartments(dept.children, result);
    }
  });
  return result;
}

// æ›´æ–°éƒ¨é—¨é€‰æ‹©å™¨
function updateDepartmentSelect() {
  const select = document.getElementById('filterDepartment');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>';
  allDepartments.forEach(dept => {
    const indent = 'ã€€'.repeat(dept.level - 1);
    select.innerHTML += `<option value="${dept.id}">${indent}${dept.name}</option>`;
  });
}

// åŠ è½½æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
async function loadAllUsers() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/users?pageSize=1000', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    if (data.success) {
      allUsers = data.users || [];
      updateUserSelect();
    }
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
  }
}

// æ›´æ–°ç”¨æˆ·é€‰æ‹©å™¨
function updateUserSelect() {
  const select = document.getElementById('filterUser');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
  allUsers.forEach(user => {
    select.innerHTML += `<option value="${user.id}">${user.username} (${user.email})</option>`;
  });
}

// å¤„ç†èŒƒå›´å˜åŒ–
function handleScopeChange() {
  const scope = document.getElementById('viewScope').value;
  const departmentFilter = document.getElementById('departmentFilter');
  const userFilter = document.getElementById('userFilter');
  
  console.log('ğŸ”„ æŸ¥çœ‹èŒƒå›´æ”¹å˜:', scope);
  
  if (scope === 'department') {
    departmentFilter.style.display = '';
    userFilter.style.display = 'none';
    // é‡ç½®éƒ¨é—¨é€‰æ‹©
    document.getElementById('filterDepartment').value = '';
  } else if (scope === 'user') {
    departmentFilter.style.display = 'none';
    userFilter.style.display = '';
    // é‡ç½®ç”¨æˆ·é€‰æ‹©
    document.getElementById('filterUser').value = '';
  } else {
    departmentFilter.style.display = 'none';
    userFilter.style.display = 'none';
  }
  
  // åˆ·æ–°æ•°æ®
  loadSalesRecords();
  loadSalesStatistics();
}

// å¤„ç†ç­›é€‰æ¡ä»¶å˜åŒ–ï¼ˆé€‰æ‹©å…·ä½“çš„éƒ¨é—¨æˆ–ç”¨æˆ·æ—¶ï¼‰
function handleFilterChange() {
  console.log('ğŸ”„ ç­›é€‰æ¡ä»¶æ”¹å˜');
  // åŒæ—¶åˆ·æ–°åˆ—è¡¨å’Œç»Ÿè®¡
  loadSalesRecords();
  loadSalesStatistics();
}

// å¤„ç†æŸ¥è¯¢æŒ‰é’®ç‚¹å‡»ï¼ˆæ—¥æœŸç­›é€‰ï¼‰
function handleSearch() {
  console.log('ğŸ” ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®');
  // åŒæ—¶åˆ·æ–°åˆ—è¡¨å’Œç»Ÿè®¡
  loadSalesRecords();
  loadSalesStatistics();
}

// åŠ è½½å®¢æˆ·åˆ—è¡¨
async function loadCustomers() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/customers?pageSize=1000', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    
    if (data.success) {
      customers = data.customers || [];
      updateCustomerSelect();
    }
  } catch (error) {
    console.error('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
  }
}

// æ›´æ–°å®¢æˆ·ä¸‹æ‹‰æ¡†
function updateCustomerSelect() {
  const select = document.getElementById('customerId');
  select.innerHTML = '<option value="">é€‰æ‹©å®¢æˆ·</option>';
  customers.forEach(c => {
    select.innerHTML += `<option value="${c.id}">${c.name} - ${c.company}</option>`;
  });
}

// åŠ è½½é”€å”®ç»Ÿè®¡
async function loadSalesStatistics() {
  try {
    console.log('=== loadSalesStatistics å‡½æ•°è¢«è°ƒç”¨ ===');
    console.log('å½“å‰ç”¨æˆ·:', currentUser);
    
    const token = localStorage.getItem('authToken');
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const params = new URLSearchParams({
      ...(startDate && { start_date: startDate }),
      ...(endDate && { end_date: endDate })
    });
    
    console.log('åˆå§‹å‚æ•°:', params.toString());
    
    // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜æˆ–ç®¡ç†å‘˜ï¼Œæ·»åŠ ç­›é€‰å‚æ•°
    if (currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin')) {
      const scopeElement = document.getElementById('viewScope');
      const scope = scopeElement ? scopeElement.value : 'all';
      console.log('ğŸ” ç­›é€‰èŒƒå›´:', scope);
      
      if (scope === 'department') {
        const deptElement = document.getElementById('filterDepartment');
        const deptId = deptElement ? deptElement.value : '';
        console.log('ğŸ¢ éƒ¨é—¨ID:', deptId);
        if (deptId) {
          params.append('department_id', deptId);
          console.log('âœ… å·²æ·»åŠ department_idå‚æ•°');
        }
      } else if (scope === 'user') {
        const userElement = document.getElementById('filterUser');
        const userId = userElement ? userElement.value : '';
        console.log('ğŸ‘¤ ç”¨æˆ·ID:', userId);
        if (userId) {
          params.append('user_id', userId);
          console.log('âœ… å·²æ·»åŠ user_idå‚æ•°');
        }
      }
    }
    
    const finalUrl = `/api/sales/statistics?${params.toString()}`;
    console.log('ğŸ“Š æœ€ç»ˆè¯·æ±‚URL:', finalUrl);
    
    const response = await fetch(finalUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      const stats = data.statistics.summary;
      document.getElementById('totalAmount').textContent = `$${parseFloat(stats.total_amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
      document.getElementById('totalRecords').textContent = stats.total_records || 0;
      document.getElementById('totalCustomers').textContent = stats.customer_count || 0;
      document.getElementById('totalQuantity').textContent = parseFloat(stats.total_quantity || 0).toFixed(2);
    }
  } catch (error) {
    console.error('åŠ è½½é”€å”®ç»Ÿè®¡å¤±è´¥:', error);
  }
}

// åŠ è½½é”€å”®è®°å½•
async function loadSalesRecords() {
  try {
    const token = localStorage.getItem('authToken');
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const params = new URLSearchParams({
      pageSize: 100,
      ...(startDate && { start_date: startDate }),
      ...(endDate && { end_date: endDate })
    });
    
    // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜æˆ–ç®¡ç†å‘˜ï¼Œæ·»åŠ ç­›é€‰å‚æ•°
    if (currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin')) {
      const scope = document.getElementById('viewScope').value;
      if (scope === 'department') {
        const deptId = document.getElementById('filterDepartment').value;
        if (deptId) params.append('department_id', deptId);
      } else if (scope === 'user') {
        const userId = document.getElementById('filterUser').value;
        if (userId) params.append('user_id', userId);
      }
    }
    
    const response = await fetch(`/api/sales?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('åŠ è½½é”€å”®è®°å½•å¤±è´¥');
      return;
    }
    
    renderSalesTable(data.sales_records || []);
    
  } catch (error) {
    console.error('åŠ è½½é”€å”®è®°å½•å¤±è´¥:', error);
    showError('åŠ è½½å¤±è´¥');
  }
}

// æ¸²æŸ“é”€å”®è®°å½•è¡¨æ ¼
function renderSalesTable(records) {
  const tbody = document.getElementById('salesTableBody');
  
  if (records.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-cash-coin"></i>
            <h5>æš‚æ— é”€å”®è®°å½•</h5>
            <p class="text-muted">ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ é”€å”®è®°å½•"åˆ›å»ºç¬¬ä¸€æ¡è®°å½•</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  records.forEach(record => {
    // è·å–é”€å”®äººå‘˜ä¿¡æ¯
    const salesperson = record.user ? record.user.username : 'æœªçŸ¥';
    const salespersonEmail = record.user ? record.user.email : '';
    
    html += `
      <tr>
        <td>${new Date(record.sale_date).toLocaleDateString('zh-CN')}</td>
        <td>
          <div><strong>${record.customer.name}</strong></div>
          <small class="text-muted">${record.customer.company}</small>
        </td>
        <td>
          <div>
            <i class="bi bi-person-badge text-primary me-1"></i>
            <strong>${salesperson}</strong>
          </div>
          ${salespersonEmail ? `<small class="text-muted">${salespersonEmail}</small>` : ''}
        </td>
        <td>${record.product_name}</td>
        <td>${parseFloat(record.quantity).toFixed(2)}</td>
        <td><strong>$${parseFloat(record.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
        <td>${record.notes || '-'}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="editSalesRecord(${record.id})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteSalesRecord(${record.id})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

// æ˜¾ç¤ºæ·»åŠ é”€å”®è®°å½•æ¨¡æ€æ¡†
function showAddSalesModal() {
  document.getElementById('salesModalTitle').textContent = 'æ·»åŠ é”€å”®è®°å½•';
  document.getElementById('salesId').value = '';
  document.getElementById('saleDate').valueAsDate = new Date();
  document.getElementById('customerId').value = '';
  document.getElementById('productName').value = '';
  document.getElementById('quantity').value = '';
  document.getElementById('amount').value = '';
  document.getElementById('notes').value = '';
  
  new bootstrap.Modal(document.getElementById('salesModal')).show();
}

// ä¿å­˜é”€å”®è®°å½•
async function saveSalesRecord() {
  try {
    const salesId = document.getElementById('salesId').value;
    const sale_date = document.getElementById('saleDate').value;
    const customer_id = document.getElementById('customerId').value;
    const product_name = document.getElementById('productName').value.trim();
    const quantity = document.getElementById('quantity').value;
    const amount = document.getElementById('amount').value;
    const notes = document.getElementById('notes').value.trim();
    
    if (!sale_date || !customer_id || !product_name || !quantity || !amount) {
      showWarning('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
      return;
    }
    
    const token = localStorage.getItem('authToken');
    const url = salesId ? `/api/sales/${salesId}` : '/api/sales';
    const method = salesId ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        customer_id: parseInt(customer_id),
        sale_date,
        product_name,
        quantity: parseFloat(quantity),
        amount: parseFloat(amount),
        notes
      })
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError(data.message || 'ä¿å­˜å¤±è´¥');
      return;
    }
    
    showSuccess(data.message || 'é”€å”®è®°å½•ä¿å­˜æˆåŠŸ');
    bootstrap.Modal.getInstance(document.getElementById('salesModal')).hide();
    await loadSalesStatistics();
    await loadSalesRecords();
    
  } catch (error) {
    console.error('ä¿å­˜é”€å”®è®°å½•å¤±è´¥:', error);
    showError('ä¿å­˜å¤±è´¥: ' + error.message);
  }
}

// åˆ é™¤é”€å”®è®°å½•
async function deleteSalesRecord(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é”€å”®è®°å½•å—ï¼Ÿ')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/sales/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError(data.message || 'åˆ é™¤å¤±è´¥');
      return;
    }
    
    showSuccess('é”€å”®è®°å½•åˆ é™¤æˆåŠŸ');
    await loadSalesStatistics();
    await loadSalesRecords();
    
  } catch (error) {
    console.error('åˆ é™¤é”€å”®è®°å½•å¤±è´¥:', error);
    showError('åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

async function editSalesRecord(id) {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/sales?pageSize=1000`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–é”€å”®è®°å½•å¤±è´¥');
      return;
    }
    
    const record = data.sales_records.find(r => r.id === id);
    
    if (!record) {
      showError('é”€å”®è®°å½•ä¸å­˜åœ¨');
      return;
    }
    
    // å¡«å……è¡¨å•
    document.getElementById('salesModalTitle').textContent = 'ç¼–è¾‘é”€å”®è®°å½•';
    document.getElementById('salesId').value = record.id;
    document.getElementById('saleDate').value = record.sale_date;
    document.getElementById('customerId').value = record.customer_id;
    document.getElementById('productName').value = record.product_name;
    document.getElementById('quantity').value = record.quantity;
    document.getElementById('amount').value = record.amount;
    document.getElementById('notes').value = record.notes || '';
    
    new bootstrap.Modal(document.getElementById('salesModal')).show();
    
  } catch (error) {
    console.error('è·å–é”€å”®è®°å½•å¤±è´¥:', error);
    showError('è·å–é”€å”®è®°å½•å¤±è´¥');
  }
}

// ==================== Toastæç¤ºå‡½æ•° ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>

