<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item active">ä¼šè®®è®°å½•</li>
      </ol>
    </nav>
    <h1 class="page-title">è§†é¢‘ä¼šè®®è®°å½•</h1>
  </div>
</div>

<!-- ä¸Šä¼ åŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-center">
      <div class="col-lg-8 col-md-7">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢ä¼šè®®æ ‡é¢˜ã€å®¢æˆ·åç§°...">
        </div>
      </div>
      <div class="col-lg-4 col-md-5">
        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#uploadMeetingModal">
          <i class="bi bi-cloud-upload me-1"></i>ä¸Šä¼ ä¼šè®®å½•éŸ³
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ä¼šè®®è®°å½•åˆ—è¡¨ -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>ä¼šè®®æ ‡é¢˜</th>
            <th>å®¢æˆ·</th>
            <th>ä¸Šä¼ æ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th width="150">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="meetingTableBody">
          <tr>
            <td colspan="5" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="d-flex align-items-center gap-2">
          <span>æ¯é¡µæ˜¾ç¤º</span>
          <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelect" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <span>æ¡</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span id="meetingCount">æ˜¾ç¤º1-0æ¡,å…±0æ¡</span>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ä¸Šä¼ ä¼šè®®å½•éŸ³æ¨¡æ€æ¡† -->
<div class="modal fade" id="uploadMeetingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ä¸Šä¼ ä¼šè®®å½•éŸ³</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="uploadMeetingForm">
          <div class="mb-3">
            <label class="form-label">ä¼šè®®æ ‡é¢˜ *</label>
            <input type="text" class="form-control" name="title" required placeholder="ä¾‹å¦‚: ä¸Appleå…¬å¸çš„äº§å“æ¼”ç¤ºä¼šè®®">
          </div>
          
          <div class="mb-3">
            <label class="form-label">ä¼šè®®æ—¥æœŸ</label>
            <input type="date" class="form-control" name="meeting_date" id="meetingDate">
          </div>
          
          <div class="mb-3">
            <label class="form-label">å…³è”å®¢æˆ·</label>
            <select class="form-select" name="customer_id" id="customerSelect">
              <option value="">é€‰æ‹©å®¢æˆ·ï¼ˆå¯é€‰ï¼‰</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">ä¼šè®®å½•éŸ³æ–‡ä»¶ *</label>
            <input type="file" class="form-control" name="video" id="meetingFile" accept="audio/*,video/*" required>
            <small class="text-muted">æ”¯æŒ MP3, MP4, WAV, M4A ç­‰æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 500MB</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">ä¼šè®®å¤‡æ³¨</label>
            <textarea class="form-control" name="notes" rows="3" placeholder="ä¼šè®®çš„å…¶ä»–è¯´æ˜ä¿¡æ¯"></textarea>
          </div>
        </form>
        
        <div id="uploadProgress" style="display: none;">
          <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                 style="width: 0%" id="progressBar"></div>
          </div>
          <p class="text-center mb-0" id="progressText">æ­£åœ¨ä¸Šä¼ ...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="uploadMeeting()">
          <i class="bi bi-cloud-upload"></i> ä¸Šä¼ å¹¶åˆ†æ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ä¼šè®®è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="meetingDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ä¼šè®®è¯¦æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="meetingDetailBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-info" onclick="downloadTranscript()" id="downloadTranscriptBtn">
          <i class="bi bi-file-text"></i> ä¸‹è½½æ–‡å­—ç¨¿ (.txt)
        </button>
        <button type="button" class="btn btn-primary" onclick="downloadAISummary()" id="downloadSummaryBtn">
          <i class="bi bi-file-earmark-text"></i> ä¸‹è½½AIåˆ†æ (.md)
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let pageSize = 20;
let currentMeetingId = null;
let currentMeetingData = null; // ä¿å­˜å½“å‰ä¼šè®®çš„å®Œæ•´æ•°æ®

$(document).ready(async function() {
  await loadMeetings();
  await loadCustomers();
  $('#searchKeyword').on('input', debounce(searchMeetings, 500));
});

// åŠ è½½ä¼šè®®è®°å½•åˆ—è¡¨
async function loadMeetings(page = 1) {
  try {
    const params = {
      page: page,
      pageSize: pageSize,
      ...currentFilters
    };

    const response = await axios.get('/api/zoom-meetings/', { params });
    const data = response.data;

    currentPage = page;
    renderMeetingTable(data.meetings || []);
    renderPagination(data.page, data.total_pages);
    updateMeetingCount(data.total, data.meetings?.length || 0, page);

  } catch (error) {
    console.error('åŠ è½½ä¼šè®®è®°å½•å¤±è´¥:', error);
    showToast('åŠ è½½ä¼šè®®è®°å½•å¤±è´¥', 'danger');
  }
}

// æ¸²æŸ“ä¼šè®®åˆ—è¡¨
function renderMeetingTable(meetings) {
  if (meetings.length === 0) {
    $('#meetingTableBody').html(`
      <tr>
        <td colspan="5" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-camera-video"></i>
            <h5>æš‚æ— ä¼šè®®è®°å½•</h5>
            <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªä¼šè®®å½•éŸ³</p>
          </div>
        </td>
      </tr>
    `);
    return;
  }

  let html = '';
  meetings.forEach(meeting => {
    const statusBadge = getStatusBadge(meeting.status);
    const customerInfo = meeting.customer ? `${meeting.customer.name} (${meeting.customer.company})` : '-';

    html += `
      <tr class="clickable-row" onclick="showMeetingDetail(${meeting.id})" style="cursor: pointer;">
        <td>
          <div class="fw-bold">${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}</div>
          ${meeting.meeting_date ? `<small class="text-muted">${formatDate(meeting.meeting_date)}</small>` : ''}
        </td>
        <td>${customerInfo}</td>
        <td>${formatDate(meeting.created_at)}</td>
        <td>${statusBadge}</td>
        <td onclick="event.stopPropagation();">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="showMeetingDetail(${meeting.id})">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="downloadAudio(${meeting.id})">
                <i class="bi bi-download"></i> ä¸‹è½½å½•éŸ³
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteMeeting(${meeting.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </a></li>
            </ul>
          </div>
        </td>
      </tr>
    `;
  });

  $('#meetingTableBody').html(html);
}

// åŠ è½½å®¢æˆ·åˆ—è¡¨
async function loadCustomers() {
  try {
    const response = await axios.get('/api/customers/');
    const customers = response.data.customers || [];
    
    let html = '<option value="">é€‰æ‹©å®¢æˆ·ï¼ˆå¯é€‰ï¼‰</option>';
    customers.forEach(customer => {
      html += `<option value="${customer.id}">${customer.name} - ${customer.company}</option>`;
    });
    
    $('#customerSelect').html(html);
  } catch (error) {
    console.error('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
  }
}

// ä¸Šä¼ ä¼šè®®
async function uploadMeeting() {
  const title = $('input[name="title"]').val();
  const customerId = $('select[name="customer_id"]').val();
  const meetingDate = $('input[name="meeting_date"]').val();
  const participants = $('input[name="participants"]').val();
  const notes = $('textarea[name="notes"]').val();
  const fileInput = document.getElementById('meetingFile');
  
  if (!title) {
    showToast('è¯·è¾“å…¥ä¼šè®®æ ‡é¢˜', 'warning');
    return;
  }
  
  if (!fileInput.files || fileInput.files.length === 0) {
    showToast('è¯·é€‰æ‹©ä¼šè®®å½•éŸ³æ–‡ä»¶', 'warning');
    return;
  }
  
  const formData = new FormData();
  formData.append('meeting_title', title);
  if (customerId) formData.append('customer_id', customerId);
  if (meetingDate) formData.append('meeting_date', meetingDate);
  if (participants) formData.append('participants', participants);
  if (notes) formData.append('notes', notes);
  formData.append('video', fileInput.files[0]);
  
  console.log('ğŸ“¤ ä¸Šä¼ ä¼šè®®æ•°æ®:');
  console.log('  - ä¼šè®®æ ‡é¢˜:', title);
  console.log('  - å®¢æˆ·ID:', customerId);
  console.log('  - ä¼šè®®æ—¥æœŸ:', meetingDate);
  console.log('  - æ–‡ä»¶:', fileInput.files[0].name);
  
  try {
    $('#uploadProgress').show();
    
    const response = await axios.post('/api/zoom-meetings/upload', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      },
      onUploadProgress: (progressEvent) => {
        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
        $('#progressBar').css('width', percentCompleted + '%');
        $('#progressText').text(`æ­£åœ¨ä¸Šä¼ ... ${percentCompleted}%`);
      }
    });
    
    showToast('ä¼šè®®å½•éŸ³ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨è¿›è¡ŒAIåˆ†æ...', 'success');
    bootstrap.Modal.getInstance(document.getElementById('uploadMeetingModal')).hide();
    $('#uploadMeetingForm')[0].reset();
    $('#uploadProgress').hide();
    
    await loadMeetings(1);
  } catch (error) {
    console.error('ä¸Šä¼ ä¼šè®®å¤±è´¥:', error);
    showToast(error.response?.data?.message || 'ä¸Šä¼ å¤±è´¥', 'danger');
    $('#uploadProgress').hide();
  }
}

// æŸ¥çœ‹ä¼šè®®è¯¦æƒ…
async function showMeetingDetail(meetingId) {
  try {
    currentMeetingId = meetingId;
    const response = await axios.get(`/api/zoom-meetings/${meetingId}`);
    const meeting = response.data.meeting;
    currentMeetingData = meeting; // ä¿å­˜å®Œæ•´ä¼šè®®æ•°æ®
    
    console.log('ğŸ“¥ ä¼šè®®è¯¦æƒ…æ•°æ®:', meeting);
    
    const html = `
      <div class="meeting-detail">
        <div class="mb-4">
          <h6 class="text-muted mb-2">ä¼šè®®ä¿¡æ¯</h6>
          <div class="row">
            <div class="col-md-6 mb-2">
              <strong>ä¼šè®®æ ‡é¢˜:</strong> ${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}
            </div>
            <div class="col-md-6 mb-2">
              <strong>ä¼šè®®æ—¥æœŸ:</strong> ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}
            </div>
            ${meeting.customer ? `
              <div class="col-md-6 mb-2">
                <strong>å…³è”å®¢æˆ·:</strong> <span class="text-dark">${meeting.customer.name} (${meeting.customer.company})</span>
              </div>
            ` : ''}
            <div class="col-md-6 mb-2">
              <strong>è§†é¢‘æ–‡ä»¶:</strong> ${meeting.video_file_name || '-'}
            </div>
            <div class="col-md-6 mb-2">
              <strong>æ–‡ä»¶å¤§å°:</strong> ${meeting.video_file_size ? (meeting.video_file_size / 1024 / 1024).toFixed(2) + ' MB' : '-'}
            </div>
            <div class="col-md-6 mb-2">
              <strong>çŠ¶æ€:</strong> ${getStatusBadge(meeting.status)}
            </div>
          </div>
        </div>
        
        ${meeting.ai_summary ? `
          <div class="mb-4">
            <h6 class="text-muted mb-2"><i class="bi bi-robot"></i> AI ä¼šè®®æ€»ç»“</h6>
            <div class="card">
              <div class="card-body markdown-content" id="aiSummaryContent-${meeting.id}"></div>
            </div>
          </div>
        ` : `
          <div class="mb-4">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> ${meeting.status === 'completed' ? 'AIæ‘˜è¦ç”Ÿæˆå¤±è´¥' : 'AIæ‘˜è¦å¤„ç†ä¸­ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹'}
            </div>
          </div>
        `}
        
        ${meeting.transcript_text ? `
          <div class="mb-4">
            <h6 class="text-muted mb-2"><i class="bi bi-file-text"></i> ä¼šè®®æ–‡å­—ç¨¿</h6>
            <div class="card">
              <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div style="white-space: pre-line; font-family: inherit; line-height: 1.8;">${meeting.transcript_text}</div>
              </div>
            </div>
          </div>
        ` : ''}
      </div>
    `;
    
    $('#meetingDetailBody').html(html);
    
    // æ¸²æŸ“Markdownï¼ˆåœ¨DOMæ’å…¥åï¼‰
    if (meeting.ai_summary && typeof marked !== 'undefined') {
      setTimeout(() => {
        const summaryEl = document.getElementById(`aiSummaryContent-${meeting.id}`);
        if (summaryEl) {
          try {
            summaryEl.innerHTML = marked.parse(meeting.ai_summary);
          } catch (e) {
            console.error('Markdownæ¸²æŸ“å¤±è´¥:', e);
            summaryEl.textContent = meeting.ai_summary;
          }
        }
      }, 100);
    }
    
    new bootstrap.Modal(document.getElementById('meetingDetailModal')).show();
  } catch (error) {
    showToast('åŠ è½½ä¼šè®®è¯¦æƒ…å¤±è´¥', 'danger');
  }
}

// åˆ é™¤ä¼šè®®
async function deleteMeeting(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè®®è®°å½•å—ï¼Ÿ')) return;
  
  try {
    await axios.delete(`/api/zoom-meetings/${id}`);
    showToast('ä¼šè®®è®°å½•å·²åˆ é™¤', 'success');
    await loadMeetings(currentPage);
  } catch (error) {
    showToast('åˆ é™¤å¤±è´¥', 'danger');
  }
}

// å·¥å…·å‡½æ•°
function getStatusBadge(status) {
  const badges = {
    'pending': '<span class="badge bg-info"><i class="bi bi-hourglass-split"></i> ç­‰å¾…å¤„ç†</span>',
    'processing': '<span class="badge bg-warning"><i class="bi bi-gear"></i> å¤„ç†ä¸­</span>',
    'transcribing': '<span class="badge bg-primary"><i class="bi bi-mic"></i> è¯†åˆ«ä¸­</span>',
    'summarizing': '<span class="badge bg-info"><i class="bi bi-robot"></i> ç”Ÿæˆä¸­</span>',
    'completed': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å·²å®Œæˆ</span>',
    'failed': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±è´¥</span>'
  };
  return badges[status] || `<span class="badge bg-secondary">${status || 'æœªçŸ¥'}</span>`;
}

function formatDuration(seconds) {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  if (hours > 0) {
    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
  }
  return `${minutes}åˆ†é’Ÿ`;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN');
}

function searchMeetings() {
  currentFilters = {};
  const keyword = $('#searchKeyword').val();
  if (keyword) currentFilters.search = keyword;
  loadMeetings(1);
}

function changePageSize() {
  pageSize = parseInt($('#pageSizeSelect').val());
  loadMeetings(1);
}

function renderPagination(current, total) {
  if (total <= 1) {
    $('#pagination').html('');
    return;
  }
  
  let html = '';
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadMeetings(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;
  
  for (let i = 1; i <= total; i++) {
    html += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadMeetings(${i}); return false;">${i}</a>
      </li>
    `;
  }
  
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadMeetings(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;
  
  $('#pagination').html(html);
}

function updateMeetingCount(total, current, page) {
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, total);
  $('#meetingCount').text(`æ˜¾ç¤º${start}-${end}æ¡,å…±${total}æ¡`);
}

// ç­›é€‰åŠŸèƒ½å·²ç§»é™¤

// ä¸‹è½½å½•éŸ³ï¼ˆé€šè¿‡åç«¯APIï¼‰
function downloadAudio(id) {
  window.location.href = `/api/zoom-meetings/${id}/download`;
}

// ä¸‹è½½æ–‡å­—ç¨¿ï¼ˆå‰ç«¯ç”Ÿæˆ.txtæ–‡ä»¶ï¼‰
function downloadTranscript() {
  if (!currentMeetingData || !currentMeetingData.transcript_text) {
    showWarning('æš‚æ— æ–‡å­—ç¨¿å†…å®¹');
    return;
  }
  
  const meeting = currentMeetingData;
  const fileName = `${meeting.meeting_title || 'ä¼šè®®'}_æ–‡å­—ç¨¿_${new Date().toISOString().split('T')[0]}.txt`;
  
  // æ„å»ºæ–‡å­—ç¨¿å†…å®¹
  let content = `ä¼šè®®æ–‡å­—ç¨¿\n`;
  content += `=====================================\n\n`;
  content += `ä¼šè®®æ ‡é¢˜: ${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}\n`;
  content += `ä¼šè®®æ—¥æœŸ: ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}\n`;
  if (meeting.customer) {
    content += `å…³è”å®¢æˆ·: ${meeting.customer.name} (${meeting.customer.company})\n`;
  }
  content += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
  content += `\n=====================================\n\n`;
  content += meeting.transcript_text;
  
  // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('æ–‡å­—ç¨¿ä¸‹è½½æˆåŠŸ');
}

// ä¸‹è½½AIåˆ†æï¼ˆå‰ç«¯ç”Ÿæˆ.mdæ–‡ä»¶ï¼‰
function downloadAISummary() {
  if (!currentMeetingData || !currentMeetingData.ai_summary) {
    showWarning('æš‚æ— AIåˆ†æå†…å®¹');
    return;
  }
  
  const meeting = currentMeetingData;
  const fileName = `${meeting.meeting_title || 'ä¼šè®®'}_AIåˆ†æ_${new Date().toISOString().split('T')[0]}.md`;
  
  // æ„å»ºMarkdownå†…å®¹
  let content = `# ${meeting.meeting_title || 'ä¼šè®®'} - AIæ™ºèƒ½åˆ†æ\n\n`;
  content += `---\n\n`;
  content += `## ğŸ“‹ ä¼šè®®ä¿¡æ¯\n\n`;
  content += `- **ä¼šè®®æ ‡é¢˜**: ${meeting.meeting_title || 'æœªå‘½åä¼šè®®'}\n`;
  content += `- **ä¼šè®®æ—¥æœŸ**: ${meeting.meeting_date ? new Date(meeting.meeting_date).toLocaleDateString('zh-CN') : '-'}\n`;
  if (meeting.customer) {
    content += `- **å…³è”å®¢æˆ·**: ${meeting.customer.name} (${meeting.customer.company})\n`;
  }
  content += `- **åˆ†ææ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n`;
  content += `\n---\n\n`;
  content += `## ğŸ¤– AIä¼šè®®æ€»ç»“\n\n`;
  content += meeting.ai_summary;
  content += `\n\n---\n\n`;
  content += `*æœ¬åˆ†æç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ*\n`;
  
  // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', fileName);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showSuccess('AIåˆ†æä¸‹è½½æˆåŠŸ');
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showToast(message, type) {
  console.log(`${type}: ${message}`);
}
</script>


