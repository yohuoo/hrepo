<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item"><a href="/emails">é‚®ä»¶</a></li>
        <li class="breadcrumb-item active">é‚®ä»¶æ¨¡æ¿</li>
      </ol>
    </nav>
    <h1 class="page-title">é‚®ä»¶æ¨¡æ¿</h1>
  </div>
</div>

<!-- æœç´¢å’Œæ“ä½œåŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-8">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢æ¨¡æ¿æ ‡é¢˜æˆ–å†…å®¹...">
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="showTemplatePreview()">
            <i class="bi bi-eye"></i> é¢„è§ˆæ¨¡æ¿
          </button>
          <button class="btn btn-primary" onclick="createNewTemplate()">
            <i class="bi bi-plus-lg"></i> æ–°å»ºæ¨¡æ¿
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ¨¡æ¿åˆ—è¡¨ -->
<div class="row" id="templateList">
  <div class="col-12 text-center p-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>
</div>

<!-- æ–°å»ºæ¨¡æ¿æ¨¡æ€æ¡† -->
<div class="modal fade" id="addTemplateModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ–°å»ºé‚®ä»¶</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- å·¦ä¾§ï¼šé‚®ä»¶æ¨¡æ¿å’Œä¸ªæ€§åŒ–å˜é‡ -->
          <div class="col-md-4">
            <!-- é‚®ä»¶æ¨¡æ¿ -->
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">é‚®ä»¶æ¨¡æ¿</h6>
                <button class="btn btn-sm btn-primary" onclick="createNewTemplate()">
                  <i class="bi bi-plus"></i> æ–°å»º
                </button>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <select class="form-select" id="templateSelect" onchange="loadTemplate()">
                    <option value="">é€‰æ‹©æ¨¡æ¿</option>
                  </select>
                </div>
                <div id="templateList">
                  <!-- æ¨¡æ¿åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
              </div>
            </div>
            
            <!-- ä¸ªæ€§åŒ–å˜é‡ -->
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">ä¸ªæ€§åŒ–å˜é‡</h6>
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{firstName}}')">
                    {{firstName}}
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{lastName}}')">
                    {{lastName}}
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{companyName}}')">
                    {{companyName}}
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{position}}')">
                    {{position}}
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- å³ä¾§ï¼šé‚®ä»¶ç¼–è¾‘å™¨ -->
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">é‚®ä»¶ç¼–è¾‘å™¨</h6>
                  <div class="btn-group" role="group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="saveDraft()">
                      <i class="bi bi-floppy"></i> ä¿å­˜è‰ç¨¿
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="previewEmail()">
                      <i class="bi bi-eye"></i> å‘é€é¢„è§ˆ
                    </button>
                    <div class="dropdown">
                      <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-send"></i> å‘é€
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="sendEmail('immediate')">ç«‹å³å‘é€</a></li>
                        <li><a class="dropdown-item" href="#" onclick="sendEmail('scheduled')">å®šæ—¶å‘é€</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <form id="emailForm">
                  <div class="mb-3">
                    <label class="form-label">æ”¶ä»¶äºº</label>
                    <input type="text" class="form-control" id="recipients" placeholder="è¯·é€‰æ‹©æ”¶ä»¶äºº" readonly>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="selectRecipients()">
                      <i class="bi bi-pencil"></i> ç¼–è¾‘æ”¶ä»¶äºº
                    </button>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">ä¸»é¢˜</label>
                    <input type="text" class="form-control" id="emailSubject" placeholder="è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">å†…å®¹</label>
                    <div class="toolbar mb-2">
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('bold')">
                          <strong>B</strong>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('italic')">
                          <em>I</em>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('underline')">
                          <u>U</u>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertList('unordered')">
                          <i class="bi bi-list-ul"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertList('ordered')">
                          <i class="bi bi-list-ol"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertLink()">
                          <i class="bi bi-link"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertImage()">
                          <i class="bi bi-image"></i>
                        </button>
                      </div>
                    </div>
                    <textarea class="form-control" id="emailContent" rows="15" placeholder="Dear {{firstName}},&#10;&#10;I hope this email finds you well..."></textarea>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveTemplate()">ä¿å­˜æ¨¡æ¿</button>
      </div>
    </div>
  </div>
</div>

<!-- æ”¶ä»¶äººé€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="recipientSelectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">é€‰æ‹©æ”¶ä»¶äºº</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6>æœç´¢å’Œç­›é€‰</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <input type="text" class="form-control" placeholder="æœç´¢è”ç³»äºº" id="contactSearch">
                </div>
                <div class="mb-3">
                  <label class="form-label">æŒ‰æ ‡ç­¾ç­›é€‰</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tagPotential">
                    <label class="form-check-label" for="tagPotential">æ½œåœ¨å®¢æˆ·</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tagConverted">
                    <label class="form-check-label" for="tagConverted">å·²æˆäº¤å®¢æˆ·</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tagKey">
                    <label class="form-check-label" for="tagKey">é‡ç‚¹å®¢æˆ·</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">æŒ‰å…¬å¸ç­›é€‰</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="company1">
                    <label class="form-check-label" for="company1">Apple Inc.</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="company2">
                    <label class="form-check-label" for="company2">Microsoft</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="company3">
                    <label class="form-check-label" for="company3">Google</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">è”ç³»äººåˆ—è¡¨</h6>
                  <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectAllContacts()">å…¨é€‰</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">ç­›é€‰</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div id="contactList">
                  <!-- è”ç³»äººåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex justify-content-between align-items-center w-100">
          <span id="selectedContactsCount">å·²é€‰æ‹© 0 äºº</span>
          <div>
            <button class="btn btn-secondary me-2" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmRecipients()">ç¡®å®š</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentTemplates = [];
let selectedRecipients = [];
let currentTemplate = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… é‚®ä»¶æ¨¡æ¿é¡µé¢å·²åŠ è½½');
  
  // åˆå§‹åŒ–æ”¶ä»¶äººæ˜¾ç¤º
  updateRecipientDisplay();
  
  // åŠ è½½æ¨¡æ¿åˆ—è¡¨
  await loadTemplates();
  
  // æœç´¢åŠŸèƒ½
  const searchInput = document.getElementById('searchKeyword');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchTemplates, 500));
  }
});

// æ›´æ–°æ”¶ä»¶äººæ˜¾ç¤º
function updateRecipientDisplay() {
  const recipientsInput = document.getElementById('recipients');
  if (recipientsInput) {
    if (selectedRecipients.length === 0) {
      recipientsInput.value = '';
      recipientsInput.placeholder = 'è¯·é€‰æ‹©æ”¶ä»¶äºº';
    } else {
      recipientsInput.value = `å·²é€‰æ‹© ${selectedRecipients.length} ä½è”ç³»äºº`;
    }
  }
}

// åŠ è½½æ¨¡æ¿åˆ—è¡¨
async function loadTemplates() {
  try {
    const response = await axios.get('/api/email-templates/');
    currentTemplates = response.data.templates || [];
    
    if (currentTemplates.length === 0) {
      $('#templateList').html(`
        <div class="col-12">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <h5>æš‚æ— æ¨¡æ¿</h5>
            <p>åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªé‚®ä»¶æ¨¡æ¿</p>
          </div>
        </div>
      `);
      return;
    }
    
    renderTemplateList(currentTemplates);
  } catch (error) {
    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
    showToast('åŠ è½½æ¨¡æ¿å¤±è´¥', 'danger');
  }
}

// æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨
function renderTemplateList(templates) {
  let html = '';
  templates.forEach(template => {
    const variables = extractVariables(template.content);
    html += `
      <div class="col-md-6 col-lg-4 mb-3">
        <div class="card template-card" onclick="editTemplate(${template.id})" style="cursor: pointer;">
          <div class="card-body">
            <h6 class="card-title">${template.title}</h6>
            <p class="card-text text-truncate-3">${template.content.substring(0, 100)}...</p>
            <div class="mt-2">
              ${variables.map(v => `<span class="badge bg-info me-1">{{${v}}}</span>`).join('')}
            </div>
            <div class="mt-3">
              <small class="text-muted">åˆ›å»ºæ—¶é—´: ${formatDate(template.created_at)}</small>
            </div>
          </div>
          <div class="card-footer" onclick="event.stopPropagation();">
            <div class="d-flex justify-content-between">
              <button class="btn btn-sm btn-outline-primary" onclick="editTemplate(${template.id})">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${template.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  $('#templateList').html(html);
}

// æœç´¢æ¨¡æ¿
function searchTemplates() {
  const keyword = $('#searchKeyword').val().toLowerCase();
  
  if (!keyword) {
    renderTemplateList(currentTemplates);
    return;
  }
  
  const filtered = currentTemplates.filter(template => 
    template.title.toLowerCase().includes(keyword) ||
    template.content.toLowerCase().includes(keyword)
  );
  
  renderTemplateList(filtered);
}

// æå–å˜é‡
function extractVariables(content) {
  const matches = content.match(/\{\{([^}]+)\}\}/g);
  return matches ? [...new Set(matches.map(m => m.replace(/[{}]/g, '')))] : [];
}

// æ–°å»ºæ¨¡æ¿
function createNewTemplate() {
  console.log('âœ… ç‚¹å‡»æ–°å»ºæ¨¡æ¿');
  
  // åˆ›å»ºæ–°å»ºæ¨¡æ¿æ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  let templateModal = document.getElementById('createTemplateModal');
  if (!templateModal) {
    const modalHTML = `
      <div class="modal fade" id="createTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-lg" style="max-width: 800px;">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-file-earmark-plus"></i> æ–°å»ºé‚®ä»¶æ¨¡æ¿</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
                <div class="col-md-9">
                  <div class="mb-3">
                    <label class="form-label">æ¨¡æ¿æ ‡é¢˜</label>
                    <input type="text" class="form-control" id="newTemplateTitle" placeholder="è¯·è¾“å…¥æ¨¡æ¿æ ‡é¢˜">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">æ¨¡æ¿å†…å®¹</label>
                    <textarea class="form-control" id="newTemplateContent" rows="12" placeholder="è¯·è¾“å…¥æ¨¡æ¿å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨å³ä¾§çš„ä¸ªæ€§åŒ–å˜é‡"></textarea>
                  </div>
                </div>
                
                <!-- å³ä¾§ï¼šä¸ªæ€§åŒ–å˜é‡ -->
                <div class="col-md-3">
                  <label class="form-label">ä¸ªæ€§åŒ–å˜é‡</label>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="insertVariableToNewTemplate('{{firstName}}')" title="æ’å…¥æ”¶ä»¶äººåå­—">
                      <i class="bi bi-person"></i> {{firstName}}
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="insertVariableToNewTemplate('{{lastName}}')" title="æ’å…¥æ”¶ä»¶äººå§“æ°">
                      <i class="bi bi-person-badge"></i> {{lastName}}
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="insertVariableToNewTemplate('{{company}}')" title="æ’å…¥å…¬å¸åç§°">
                      <i class="bi bi-building"></i> {{company}}
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="insertVariableToNewTemplate('{{position}}')" title="æ’å…¥èŒä½">
                      <i class="bi bi-briefcase"></i> {{position}}
                    </button>
                  </div>
                  
                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <i class="bi bi-info-circle"></i> ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯å°†å˜é‡æ’å…¥åˆ°å…‰æ ‡ä½ç½®
                    </small>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button type="button" class="btn btn-primary" onclick="saveNewTemplate()">
                <i class="bi bi-check-lg"></i> ä¿å­˜æ¨¡æ¿
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  // æ¸…ç©ºè¡¨å•
  const titleInput = document.getElementById('newTemplateTitle');
  const contentInput = document.getElementById('newTemplateContent');
  if (titleInput) titleInput.value = '';
  if (contentInput) contentInput.value = '';
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  const modal = new bootstrap.Modal(document.getElementById('createTemplateModal'));
  modal.show();
}

// æ’å…¥å˜é‡åˆ°æ–°å»ºæ¨¡æ¿
function insertVariableToNewTemplate(variable) {
  const textarea = document.getElementById('newTemplateContent');
  if (!textarea) return;
  
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const content = textarea.value;
  
  textarea.value = content.substring(0, start) + variable + content.substring(end);
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  textarea.focus();
  
  console.log('âœ… æ’å…¥å˜é‡:', variable);
}

// ä¿å­˜æ–°å»ºæ¨¡æ¿
async function saveNewTemplate() {
  const title = document.getElementById('newTemplateTitle').value.trim();
  const content = document.getElementById('newTemplateContent').value.trim();
  
  if (!title) {
    showError('è¯·è¾“å…¥æ¨¡æ¿æ ‡é¢˜');
    return;
  }
  
  if (!content) {
    showError('è¯·è¾“å…¥æ¨¡æ¿å†…å®¹');
    return;
  }
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ åˆ›å»ºæ–°æ¨¡æ¿...');
    console.log('æ ‡é¢˜:', title);
    console.log('å†…å®¹:', content);
    
    const response = await fetch('/api/email-templates/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: title,
        content: content
      })
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ åˆ›å»ºç»“æœ:', data);
    
    if (!data.success) {
      showError('åˆ›å»ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    showSuccess('æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼');
    
    // å…³é—­æ¨¡æ€æ¡†
    const modal = bootstrap.Modal.getInstance(document.getElementById('createTemplateModal'));
    if (modal) {
      modal.hide();
    }
    
    // é‡æ–°åŠ è½½æ¨¡æ¿åˆ—è¡¨
    await loadTemplates();
    
  } catch (error) {
    console.error('âŒ åˆ›å»ºæ¨¡æ¿å¤±è´¥:', error);
    showError('åˆ›å»ºæ¨¡æ¿å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// åŠ è½½æ¨¡æ¿åˆ°ç¼–è¾‘å™¨
function loadTemplate() {
  const templateId = $('#templateSelect').val();
  if (!templateId) return;
  
  const template = currentTemplates.find(t => t.id == templateId);
  if (template) {
    $('#emailSubject').val(template.title);
    $('#emailContent').val(template.content);
    currentTemplate = template;
  }
}

// æ’å…¥å˜é‡
function insertVariable(variable) {
  const textarea = document.getElementById('emailContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  const before = text.substring(0, start);
  const after = text.substring(end, text.length);
  
  textarea.value = before + variable + after;
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  textarea.focus();
}

// æ ¼å¼åŒ–æ–‡æœ¬
function formatText(command) {
  document.execCommand(command, false, null);
}

// æ’å…¥åˆ—è¡¨
function insertList(type) {
  const listText = type === 'unordered' ? 'â€¢ ' : '1. ';
  insertText(listText);
}

// æ’å…¥é“¾æ¥
function insertLink() {
  const url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€:');
  if (url) {
    const text = prompt('è¯·è¾“å…¥é“¾æ¥æ–‡æœ¬:') || url;
    insertText(`<a href="${url}">${text}</a>`);
  }
}

// æ’å…¥å›¾ç‰‡
function insertImage() {
  const url = prompt('è¯·è¾“å…¥å›¾ç‰‡åœ°å€:');
  if (url) {
    insertText(`<img src="${url}" alt="å›¾ç‰‡" style="max-width: 100%;">`);
  }
}

// æ’å…¥æ–‡æœ¬
function insertText(text) {
  const textarea = document.getElementById('emailContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const content = textarea.value;
  
  textarea.value = content.substring(0, start) + text + content.substring(end);
  textarea.selectionStart = textarea.selectionEnd = start + text.length;
  textarea.focus();
}

// é€‰æ‹©æ”¶ä»¶äºº
function selectRecipients() {
  console.log('âœ… é€‰æ‹©æ”¶ä»¶äºº');
  const modal = new bootstrap.Modal(document.getElementById('recipientSelectModal'));
  modal.show();
  loadContactsForSelection();
}

// åŠ è½½è”ç³»äººç”¨äºé€‰æ‹©
async function loadContactsForSelection() {
  try {
    console.log('ğŸ”„ åŠ è½½è”ç³»äººåˆ—è¡¨...');
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/contacts/?pageSize=100', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ è”ç³»äººæ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½è”ç³»äººå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    const contacts = data.contacts || [];
    window.allContacts = contacts;  // ä¿å­˜åˆ°å…¨å±€å˜é‡
    
    let html = '';
    contacts.forEach(contact => {
      const isSelected = selectedRecipients.some(r => r.id === contact.id);
      html += `
        <div class="contact-item d-flex align-items-center p-2 border-bottom">
          <input type="checkbox" class="form-check-input me-3 recipient-checkbox" 
                 value="${contact.id}" 
                 data-contact-name="${contact.name}"
                 data-contact-email="${contact.email}"
                 data-contact-company="${contact.company || ''}"
                 ${isSelected ? 'checked' : ''} 
                 onchange="toggleRecipient(${contact.id}, this.checked)">
          <div class="flex-grow-1">
            <div class="fw-bold">${contact.name}</div>
            <small class="text-muted">${contact.email} â€¢ ${contact.company || 'æœªçŸ¥å…¬å¸'}</small>
          </div>
          <div class="tags">
            <span class="badge bg-secondary">æ½œåœ¨å®¢æˆ·</span>
          </div>
        </div>
      `;
    });
    
    const contactList = document.getElementById('contactList');
    if (contactList) {
      contactList.innerHTML = html;
    }
    
    updateSelectedCount();
    
    console.log(`âœ… åŠ è½½äº† ${contacts.length} ä¸ªè”ç³»äºº`);
  } catch (error) {
    console.error('âŒ åŠ è½½è”ç³»äººå¤±è´¥:', error);
    showError('åŠ è½½è”ç³»äººå¤±è´¥: ' + error.message);
  }
}

// åˆ‡æ¢æ”¶ä»¶äººé€‰æ‹©
function toggleRecipient(contactId, isSelected) {
  console.log('âœ… åˆ‡æ¢æ”¶ä»¶äºº:', contactId, isSelected);
  
  if (isSelected) {
    // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
    const contact = window.allContacts.find(c => c.id === contactId);
    if (contact && !selectedRecipients.some(r => r.id === contactId)) {
      selectedRecipients.push(contact);
      console.log('â• æ·»åŠ æ”¶ä»¶äºº:', contact.name);
    }
  } else {
    // ä»é€‰ä¸­åˆ—è¡¨ç§»é™¤
    const beforeLength = selectedRecipients.length;
    selectedRecipients = selectedRecipients.filter(r => r.id !== contactId);
    console.log('â– ç§»é™¤æ”¶ä»¶äººï¼Œæ•°é‡ä»', beforeLength, 'å˜ä¸º', selectedRecipients.length);
  }
  
  updateSelectedCount();
}

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
  const count = selectedRecipients.length;
  const countElement = document.getElementById('selectedContactsCount');
  if (countElement) {
    countElement.textContent = `å·²é€‰æ‹© ${count} äºº`;
  }
  console.log('ğŸ“Š å½“å‰é€‰ä¸­æ•°é‡:', count);
}

// å…¨é€‰è”ç³»äºº
function selectAllContacts() {
  const checkboxes = document.querySelectorAll('.recipient-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = true;
    toggleRecipient(parseInt(cb.value), true);
  });
}

// æ¸…ç©ºé€‰æ‹©
function clearSelection() {
  const checkboxes = document.querySelectorAll('.recipient-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = false;
  });
  selectedRecipients = [];
  updateSelectedCount();
  updateRecipientDisplay();
}

// ç¡®è®¤æ”¶ä»¶äºº
function confirmRecipients() {
  console.log('âœ… ç¡®è®¤æ”¶ä»¶äººï¼Œå…±é€‰æ‹©:', selectedRecipients.length);
  
  // æ›´æ–°æ”¶ä»¶äººæ˜¾ç¤º
  updateRecipientDisplay();
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('recipientSelectModal'));
  if (modal) {
    modal.hide();
  }
  
  console.log('ğŸ“‹ é€‰ä¸­çš„è”ç³»äººåˆ—è¡¨:', selectedRecipients);
}

// ä¿å­˜è‰ç¨¿
async function saveDraft() {
  const formData = {
    title: $('#emailSubject').val(),
    content: $('#emailContent').val(),
    status: 'draft'
  };
  
  try {
    await axios.post('/api/emails/draft', formData);
    showToast('è‰ç¨¿å·²ä¿å­˜', 'success');
  } catch (error) {
    showToast('ä¿å­˜è‰ç¨¿å¤±è´¥', 'danger');
  }
}

// å½“å‰é¢„è§ˆç´¢å¼•
let currentPreviewIndex = 0;
let emailPreviews = [];

// é¢„è§ˆé‚®ä»¶
async function previewEmail() {
  console.log('âœ… ç‚¹å‡»å‘é€é¢„è§ˆ');
  
  if (selectedRecipients.length === 0) {
    showError('è¯·å…ˆé€‰æ‹©æ”¶ä»¶äºº');
    return;
  }
  
  const subject = document.getElementById('emailSubject').value;
  const content = document.getElementById('emailContent').value;
  
  if (!subject || !content) {
    showError('è¯·å¡«å†™é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹');
    return;
  }
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ è°ƒç”¨é‚®ä»¶é¢„è§ˆæ¥å£...');
    console.log('é€‰ä¸­çš„æ”¶ä»¶äºº:', selectedRecipients);
    console.log('å½“å‰æ¨¡æ¿ID:', currentTemplate);
    
    // æ„å»ºè¯·æ±‚ä½“
    const requestBody = {
      contact_ids: selectedRecipients.map(r => r.id),
      template_title: subject,
      template_content: content
    };
    
    // å¦‚æœé€‰æ‹©äº†æ¨¡æ¿ï¼Œåˆ™æ·»åŠ  template_id
    if (currentTemplate) {
      requestBody.template_id = currentTemplate;
    }
    
    console.log('ğŸ“¤ è¯·æ±‚ä½“:', requestBody);
    
    // è°ƒç”¨æ‰¹é‡é¢„è§ˆæ¥å£
    const response = await fetch('/api/email-templates/batch-preview', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ é¢„è§ˆæ•°æ®:', data);
    
    if (!data.success) {
      showError('é¢„è§ˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    emailPreviews = data.previews || [];
    currentPreviewIndex = 0;
    
    console.log(`âœ… ç”Ÿæˆäº† ${emailPreviews.length} ä¸ªé¢„è§ˆ`);
    
    // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
    showPreviewModal();
    
  } catch (error) {
    console.error('âŒ é¢„è§ˆå¤±è´¥:', error);
    showError('é¢„è§ˆå¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
function showPreviewModal() {
  if (emailPreviews.length === 0) {
    showWarning('æ²¡æœ‰å¯é¢„è§ˆçš„å†…å®¹');
    return;
  }
  
  // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  let previewModal = document.getElementById('emailPreviewModal');
  if (!previewModal) {
    const modalHTML = `
      <div class="modal fade" id="emailPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg" style="max-width: 700px;">
          <div class="modal-content" style="position: relative;">
            <div class="modal-header">
              <h5 class="modal-title">é‚®ä»¶é¢„è§ˆ</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="min-height: 500px; max-height: 70vh; overflow-y: auto; padding: 2rem;">
              <div id="previewContent">
                <!-- é¢„è§ˆå†…å®¹ -->
              </div>
            </div>
            
            <!-- å·¦å³åˆ‡æ¢æŒ‰é’® - ç§»åˆ° modal-content å¤–å±‚ -->
            <button class="btn btn-primary rounded-circle preview-nav-btn" 
                    onclick="previousPreview()" 
                    id="prevBtn" 
                    style="display: none; position: absolute; left: -60px; top: 50%; transform: translateY(-50%); z-index: 1100; width: 45px; height: 45px; opacity: 0.9;">
              <i class="bi bi-chevron-left"></i>
            </button>
            
            <button class="btn btn-primary rounded-circle preview-nav-btn" 
                    onclick="nextPreview()" 
                    id="nextBtn" 
                    style="display: none; position: absolute; right: -60px; top: 50%; transform: translateY(-50%); z-index: 1100; width: 45px; height: 45px; opacity: 0.9;">
              <i class="bi bi-chevron-right"></i>
            </button>
            
            <div class="modal-footer">
              <div class="d-flex justify-content-between align-items-center w-100">
                <span id="previewCounter" class="text-muted">1 / 1</span>
                <div>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                  <button type="button" class="btn btn-primary" onclick="confirmAndSend()">
                    <i class="bi bi-send"></i> ç¡®è®¤å‘é€
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  // æ¸²æŸ“ç¬¬ä¸€ä¸ªé¢„è§ˆ
  renderPreview();
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  const modal = new bootstrap.Modal(document.getElementById('emailPreviewModal'));
  modal.show();
}

// æ¸²æŸ“é¢„è§ˆå†…å®¹
function renderPreview() {
  if (emailPreviews.length === 0) return;
  
  const preview = emailPreviews[currentPreviewIndex];
  const total = emailPreviews.length;
  
  const previewHTML = `
    <div class="email-preview-card">
      <div class="preview-header mb-4 p-3 bg-light rounded">
        <div class="mb-2">
          <strong class="text-primary">æ”¶ä»¶äººï¼š</strong> 
          <span>${preview.recipient_name || 'æœªçŸ¥'}</span>
        </div>
        <div>
          <strong class="text-primary">é‚®ç®±ï¼š</strong> 
          <span>${preview.recipient_email || 'æœªçŸ¥'}</span>
        </div>
      </div>
      
      <div class="preview-body">
        <div class="mb-4">
          <label class="text-muted mb-2"><i class="bi bi-envelope"></i> é‚®ä»¶ä¸»é¢˜</label>
          <div class="p-3 bg-light rounded">
            <strong style="font-size: 1.1rem;">${preview.template_title || '(æ— ä¸»é¢˜)'}</strong>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="text-muted mb-2"><i class="bi bi-file-text"></i> é‚®ä»¶å†…å®¹</label>
          <div class="p-3 bg-white border rounded" style="min-height: 250px; white-space: pre-wrap; line-height: 1.6;">
${preview.rendered_content || '(æ— å†…å®¹)'}
          </div>
        </div>
        
        ${preview.variables_used && preview.variables_used.length > 0 ? `
          <div class="mt-3 p-2 bg-info bg-opacity-10 rounded">
            <small class="text-muted">
              <i class="bi bi-info-circle text-info"></i> ä½¿ç”¨çš„å˜é‡: 
              ${preview.variables_used.map(v => `<code class="bg-white px-2 py-1 rounded">{{${v}}}</code>`).join(' ')}
            </small>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.getElementById('previewContent').innerHTML = previewHTML;
  
  // æ›´æ–°è®¡æ•°å™¨
  document.getElementById('previewCounter').textContent = `${currentPreviewIndex + 1} / ${total}`;
  
  // æ§åˆ¶å·¦å³æŒ‰é’®æ˜¾ç¤º
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (total > 1) {
    if (currentPreviewIndex === 0) {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'block';
    } else if (currentPreviewIndex === total - 1) {
      prevBtn.style.display = 'block';
      nextBtn.style.display = 'none';
    } else {
      prevBtn.style.display = 'block';
      nextBtn.style.display = 'block';
    }
  } else {
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
  }
  
  console.log(`ğŸ“§ æ˜¾ç¤ºé¢„è§ˆ ${currentPreviewIndex + 1}/${total}`);
}

// ä¸Šä¸€ä¸ªé¢„è§ˆ
function previousPreview() {
  if (currentPreviewIndex > 0) {
    currentPreviewIndex--;
    renderPreview();
  }
}

// ä¸‹ä¸€ä¸ªé¢„è§ˆ
function nextPreview() {
  if (currentPreviewIndex < emailPreviews.length - 1) {
    currentPreviewIndex++;
    renderPreview();
  }
}

// ç¡®è®¤å¹¶å‘é€
function confirmAndSend() {
  showInfo('ğŸ“§ å‘é€åŠŸèƒ½å¼€å‘ä¸­...\n\nå°†ä¼šè°ƒç”¨æ‰¹é‡å‘é€æ¥å£å‘é€è¿™ ' + emailPreviews.length + ' å°é‚®ä»¶');
}

// å‘é€é‚®ä»¶
async function sendEmail(type) {
  if (selectedRecipients.length === 0) {
    showToast('è¯·å…ˆé€‰æ‹©æ”¶ä»¶äºº', 'warning');
    return;
  }
  
  const formData = {
    title: $('#emailSubject').val(),
    content: $('#emailContent').val(),
    recipient_ids: selectedRecipients.map(r => r.id),
    send_type: type
  };
  
  try {
    showLoading();
    await axios.post('/api/emails/send-batch', formData);
    showToast('é‚®ä»¶å‘é€æˆåŠŸ', 'success');
    $('#addTemplateModal').modal('hide');
  } catch (error) {
    showToast('å‘é€å¤±è´¥', 'danger');
  } finally {
    hideLoading();
  }
}

// ä¿å­˜æ¨¡æ¿
async function saveTemplate() {
  const formData = {
    title: $('#emailSubject').val(),
    content: $('#emailContent').val()
  };
  
  if (!formData.title || !formData.content) {
    showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
    return;
  }
  
  try {
    if (currentTemplate) {
      // æ›´æ–°ç°æœ‰æ¨¡æ¿
      await axios.put(`/api/email-templates/${currentTemplate.id}`, formData);
      showToast('æ¨¡æ¿æ›´æ–°æˆåŠŸ', 'success');
    } else {
      // åˆ›å»ºæ–°æ¨¡æ¿
      await axios.post('/api/email-templates/', formData);
      showToast('æ¨¡æ¿åˆ›å»ºæˆåŠŸ', 'success');
    }
    
    $('#addTemplateModal').modal('hide');
    await loadTemplates();
  } catch (error) {
    showToast('ä¿å­˜å¤±è´¥', 'danger');
  }
}

// ç¼–è¾‘æ¨¡æ¿
function editTemplate(id) {
  const template = currentTemplates.find(t => t.id === id);
  if (template) {
    currentTemplate = template;
    $('#templateSelect').val(id);
    $('#emailSubject').val(template.title);
    $('#emailContent').val(template.content);
    $('#addTemplateModal').modal('show');
  }
}

// åˆ é™¤æ¨¡æ¿
async function deleteTemplate(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
  
  try {
    await axios.delete(`/api/email-templates/${id}`);
    showToast('æ¨¡æ¿å·²åˆ é™¤', 'success');
    await loadTemplates();
  } catch (error) {
    showToast('åˆ é™¤å¤±è´¥', 'danger');
  }
}

// æ˜¾ç¤ºæ¨¡æ¿é¢„è§ˆ
function showTemplatePreview() {
  showToast('æ¨¡æ¿é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// å·¥å…·å‡½æ•°
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN');
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showLoading() {
  console.log('ğŸ”„ æ˜¾ç¤ºåŠ è½½ä¸­...');
  const loadingHTML = `
    <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">åŠ è½½ä¸­...</span>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
  console.log('âœ… éšè—åŠ è½½ä¸­');
  const loading = document.getElementById('loadingOverlay');
  if (loading) {
    loading.remove();
  }
}

function showToast(message, type) {
  console.log(`${type}: ${message}`);
  showToast(message, 'info');
}
</script>
