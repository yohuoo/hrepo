<!-- å†™é‚®ä»¶é¡µé¢ -->
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-envelope-plus"></i> å†™é‚®ä»¶</h2>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary" onclick="showDraftsModal()">
        <i class="bi bi-folder2-open"></i> è‰ç¨¿ç®±
      </button>
      <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
        <i class="bi bi-save"></i> ä¿å­˜è‰ç¨¿
      </button>
    </div>
  </div>

  <div class="row">
    <!-- å·¦ä¾§ï¼šé‚®ä»¶ç¼–è¾‘åŒº -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">é‚®ä»¶å†…å®¹</h5>
        </div>
        <div class="card-body">
          <form id="composeForm">
            <!-- æ”¶ä»¶äºº -->
                  <div class="mb-3">
                    <label class="form-label">æ”¶ä»¶äºº</label>
                    <input type="text" class="form-control" id="recipients" placeholder="ç‚¹å‡»é€‰æ‹©æ”¶ä»¶äºº" readonly onclick="selectRecipients()" style="cursor: pointer;">
                    <div class="mt-2 d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectRecipients()">
                        <i class="bi bi-pencil"></i> ç¼–è¾‘æ”¶ä»¶äºº
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllRecipients()" id="clearRecipientsBtn" style="display: none;">
                        <i class="bi bi-x-circle"></i> æ¸…ç©ºæ”¶ä»¶äºº
                      </button>
                    </div>
                    <small class="text-muted">æ”¯æŒé€‰æ‹©è”ç³»äººå’Œå®¢æˆ·ï¼Œç›¸åŒé‚®ç®±è‡ªåŠ¨åŒæ­¥</small>
                  </div>

            <!-- å‘ä»¶äººé‚®ç®± -->
            <div class="mb-3">
              <label class="form-label">å‘ä»¶äººé‚®ç®±</label>
              <select class="form-select" id="senderEmail">
                <option value="">é€‰æ‹©å‘ä»¶é‚®ç®±...</option>
              </select>
            </div>

            <!-- é‚®ä»¶ä¸»é¢˜ -->
            <div class="mb-3">
              <label class="form-label">é‚®ä»¶ä¸»é¢˜</label>
              <input type="text" class="form-control" id="emailTitle" placeholder="è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜">
              <!-- AIç”Ÿæˆçš„æ ‡é¢˜é¢„è§ˆ -->
              <div id="aiTitlePreview" style="display: none;">
                <div class="ai-result-preview mt-2">
                  <div class="ai-result-header">
                    <span class="ai-result-label">
                      <i class="bi bi-stars"></i> AIä¼˜åŒ–åçš„æ ‡é¢˜
                    </span>
                    <div class="ai-result-actions">
                      <button type="button" class="btn btn-sm btn-success" onclick="applyAITitle()">
                        <i class="bi bi-check-lg"></i> æ›¿æ¢
                      </button>
                      <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAITitle()">
                        <i class="bi bi-x-lg"></i> å–æ¶ˆ
                      </button>
                    </div>
                  </div>
                  <div class="ai-result-content" id="aiTitleContent"></div>
                </div>
              </div>
            </div>

            <!-- é‚®ä»¶å†…å®¹ -->
            <div class="mb-3">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>é‚®ä»¶å†…å®¹</span>
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-primary" onclick="aiEnrichEmail()" title="AIç”Ÿæˆä¼˜åŒ–é‚®ä»¶">
                    <i class="bi bi-stars"></i> AIç”Ÿæˆ
                  </button>
                  <button type="button" class="btn btn-outline-info" onclick="translateEmail()" title="ç¿»è¯‘é‚®ä»¶">
                    <i class="bi bi-translate"></i> ç¿»è¯‘
                  </button>
                </div>
              </label>
              <textarea class="form-control" id="emailContent" rows="15" placeholder="è¯·è¾“å…¥é‚®ä»¶å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸ªæ€§åŒ–å˜é‡"></textarea>
              <!-- AIç”Ÿæˆçš„å†…å®¹é¢„è§ˆ -->
              <div id="aiContentPreview" style="display: none;">
                <div class="ai-result-preview mt-2">
                  <div class="ai-result-header">
                    <span class="ai-result-label">
                      <i class="bi bi-stars"></i> <span id="aiContentLabel">AIä¼˜åŒ–åçš„å†…å®¹</span>
                    </span>
                    <div class="ai-result-actions">
                      <button type="button" class="btn btn-sm btn-success" onclick="applyAIContent()">
                        <i class="bi bi-check-lg"></i> æ›¿æ¢
                      </button>
                      <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAIContent()">
                        <i class="bi bi-x-lg"></i> å–æ¶ˆ
                      </button>
                    </div>
                  </div>
                  <div class="ai-result-content" id="aiContentContent"></div>
                </div>
              </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-info" onclick="previewEmail()">
                <i class="bi bi-eye"></i> é¢„è§ˆ
              </button>
              <button type="button" class="btn btn-primary" onclick="sendEmail()">
                <i class="bi bi-send"></i> å‘é€é‚®ä»¶
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šå·¥å…·æ  -->
    <div class="col-md-4">
      <!-- é‚®ä»¶æ¨¡æ¿ -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-file-text"></i> é‚®ä»¶æ¨¡æ¿</h6>
        </div>
        <div class="card-body">
          <select class="form-select mb-2" id="templateSelect" onchange="loadTemplate()">
            <option value="">é€‰æ‹©æ¨¡æ¿...</option>
          </select>
          <small class="text-muted">é€‰æ‹©æ¨¡æ¿åå°†è‡ªåŠ¨å¡«å……ä¸»é¢˜å’Œå†…å®¹</small>
        </div>
      </div>

      <!-- ä¸ªæ€§åŒ–å˜é‡ -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-code-square"></i> ä¸ªæ€§åŒ–å˜é‡</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="insertVariable('{{firstName}}')" title="æ’å…¥æ”¶ä»¶äººåå­—">
              <i class="bi bi-person"></i> {{firstName}}
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="insertVariable('{{lastName}}')" title="æ’å…¥æ”¶ä»¶äººå§“æ°">
              <i class="bi bi-person-badge"></i> {{lastName}}
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="insertVariable('{{company}}')" title="æ’å…¥å…¬å¸åç§°">
              <i class="bi bi-building"></i> {{company}}
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="insertVariable('{{position}}')" title="æ’å…¥èŒä½">
              <i class="bi bi-briefcase"></i> {{position}}
            </button>
          </div>
          <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> ç‚¹å‡»æŒ‰é’®å°†å˜é‡æ’å…¥åˆ°å…‰æ ‡ä½ç½®
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- é€‰æ‹©æ”¶ä»¶äººæ¨¡æ€æ¡† -->
<div class="modal fade" id="recipientSelectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">é€‰æ‹©æ”¶ä»¶äºº</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- ç±»å‹åˆ‡æ¢å’Œæœç´¢ -->
        <div class="row mb-3">
          <div class="col-md-12">
            <div class="btn-group w-100 mb-3" role="group">
              <button type="button" class="btn btn-outline-primary active" id="btnContacts" onclick="switchRecipientType('contacts')">
                <i class="bi bi-person-lines-fill"></i> è”ç³»äºº
              </button>
              <button type="button" class="btn btn-outline-primary" id="btnCustomers" onclick="switchRecipientType('customers')">
                <i class="bi bi-people"></i> å®¢æˆ·
              </button>
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" placeholder="æœç´¢åç§°ã€å…¬å¸æˆ–åŸŸå..." id="recipientSearch" oninput="searchRecipients()">
            </div>
          </div>
        </div>
        
        <!-- æ”¶ä»¶äººåˆ—è¡¨ -->
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0" id="recipientListTitle">è”ç³»äººåˆ—è¡¨</h6>
                  <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectAllRecipients()">å…¨é€‰</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">æ¸…ç©º</button>
                  </div>
                </div>
              </div>
              <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="recipientList">
                  <!-- æ”¶ä»¶äººåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                  <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex justify-content-between align-items-center w-100">
          <span id="selectedRecipientsCount">å·²é€‰æ‹© 0 äºº</span>
          <div>
            <button class="btn btn-secondary me-2" onclick="cancelRecipientSelection()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmRecipients()">ç¡®å®š</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æŸ¥çœ‹å·²é€‰æ‹©æ”¶ä»¶äººæ¨¡æ€æ¡† -->
<div class="modal fade" id="selectedRecipientsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-people"></i> å·²é€‰æ‹©çš„æ”¶ä»¶äºº 
          <span class="badge bg-primary ms-2" id="selectedRecipientsCountBadge">0</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="selectedRecipientsList" style="max-height: 400px; overflow-y: auto;">
          <!-- å·²é€‰æ‹©çš„æ”¶ä»¶äººåˆ—è¡¨ -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-primary" onclick="editRecipients()">
          <i class="bi bi-pencil"></i> ç¼–è¾‘æ”¶ä»¶äºº
        </button>
      </div>
    </div>
  </div>
</div>

<!-- å‘é€ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="sendConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="bi bi-send-check"></i> ç¡®è®¤å‘é€
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>è¯·ç¡®è®¤ä»¥ä¸‹ä¿¡æ¯ï¼š</strong>
        </div>
        <div class="mb-3">
          <label class="text-muted small">æ”¶ä»¶äººæ•°é‡</label>
          <div class="fs-5 fw-bold" id="confirmRecipientCount">0 ä½æ”¶ä»¶äºº</div>
        </div>
        <div class="mb-3">
          <label class="text-muted small">é‚®ä»¶ä¸»é¢˜</label>
          <div class="fw-bold" id="confirmEmailSubject">-</div>
        </div>
        <div>
          <label class="text-muted small">å‘ä»¶é‚®ç®±</label>
          <div class="fw-bold" id="confirmSenderEmail">-</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> å–æ¶ˆ
        </button>
        <button type="button" class="btn btn-primary" onclick="confirmSendEmail()">
          <i class="bi bi-send-fill"></i> ç¡®è®¤å‘é€
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ä¿å­˜ä¸ºæ¨¡æ¿ç¡®è®¤æ¨¡æ€æ¡†ï¼ˆæ›¿ä»£æµè§ˆå™¨åŸç”Ÿconfirmï¼‰ -->
<div class="modal fade" id="saveAsTemplateModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-journal-plus"></i> ä¿å­˜ä¸ºæ¨¡æ¿
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        æ˜¯å¦å°†æœ¬æ¬¡é‚®ä»¶å†…å®¹ä¿å­˜ä¸ºæ¨¡æ¿ï¼Ÿ
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> å–æ¶ˆ
        </button>
        <button type="button" class="btn btn-primary" id="confirmSaveTemplateBtn">
          <i class="bi bi-check-lg"></i> ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ä¿å­˜è‰ç¨¿æ¨¡æ€æ¡† -->
<div class="modal fade" id="saveDraftModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-save"></i> ä¿å­˜è‰ç¨¿
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">è‰ç¨¿åç§°ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" class="form-control" id="draftNameInput" placeholder="ä¾‹å¦‚ï¼šç»™å®¢æˆ·Açš„äº§å“ä»‹ç»é‚®ä»¶">
          <small class="text-muted">ç•™ç©ºåˆ™ä½¿ç”¨é‚®ä»¶æ ‡é¢˜ä½œä¸ºè‰ç¨¿åç§°</small>
        </div>
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          è‰ç¨¿å°†ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œå¯åœ¨ä»»ä½•è®¾å¤‡è®¿é—®
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> å–æ¶ˆ
        </button>
        <button type="button" class="btn btn-primary" onclick="confirmSaveDraft()">
          <i class="bi bi-check-lg"></i> ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<!-- è‰ç¨¿ç®±æ¨¡æ€æ¡† -->
<div class="modal fade" id="draftsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-folder2-open"></i> è‰ç¨¿ç®±
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="draftsList">
          <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 text-muted">åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div id="draftsPagination" class="flex-grow-1"></div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<!-- ä½¿ç”¨è‰ç¨¿ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="useDraftConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle"></i> ç¡®è®¤æ“ä½œ
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>æ³¨æ„</strong>
        </div>
        <p class="mb-0">åŠ è½½æ­¤è‰ç¨¿å°†è¦†ç›–å½“å‰ç¼–è¾‘çš„å†…å®¹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> å–æ¶ˆ
        </button>
        <button type="button" class="btn btn-primary" id="confirmUseDraftBtn">
          <i class="bi bi-check-lg"></i> ç»§ç»­
        </button>
      </div>
    </div>
  </div>
</div>

<!-- åˆ é™¤è‰ç¨¿ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteDraftConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-trash"></i> ç¡®è®¤åˆ é™¤
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger mb-3">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>è­¦å‘Š</strong>
        </div>
        <p class="mb-0">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‰ç¨¿å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> å–æ¶ˆ
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteDraftBtn">
          <i class="bi bi-trash"></i> åˆ é™¤
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* AIç»“æœé¢„è§ˆæ ·å¼ */
.ai-result-preview {
  background: #f0f0f0;
  border: 2px dashed #667eea;
  border-radius: 12px;
  padding: 16px;
  position: relative;
}

.ai-result-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid #d0d0d0;
}

.ai-result-label {
  font-weight: 600;
  color: #667eea;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ai-result-actions {
  display: flex;
  gap: 8px;
}

.ai-result-content {
  background: #e8e8e8;
  padding: 16px;
  border-radius: 8px;
  min-height: 60px;
  white-space: pre-line;
  line-height: 1.6;
  color: #333;
  font-size: 0.95rem;
}

/* AIé¢„è§ˆtextareaæ ·å¼ï¼ˆä¸ä¸Šæ–¹è¾“å…¥æ¡†ç»Ÿä¸€ï¼Œä»…åŠ æ·¡åº•è‰²ï¼‰ */
.ai-preview-textarea {
  width: 100% !important;
  height: 200px !important;
  background-color: #f8f9fa !important;
  border: 1px solid #ced4da !important;
  border-radius: 0.375rem !important;
  padding: 0.375rem 0.75rem !important;
  font-family: inherit !important;
  font-size: 1rem !important;
  line-height: 1.5 !important;
  resize: vertical !important;
  cursor: not-allowed !important;
  color: #212529 !important;
  opacity: 0.8 !important;
}

.ai-preview-textarea:focus {
  background-color: #f8f9fa !important;
  border-color: #86b7fe !important;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
  outline: none !important;
}

/* åŸå†…å®¹æ ·å¼ï¼ˆæ·±è‰²ï¼‰ */
.form-control {
  background: white;
  color: #212529;
}

/* åŠ è½½çŠ¶æ€ */
.ai-loading {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #667eea;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-top: 8px;
}

.loading-dots {
  display: inline-block;
  min-width: 20px;
}
</style>

<script>
// å…¨å±€å˜é‡
let selectedRecipients = [];
let tempSelectedRecipients = []; // ä¸´æ—¶é€‰æ‹©ï¼ˆæ¨¡æ€æ¡†ä¸­ï¼‰
let currentTemplate = null;

// è¿½è¸ªé‚®ä»¶æ¥æºå’Œç¼–è¾‘çŠ¶æ€
let emailSource = {
  type: 'manual', // 'manual', 'template', 'reply', 'draft'
  wasEdited: false, // æ˜¯å¦è¢«æ‰‹åŠ¨ç¼–è¾‘è¿‡
  loadedFromTemplate: false,
  loadedFromDraft: false,
  isReply: false
};
let emailPreviews = [];
let currentPreviewIndex = 0;
let aiGeneratedTitle = '';
let aiGeneratedContent = '';

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… å†™é‚®ä»¶é¡µé¢å·²åŠ è½½');
  
  // åˆå§‹åŒ–æ”¶ä»¶äººæ˜¾ç¤º
  updateRecipientDisplay();
  
  // åŠ è½½å‘ä»¶é‚®ç®±åˆ—è¡¨
  await loadSenderEmails();
  
  // ç›‘å¬å†…å®¹ç¼–è¾‘ï¼Œæ ‡è®°ä¸ºå·²ç¼–è¾‘
  const titleInput = document.getElementById('emailTitle');
  const contentInput = document.getElementById('emailContent');
  
  if (titleInput) {
    titleInput.addEventListener('input', () => {
      if (emailSource.type !== 'manual' && !emailSource.wasEdited) {
        emailSource.wasEdited = true;
        console.log('ğŸ“ å†…å®¹å·²è¢«ç¼–è¾‘');
      }
    });
  }
  
  if (contentInput) {
    contentInput.addEventListener('input', () => {
      if (emailSource.type !== 'manual' && !emailSource.wasEdited) {
        emailSource.wasEdited = true;
        console.log('ğŸ“ å†…å®¹å·²è¢«ç¼–è¾‘');
      }
    });
  }
  
  // åŠ è½½é‚®ä»¶æ¨¡æ¿åˆ—è¡¨
  await loadTemplateList();
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯å›å¤é‚®ä»¶
  checkReplyMode();
  
  // ç›‘å¬æ”¶ä»¶äººé€‰æ‹©æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
  const recipientModal = document.getElementById('recipientSelectModal');
  if (recipientModal) {
    recipientModal.addEventListener('hidden.bs.modal', function(event) {
      // å¦‚æœä¸æ˜¯é€šè¿‡"ç¡®å®š"æŒ‰é’®å…³é—­çš„ï¼Œæ¢å¤ä¸´æ—¶é€‰æ‹©
      // è¿™é‡Œä¸éœ€è¦åšä»»ä½•æ“ä½œï¼Œå› ä¸ºtempSelectedRecipientsä¼šåœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶é‡æ–°åˆå§‹åŒ–
      console.log('ğŸ“‹ æ”¶ä»¶äººé€‰æ‹©æ¨¡æ€æ¡†å·²å…³é—­');
    });
  }
});

// æ£€æŸ¥å›å¤æ¨¡å¼
async function checkReplyMode() {
  const replyDataStr = sessionStorage.getItem('replyData');
  if (replyDataStr) {
    try {
      const replyData = JSON.parse(replyDataStr);
      console.log('ğŸ“§ æ£€æµ‹åˆ°å›å¤æ¨¡å¼:', replyData);
      
      // å¡«å……ä¸»é¢˜ï¼ˆæ·»åŠ  Re: å‰ç¼€ï¼‰
      const subject = replyData.originalSubject.startsWith('Re:') 
        ? replyData.originalSubject 
        : `Re: ${replyData.originalSubject}`;
      document.getElementById('emailTitle').value = subject;
      
      // å¡«å……å†…å®¹ï¼ˆå¼•ç”¨åŸé‚®ä»¶ï¼‰
      const originalDate = new Date(replyData.originalTime).toLocaleString('zh-CN');
      const quotedContent = `


------- åŸå§‹é‚®ä»¶ -------
å‘ä»¶äºº: ${replyData.originalSender}
å‘é€æ—¶é—´: ${originalDate}
ä¸»é¢˜: ${replyData.originalSubject}

${replyData.originalContent}
`;
      
      document.getElementById('emailContent').value = quotedContent;
      
      // å°†å…‰æ ‡ç§»åˆ°å†…å®¹å¼€å¤´
      const textarea = document.getElementById('emailContent');
      textarea.setSelectionRange(0, 0);
      textarea.focus();
      
      // è‡ªåŠ¨æŸ¥æ‰¾å¹¶æ·»åŠ å¯¹åº”çš„è”ç³»äºº
      await autoSelectRecipientByEmail(replyData.replyTo);
      
      // æ·»åŠ æç¤ºæ¨ªå¹…
      const composeForm = document.getElementById('composeForm');
      if (composeForm && composeForm.parentElement) {
        const banner = document.createElement('div');
        banner.className = 'alert alert-info alert-dismissible fade show mb-3';
        banner.innerHTML = `
          <i class="bi bi-reply"></i> <strong>å›å¤æ¨¡å¼</strong>
          <p class="mb-0 small">æ­£åœ¨å›å¤æ¥è‡ª <strong>${replyData.replyTo}</strong> çš„é‚®ä»¶</p>
          <p class="mb-0 small text-muted">${selectedRecipients.length > 0 ? 'å·²è‡ªåŠ¨é€‰æ‹©æ”¶ä»¶äºº' : 'è¯·æ‰‹åŠ¨é€‰æ‹©æ”¶ä»¶äºº'}</p>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        composeForm.parentElement.insertBefore(banner, composeForm);
      }
      
      // æ ‡è®°ä¸ºå›å¤é‚®ä»¶
      emailSource.type = 'reply';
      emailSource.isReply = true;
      emailSource.wasEdited = false; // å›å¤é‚®ä»¶å³ä½¿ç¼–è¾‘ä¹Ÿä¸æç¤ºä¿å­˜ä¸ºæ¨¡æ¿
      
      // æ¸…é™¤ sessionStorage
      sessionStorage.removeItem('replyData');
      
    } catch (error) {
      console.error('âŒ è§£æå›å¤æ•°æ®å¤±è´¥:', error);
      sessionStorage.removeItem('replyData');
    }
  }
}

// æ ¹æ®é‚®ç®±åœ°å€è‡ªåŠ¨é€‰æ‹©è”ç³»äºº
async function autoSelectRecipientByEmail(email) {
  try {
    console.log('ğŸ” è‡ªåŠ¨æŸ¥æ‰¾è”ç³»äºº:', email);
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/contacts/?pageSize=100', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.contacts) {
      // æŸ¥æ‰¾åŒ¹é…çš„è”ç³»äºº
      const contact = data.contacts.find(c => c.email === email);
      
      if (contact) {
        console.log('âœ… æ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº:', contact.name);
        // æ·»åŠ  type å­—æ®µï¼Œç¡®ä¿åœ¨æ¨¡æ€æ¡†ä¸­èƒ½æ­£ç¡®è¯†åˆ«
        const contactWithType = { ...contact, type: 'contacts' };
        selectedRecipients = [contactWithType];
        updateRecipientDisplay();
      } else {
        console.log('âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„è”ç³»äººï¼Œé‚®ç®±:', email);
        // æ˜¾ç¤ºæç¤ºï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
        const recipientsInput = document.getElementById('recipients');
        if (recipientsInput) {
          recipientsInput.placeholder = `æœªæ‰¾åˆ°è”ç³»äºº (${email})ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©`;
        }
      }
    }
    
  } catch (error) {
    console.error('âŒ è‡ªåŠ¨é€‰æ‹©è”ç³»äººå¤±è´¥:', error);
  }
}

// åŠ è½½å‘ä»¶é‚®ç®±åˆ—è¡¨
async function loadSenderEmails() {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/user-email-bindings/', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.bindings) {
      const select = document.getElementById('senderEmail');
      select.innerHTML = '<option value="">é€‰æ‹©å‘ä»¶é‚®ç®±...</option>';
      
      let defaultEmailId = null;
      
      data.bindings.forEach(binding => {
        const option = document.createElement('option');
        option.value = binding.id;
        option.textContent = `${binding.email_address}${binding.is_default ? ' (é»˜è®¤)' : ''}`;
        select.appendChild(option);
        
        // è®°å½•é»˜è®¤é‚®ç®±
        if (binding.is_default) {
          defaultEmailId = binding.id;
        }
      });
      
      // ä¼˜å…ˆé€‰æ‹©ï¼šé»˜è®¤é‚®ç®± > å”¯ä¸€é‚®ç®±
      if (defaultEmailId) {
        select.value = defaultEmailId;
        console.log('âœ… å·²è‡ªåŠ¨é€‰æ‹©é»˜è®¤é‚®ç®±:', defaultEmailId);
      } else if (data.bindings.length === 1) {
        select.value = data.bindings[0].id;
        console.log('âœ… å·²è‡ªåŠ¨é€‰æ‹©å”¯ä¸€é‚®ç®±:', data.bindings[0].id);
      }
      
      console.log('âœ… å‘ä»¶é‚®ç®±åˆ—è¡¨åŠ è½½å®Œæˆ:', data.bindings.length, 'ä¸ª');
    }
  } catch (error) {
    console.error('âŒ åŠ è½½å‘ä»¶é‚®ç®±å¤±è´¥:', error);
  }
}

// åŠ è½½é‚®ä»¶æ¨¡æ¿åˆ—è¡¨
async function loadTemplateList() {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/email-templates/?pageSize=100', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.templates) {
      window.allTemplates = data.templates;
      
      const select = document.getElementById('templateSelect');
      select.innerHTML = '<option value="">é€‰æ‹©æ¨¡æ¿...</option>';
      
      data.templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.title;
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('âŒ åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
  }
}

// åŠ è½½æ¨¡æ¿
function loadTemplate() {
  const templateId = document.getElementById('templateSelect').value;
  if (!templateId) {
    document.getElementById('emailTitle').value = '';
    document.getElementById('emailContent').value = '';
    currentTemplate = null;
    
    // é‡ç½®ä¸ºæ‰‹åŠ¨ç¼–è¾‘
    emailSource.type = 'manual';
    emailSource.loadedFromTemplate = false;
    emailSource.wasEdited = false;
    return;
  }
  
  const template = window.allTemplates.find(t => t.id == templateId);
  if (template) {
    document.getElementById('emailTitle').value = template.title;
    document.getElementById('emailContent').value = template.content;
    currentTemplate = template;
    
    // æ ‡è®°ä¸ºä»æ¨¡æ¿åŠ è½½
    emailSource.type = 'template';
    emailSource.loadedFromTemplate = true;
    emailSource.wasEdited = false; // åˆšåŠ è½½æ—¶æœªç¼–è¾‘
    
    console.log('âœ… å·²åŠ è½½æ¨¡æ¿:', template.title);
  }
}

// ==================== æ”¶ä»¶äººé€‰æ‹©ç›¸å…³å‡½æ•° ====================

// å…¨å±€å˜é‡
let currentRecipientType = 'contacts';  // contacts æˆ– customers
let allRecipients = [];  // æ‰€æœ‰æ”¶ä»¶äººæ•°æ®
let filteredRecipients = [];  // è¿‡æ»¤åçš„æ”¶ä»¶äººæ•°æ®

// æ›´æ–°æ”¶ä»¶äººæ˜¾ç¤º
function updateRecipientDisplay() {
  const recipientsInput = document.getElementById('recipients');
  const clearBtn = document.getElementById('clearRecipientsBtn');
  
  if (recipientsInput) {
    if (selectedRecipients.length === 0) {
      recipientsInput.value = '';
      recipientsInput.placeholder = 'ç‚¹å‡»é€‰æ‹©æ”¶ä»¶äºº';
      // éšè—æ¸…ç©ºæŒ‰é’®
      if (clearBtn) clearBtn.style.display = 'none';
    } else {
      // æŒ‰é‚®ç®±å»é‡ï¼Œç»Ÿè®¡å”¯ä¸€æ”¶ä»¶äººæ•°é‡
      const uniqueEmails = new Set(selectedRecipients.map(r => r.email));
      const totalUnique = uniqueEmails.size;
      
      // ç»Ÿè®¡è”ç³»äººå’Œå®¢æˆ·æ•°é‡
      const contactCount = selectedRecipients.filter(r => r.type === 'contacts').length;
      const customerCount = selectedRecipients.filter(r => r.type === 'customers').length;
      
      const parts = [];
      if (contactCount > 0) parts.push(`${contactCount}ä½è”ç³»äºº`);
      if (customerCount > 0) parts.push(`${customerCount}ä½å®¢æˆ·`);
      
      recipientsInput.value = `å·²é€‰æ‹© ${parts.join('ã€')}ï¼ˆå…±${totalUnique}ä¸ªé‚®ç®±ï¼‰`;
      
      // æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
      if (clearBtn) clearBtn.style.display = 'inline-block';
    }
  }
}

// æ¸…ç©ºæ‰€æœ‰æ”¶ä»¶äºº
function clearAllRecipients() {
  if (selectedRecipients.length > 0 && !confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²é€‰æ‹©çš„æ”¶ä»¶äººå—ï¼Ÿ')) {
    return;
  }
  selectedRecipients = [];
  updateRecipientDisplay();
  console.log('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ”¶ä»¶äºº');
  showSuccess('æ”¶ä»¶äººå·²æ¸…ç©º');
}

// é€‰æ‹©æ”¶ä»¶äºº
function selectRecipients() {
  console.log('âœ… é€‰æ‹©æ”¶ä»¶äºº');
  
  // å¤‡ä»½å½“å‰é€‰æ‹©åˆ°ä¸´æ—¶å˜é‡
  tempSelectedRecipients = JSON.parse(JSON.stringify(selectedRecipients));
  console.log('ğŸ“‹ å¤‡ä»½å½“å‰é€‰æ‹©:', tempSelectedRecipients.length, 'äºº');
  
  const modal = new bootstrap.Modal(document.getElementById('recipientSelectModal'));
  modal.show();
  
  // é»˜è®¤åŠ è½½è”ç³»äºº
  currentRecipientType = 'contacts';
  document.getElementById('btnContacts').classList.add('active');
  document.getElementById('btnCustomers').classList.remove('active');
  document.getElementById('recipientSearch').value = '';
  
  loadRecipientsForSelection();
}

// åˆ‡æ¢æ”¶ä»¶äººç±»å‹
function switchRecipientType(type) {
  console.log('ğŸ”„ åˆ‡æ¢æ”¶ä»¶äººç±»å‹:', type);
  currentRecipientType = type;
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  document.getElementById('btnContacts').classList.toggle('active', type === 'contacts');
  document.getElementById('btnCustomers').classList.toggle('active', type === 'customers');
  
  // æ›´æ–°æ ‡é¢˜
  document.getElementById('recipientListTitle').textContent = type === 'contacts' ? 'è”ç³»äººåˆ—è¡¨' : 'å®¢æˆ·åˆ—è¡¨';
  
  // æ¸…ç©ºæœç´¢æ¡†
  document.getElementById('recipientSearch').value = '';
  
  // åŠ è½½æ•°æ®ï¼ˆä¼šè‡ªåŠ¨åŒæ­¥æ˜¾ç¤ºç›¸åŒé‚®ç®±çš„é€‰ä¸­çŠ¶æ€ï¼‰
  loadRecipientsForSelection();
  
  console.log('ğŸ“‹ å½“å‰å·²é€‰æ”¶ä»¶äººé‚®ç®±:', selectedRecipients.map(r => r.email).join(', '));
}

// åŠ è½½æ”¶ä»¶äººåˆ—è¡¨ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
async function loadRecipientsForSelection() {
  try {
    console.log('ğŸ”„ åŠ è½½æ”¶ä»¶äººåˆ—è¡¨ï¼Œç±»å‹:', currentRecipientType);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('recipientList').innerHTML = `
      <div class="text-center p-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
      </div>
    `;
    
    const token = localStorage.getItem('authToken');
    const endpoint = currentRecipientType === 'contacts' ? '/api/contacts/?pageSize=1000' : '/api/customers?page_size=1000';
    
    const response = await fetch(endpoint, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ æ”¶ä»¶äººæ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    // ç»Ÿä¸€æ•°æ®æ ¼å¼
    allRecipients = currentRecipientType === 'contacts' ? (data.contacts || []) : (data.customers || []);
    filteredRecipients = allRecipients;
    
    renderRecipientList(filteredRecipients);
    
    console.log(`âœ… åŠ è½½äº† ${allRecipients.length} ä¸ª${currentRecipientType === 'contacts' ? 'è”ç³»äºº' : 'å®¢æˆ·'}`);
  } catch (error) {
    console.error('âŒ åŠ è½½å¤±è´¥:', error);
    showError('åŠ è½½å¤±è´¥: ' + error.message);
    document.getElementById('recipientList').innerHTML = `
      <div class="alert alert-danger m-3">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>
    `;
  }
}

// æ¸²æŸ“æ”¶ä»¶äººåˆ—è¡¨
function renderRecipientList(recipients) {
  if (recipients.length === 0) {
    document.getElementById('recipientList').innerHTML = `
      <div class="alert alert-info m-3">æš‚æ— æ•°æ®</div>
    `;
    return;
  }
  
  let html = '';
  recipients.forEach(recipient => {
    // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­ï¼ˆé€šè¿‡é‚®ç®±åŒ¹é…ï¼Œä¸é™ç±»å‹ï¼‰
    const isSelected = tempSelectedRecipients.some(r => r.email === recipient.email);
    html += `
      <div class="recipient-item d-flex align-items-center p-2 border-bottom" style="cursor: pointer;" onclick="toggleRecipientCheckbox(${recipient.id})">
        <input type="checkbox" class="form-check-input me-3 recipient-checkbox" 
               value="${recipient.id}" 
               data-type="${currentRecipientType}"
               data-name="${recipient.name}"
               data-email="${recipient.email}"
               data-company="${recipient.company || ''}"
               ${isSelected ? 'checked' : ''} 
               onclick="event.stopPropagation(); toggleRecipient(${recipient.id}, this.checked)">
        <div class="flex-grow-1">
          <div class="fw-bold">${recipient.name}</div>
          <small class="text-muted">${recipient.email}${recipient.company ? ' â€¢ ' + recipient.company : ''}</small>
        </div>
        <span class="badge ${currentRecipientType === 'contacts' ? 'bg-info' : 'bg-success'}">${currentRecipientType === 'contacts' ? 'è”ç³»äºº' : 'å®¢æˆ·'}</span>
      </div>
    `;
  });
  
  document.getElementById('recipientList').innerHTML = html;
  updateSelectedCount();
}

// åˆ‡æ¢checkboxï¼ˆç‚¹å‡»æ•´è¡Œæ—¶ï¼‰
function toggleRecipientCheckbox(recipientId) {
  const checkbox = document.querySelector(`.recipient-checkbox[value="${recipientId}"]`);
  if (checkbox) {
    checkbox.checked = !checkbox.checked;
    toggleRecipient(recipientId, checkbox.checked);
  }
}

// æœç´¢æ”¶ä»¶äºº
function searchRecipients() {
  const searchTerm = document.getElementById('recipientSearch').value.toLowerCase().trim();
  
  if (!searchTerm) {
    filteredRecipients = allRecipients;
  } else {
    filteredRecipients = allRecipients.filter(recipient => {
      const name = (recipient.name || '').toLowerCase();
      const email = (recipient.email || '').toLowerCase();
      const company = (recipient.company || '').toLowerCase();
      const domain = (recipient.domain || '').toLowerCase();
      
      return name.includes(searchTerm) || 
             email.includes(searchTerm) || 
             company.includes(searchTerm) || 
             domain.includes(searchTerm);
    });
  }
  
  console.log(`ğŸ” æœç´¢ "${searchTerm}"ï¼Œæ‰¾åˆ° ${filteredRecipients.length} ä¸ªç»“æœ`);
  renderRecipientList(filteredRecipients);
}

// åˆ‡æ¢æ”¶ä»¶äººé€‰æ‹©ï¼ˆæŒ‰é‚®ç®±åŒæ­¥ï¼‰
function toggleRecipient(recipientId, isSelected) {
  const recipient = allRecipients.find(r => r.id === recipientId);
  if (!recipient) return;
  
  const recipientEmail = recipient.email;
  console.log('âœ… åˆ‡æ¢æ”¶ä»¶äºº:', recipient.name, recipientEmail, 'é€‰ä¸­:', isSelected);
  
  if (isSelected) {
    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç›¸åŒé‚®ç®±çš„äººè¢«é€‰ä¸­
    const existingSameEmail = tempSelectedRecipients.find(r => r.email === recipientEmail);
    
    if (!existingSameEmail) {
      // å¦‚æœæ²¡æœ‰ç›¸åŒé‚®ç®±ï¼Œæ·»åŠ å½“å‰æ”¶ä»¶äºº
      const recipientWithType = { ...recipient, type: currentRecipientType };
      tempSelectedRecipients.push(recipientWithType);
      console.log('â• æ·»åŠ æ”¶ä»¶äºº:', recipient.name, 'é‚®ç®±:', recipientEmail, 'ç±»å‹:', currentRecipientType);
    } else {
      // å¦‚æœå·²æœ‰ç›¸åŒé‚®ç®±ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç±»å‹
      if (existingSameEmail.type !== currentRecipientType) {
        // ä¸åŒç±»å‹ï¼Œä¹Ÿæ·»åŠ ï¼ˆåŒä¸€é‚®ç®±å¯èƒ½æ—¢æ˜¯è”ç³»äººåˆæ˜¯å®¢æˆ·ï¼‰
        const recipientWithType = { ...recipient, type: currentRecipientType };
        tempSelectedRecipients.push(recipientWithType);
        console.log('â• æ·»åŠ æ”¶ä»¶äººï¼ˆåŒé‚®ç®±ä¸åŒç±»å‹ï¼‰:', recipient.name, 'ç±»å‹:', currentRecipientType);
      } else {
        console.log('âš ï¸ è¯¥æ”¶ä»¶äººå·²åœ¨åˆ—è¡¨ä¸­');
      }
    }
  } else {
    // å–æ¶ˆé€‰ä¸­ï¼šç§»é™¤æ‰€æœ‰ç›¸åŒé‚®ç®±çš„æ”¶ä»¶äººï¼ˆåŒ…æ‹¬è”ç³»äººå’Œå®¢æˆ·ï¼‰
    const beforeLength = tempSelectedRecipients.length;
    tempSelectedRecipients = tempSelectedRecipients.filter(r => r.email !== recipientEmail);
    console.log('â– ç§»é™¤é‚®ç®±ä¸º', recipientEmail, 'çš„æ‰€æœ‰æ”¶ä»¶äººï¼Œæ•°é‡ä»', beforeLength, 'å˜ä¸º', tempSelectedRecipients.length);
    
    // åˆ·æ–°åˆ—è¡¨ä»¥åŒæ­¥å…¶ä»–ç±»å‹çš„checkboxçŠ¶æ€
    renderRecipientList(filteredRecipients);
  }
  
  updateSelectedCount();
}

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
  const count = tempSelectedRecipients.length;
  const countElement = document.getElementById('selectedRecipientsCount');
  if (countElement) {
    countElement.textContent = `å·²é€‰æ‹© ${count} äºº`;
  }
  console.log('ğŸ“Š å½“å‰é€‰ä¸­æ•°é‡:', count);
}

// å…¨é€‰æ”¶ä»¶äºº
function selectAllRecipients() {
  filteredRecipients.forEach(recipient => {
    // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­ï¼ˆé€šè¿‡é‚®ç®±ï¼‰
    if (!tempSelectedRecipients.some(r => r.email === recipient.email)) {
      const recipientWithType = { ...recipient, type: currentRecipientType };
      tempSelectedRecipients.push(recipientWithType);
    }
  });
  
  // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
  renderRecipientList(filteredRecipients);
  updateSelectedCount();
  console.log('âœ… å…¨é€‰å®Œæˆï¼Œå…±é€‰ä¸­:', tempSelectedRecipients.length);
}

// æ¸…ç©ºé€‰æ‹©ï¼ˆæ¸…ç©ºæ‰€æœ‰ï¼Œä¸åˆ†ç±»å‹ï¼‰
function clearSelection() {
  tempSelectedRecipients = [];
  renderRecipientList(filteredRecipients);
  updateSelectedCount();
  console.log('ğŸ—‘ï¸ å·²æ¸…ç©ºä¸´æ—¶é€‰æ‹©');
}

// ç¡®è®¤æ”¶ä»¶äºº
function confirmRecipients() {
  console.log('âœ… ç¡®è®¤æ”¶ä»¶äººï¼Œå…±é€‰æ‹©:', tempSelectedRecipients.length);
  
  // åº”ç”¨ä¸´æ—¶é€‰æ‹©åˆ°æ­£å¼å˜é‡
  selectedRecipients = JSON.parse(JSON.stringify(tempSelectedRecipients));
  updateRecipientDisplay();
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('recipientSelectModal'));
  if (modal) {
    modal.hide();
  }
  
  console.log('ğŸ“‹ é€‰ä¸­çš„æ”¶ä»¶äººåˆ—è¡¨:', selectedRecipients);
}

// å–æ¶ˆé€‰æ‹©ï¼ˆæ¢å¤åŸå§‹çŠ¶æ€ï¼‰
function cancelRecipientSelection() {
  console.log('âŒ å–æ¶ˆé€‰æ‹©ï¼Œæ¢å¤åˆ°æ‰“å¼€å‰çš„çŠ¶æ€');
  // ä¸éœ€è¦åšä»»ä½•æ“ä½œï¼Œå› ä¸ºtempSelectedRecipientsåœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶ä¼šè¢«é‡ç½®
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('recipientSelectModal'));
  if (modal) {
    modal.hide();
  }
}

// æ˜¾ç¤ºå·²é€‰æ‹©çš„æ”¶ä»¶äººåˆ—è¡¨
function showSelectedRecipients() {
  console.log('âœ… æ˜¾ç¤ºå·²é€‰æ‹©çš„æ”¶ä»¶äººåˆ—è¡¨');
  
  if (selectedRecipients.length === 0) {
    showError('å°šæœªé€‰æ‹©ä»»ä½•æ”¶ä»¶äºº\n\nè¯·ç‚¹å‡»"é€‰æ‹©æ”¶ä»¶äºº"æŒ‰é’®æ·»åŠ æ”¶ä»¶äºº');
    return;
  }
  
  // æ›´æ–°å¾½ç« æ•°é‡
  const countBadge = document.getElementById('selectedRecipientsCountBadge');
  if (countBadge) {
    countBadge.textContent = selectedRecipients.length;
  }
  
  // æ¸²æŸ“æ”¶ä»¶äººåˆ—è¡¨
  const listContainer = document.getElementById('selectedRecipientsList');
  if (listContainer) {
    let html = '';
    
    if (selectedRecipients.length === 0) {
      html = '<div class="text-center text-muted p-4">å°šæœªé€‰æ‹©æ”¶ä»¶äºº</div>';
    } else {
      html = '<div class="list-group">';
      selectedRecipients.forEach((recipient, index) => {
        html += `
          <div class="list-group-item d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center">
                <i class="bi bi-person-circle text-primary me-2" style="font-size: 1.5rem;"></i>
                <div>
                  <div class="fw-bold">${recipient.name}</div>
                  <small class="text-muted">
                    <i class="bi bi-envelope"></i> ${recipient.email}
                  </small>
                  ${recipient.company ? `<br><small class="text-muted"><i class="bi bi-building"></i> ${recipient.company}</small>` : ''}
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRecipient(${index})" title="ç§»é™¤">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        `;
      });
      html += '</div>';
    }
    
    listContainer.innerHTML = html;
  }
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  const modal = new bootstrap.Modal(document.getElementById('selectedRecipientsModal'));
  modal.show();
}

// ç§»é™¤æŒ‡å®šçš„æ”¶ä»¶äºº
function removeRecipient(index) {
  if (index >= 0 && index < selectedRecipients.length) {
    const removed = selectedRecipients.splice(index, 1)[0];
    console.log('â– ç§»é™¤æ”¶ä»¶äºº:', removed.name);
    
    // æ›´æ–°æ”¶ä»¶äººè¾“å…¥æ¡†æ˜¾ç¤º
    updateRecipientDisplay();
    
    // å¦‚æœè¿˜æœ‰æ”¶ä»¶äººï¼Œæ›´æ–°åˆ—è¡¨ï¼›å¦åˆ™å…³é—­æ¨¡æ€æ¡†
    if (selectedRecipients.length > 0) {
      // æ›´æ–°å¾½ç« æ•°é‡
      const countBadge = document.getElementById('selectedRecipientsCountBadge');
      if (countBadge) {
        countBadge.textContent = selectedRecipients.length;
      }
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      const listContainer = document.getElementById('selectedRecipientsList');
      if (listContainer) {
        let html = '<div class="list-group">';
        selectedRecipients.forEach((recipient, idx) => {
          html += `
            <div class="list-group-item d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-circle text-primary me-2" style="font-size: 1.5rem;"></i>
                  <div>
                    <div class="fw-bold">${recipient.name}</div>
                    <small class="text-muted">
                      <i class="bi bi-envelope"></i> ${recipient.email}
                    </small>
                    ${recipient.company ? `<br><small class="text-muted"><i class="bi bi-building"></i> ${recipient.company}</small>` : ''}
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRecipient(${idx})" title="ç§»é™¤">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          `;
        });
        html += '</div>';
        listContainer.innerHTML = html;
      }
    } else {
      // æ²¡æœ‰æ”¶ä»¶äººäº†ï¼Œå…³é—­æ¨¡æ€æ¡†
      console.log('ğŸ“­ æ‰€æœ‰æ”¶ä»¶äººå·²ç§»é™¤ï¼Œå…³é—­æ¨¡æ€æ¡†');
      const modal = bootstrap.Modal.getInstance(document.getElementById('selectedRecipientsModal'));
      if (modal) {
        modal.hide();
      }
    }
  }
}

// ç¼–è¾‘æ”¶ä»¶äººï¼ˆå…³é—­å½“å‰æ¨¡æ€æ¡†ï¼Œæ‰“å¼€é€‰æ‹©æ¨¡æ€æ¡†ï¼‰
function editRecipients() {
  // å…³é—­å·²é€‰æ‹©æ”¶ä»¶äººæ¨¡æ€æ¡†
  const currentModal = bootstrap.Modal.getInstance(document.getElementById('selectedRecipientsModal'));
  if (currentModal) {
    currentModal.hide();
  }
  
  // æ‰“å¼€é€‰æ‹©æ”¶ä»¶äººæ¨¡æ€æ¡†
  setTimeout(() => {
    selectRecipients();
  }, 300);
}

// æ’å…¥å˜é‡
function insertVariable(variable) {
  const textarea = document.getElementById('emailContent');
  if (!textarea) return;
  
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const content = textarea.value;
  
  textarea.value = content.substring(0, start) + variable + content.substring(end);
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  textarea.focus();
  
  console.log('âœ… æ’å…¥å˜é‡:', variable);
}

// é¢„è§ˆé‚®ä»¶
async function previewEmail() {
  console.log('âœ… ç‚¹å‡»é¢„è§ˆ');
  
  if (selectedRecipients.length === 0) {
    showError('è¯·å…ˆé€‰æ‹©æ”¶ä»¶äºº');
    return;
  }
  
  const subject = document.getElementById('emailTitle').value;
  const content = document.getElementById('emailContent').value;
  
  if (!subject || !content) {
    showError('è¯·å¡«å†™é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹');
    return;
  }
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ è°ƒç”¨é‚®ä»¶é¢„è§ˆæ¥å£...');
    console.log('é€‰ä¸­çš„æ”¶ä»¶äºº:', selectedRecipients);
    console.log('å½“å‰æ¨¡æ¿ID:', currentTemplate ? currentTemplate.id : null);
    
    const requestBody = {
      contact_ids: selectedRecipients.map(r => r.id),
      template_title: subject,
      template_content: content
    };
    
    if (currentTemplate) {
      requestBody.template_id = currentTemplate.id;
    }
    
    console.log('ğŸ“¤ è¯·æ±‚ä½“:', requestBody);
    
    const response = await fetch('/api/email-templates/batch-preview', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ é¢„è§ˆæ•°æ®:', data);
    
    if (!data.success) {
      showError('é¢„è§ˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    emailPreviews = data.previews || [];
    currentPreviewIndex = 0;
    
    console.log(`âœ… ç”Ÿæˆäº† ${emailPreviews.length} ä¸ªé¢„è§ˆ`);
    
    showPreviewModal();
    
  } catch (error) {
    console.error('âŒ é¢„è§ˆå¤±è´¥:', error);
    showError('é¢„è§ˆå¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
function showPreviewModal() {
  if (emailPreviews.length === 0) {
    showWarning('æ²¡æœ‰å¯é¢„è§ˆçš„å†…å®¹');
    return;
  }
  
  let previewModal = document.getElementById('emailPreviewModal');
  if (!previewModal) {
    const modalHTML = `
      <div class="modal fade" id="emailPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg" style="max-width: 700px;">
          <div class="modal-content" style="position: relative;">
            <div class="modal-header">
              <h5 class="modal-title">é‚®ä»¶é¢„è§ˆ</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="min-height: 500px; max-height: 70vh; overflow-y: auto; padding: 2rem;">
              <div id="previewContent"></div>
            </div>
            
            <button class="btn btn-primary rounded-circle preview-nav-btn" 
                    onclick="previousPreview()" 
                    id="prevBtn" 
                    style="display: none; position: absolute; left: -60px; top: 50%; transform: translateY(-50%); z-index: 1100; width: 45px; height: 45px; opacity: 0.9;">
              <i class="bi bi-chevron-left"></i>
            </button>
            
            <button class="btn btn-primary rounded-circle preview-nav-btn" 
                    onclick="nextPreview()" 
                    id="nextBtn" 
                    style="display: none; position: absolute; right: -60px; top: 50%; transform: translateY(-50%); z-index: 1100; width: 45px; height: 45px; opacity: 0.9;">
              <i class="bi bi-chevron-right"></i>
            </button>
            
            <div class="modal-footer">
              <div class="d-flex justify-content-between align-items-center w-100">
                <span id="previewCounter" class="text-muted">1 / 1</span>
                <div>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                  <button type="button" class="btn btn-primary" onclick="confirmAndSend()">
                    <i class="bi bi-send"></i> ç¡®è®¤å‘é€
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  renderPreview();
  
  const modal = new bootstrap.Modal(document.getElementById('emailPreviewModal'));
  modal.show();
}

// æ¸²æŸ“é¢„è§ˆå†…å®¹
function renderPreview() {
  if (emailPreviews.length === 0) return;
  
  const preview = emailPreviews[currentPreviewIndex];
  const total = emailPreviews.length;
  
  const previewHTML = `
    <div class="email-preview-card">
      <div class="preview-header mb-4 p-3 bg-light rounded">
        <div class="mb-2">
          <strong class="text-primary">æ”¶ä»¶äººï¼š</strong> 
          <span>${preview.recipient_name || 'æœªçŸ¥'}</span>
        </div>
        <div>
          <strong class="text-primary">é‚®ç®±ï¼š</strong> 
          <span>${preview.recipient_email || 'æœªçŸ¥'}</span>
        </div>
      </div>
      
      <div class="preview-body">
        <div class="mb-4">
          <label class="text-muted mb-2"><i class="bi bi-envelope"></i> é‚®ä»¶ä¸»é¢˜</label>
          <div class="p-3 bg-light rounded">
            <strong style="font-size: 1.1rem;">${preview.template_title || '(æ— ä¸»é¢˜)'}</strong>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="text-muted mb-2"><i class="bi bi-file-text"></i> é‚®ä»¶å†…å®¹</label>
          <div class="p-3 bg-white border rounded" style="min-height: 250px; white-space: pre-wrap; line-height: 1.6;">
${preview.rendered_content || '(æ— å†…å®¹)'}
          </div>
        </div>
        
        ${preview.variables_used && preview.variables_used.length > 0 ? `
          <div class="mt-3 p-2 bg-info bg-opacity-10 rounded">
            <small class="text-muted">
              <i class="bi bi-info-circle text-info"></i> ä½¿ç”¨çš„å˜é‡: 
              ${preview.variables_used.map(v => `<code class="bg-white px-2 py-1 rounded">{{${v}}}</code>`).join(' ')}
            </small>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.getElementById('previewContent').innerHTML = previewHTML;
  document.getElementById('previewCounter').textContent = `${currentPreviewIndex + 1} / ${total}`;
  
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (total > 1) {
    if (currentPreviewIndex === 0) {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'block';
    } else if (currentPreviewIndex === total - 1) {
      prevBtn.style.display = 'block';
      nextBtn.style.display = 'none';
    } else {
      prevBtn.style.display = 'block';
      nextBtn.style.display = 'block';
    }
  } else {
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
  }
  
  console.log(`ğŸ“§ æ˜¾ç¤ºé¢„è§ˆ ${currentPreviewIndex + 1}/${total}`);
}

// ä¸Šä¸€ä¸ªé¢„è§ˆ
function previousPreview() {
  if (currentPreviewIndex > 0) {
    currentPreviewIndex--;
    renderPreview();
  }
}

// ä¸‹ä¸€ä¸ªé¢„è§ˆ
function nextPreview() {
  if (currentPreviewIndex < emailPreviews.length - 1) {
    currentPreviewIndex++;
    renderPreview();
  }
}

// ç¡®è®¤å¹¶å‘é€
function confirmAndSend() {
  // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
  const previewModal = bootstrap.Modal.getInstance(document.getElementById('emailPreviewModal'));
  if (previewModal) {
    previewModal.hide();
  }
  
  sendEmail();
}

// å‘é€é‚®ä»¶ï¼ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼‰
async function sendEmail() {
  console.log('âœ… ç‚¹å‡»å‘é€é‚®ä»¶');
  
  if (selectedRecipients.length === 0) {
    showError('è¯·å…ˆé€‰æ‹©æ”¶ä»¶äºº');
    return;
  }
  
  const senderEmailId = document.getElementById('senderEmail').value;
  if (!senderEmailId) {
    showError('è¯·é€‰æ‹©å‘ä»¶é‚®ç®±');
    return;
  }
  
  const subject = document.getElementById('emailTitle').value;
  const content = document.getElementById('emailContent').value;
  
  if (!subject || !content) {
    showError('è¯·å¡«å†™é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹');
    return;
  }
  
  // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
  const uniqueEmails = new Set(selectedRecipients.map(r => r.email));
  document.getElementById('confirmRecipientCount').textContent = `${uniqueEmails.size} ä½æ”¶ä»¶äºº`;
  document.getElementById('confirmEmailSubject').textContent = subject;
  
  // è·å–å‘ä»¶é‚®ç®±æ–‡æœ¬
  const senderSelect = document.getElementById('senderEmail');
  const senderText = senderSelect.options[senderSelect.selectedIndex].text;
  document.getElementById('confirmSenderEmail').textContent = senderText;
  
  const confirmModal = new bootstrap.Modal(document.getElementById('sendConfirmModal'));
  confirmModal.show();
}

// ç¡®è®¤å‘é€é‚®ä»¶ï¼ˆå®é™…å‘é€ï¼‰
async function confirmSendEmail() {
  console.log('âœ… ç¡®è®¤å‘é€é‚®ä»¶');
  
  // å…³é—­ç¡®è®¤æ¨¡æ€æ¡†
  const confirmModal = bootstrap.Modal.getInstance(document.getElementById('sendConfirmModal'));
  if (confirmModal) {
    confirmModal.hide();
  }
  
  const senderEmailId = document.getElementById('senderEmail').value;
  const subject = document.getElementById('emailTitle').value;
  const content = document.getElementById('emailContent').value;
  
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ å‘é€é‚®ä»¶...');
    console.log('æ”¶ä»¶äººæ•°é‡:', selectedRecipients.length);
    console.log('å‘ä»¶é‚®ç®±ID:', senderEmailId);
    console.log('æ˜¯å¦ä½¿ç”¨æ¨¡æ¿:', currentTemplate ? 'æ˜¯' : 'å¦');
    
    // åˆ†ç¦»è”ç³»äººå’Œå®¢æˆ·IDï¼ˆæŒ‰é‚®ç®±å»é‡ï¼‰
    const uniqueEmails = new Set();
    const contactIds = [];
    const customerIds = [];
    
    selectedRecipients.forEach(r => {
      if (!uniqueEmails.has(r.email)) {
        uniqueEmails.add(r.email);
        if (r.type === 'contacts') {
          contactIds.push(r.id);
        } else if (r.type === 'customers') {
          customerIds.push(r.id);
        }
      }
    });
    
    console.log('ğŸ“‹ è”ç³»äººID:', contactIds);
    console.log('ğŸ“‹ å®¢æˆ·ID:', customerIds);
    console.log('ğŸ“§ å”¯ä¸€é‚®ç®±æ•°:', uniqueEmails.size);
    
    // æ„å»ºè¯·æ±‚ä½“
    const requestBody = {
      sender_email_binding_id: parseInt(senderEmailId),
      contact_ids: contactIds,
      customer_ids: customerIds
    };
    
    // å¦‚æœä½¿ç”¨äº†æ¨¡æ¿
    if (currentTemplate) {
      requestBody.template_id = currentTemplate.id;
      console.log('ä½¿ç”¨æ¨¡æ¿ID:', currentTemplate.id);
    } else {
      // æ²¡æœ‰ä½¿ç”¨æ¨¡æ¿ï¼Œç›´æ¥å‘é€å†…å®¹
      requestBody.template_title = subject;
      requestBody.template_content = content;
      console.log('ç›´æ¥å‘é€å†…å®¹ï¼ˆæ— æ¨¡æ¿ï¼‰');
    }
    
    console.log('ğŸ“¤ è¯·æ±‚ä½“:', requestBody);
    
    const response = await fetch('/api/emails/send-batch', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ å‘é€ç»“æœ:', data);
    
    if (!data.success) {
      showError('å‘é€å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      hideLoading();
      return;
    }
    
    showSuccess(`é‚®ä»¶å‘é€æˆåŠŸï¼å·²å‘é€ ${data.total_sent} å°é‚®ä»¶`);

    // å‘é€å·²å®Œæˆï¼Œå…ˆå…³é—­å…¨å±€åŠ è½½é®ç½©ï¼Œé¿å…ä¸€ç›´è½¬åœˆ
    hideLoading();
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦æç¤ºä¿å­˜ä¸ºæ¨¡æ¿
    const shouldPrompt = shouldPromptSaveAsTemplate();
    
    console.log('ğŸ“‹ æ˜¯å¦æç¤ºä¿å­˜ä¸ºæ¨¡æ¿:', shouldPrompt, 'æ¥æº:', emailSource);
    
    // å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œè¯¢é—®æ˜¯å¦ä¿å­˜ä¸ºæ¨¡æ¿
    if (shouldPrompt) {
      await new Promise((resolve) => {
        const modalEl = document.getElementById('saveAsTemplateModal');
        const modal = new bootstrap.Modal(modalEl);
        const confirmBtn = document.getElementById('confirmSaveTemplateBtn');

        const cleanup = () => {
          confirmBtn.removeEventListener('click', onConfirm);
          modalEl.removeEventListener('hidden.bs.modal', onHidden);
        };

        const onConfirm = async () => {
          cleanup();
          modal.hide();
          // å•ç‹¬ä¸º"ä¿å­˜ä¸ºæ¨¡æ¿"è¿‡ç¨‹æ˜¾ç¤ºåŠ è½½
          showLoading();
          await saveAsNewTemplate(subject, content);
          hideLoading();
          showSuccess('å·²ä¿å­˜ä¸ºæ¨¡æ¿');
          resolve();
        };

        const onHidden = () => {
          cleanup();
          resolve();
        };

        confirmBtn.addEventListener('click', onConfirm);
        modalEl.addEventListener('hidden.bs.modal', onHidden);
        modal.show();
      });
    }
    
    // æ¸…ç©ºè¡¨å•
    clearForm();
    
  } catch (error) {
    console.error('âŒ å‘é€é‚®ä»¶å¤±è´¥:', error);
    showError('å‘é€é‚®ä»¶å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ä¿å­˜ä¸ºæ–°æ¨¡æ¿
async function saveAsNewTemplate(title, content) {
  try {
    showLoading();
    
    const token = localStorage.getItem('authToken');
    
    console.log('ğŸ”„ ä¿å­˜ä¸ºæ¨¡æ¿...');
    
    const response = await fetch('/api/email-templates/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: title,
        content: content
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess('å·²ä¿å­˜ä¸ºæ¨¡æ¿ï¼');
      // é‡æ–°åŠ è½½æ¨¡æ¿åˆ—è¡¨
      await loadTemplateList();
    } else {
      showError('ä¿å­˜æ¨¡æ¿å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
    
  } catch (error) {
    console.error('âŒ ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
    showError('ä¿å­˜æ¨¡æ¿å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// åˆ¤æ–­æ˜¯å¦åº”è¯¥æç¤ºä¿å­˜ä¸ºæ¨¡æ¿
function shouldPromptSaveAsTemplate() {
  // 1. å¦‚æœæ˜¯å›å¤é‚®ä»¶ï¼Œä¸æç¤º
  if (emailSource.isReply || emailSource.type === 'reply') {
    console.log('  â†’ å›å¤é‚®ä»¶ï¼Œä¸æç¤º');
    return false;
  }
  
  // 2. å¦‚æœä½¿ç”¨äº†æ¨¡æ¿ä¸”æœªç¼–è¾‘ï¼Œä¸æç¤º
  if (emailSource.loadedFromTemplate && !emailSource.wasEdited) {
    console.log('  â†’ ä½¿ç”¨æ¨¡æ¿æœªç¼–è¾‘ï¼Œä¸æç¤º');
    return false;
  }
  
  // 3. å¦‚æœä»è‰ç¨¿åŠ è½½ä¸”æœªç¼–è¾‘ï¼Œä¸æç¤º
  if (emailSource.loadedFromDraft && !emailSource.wasEdited) {
    console.log('  â†’ ä»è‰ç¨¿åŠ è½½æœªç¼–è¾‘ï¼Œä¸æç¤º');
    return false;
  }
  
  // 4. å…¶ä»–æƒ…å†µï¼ˆæ‰‹åŠ¨ç¼–è¾‘ã€æˆ–ä»æ¨¡æ¿/è‰ç¨¿ç¼–è¾‘è¿‡ï¼‰éƒ½æç¤º
  console.log('  â†’ æ»¡è¶³ä¿å­˜æ¡ä»¶ï¼Œæç¤ºä¿å­˜');
  return true;
}

// æ¸…ç©ºè¡¨å•
function clearForm() {
  document.getElementById('emailTitle').value = '';
  document.getElementById('emailContent').value = '';
  document.getElementById('templateSelect').value = '';
  selectedRecipients = [];
  currentTemplate = null;
  updateRecipientDisplay();
  
  // é‡ç½®é‚®ä»¶æ¥æºçŠ¶æ€
  emailSource = {
    type: 'manual',
    wasEdited: false,
    loadedFromTemplate: false,
    loadedFromDraft: false,
    isReply: false
  };
  
  console.log('âœ… è¡¨å•å·²æ¸…ç©º');
}

// æ˜¾ç¤ºåŠ è½½
function showLoading() {
  // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§é®ç½©
  hideLoading();
  
  console.log('ğŸ”„ æ˜¾ç¤ºåŠ è½½ä¸­...');
  const loadingHTML = `
    <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">åŠ è½½ä¸­...</span>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
  console.log('âœ… éšè—åŠ è½½ä¸­');
  const loading = document.getElementById('loadingOverlay');
  if (loading) {
    loading.remove();
  }
}

// ==================== AIè¾…åŠ©åŠŸèƒ½ ====================

let loadingDotsInterval = null;

// å¯åŠ¨åŠ¨æ€çœç•¥å·åŠ¨ç”»
function startLoadingDots() {
  let dotCount = 1;
  loadingDotsInterval = setInterval(() => {
    const dotsElements = document.querySelectorAll('.loading-dots-title, .loading-dots-content');
    dotsElements.forEach(el => {
      if (el) {
        dotCount = (dotCount % 3) + 1;
        el.textContent = '.'.repeat(dotCount);
      }
    });
  }, 500);
}

// åœæ­¢åŠ¨æ€çœç•¥å·åŠ¨ç”»
function stopLoadingDots() {
  if (loadingDotsInterval) {
    clearInterval(loadingDotsInterval);
    loadingDotsInterval = null;
  }
}

// AIç”Ÿæˆé‚®ä»¶
async function aiEnrichEmail() {
  const title = document.getElementById('emailTitle').value.trim();
  const content = document.getElementById('emailContent').value.trim();
  
  if (!title && !content) {
    showWarning('è¯·å…ˆè¾“å…¥é‚®ä»¶æ ‡é¢˜æˆ–å†…å®¹');
    return;
  }
  
  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const titlePreview = document.getElementById('aiTitlePreview');
    const contentPreview = document.getElementById('aiContentPreview');
    
    titlePreview.style.display = '';
    titlePreview.innerHTML = `
      <div class="ai-loading">
        <div class="spinner-border spinner-border-sm text-primary"></div>
        <span>AIç”Ÿæˆä¸­<span class="loading-dots-title">.</span></span>
      </div>
    `;
    
    contentPreview.style.display = '';
    contentPreview.innerHTML = `
      <div class="ai-loading">
        <div class="spinner-border spinner-border-sm text-primary"></div>
        <span>AIç”Ÿæˆä¸­<span class="loading-dots-content">.</span></span>
      </div>
    `;
    
    // å¯åŠ¨çœç•¥å·åŠ¨ç”»
    startLoadingDots();
    
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/emails/ai-assist', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title,
        content,
        type: 'enrich'
      })
    });
    
    const data = await response.json();
    
    // åœæ­¢çœç•¥å·åŠ¨ç”»
    stopLoadingDots();
    
    if (!data.success) {
      showError('AIç”Ÿæˆå¤±è´¥: ' + data.message);
      titlePreview.style.display = 'none';
      contentPreview.style.display = 'none';
      return;
    }
    
    // ä¿å­˜AIç”Ÿæˆçš„ç»“æœ
    aiGeneratedTitle = data.result.title;
    aiGeneratedContent = data.result.content;
    
    // æ˜¾ç¤ºæ ‡é¢˜ç»“æœ
    if (aiGeneratedTitle) {
      titlePreview.innerHTML = `
        <div class="ai-result-preview mt-2">
          <div class="ai-result-header">
            <span class="ai-result-label">
              <i class="bi bi-stars"></i> AIä¼˜åŒ–åçš„æ ‡é¢˜
            </span>
            <div class="ai-result-actions">
              <button type="button" class="btn btn-sm btn-success" onclick="applyAITitle()">
                <i class="bi bi-check-lg"></i> æ›¿æ¢
              </button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAITitle()">
                <i class="bi bi-x-lg"></i> å–æ¶ˆ
              </button>
            </div>
          </div>
          <div class="ai-result-content">${aiGeneratedTitle}</div>
        </div>
      `;
    } else {
      titlePreview.style.display = 'none';
    }
    
    // æ˜¾ç¤ºå†…å®¹ç»“æœ
    if (aiGeneratedContent) {
      contentPreview.innerHTML = `
        <div class="ai-result-preview mt-2">
          <div class="ai-result-header">
            <span class="ai-result-label">
              <i class="bi bi-stars"></i> AIä¼˜åŒ–åçš„å†…å®¹
            </span>
            <div class="ai-result-actions">
              <button type="button" class="btn btn-sm btn-success" onclick="applyAIContent()">
                <i class="bi bi-check-lg"></i> æ›¿æ¢
              </button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAIContent()">
                <i class="bi bi-x-lg"></i> å–æ¶ˆ
              </button>
            </div>
          </div>
          <textarea class="ai-preview-textarea" readonly style="width: 100% !important; height: 200px !important; background-color: #f8f9fa !important; border: 1px solid #ced4da !important; border-radius: 0.375rem !important; padding: 0.375rem 0.75rem !important; font-size: 1rem !important; line-height: 1.5 !important; resize: vertical !important; cursor: not-allowed !important; color: #212529 !important; opacity: 0.8 !important;">${aiGeneratedContent}</textarea>
        </div>
      `;
    } else {
      contentPreview.style.display = 'none';
    }
    
  } catch (error) {
    console.error('AIç”Ÿæˆå¤±è´¥:', error);
    stopLoadingDots();
    showError('AIç”Ÿæˆå¤±è´¥: ' + error.message);
    document.getElementById('aiTitlePreview').style.display = 'none';
    document.getElementById('aiContentPreview').style.display = 'none';
  }
}

// ç¿»è¯‘é‚®ä»¶
async function translateEmail(targetLanguage = null) {
  const title = document.getElementById('emailTitle').value.trim();
  const content = document.getElementById('emailContent').value.trim();
  
  if (!title && !content) {
    showWarning('è¯·å…ˆè¾“å…¥é‚®ä»¶æ ‡é¢˜æˆ–å†…å®¹');
    return;
  }
  
  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const titlePreview = document.getElementById('aiTitlePreview');
    const contentPreview = document.getElementById('aiContentPreview');
    
    titlePreview.style.display = '';
    titlePreview.innerHTML = `
      <div class="ai-loading">
        <div class="spinner-border spinner-border-sm text-info"></div>
        <span>ç¿»è¯‘ä¸­<span class="loading-dots-title">.</span></span>
      </div>
    `;
    
    contentPreview.style.display = '';
    contentPreview.innerHTML = `
      <div class="ai-loading">
        <div class="spinner-border spinner-border-sm text-info"></div>
        <span>ç¿»è¯‘ä¸­<span class="loading-dots-content">.</span></span>
      </div>
    `;
    
    // å¯åŠ¨çœç•¥å·åŠ¨ç”»
    startLoadingDots();
    
    const token = localStorage.getItem('authToken');
    const response = await fetch('/api/emails/ai-assist', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title,
        content,
        type: 'translate',
        target_language: targetLanguage
      })
    });
    
    const data = await response.json();
    
    // åœæ­¢çœç•¥å·åŠ¨ç”»
    stopLoadingDots();
    
    if (!data.success) {
      showError('ç¿»è¯‘å¤±è´¥: ' + data.message);
      titlePreview.style.display = 'none';
      contentPreview.style.display = 'none';
      return;
    }
    
    // ä¿å­˜ç¿»è¯‘ç»“æœ
    aiGeneratedTitle = data.result.title;
    aiGeneratedContent = data.result.content;
    
    const langInfo = data.result.detected_language && data.result.target_language 
      ? ` (${data.result.detected_language} â†’ ${data.result.target_language})`
      : '';
    
    // æ˜¾ç¤ºæ ‡é¢˜ç»“æœ
    if (aiGeneratedTitle) {
      titlePreview.innerHTML = `
        <div class="ai-result-preview mt-2">
          <div class="ai-result-header">
            <span class="ai-result-label">
              <i class="bi bi-translate"></i> ç¿»è¯‘åçš„æ ‡é¢˜${langInfo}
            </span>
            <div class="ai-result-actions">
              <button type="button" class="btn btn-sm btn-success" onclick="applyAITitle()">
                <i class="bi bi-check-lg"></i> æ›¿æ¢
              </button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAITitle()">
                <i class="bi bi-x-lg"></i> å–æ¶ˆ
              </button>
            </div>
          </div>
          <div class="ai-result-content">${aiGeneratedTitle}</div>
        </div>
      `;
    } else {
      titlePreview.style.display = 'none';
    }
    
    // æ˜¾ç¤ºå†…å®¹ç»“æœ
    if (aiGeneratedContent) {
      contentPreview.innerHTML = `
        <div class="ai-result-preview mt-2">
          <div class="ai-result-header">
            <span class="ai-result-label">
              <i class="bi bi-translate"></i> ç¿»è¯‘åçš„å†…å®¹${langInfo}
            </span>
            <div class="ai-result-actions">
              <button type="button" class="btn btn-sm btn-success" onclick="applyAIContent()">
                <i class="bi bi-check-lg"></i> æ›¿æ¢
              </button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="cancelAIContent()">
                <i class="bi bi-x-lg"></i> å–æ¶ˆ
              </button>
            </div>
          </div>
          <textarea class="ai-preview-textarea" readonly style="width: 100% !important; height: 200px !important; background-color: #f8f9fa !important; border: 1px solid #ced4da !important; border-radius: 0.375rem !important; padding: 0.375rem 0.75rem !important; font-size: 1rem !important; line-height: 1.5 !important; resize: vertical !important; cursor: not-allowed !important; color: #212529 !important; opacity: 0.8 !important;">${aiGeneratedContent}</textarea>
        </div>
      `;
    } else {
      contentPreview.style.display = 'none';
    }
    
  } catch (error) {
    console.error('ç¿»è¯‘å¤±è´¥:', error);
    stopLoadingDots();
    showError('ç¿»è¯‘å¤±è´¥: ' + error.message);
    document.getElementById('aiTitlePreview').style.display = 'none';
    document.getElementById('aiContentPreview').style.display = 'none';
  }
}

// åº”ç”¨AIæ ‡é¢˜
function applyAITitle() {
  document.getElementById('emailTitle').value = aiGeneratedTitle;
  document.getElementById('aiTitlePreview').style.display = 'none';
  showSuccess('æ ‡é¢˜å·²æ›¿æ¢');
}

// å–æ¶ˆAIæ ‡é¢˜
function cancelAITitle() {
  document.getElementById('aiTitlePreview').style.display = 'none';
  aiGeneratedTitle = '';
}

// åº”ç”¨AIå†…å®¹
function applyAIContent() {
  document.getElementById('emailContent').value = aiGeneratedContent;
  document.getElementById('aiContentPreview').style.display = 'none';
  showSuccess('å†…å®¹å·²æ›¿æ¢');
}

// å–æ¶ˆAIå†…å®¹
function cancelAIContent() {
  document.getElementById('aiContentPreview').style.display = 'none';
  aiGeneratedContent = '';
}

// ==================== Toastæç¤ºå‡½æ•° ====================

function showSuccess(message) {
  showToast(message, 'success');
}

function showError(message) {
  showToast(message, 'error');
}

function showWarning(message) {
  showToast(message, 'warning');
}

function showInfo(message) {
  showToast(message, 'info');
}

function showToast(message, type = 'info') {
  // åˆ›å»ºtoastå…ƒç´ 
  const toastContainer = document.getElementById('toastContainer') || document.body;
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

// ==================== è‰ç¨¿ç®±åŠŸèƒ½ ====================

// ä¿å­˜è‰ç¨¿ - æ˜¾ç¤ºæ¨¡æ€æ¡†
function saveDraft() {
  // æ¸…ç©ºè¾“å…¥æ¡†
  document.getElementById('draftNameInput').value = '';
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  const modal = new bootstrap.Modal(document.getElementById('saveDraftModal'));
  modal.show();
}

// ç¡®è®¤ä¿å­˜è‰ç¨¿
async function confirmSaveDraft() {
  const draftName = document.getElementById('draftNameInput').value.trim();
  
  // å…³é—­æ¨¡æ€æ¡†
  const modal = bootstrap.Modal.getInstance(document.getElementById('saveDraftModal'));
  if (modal) modal.hide();
  
  showLoading();
  const result = await EmailDraftManager.saveToDrafts(draftName || null, false);
  hideLoading();
  
  if (result) {
    // ä¿å­˜æˆåŠŸåæ¸…é™¤localStorageç¼“å­˜
    EmailDraftManager.clearCache();
  }
}

// æ˜¾ç¤ºè‰ç¨¿ç®±æ¨¡æ€æ¡†
async function showDraftsModal() {
  const modal = new bootstrap.Modal(document.getElementById('draftsModal'));
  modal.show();
  await loadDrafts();
}

// åŠ è½½è‰ç¨¿åˆ—è¡¨
async function loadDrafts(page = 1) {
  try {
    const token = localStorage.getItem('authToken');
    
    showLoading();
    const response = await fetch(`/api/email-drafts?page=${page}&pageSize=20&is_auto_save=false`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    hideLoading();
    
    const data = await response.json();
    
    if (data.success) {
      renderDraftsList(data.drafts);
      renderDraftsPagination(data.pagination);
    } else {
      showError('åŠ è½½è‰ç¨¿å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    hideLoading();
    console.error('åŠ è½½è‰ç¨¿å¤±è´¥:', error);
    showError('åŠ è½½è‰ç¨¿å¤±è´¥');
  }
}

// æ¸²æŸ“è‰ç¨¿åˆ—è¡¨
function renderDraftsList(drafts) {
  const listContainer = document.getElementById('draftsList');
  
  if (!drafts || drafts.length === 0) {
    listContainer.innerHTML = `
      <div class="text-center py-5 text-muted">
        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
        <p class="mt-3">æš‚æ— è‰ç¨¿</p>
      </div>
    `;
    return;
  }
  
  listContainer.innerHTML = drafts.map(draft => `
    <div class="list-group-item list-group-item-action">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1" style="cursor: pointer;" onclick="useDraft(${draft.id})">
          <h6 class="mb-1">${draft.draft_name || draft.title || '(æ— æ ‡é¢˜)'}</h6>
          <p class="mb-1 text-muted small">${(draft.content || '').substring(0, 100)}${draft.content && draft.content.length > 100 ? '...' : ''}</p>
          <small class="text-muted">
            <i class="bi bi-clock"></i> ${new Date(draft.updated_at).toLocaleString()}
            ${draft.recipients && draft.recipients.length > 0 ? ` | <i class="bi bi-people"></i> ${draft.recipients.length}ä½æ”¶ä»¶äºº` : ''}
          </small>
        </div>
        <div class="btn-group-vertical btn-group-sm ms-2">
          <button class="btn btn-outline-primary" onclick="event.stopPropagation(); useDraft(${draft.id})" title="ä½¿ç”¨æ­¤è‰ç¨¿">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteDraftConfirm(${draft.id})" title="åˆ é™¤">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

// æ¸²æŸ“åˆ†é¡µ
function renderDraftsPagination(pagination) {
  const container = document.getElementById('draftsPagination');
  
  if (!pagination || pagination.totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let html = '<nav><ul class="pagination pagination-sm justify-content-center mb-0">';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="event.preventDefault(); loadDrafts(${pagination.page - 1})">ä¸Šä¸€é¡µ</a>
    </li>
  `;
  
  // é¡µç 
  for (let i = 1; i <= pagination.totalPages; i++) {
    if (i === 1 || i === pagination.totalPages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
      html += `
        <li class="page-item ${i === pagination.page ? 'active' : ''}">
          <a class="page-link" href="#" onclick="event.preventDefault(); loadDrafts(${i})">${i}</a>
        </li>
      `;
    } else if (i === pagination.page - 3 || i === pagination.page + 3) {
      html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
    }
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${pagination.page === pagination.totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="event.preventDefault(); loadDrafts(${pagination.page + 1})">ä¸‹ä¸€é¡µ</a>
    </li>
  `;
  
  html += '</ul></nav>';
  container.innerHTML = html;
}

// ä½¿ç”¨è‰ç¨¿ - æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
function useDraft(draftId) {
  const modal = new bootstrap.Modal(document.getElementById('useDraftConfirmModal'));
  modal.show();
  
  // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
  document.getElementById('confirmUseDraftBtn').onclick = async function() {
    modal.hide();
    await performUseDraft(draftId);
  };
}

// æ‰§è¡Œä½¿ç”¨è‰ç¨¿
async function performUseDraft(draftId) {
  showLoading();
  const draft = await EmailDraftManager.loadDraft(draftId);
  hideLoading();
  
  if (draft) {
    // æ ‡è®°ä¸ºä»è‰ç¨¿åŠ è½½
    emailSource.type = 'draft';
    emailSource.loadedFromDraft = true;
    emailSource.wasEdited = false; // åˆšåŠ è½½æ—¶æœªç¼–è¾‘
    
    // å…³é—­è‰ç¨¿ç®±æ¨¡æ€æ¡†
    const modal = bootstrap.Modal.getInstance(document.getElementById('draftsModal'));
    if (modal) modal.hide();
  }
}

// åˆ é™¤è‰ç¨¿ - æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
function deleteDraftConfirm(draftId) {
  const modal = new bootstrap.Modal(document.getElementById('deleteDraftConfirmModal'));
  modal.show();
  
  // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
  document.getElementById('confirmDeleteDraftBtn').onclick = async function() {
    modal.hide();
    await performDeleteDraft(draftId);
  };
}

// æ‰§è¡Œåˆ é™¤è‰ç¨¿
async function performDeleteDraft(draftId) {
  showLoading();
  const success = await EmailDraftManager.deleteDraft(draftId);
  hideLoading();
  
  if (success) {
    // é‡æ–°åŠ è½½è‰ç¨¿åˆ—è¡¨
    await loadDrafts();
  }
}

// å‘é€é‚®ä»¶æˆåŠŸåæ¸…é™¤ç¼“å­˜
const originalSendEmail = sendEmail;
sendEmail = function() {
  originalSendEmail().then(success => {
    if (success) {
      // æ¸…é™¤localStorageç¼“å­˜
      EmailDraftManager.clearCache();
    }
  });
};
</script>

<!-- å¼•å…¥è‰ç¨¿ç®¡ç†JS -->
<script src="/js/email-draft.js"></script>

