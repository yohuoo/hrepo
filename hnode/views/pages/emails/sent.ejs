<!-- é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">æ§åˆ¶å°</a></li>
        <li class="breadcrumb-item"><a href="/emails">é‚®ä»¶</a></li>
        <li class="breadcrumb-item active">å‘ä»¶ç®±</li>
      </ol>
    </nav>
    <h1 class="page-title">é‚®ç®±å‘é€åˆ—è¡¨</h1>
  </div>
</div>

<!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢é‚®ä»¶ä¸»é¢˜ã€æ”¶ä»¶äºº...">
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="showFilterModal()">
            <i class="bi bi-funnel"></i> ç­›é€‰
          </button>
          <button class="btn btn-primary" onclick="composeNewEmail()">
            <i class="bi bi-plus-lg"></i> æ–°å»ºé‚®ä»¶
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- é‚®ä»¶åˆ—è¡¨ -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th width="50">åºå·</th>
            <th>é‚®ä»¶ä¸»é¢˜</th>
            <th>æ”¶ä»¶äºº</th>
            <th>å‘ä»¶äºº</th>
            <th>å‘é€æ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th width="100">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="emailTableBody">
          <tr>
            <td colspan="7" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="d-flex align-items-center gap-2">
          <span>æ¯é¡µæ˜¾ç¤º</span>
          <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelect" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <span>æ¡</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span id="emailCount">æ˜¾ç¤º1-4æ¡,å…±4æ¡</span>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">é‚®ä»¶è¯¦æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="emailDetailBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let currentEmailId = null;
let pageSize = 20;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… å‘ä»¶ç®±é¡µé¢å·²åŠ è½½');
  await loadEmails();
  
  const searchInput = document.getElementById('searchKeyword');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchEmails, 500));
  }
  
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  if (pageSizeSelect) {
    pageSizeSelect.addEventListener('change', changePageSize);
  }
});

async function loadEmails(page = 1) {
  try {
    console.log('ğŸ”„ åŠ è½½å‘ä»¶ç®±é‚®ä»¶ï¼Œç¬¬', page, 'é¡µ');
    
    const token = localStorage.getItem('authToken');
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const params = new URLSearchParams({
      email_type: 'sent',
      page: page,
      pageSize: pageSize,
      ...currentFilters
    });
    
    const response = await fetch(`/api/email-history/?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ å‘ä»¶ç®±æ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½é‚®ä»¶å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    currentPage = page;
    renderEmailTable(data.email_history || [], page);
    renderPagination(data.page, data.total_pages);
    updateEmailCount(data.total, (data.email_history || []).length, page);
    
  } catch (error) {
    console.error('âŒ åŠ è½½é‚®ä»¶å¤±è´¥:', error);
    showError('åŠ è½½é‚®ä»¶å¤±è´¥: ' + error.message);
  }
}

function renderEmailTable(emails, page) {
  const tableBody = document.getElementById('emailTableBody');
  if (!tableBody) {
    console.error('âŒ æ‰¾ä¸åˆ° emailTableBody å…ƒç´ ');
    return;
  }
  
  if (emails.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center p-5">
          <div class="empty-state">
            <i class="bi bi-send"></i>
            <h5>å‘ä»¶ç®±ä¸ºç©º</h5>
            <p class="text-muted">æ‚¨è¿˜æ²¡æœ‰å‘é€è¿‡é‚®ä»¶</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  emails.forEach((email, index) => {
    const statusBadge = getStatusBadge(email.status);
    const customerInfo = email.customer ? `${email.customer.name} (${email.customer.company})` : '';
    
    html += `
      <tr class="email-row clickable-row" data-email-id="${email.id}" onclick="showEmailDetail(${email.id})" style="cursor: pointer;">
        <td>${(page - 1) * pageSize + index + 1}</td>
        <td>
          <div class="fw-bold">${email.title || '(æ— ä¸»é¢˜)'}</div>
          ${customerInfo ? `<small class="text-muted">å®¢æˆ·: ${customerInfo}</small>` : ''}
        </td>
        <td>
          <div class="d-flex align-items-center">
            <span class="badge bg-primary me-2">æ”¶ä»¶äºº</span>
            <span>${email.receive_address}</span>
          </div>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <span class="badge bg-secondary me-2">å‘ä»¶äºº</span>
            <span>${email.send_address}</span>
          </div>
        </td>
        <td>${formatDate(email.send_time)}</td>
        <td>${statusBadge}</td>
        <td onclick="event.stopPropagation();">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="showEmailDetail(${email.id})">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteEmail(${email.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </a></li>
            </ul>
          </div>
        </td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = html;
  console.log(`âœ… æ¸²æŸ“äº† ${emails.length} å°é‚®ä»¶`);
}

function renderPagination(current, total) {
  if (total <= 1) {
    $('#pagination').html('');
    return;
  }
  
  let html = '';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadEmails(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;
  
  // é¡µç 
  const startPage = Math.max(1, current - 2);
  const endPage = Math.min(total, current + 2);
  
  if (startPage > 1) {
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmails(1); return false;">1</a></li>`;
    if (startPage > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadEmails(${i}); return false;">${i}</a>
      </li>
    `;
  }
  
  if (endPage < total) {
    if (endPage < total - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmails(${total}); return false;">${total}</a></li>`;
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadEmails(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;
  
  $('#pagination').html(html);
}

function updateEmailCount(total, current, page) {
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, total);
  $('#emailCount').text(`æ˜¾ç¤º${start}-${end}æ¡,å…±${total}æ¡`);
}

function searchEmails() {
  currentFilters = {};
  
  const keyword = $('#searchKeyword').val();
  if (keyword) currentFilters.query = keyword;
  
  loadEmails(1);
}

function changePageSize() {
  pageSize = parseInt($('#pageSizeSelect').val());
  loadEmails(1);
}

// ç­›é€‰åŠŸèƒ½
function showFilterModal() {
  // å®ç°ç­›é€‰æ¨¡æ€æ¡†
  showToast('ç­›é€‰åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// æ–°å»ºé‚®ä»¶
function composeNewEmail() {
  window.location.href = '/emails/compose';
}

// é‚®ä»¶è¯¦æƒ…
async function showEmailDetail(emailId) {
  try {
    currentEmailId = emailId;
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/email-history/${emailId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ é‚®ä»¶è¯¦æƒ…:', data);
    
    if (!data.success) {
      showError('åŠ è½½é‚®ä»¶è¯¦æƒ…å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    const email = data.email_history;
    
    const html = `
      <div class="mb-3">
        <strong>å‘ä»¶äºº:</strong> ${email.send_address || 'æœªçŸ¥'}
        ${email.sender_email_binding ? `<br><small class="text-muted">é‚®ç®±: ${email.sender_email_binding.email_address}</small>` : ''}
      </div>
      <div class="mb-3">
        <strong>æ”¶ä»¶äºº:</strong> ${email.receive_address || 'æœªçŸ¥'}
      </div>
      <div class="mb-3">
        <strong>ä¸»é¢˜:</strong> ${email.title || '(æ— ä¸»é¢˜)'}
      </div>
      <div class="mb-3">
        <strong>æ—¶é—´:</strong> ${new Date(email.send_time).toLocaleString('zh-CN')}
      </div>
      <div class="mb-3">
        <strong>çŠ¶æ€:</strong> ${getStatusBadge(email.status || 'sent')}
      </div>
      ${email.customer ? `
        <div class="mb-3">
          <strong>å…³è”å®¢æˆ·:</strong> 
          <span class="text-dark">${email.customer.name} (${email.customer.company})</span>
        </div>
      ` : ''}
      <hr>
      <div class="mb-3">
        <strong>å†…å®¹:</strong>
        <div class="mt-2 p-3 bg-light rounded" style="white-space: pre-line;">${email.content ? email.content.trim() : '(æ— å†…å®¹)'}</div>
      </div>
    `;
    
    const emailDetailBody = document.getElementById('emailDetailBody');
    if (emailDetailBody) {
      emailDetailBody.innerHTML = html;
    }
    
    new bootstrap.Modal(document.getElementById('emailDetailModal')).show();
  } catch (error) {
    console.error('âŒ åŠ è½½é‚®ä»¶è¯¦æƒ…å¤±è´¥:', error);
    showError('åŠ è½½é‚®ä»¶è¯¦æƒ…å¤±è´¥: ' + error.message);
  }
}

// åˆ é™¤é‚®ä»¶
async function deleteEmail(emailId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å°é‚®ä»¶å—ï¼Ÿ')) return;
  
  try {
    await axios.delete(`/api/email-history/${emailId}`);
    showToast('é‚®ä»¶å·²åˆ é™¤', 'success');
    await loadEmails(currentPage);
  } catch (error) {
    showToast('åˆ é™¤å¤±è´¥', 'danger');
  }
}

// å·¥å…·å‡½æ•°
function getStatusBadge(status) {
  const badges = {
    'sent': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å·²å‘é€</span>',
    'failed': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±è´¥</span>',
    'pending': '<span class="badge bg-warning"><i class="bi bi-clock"></i> å¾…å‘é€</span>',
    'draft': '<span class="badge bg-secondary"><i class="bi bi-file-text"></i> è‰ç¨¿</span>'
  };
  return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN');
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showToast(message, type) {
  // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
  console.log(`${type}: ${message}`);
}
</script>
