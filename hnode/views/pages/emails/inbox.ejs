<div class="row">
  <div class="col-12 mb-3">
    <h2><i class="bi bi-inbox"></i> æ”¶ä»¶ç®±</h2>
  </div>
</div>

<!-- ç­›é€‰å·¥å…·æ  -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢æ ‡é¢˜ã€å†…å®¹...">
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" id="filterSendAddress" placeholder="å‘ä»¶äººé‚®ç®±...">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="filterCustomer">
          <option value="">æ‰€æœ‰å®¢æˆ·</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" onclick="searchEmails()">
          <i class="bi bi-search"></i> æœç´¢
        </button>
      </div>
    </div>
  </div>
</div>

<!-- é‚®ä»¶åˆ—è¡¨ -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>å…± <span id="totalCount">0</span> å°é‚®ä»¶</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="refreshEmails()">
      <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
    </button>
  </div>
  <div class="card-body p-0">
    <div id="emailList">
      <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åˆ†é¡µ -->
  <div class="card-footer">
    <nav>
      <ul class="pagination pagination-sm mb-0 justify-content-center" id="pagination">
      </ul>
    </nav>
  </div>
</div>

<!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailDetailTitle">é‚®ä»¶è¯¦æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="emailDetailBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-primary" onclick="replyEmail()">
          <i class="bi bi-reply"></i> å›å¤
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let currentEmailId = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('âœ… æ”¶ä»¶ç®±é¡µé¢å·²åŠ è½½');
  await loadCustomerOptions();
  await loadEmails();
  
  // æœç´¢é˜²æŠ–
  const searchInput = document.getElementById('searchKeyword');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchEmails, 500));
  }
});

async function loadCustomerOptions() {
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('/api/customers/?pageSize=100', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.customers) {
      let options = '<option value="">æ‰€æœ‰å®¢æˆ·</option>';
      data.customers.forEach(customer => {
        options += `<option value="${customer.id}">${customer.name} (${customer.company})</option>`;
      });
      
      const filterCustomer = document.getElementById('filterCustomer');
      if (filterCustomer) {
        filterCustomer.innerHTML = options;
      }
    }
  } catch (error) {
    console.error('âŒ åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
  }
}

async function loadEmails(page = 1) {
  try {
    console.log('ğŸ”„ åŠ è½½æ”¶ä»¶ç®±é‚®ä»¶ï¼Œé¡µç :', page);
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      showWarning('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    let queryParams = `email_type=received&page=${page}&pageSize=20`;
    if (currentFilters.query) queryParams += `&query=${encodeURIComponent(currentFilters.query)}`;
    if (currentFilters.send_address) queryParams += `&send_address=${encodeURIComponent(currentFilters.send_address)}`;
    if (currentFilters.customer_id) queryParams += `&customer_id=${currentFilters.customer_id}`;
    
    const url = `/api/email-history/?${queryParams}`;
    console.log('ğŸ“ è¯·æ±‚URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ é‚®ä»¶æ•°æ®:', data);
    
    if (!data.success) {
      showError('åŠ è½½é‚®ä»¶å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      const emailList = document.getElementById('emailList');
      if (emailList) {
        emailList.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';
      }
      return;
    }
    
    currentPage = page;
    
    // æ›´æ–°æ€»æ•°
    const totalCountElement = document.getElementById('totalCount');
    if (totalCountElement) {
      totalCountElement.textContent = data.total || 0;
    }
    
    // æ¸²æŸ“é‚®ä»¶åˆ—è¡¨
    renderEmailList(data.email_history || []);
    
    // æ¸²æŸ“åˆ†é¡µ
    renderPagination(data.page, data.total_pages, data.total);
    
  } catch (error) {
    console.error('âŒ åŠ è½½é‚®ä»¶å¤±è´¥:', error);
    showError('åŠ è½½é‚®ä»¶å¤±è´¥: ' + error.message);
    const emailList = document.getElementById('emailList');
    if (emailList) {
      emailList.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
    }
  }
}

function renderEmailList(emails) {
  const emailList = document.getElementById('emailList');
  if (!emailList) return;
  
  if (emails.length === 0) {
    emailList.innerHTML = `
      <div class="empty-state p-5 text-center">
        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
        <h5 class="mt-3">æ”¶ä»¶ç®±ä¸ºç©º</h5>
        <p class="text-muted">æš‚æ— æ”¶åˆ°çš„é‚®ä»¶</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  emails.forEach(email => {
    const customerInfo = email.customer ? `${email.customer.name} (${email.customer.company})` : 'æœªçŸ¥';
    
    html += `
      <div class="email-item p-3 border-bottom" style="cursor: pointer;" onclick="showEmailDetail(${email.id})">
        <div class="d-flex justify-content-between">
          <div class="flex-grow-1">
            <div class="email-sender mb-1">
              <i class="bi bi-envelope"></i> <strong>${email.send_address}</strong>
              ${email.customer ? `<span class="badge bg-info ms-2">${customerInfo}</span>` : ''}
            </div>
            <div class="email-subject fw-bold mb-1">${email.title || '(æ— ä¸»é¢˜)'}</div>
            <div class="email-preview text-muted small">${(email.content || '').substring(0, 100)}...</div>
          </div>
          <div class="text-end ms-3">
            <div class="email-time text-muted small">${formatDate(email.send_time)}</div>
            ${email.parent_email_id ? '<span class="badge bg-secondary mt-2"><i class="bi bi-reply"></i> å›å¤</span>' : ''}
          </div>
        </div>
      </div>
    `;
  });
  
  emailList.innerHTML = html;
  console.log(`âœ… æ¸²æŸ“äº† ${emails.length} å°é‚®ä»¶`);
}

function renderPagination(current, total, count) {
  const pagination = document.getElementById('pagination');
  if (!pagination) return;
  
  if (total <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // ä¸Šä¸€é¡µ
  html += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadEmails(${current - 1}); return false;">ä¸Šä¸€é¡µ</a>
    </li>
  `;
  
  // é¡µç 
  for (let i = 1; i <= Math.min(total, 5); i++) {
    html += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadEmails(${i}); return false;">${i}</a>
      </li>
    `;
  }
  
  // ä¸‹ä¸€é¡µ
  html += `
    <li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadEmails(${current + 1}); return false;">ä¸‹ä¸€é¡µ</a>
    </li>
  `;
  
  pagination.innerHTML = html;
}

function searchEmails() {
  currentFilters = {};
  
  const keyword = document.getElementById('searchKeyword')?.value;
  const sendAddress = document.getElementById('filterSendAddress')?.value;
  const customerId = document.getElementById('filterCustomer')?.value;
  
  if (keyword) currentFilters.query = keyword;
  if (sendAddress) currentFilters.send_address = sendAddress;
  if (customerId) currentFilters.customer_id = customerId;
  
  loadEmails(1);
}

function refreshEmails() {
  loadEmails(currentPage);
}

async function showEmailDetail(emailId) {
  try {
    currentEmailId = emailId;
    
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`/api/email-history/${emailId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    console.log('ğŸ“¥ é‚®ä»¶è¯¦æƒ…:', data);
    
    if (!data.success) {
      showError('åŠ è½½é‚®ä»¶è¯¦æƒ…å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      return;
    }
    
    const email = data.email_history;
    
    const html = `
      <div class="mb-3">
        <strong>å‘ä»¶äºº:</strong> ${email.send_address}
      </div>
      <div class="mb-3">
        <strong>æ”¶ä»¶äºº:</strong> ${email.receive_address}
      </div>
      <div class="mb-3">
        <strong>ä¸»é¢˜:</strong> ${email.title || '(æ— ä¸»é¢˜)'}
      </div>
      <div class="mb-3">
        <strong>æ—¶é—´:</strong> ${new Date(email.send_time).toLocaleString('zh-CN')}
      </div>
      ${email.customer ? `
        <div class="mb-3">
          <strong>å…³è”å®¢æˆ·:</strong> ${email.customer.name} (${email.customer.company})
        </div>
      ` : ''}
      <hr>
      <div class="mb-3">
        <strong>å†…å®¹:</strong>
        <div class="mt-2 p-3 bg-light rounded" style="white-space: pre-line;">${email.content ? email.content.trim() : '(æ— å†…å®¹)'}</div>
      </div>
    `;
    
    const emailDetailBody = document.getElementById('emailDetailBody');
    if (emailDetailBody) {
      emailDetailBody.innerHTML = html;
    }
    
    new bootstrap.Modal(document.getElementById('emailDetailModal')).show();
  } catch (error) {
    console.error('âŒ åŠ è½½é‚®ä»¶è¯¦æƒ…å¤±è´¥:', error);
    showError('åŠ è½½é‚®ä»¶è¯¦æƒ…å¤±è´¥: ' + error.message);
  }
}

// å›å¤é‚®ä»¶
async function replyEmail() {
  if (!currentEmailId) {
    showError('è¯·å…ˆé€‰æ‹©è¦å›å¤çš„é‚®ä»¶');
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    // è·å–é‚®ä»¶è¯¦æƒ…
    const response = await fetch(`/api/email-history/${currentEmailId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!data.success) {
      showError('è·å–é‚®ä»¶ä¿¡æ¯å¤±è´¥');
      return;
    }
    
    const email = data.email_history;
    
    // å°†å›å¤ä¿¡æ¯å­˜å‚¨åˆ° sessionStorageï¼Œåœ¨å†™é‚®ä»¶é¡µé¢ä½¿ç”¨
    const replyData = {
      originalEmailId: email.id,
      replyTo: email.send_address,
      originalSubject: email.title || '(æ— ä¸»é¢˜)',
      originalContent: email.content || '',
      originalSender: email.send_address,
      originalTime: email.send_time
    };
    
    sessionStorage.setItem('replyData', JSON.stringify(replyData));
    
    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
    const modal = bootstrap.Modal.getInstance(document.getElementById('emailDetailModal'));
    if (modal) {
      modal.hide();
    }
    
    // è·³è½¬åˆ°å†™é‚®ä»¶é¡µé¢
    window.location.href = '/emails/compose';
    
  } catch (error) {
    console.error('âŒ å›å¤é‚®ä»¶å¤±è´¥:', error);
    showError('å›å¤é‚®ä»¶å¤±è´¥: ' + error.message);
  }
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
</script>
